<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Project Management Platform (Leaflet GIS)</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marzipano@0.10.2/dist/marzipano.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/5.3.0/fabric.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff9a9e;
            --text-light: #ffffff;
            --text-dark: #271930;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.37);
            --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.5);
            --border-radius: 15px;
            --transition: all 0.3s ease;
            --backdrop-blur: blur(18px);
            --font-size: 16px;
        }

        [data-theme="dark"] {
            --primary-color: #5a67d8;
            --secondary-color: #805ad5;
            --text-light: #e2e8f0;
            --text-dark: #f7fafc;
            --glass-bg: rgba(26, 32, 44, 0.2);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Open Sans", sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
            font-size: var(--font-size);
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("https://i.postimg.cc/0jv27Qvw/20008380-645221846.jpg") center/cover no-repeat fixed;
            z-index: -1;
            opacity: 0.2;
            transition: var(--transition);
        }

        /* Glassmorphism Base Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .glass:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        /* Main App Layout */
        .main-app { display: none; min-height: 100vh; }
        .header {
            padding: 15px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky; top: 0; z-index: 1000;
            margin-bottom: 20px;
        }
        .app-layout { display: flex; min-height: calc(100vh - 90px); gap: 20px; padding: 0 20px; }
        .sidebar { width: 280px; overflow-y: auto; height: fit-content; }
        .main-content { flex: 1; overflow-y: auto; padding-right: 10px; position: relative; }
        .page { display: none; animation: fadeIn 0.5s ease-in-out; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

        /* Common Components */
        .card { padding: 25px; margin-bottom: 25px; }
        .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; padding-bottom: 15px; border-bottom: 1px solid var(--glass-border); }
        .card-title { font-size: 24px; font-weight: 600; }
        .btn { padding: 10px 20px; border: none; border-radius: 25px; font-size: 14px; cursor: pointer; transition: var(--transition); display: inline-flex; align-items: center; gap: 8px; text-decoration: none; }
        .btn:hover { transform: translateY(-2px); box-shadow: var(--shadow-glass); }
        .btn-primary { background: linear-gradient(135deg, var(--primary-color), var(--secondary-color)); color: var(--text-light); border: none; }
        .form-group { margin-bottom: 20px; }
        .form-label { display: block; margin-bottom: 8px; font-weight: 500; }
        .form-input, .form-select, .form-textarea { width: 100%; padding: 12px; border: 1px solid var(--glass-border); border-radius: 12px; background: var(--glass-bg); color: var(--text-light); }
        .form-input:focus, .form-select:focus, .form-textarea:focus { outline: none; border-color: var(--accent-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--accent-color) 20%, transparent); }
        .table-container { overflow-x: auto; }
        .table { width: 100%; border-collapse: collapse; }
        .table th, .table td { padding: 15px; text-align: left; border-bottom: 1px solid var(--glass-border); }

        /* GIS Mapping Page Styles */
        .gis-container { position: relative; height: calc(100vh - 120px); border-radius: var(--border-radius); overflow: hidden; }
        #gis-map { width: 100%; height: 100%; background: #aadaff; } /* Added background for map loading */
        .gis-card-stack { position: absolute; top: 15px; right: 15px; width: 320px; z-index: 1000; display: flex; flex-direction: column; gap: 10px; }
        .gis-card { padding: 15px; max-height: 80vh; overflow-y: auto; }
        .gis-card-header { padding-bottom: 10px; margin-bottom: 10px; display: flex; justify-content: space-between; align-items: center; }
        .gis-card-title { font-size: 16px; font-weight: bold; }
        .gis-card-toggle { cursor: pointer; font-size: 16px; }
        .gis-card-content { display: block; }
        .gis-card-content.hidden { display: none; }
        .gis-hamburger-menu { position: absolute; top: 15px; right: 15px; z-index: 1001; display: none; }
        .gis-hamburger-menu-content { display: none; position: absolute; top: 50px; right: 0; background: var(--glass-bg); padding: 10px; border-radius: 10px; }
        .gis-hamburger-menu:hover .gis-hamburger-menu-content { display: block; }
        .gis-hamburger-menu-content a { display: block; padding: 8px; color: var(--text-light); text-decoration: none; }
        .leaflet-pm-toolbar { top: 15px; left: 15px; } /* Position Geoman toolbar */

        /* Chat System Styles */
        .chat-container { display: flex; height: calc(100vh - 200px); }
        .chat-sidebar { width: 300px; border-right: 1px solid var(--glass-border); display: flex; flex-direction: column; }
        .chat-list { flex-grow: 1; overflow-y: auto; }
        .chat-user { padding: 15px; cursor: pointer; border-bottom: 1px solid var(--glass-border); }
        .chat-user.active, .chat-user:hover { background: rgba(255, 255, 255, 0.1); }
        .chat-main { flex-grow: 1; display: flex; flex-direction: column; }
        .chat-messages { flex-grow: 1; padding: 20px; overflow-y: auto; display: flex; flex-direction: column-reverse; }
        .message { max-width: 70%; padding: 10px 15px; border-radius: 18px; margin-bottom: 10px; }
        .message.sent { background: var(--primary-color); align-self: flex-end; }
        .message.received { background: var(--secondary-color); align-self: flex-start; }
        .chat-input { display: flex; padding: 15px; border-top: 1px solid var(--glass-border); }
        .chat-input input { flex-grow: 1; }
        .chat-input .btn { border-radius: 50%; width: 45px; height: 45px; padding: 0; }
        #chat-file-input { display: none; }

        /* CAD Editor Styles */
        .cad-container { display: flex; flex-direction: column; height: calc(100vh - 180px); }
        .cad-toolbar { display: flex; flex-wrap: wrap; gap: 5px; padding: 10px; background: var(--glass-bg); border-radius: var(--border-radius); margin-bottom: 10px; }
        .cad-toolbar .btn { padding: 8px 12px; }
        .cad-canvas-wrapper { flex-grow: 1; position: relative; background: #fff; border-radius: var(--border-radius); overflow: hidden; }
        #cad-canvas { position: absolute; top: 0; left: 0; }
        .fabric-container { width: 100%; height: 100%; }

        /* Inspection & Cost Page */
        .estimation-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .estimation-card { padding: 20px; }
        .tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: 20px; }
        .tab-button { padding: 12px 20px; border: 1px solid var(--glass-border); border-bottom: none; border-radius: 10px 10px 0 0; cursor: pointer; background-color: var(--glass-bg); }
        .tab-button.active { background-color: color-mix(in srgb, var(--glass-bg) 50%, #fff); }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .boq-form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; align-items: end; }

        /* File Manager Styles */
        .file-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(180px, 1fr)); gap: 15px; }
        .file-item { padding: 20px; text-align: center; cursor: pointer; }
        .file-icon { font-size: 48px; margin-bottom: 10px; color: var(--accent-color); }
        .file-item .file-actions { display: none; margin-top: 10px; }
        .file-item:hover .file-actions { display: flex; justify-content: center; gap: 10px; }

        /* Modals */
        .modal { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.6); display: none; justify-content: center; align-items: center; z-index: 2000; }
        .modal.active { display: flex; }
        .modal-content { padding: 30px; width: 90%; max-width: 600px; max-height: 90vh; overflow-y: auto; position: relative; }
        .modal-close { position: absolute; top: 15px; right: 20px; background: none; border: none; font-size: 24px; cursor: pointer; color: var(--text-light); }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .app-layout { flex-direction: column; }
            .sidebar { width: 100%; order: 2; height: auto; }
            .main-content { order: 1; padding-right: 0; }
            .gis-card-stack { display: none; }
            .gis-hamburger-menu { display: block; }
        }
        @media (max-width: 768px) {
            .header { flex-direction: column; gap: 10px; }
            .chat-container { flex-direction: column; }
            .chat-sidebar { width: 100%; height: 200px; border-right: none; border-bottom: 1px solid var(--glass-border); }
        }

        /* Print Styles */
        @media print {
            body, .card, .modal-content { background: #fff !important; color: #000 !important; }
            .header, .sidebar, .btn, .gis-card-stack, .gis-top-controls, .modal-close, .no-print { display: none !important; }
            .main-app, .app-layout, .main-content, .page, .page.active { display: block !important; }
            .table-container { overflow: visible; }
            .card { box-shadow: none; border: 1px solid #ccc; }
            .page { animation: none; }
            .printable-area { display: block !important; }
            @page { size: auto; margin: 20mm; }
        }
    </style>
</head>
<body data-theme="light">

    <div id="auth-container" class="auth-container glass">
        <div class="wrapper">
            <h2>Sign In</h2>
            <form id="auth-form">
                <div class="form-group"><input type="email" id="auth-email" class="form-input" placeholder="Email" required></div>
                <div class="form-group"><input type="password" id="auth-password" class="form-input" placeholder="Password" required></div>
                <button type="submit" class="btn btn-primary">Sign In</button>
            </form>
        </div>
    </div>

    <div id="main-app" class="main-app">
        <header class="header glass">
            <div class="logo">Smart Project Platform</div>
            <div class="header-actions">
                <button class="btn theme-toggle" onclick="toggleTheme()"><i class="fas fa-moon"></i></button>
                <div class="user-avatar" onclick="toggleUserMenu()">U</div>
                <div id="user-dropdown" class="user-dropdown glass">
                    <div class="user-dropdown-item" onclick="logout()">Logout</div>
                </div>
            </div>
        </header>

        <div class="app-layout">
            <nav id="sidebar" class="sidebar glass">
                <div class="nav-section">
                    <div class="nav-item active" onclick="showPage('dashboard')"><i class="fas fa-tachometer-alt"></i> Dashboard</div>
                    <div class="nav-item" onclick="showPage('file-manager')"><i class="fas fa-folder"></i> File Manager</div>
                    <div class="nav-item" onclick="showPage('chat')"><i class="fas fa-comments"></i> Chat</div>
                </div>
                <div class="nav-section">
                    <div class="nav-item" onclick="showPage('inspection-cost')"><i class="fas fa-clipboard-check"></i> Inspection & Cost</div>
                    <div class="nav-item" onclick="showPage('gis-mapping')"><i class="fas fa-map-marked-alt"></i> GIS Mapping</div>
                    <div class="nav-item" onclick="showPage('cad-editor')"><i class="fas fa-drafting-compass"></i> CAD Editor</div>
                </div>
                <div class="nav-section">
                     <div class="nav-item" onclick="showPage('settings')"><i class="fas fa-cog"></i> Settings</div>
                </div>
            </nav>

            <main class="main-content">
                <div id="dashboard-page" class="page active card glass"><h1>Dashboard</h1><p>Welcome to the Smart Project Management Platform.</p></div>
                
                <div id="file-manager-page" class="page card glass">
                    <div class="card-header">
                        <h2 class="card-title">File Manager</h2>
                        <button class="btn btn-primary no-print" onclick="document.getElementById('file-upload-input').click()"><i class="fas fa-upload"></i> Upload File</button>
                        <input type="file" id="file-upload-input" style="display:none" onchange="handleFileUpload(event)">
                    </div>
                    <div class="form-group">
                        <label for="contract-select" class="form-label">Select Contract:</label>
                        <select id="contract-select" class="form-select" onchange="renderFileManager()">
                            <option value="CONTRACT-0001">CONTRACT-0001</option>
                            <option value="CONTRACT-0002">CONTRACT-0002</option>
                        </select>
                    </div>
                    <div id="file-grid" class="file-grid"></div>
                </div>

                <div id="chat-page" class="page card glass">
                    <div class="chat-container">
                        <div class="chat-sidebar">
                             <div class="chat-list" id="chat-list">
                                 <div class="chat-user active" onclick="switchChat('general')"># General</div>
                                 <div class="chat-user" onclick="switchChat('user2')">User Two</div>
                             </div>
                        </div>
                        <div class="chat-main">
                            <div class="chat-messages" id="chat-messages"></div>
                            <div class="chat-input no-print">
                                <input type="file" id="chat-file-input" onchange="handleChatFileUpload(event)">
                                <button class="btn" onclick="document.getElementById('chat-file-input').click()"><i class="fas fa-paperclip"></i></button>
                                <input type="text" id="chat-message-input" class="form-input" placeholder="Type a message...">
                                <button class="btn btn-primary" onclick="sendChatMessage()"><i class="fas fa-paper-plane"></i></button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="gis-mapping-page" class="page">
                    <div class="gis-container">
                        <div id="gis-map"></div>
                        <div class="gis-hamburger-menu no-print">
                            <button class="btn"><i class="fas fa-bars"></i></button>
                            <div class="gis-hamburger-menu-content glass">
                                 <a href="#" onclick="toggleGisCard('qnas-card')">QNAS</a>
                                 <a href="#" onclick="toggleGisCard('simulation-card')">Simulation</a>
                                 <a href="#" onclick="toggleGisCard('info-card')">Info</a>
                                 <a href="#" onclick="toggleGisCard('overlays-card')">Overlays</a>
                            </div>
                        </div>
                        <div class="gis-card-stack no-print">
                            <div id="qnas-card" class="gis-card glass">
                                <div class="gis-card-header"><span class="gis-card-title">QNAS Metadata</span><i class="fas fa-chevron-up gis-card-toggle" onclick="toggleGisCardContent('qnas-card')"></i></div>
                                <div class="gis-card-content">
                                    <div class="form-group"><label>ID:</label><input type="text" id="qnas-id" class="form-input"></div>
                                    <div class="form-group"><label>Coordinates:</label><input type="text" id="qnas-coords" class="form-input"></div>
                                    <div class="form-group"><label>Notes:</label><textarea id="qnas-notes" class="form-textarea"></textarea></div>
                                    <button class="btn btn-primary" onclick="saveQnasData()">Save</button>
                                </div>
                            </div>
                            <div id="simulation-card" class="gis-card glass">
                                <div class="gis-card-header"><span class="gis-card-title">Simulation Entry</span><i class="fas fa-chevron-up gis-card-toggle" onclick="toggleGisCardContent('simulation-card')"></i></div>
                                <div class="gis-card-content">
                                    <div class="form-group"><label>Lat, Lng:</label><input type="text" id="sim-coords" class="form-input" placeholder="e.g., 25.28, 51.53"></div>
                                    <button class="btn" onclick="addSimulationPoint()">Add Point</button>
                                    <hr style="margin: 10px 0;">
                                    <input type="file" id="gis-import-input" style="display:none;" onchange="importGisData(event)">
                                    <button class="btn" onclick="document.getElementById('gis-import-input').click()">Import CSV/KML</button>
                                </div>
                            </div>
                            <div id="info-card" class="gis-card glass">
                                <div class="gis-card-header"><span class="gis-card-title">Shape Info</span><i class="fas fa-chevron-up gis-card-toggle" onclick="toggleGisCardContent('info-card')"></i></div>
                                <div class="gis-card-content" id="info-card-content"><p>Draw or select a shape.</p></div>
                            </div>
                            <div id="overlays-card" class="gis-card glass">
                                <div class="gis-card-header"><span class="gis-card-title">Overlays</span><i class="fas fa-chevron-up gis-card-toggle" onclick="toggleGisCardContent('overlays-card')"></i></div>
                                <div class="gis-card-content">
                                    <button class="btn" onclick="toggleGisLayer('traffic')">Toggle Traffic</button>
                                    <button class="btn" onclick="toggleGisLayer('weather')">Toggle Weather</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <div id="cad-editor-page" class="page card glass">
                    <div class="card-header">
                        <h2 class="card-title">CAD Editor</h2>
                        <div class="d-flex gap-2 no-print">
                            <input type="file" id="cad-import-input" accept=".svg,.json" style="display:none" onchange="importToCad(event)">
                            <button class="btn" onclick="document.getElementById('cad-import-input').click()"><i class="fas fa-upload"></i> Import</button>
                            <button class="btn" onclick="exportFromCad('svg')"><i class="fas fa-file-code"></i> SVG</button>
                            <button class="btn" onclick="exportFromCad('png')"><i class="fas fa-file-image"></i> PNG</button>
                            <button class="btn btn-primary" onclick="shareCadViaTelegram()"><i class="fab fa-telegram-plane"></i> Share</button>
                        </div>
                    </div>
                    <div class="cad-container">
                        <div class="cad-toolbar glass no-print">
                             <button class="btn" data-tool="select" onclick="setCadTool('select')"><i class="fas fa-mouse-pointer"></i></button>
                             <button class="btn" data-tool="line" onclick="setCadTool('line')"><i class="fas fa-pen"></i></button>
                             <button class="btn" data-tool="rect" onclick="setCadTool('rect')"><i class="far fa-square"></i></button>
                             <button class="btn" data-tool="circle" onclick="setCadTool('circle')"><i class="far fa-circle"></i></button>
                             <button class="btn" data-tool="text" onclick="setCadTool('text')"><i class="fas fa-font"></i></button>
                             <input type="color" id="cad-color-picker" value="#ff0000">
                             <button class="btn btn-danger" onclick="deleteSelectedCadObject()"><i class="fas fa-trash"></i></button>
                        </div>
                        <div class="cad-canvas-wrapper"><canvas id="cad-canvas"></canvas></div>
                    </div>
                </div>

                <div id="inspection-cost-page" class="page">
                    <div class="card glass printable-area">
                        <div class="card-header no-print">
                            <h1 class="card-title">Enhanced Estimation & Inspection System</h1>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="exportProjectData()"><i class="fas fa-save"></i> Export Project</button>
                                <input type="file" id="project-import-input" accept=".json" style="display: none;" onchange="importProjectData(event)">
                                <button class="btn btn-success" onclick="document.getElementById('project-import-input').click()"><i class="fas fa-upload"></i> Import Project</button>
                                <button class="btn btn-info" onclick="window.print()"><i class="fas fa-print"></i> Print Report</button>
                            </div>
                        </div>

                        <div class="tabs no-print">
                            <button class="tab-button active" onclick="openTab(event, 'inspection-tab')">Inspection Report</button>
                            <button class="tab-button" onclick="openTab(event, 'cost-tab')">Cost Estimation</button>
                        </div>

                        <div id="inspection-tab" class="tab-content active">
                            <div class="estimation-form-grid">
                                <div class="estimation-card glass">
                                    <h3>Asset Information</h3>
                                    <div class="form-group"><label class="form-label">Asset Description</label><input type="text" id="asset-description" class="form-input" list="asset-options" placeholder="Enter asset description"></div>
                                    <div class="form-group"><label class="form-label">Status</label><select id="asset-status" class="form-select"><option>Good</option><option>Fair</option><option>Poor</option></select></div>
                                    <div class="form-group"><label class="form-label">Recommendation</label><textarea id="asset-recommendation" class="form-textarea"></textarea></div>
                                    <div class="form-group"><label class="form-label">Quantity</label><input type="number" id="asset-quantity" class="form-input"></div>
                                </div>
                                <div class="estimation-card glass">
                                    <h3>Photo Documentation</h3>
                                    <input type="file" id="photo-input" multiple accept="image/*" style="display: none;" onchange="handleInspectionPhotos(event)">
                                    <button class="btn" onclick="document.getElementById('photo-input').click()">Add Photos</button>
                                    <div id="photo-previews" class="photo-previews"></div>
                                </div>
                                <div class="estimation-card glass">
                                     <h3>GPS Location</h3>
                                     <button class="btn btn-success w-100 mb-2" onclick="getInspectionCurrentLocation()">Get Current GPS</button>
                                     <div class="form-group"><label>Lat:</label><input id="current-lat" class="form-input" readonly></div>
                                     <div class="form-group"><label>Lng:</label><input id="current-lng" class="form-input" readonly></div>
                                </div>
                            </div>
                            <button class="btn btn-primary no-print" onclick="addInspectionRow()">Add to Report</button>
                            <div class="table-container mt-3"><table class="table" id="inspection-table"><thead><tr><th>ID</th><th>Asset</th><th>Status</th><th>Photos</th><th>Location</th><th>Actions</th></tr></thead><tbody id="inspection-tbody"></tbody></table></div>
                        </div>

                        <div id="cost-tab" class="tab-content">
                            <div class="boq-form-grid">
                                <div class="form-group"><label>BOQ Ref</label><select id="boq-select" class="form-select" onchange="updateBOQDetails()"><option value="">Select</option><option value="A1.1" data-desc="Excavation" data-unit="m³" data-rate="15.00">A1.1</option><option value="B2.1" data-desc="Concrete Paving" data-unit="m²" data-rate="75.00">B2.1</option></select></div>
                                <div class="form-group"><label>Description</label><input id="boq-description" class="form-input" readonly></div>
                                <div class="form-group"><label>Unit</label><input id="boq-unit" class="form-input" readonly></div>
                                <div class="form-group"><label>Quantity</label><input type="number" id="boq-quantity" class="form-input" oninput="calculateBOQAmount()"></div>
                                <div class="form-group"><label>Rate</label><input id="boq-rate" class="form-input" readonly></div>
                                <div class="form-group"><label>Amount</label><input id="boq-amount" class="form-input" readonly></div>
                            </div>
                            <button class="btn btn-success no-print" onclick="addBOQRow()">Add Item</button>
                             <div class="table-container mt-3"><table class="table" id="cost-table"><thead><tr><th>Ref</th><th>Description</th><th>Qty</th><th>Rate</th><th>Amount</th><th>Actions</th></tr></thead><tbody id="cost-tbody"></tbody><tfoot><tr><td colspan="4" class="text-right">Total:</td><td id="total-amount">QR 0.00</td><td></td></tr></tfoot></table></div>
                        </div>
                    </div>
                </div>

                <div id="settings-page" class="page card glass">
                    <h2 class="card-title">Settings</h2>
                    <div class="form-group">
                        <label class="form-label">Theme</label>
                        <select class="form-select" onchange="setTheme(this.value)">
                            <option value="light">Light</option>
                            <option value="dark">Dark</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label class="form-label">Font Size</label>
                        <input type="range" class="form-input" min="12" max="20" value="16" onchange="setFontSize(this.value)">
                    </div>
                     <div class="form-group">
                        <label class="form-label">Background Image</label>
                        <input type="file" class="form-input" accept="image/*" onchange="setBackgroundImage(event)">
                    </div>
                    <div class="form-group">
                        <label class="form-label">AI Prompt</label>
                        <textarea id="ai-prompt-field" class="form-textarea" rows="5" placeholder="Enter your multi-line AI prompt here..."></textarea>
                    </div>
                </div>

            </main>
        </div>
    </div>
    
    <div id="share-modal" class="modal">
        <div class="modal-content glass">
            <button class="modal-close" onclick="hideModal('share-modal')">&times;</button>
            <h2>Share File</h2>
            <div class="form-group">
                <label>Recipient (Email/User/Phone):</label>
                <input id="share-recipient" class="form-input">
            </div>
            <div class="form-group">
                <label>Duration (minutes):</label>
                <input id="share-duration" type="number" class="form-input" value="10">
            </div>
            <button id="share-confirm-btn" class="btn btn-primary" onclick="confirmShare()">Share via Telegram</button>
        </div>
    </div>


<script>
// --- GLOBAL CONFIG & STATE ---
const SUPABASE_URL = 'YOUR_SUPABASE_URL'; // Add your Supabase URL
const SUPABASE_ANON_KEY = 'YOUR_SUPABASE_ANON_KEY'; // Add your Supabase Anon Key

// const supabase = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); // Uncomment when using real Supabase
let currentUser = { id: 'user-123', name: 'Demo User' };
let currentPage = 'dashboard';
let gisMap, cadCanvas;
let gisTrafficLayer = null, gisWeatherLayer = null; // For overlay toggling
let activeChat = 'general';
let fileSystem = {}; // Simulated file system
let chatHistory = {}; // Simulated chat history

// --- INITIALIZATION ---
document.addEventListener('DOMContentLoaded', () => {
    // Simulate login
    document.getElementById('auth-container').style.display = 'none';
    document.getElementById('main-app').style.display = 'block';
    
    initializeAll();
});

function initializeAll() {
    initFileManager();
    initChat();
    initGisMap();
    initCadEditor();
    initInspectionCost();
    // Set default theme
    document.body.dataset.theme = 'light';
    document.querySelector('.theme-toggle i').className = 'fas fa-moon';
}

function showPage(pageId) {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(`${pageId}-page`).classList.add('active');
    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
    document.querySelector(`[onclick="showPage('${pageId}')"]`).classList.add('active');
    currentPage = pageId;

    // Lazy load maps to prevent initialization issues
    if (pageId === 'gis-mapping' && gisMap) {
        setTimeout(() => gisMap.invalidateSize(), 10);
    }
    if (pageId === 'cad-editor' && cadCanvas) {
        setTimeout(() => cadCanvas.calcOffset(), 10);
    }
}

// --- AUTHENTICATION & USER ---
function logout() {
    alert("User logged out.");
    location.reload();
}

function toggleUserMenu() {
    document.getElementById('user-dropdown').classList.toggle('active');
}

// --- FILE MANAGER ---
function initFileManager() {
    // Simulate fetching file metadata from Supabase
    fileSystem = {
        'CONTRACT-0001': {
            'Contracts': [{ name: 'CONTRACT-0001_MainAgreement_2025-07-13_1000.pdf', size: 1200000, owner: 'user-123' }],
            'BOQ': [{ name: 'CONTRACT-0001_BOQ_2025-07-13_1005.xlsx', size: 50000, owner: 'user-123' }],
            'GISReports': [],
            'ChatMedia': []
        },
        'CONTRACT-0002': { 'Contracts': [], 'BOQ': [], 'GISReports': [], 'ChatMedia': [] }
    };
    renderFileManager();
}

function renderFileManager() {
    const contractId = document.getElementById('contract-select').value;
    const grid = document.getElementById('file-grid');
    grid.innerHTML = '';
    const currentContractFiles = fileSystem[contractId];

    for (const folder in currentContractFiles) {
        currentContractFiles[folder].forEach(file => {
            const fileItem = document.createElement('div');
            fileItem.className = 'file-item glass';
            fileItem.innerHTML = `
                <div class="file-icon"><i class="fas fa-file-alt"></i></div>
                <div>${file.name}</div>
                <small>${(file.size / 1024 / 1024).toFixed(2)} MB</small>
                <div class="file-actions">
                    <button class="btn" onclick="shareFile('${contractId}', '${folder}', '${file.name}')"><i class="fas fa-share-alt"></i></button>
                    <button class="btn btn-primary" onclick="sendFileToTelegram({name: '${file.name}', content: '...'})"><i class="fab fa-telegram-plane"></i></button>
                </div>
            `;
            grid.appendChild(fileItem);
        });
    }
}

function handleFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (file.size > 20 * 1024 * 1024 * 1024) {
        alert("File exceeds 20GB limit!");
        return;
    }

    const contractId = document.getElementById('contract-select').value;
    const now = new Date();
    const formattedDate = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
    const newFileName = `${contractId}_${file.name.split('.')[0]}_${formattedDate}.${file.name.split('.').pop()}`;

    // SIMULATED: Upload to internal storage, then save metadata to Supabase
    console.log(`Uploading ${newFileName} to /storage/${contractId}/Contracts/`);
    fileSystem[contractId]['Contracts'].push({ name: newFileName, size: file.size, owner: currentUser.id });
    
    alert(`File ${newFileName} uploaded successfully (Simulated).`);
    renderFileManager();
}

// --- TIME-LIMITED SHARING ---
function shareFile(contractId, folder, fileName) {
    const modal = document.getElementById('share-modal');
    modal.classList.add('active');
    // Pass file info to the confirm button
    modal.querySelector('#share-confirm-btn').dataset.fileInfo = JSON.stringify({ contractId, folder, fileName });
}

function confirmShare() {
    const recipient = document.getElementById('share-recipient').value;
    const duration = document.getElementById('share-duration').value;
    const fileInfo = JSON.parse(document.getElementById('share-confirm-btn').dataset.fileInfo);

    if (!recipient) {
        alert("Please enter a recipient.");
        return;
    }
    
    // As per new spec, send via Telegram
    sendFileToTelegram({ name: fileInfo.fileName, content: '...' }, recipient);
    hideModal('share-modal');
}


// --- CHAT SYSTEM ---
function initChat() {
    // Simulate loading chat history
    chatHistory = {
        'general': [
            { sender: 'User Two', type: 'text', content: 'Hello everyone!', timestamp: new Date() },
            { sender: currentUser.name, type: 'text', content: 'Hi there!', timestamp: new Date() }
        ],
        'user2': []
    };
    renderChatMessages();
}

function switchChat(chatId) {
    activeChat = chatId;
    document.querySelectorAll('.chat-user').forEach(u => u.classList.remove('active'));
    document.querySelector(`[onclick="switchChat('${chatId}')"]`).classList.add('active');
    renderChatMessages();
}

function renderChatMessages() {
    const messagesContainer = document.getElementById('chat-messages');
    messagesContainer.innerHTML = '';
    const history = chatHistory[activeChat] || [];
    
    // We reverse the display with flex-direction, so iterate normally
    history.forEach(msg => {
        const msgEl = document.createElement('div');
        msgEl.className = `message ${msg.sender === currentUser.name ? 'sent' : 'received'}`;
        
        if (msg.type === 'text') {
            msgEl.textContent = msg.content;
        } else if (msg.type === 'location') {
            msgEl.innerHTML = `Location: <a href="${msg.content}" target="_blank">${msg.content}</a>`;
        } else if (msg.type === 'file') {
             msgEl.innerHTML = `File: ${msg.content.name} <button class="btn" onclick="sendFileToTelegram({name: '${msg.content.name}'})"><i class="fab fa-telegram-plane"></i></button>`;
        }
        messagesContainer.prepend(msgEl); // Prepend to show newest at bottom
    });
}

function sendChatMessage() {
    const input = document.getElementById('chat-message-input');
    const content = input.value.trim();
    if (!content) return;

    let messageType = 'text';
    // Regex to check for lat,lng or Google Maps URL
    const isLocation = /^(-?\d{1,3}\.\d+),\s*(-?\d{1,3}\.\d+)$/.test(content) || /google\.com\/maps/.test(content);
    
    if (isLocation) {
        if (content.includes('goo.gl')) {
            alert("Short links are not supported for locations. Please use full coordinates or a Google Maps URL.");
            return;
        }
        messageType = 'location';
    }

    const message = { sender: currentUser.name, type: messageType, content: content, timestamp: new Date() };
    chatHistory[activeChat].push(message);
    
    renderChatMessages();
    input.value = '';
}

function handleChatFileUpload(event) {
    const file = event.target.files[0];
    if (!file) return;

    const message = { sender: currentUser.name, type: 'file', content: { name: file.name, size: file.size }, timestamp: new Date() };
    chatHistory[activeChat].push(message);
    renderChatMessages();
}

// --- GIS MAPPING (LEAFLET + LEAFLET-GEOMAN) ---
function initGisMap() {
    if (gisMap) return;
    gisMap = L.map('gis-map').setView([25.2854, 51.5310], 12); // Qatar coordinates

    // Use OpenStreetMap which is free and requires no key
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(gisMap);

    // Add Leaflet-Geoman controls for drawing
    gisMap.pm.addControls({
        position: 'topleft',
        drawMarker: true,
        drawCircleMarker: false,
        drawPolyline: true,
        drawRectangle: true,
        drawPolygon: true,
        drawCircle: true,
        editMode: true,
        dragMode: true,
        cutPolygon: true,
        removalMode: true,
    });
    
    // Event listener for when a shape is created
    gisMap.on('pm:create', function (e) {
        const layer = e.layer;
        updateGisInfoCard(layer);
        
        if (e.shape === 'Marker') {
            const coords = layer.getLatLng();
            document.getElementById('qnas-coords').value = `${coords.lat.toFixed(5)}, ${coords.lng.toFixed(5)}`;
            toggleGisCard('qnas-card', true);
        }
    });
    
    // GPS Location
    gisMap.locate({ setView: true, maxZoom: 16 });
    gisMap.on('locationfound', e => {
        L.marker(e.latlng).addTo(gisMap).bindPopup("You are here").openPopup();
        L.circle(e.latlng, e.accuracy).addTo(gisMap);
    });
}

function updateGisInfoCard(layer) {
    const infoContent = document.getElementById('info-card-content');
    let html = '';
    let coordsText = '';

    if (layer instanceof L.Polygon || layer instanceof L.Rectangle || layer instanceof L.Circle) {
        const latlngs = layer.getLatLngs()[0];
        let area = 0;
        // Simple area calculation for polygons
        if (L.GeometryUtil) { // L.GeometryUtil may not be in base Leaflet, fallback needed
             area = L.GeometryUtil.geodesicArea(latlngs);
        }
        let perimeter = 0;
        for (let i = 0; i < latlngs.length; i++) {
            perimeter += gisMap.distance(latlngs[i], latlngs[(i + 1) % latlngs.length]);
        }
        html += `<p>Area: ${area.toFixed(2)} m² (approx)</p>`;
        html += `<p>Perimeter: ${perimeter.toFixed(2)} m</p>`;
        coordsText = latlngs.map(ll => `${ll.lat.toFixed(5)},${ll.lng.toFixed(5)}`).join(';');
    } else if (layer instanceof L.Polyline) {
        const latlngs = layer.getLatLngs();
        let length = 0;
        for (let i = 0; i < latlngs.length - 1; i++) {
            length += gisMap.distance(latlngs[i], latlngs[i+1]);
        }
        html += `<p>Length: ${length.toFixed(2)} m</p>`;
        coordsText = latlngs.map(ll => `${ll.lat.toFixed(5)},${ll.lng.toFixed(5)}`).join(';');
    } else if (layer instanceof L.Marker) {
        const latlng = layer.getLatLng();
        html += `<p>Lat: ${latlng.lat.toFixed(5)}</p>`;
        html += `<p>Lng: ${latlng.lng.toFixed(5)}</p>`;
        coordsText = `${latlng.lat.toFixed(5)},${latlng.lng.toFixed(5)}`;
    }
    
    html += `
        <div class="d-flex gap-2 mt-2">
            <button class="btn" onclick="exportGisData('csv', \`${coordsText}\`)">CSV</button>
            <button class="btn" onclick="exportGisData('kml', \`${coordsText}\`)">KML</button>
            <button class="btn" onclick="exportGisData('pdf')">PDF</button>
        </div>`;
    infoContent.innerHTML = html;
    toggleGisCard('info-card', true);
}

function exportGisData(format, data) {
    alert(`Exporting as ${format.toUpperCase()} (Simulated).`);
}

function toggleGisCard(cardId, forceShow = false) {
    const card = document.getElementById(cardId);
    if (forceShow) {
        card.style.display = 'block';
    } else {
        card.style.display = card.style.display === 'none' ? 'block' : 'none';
    }
}

function toggleGisCardContent(cardId) {
    document.querySelector(`#${cardId} .gis-card-content`).classList.toggle('hidden');
    const icon = document.querySelector(`#${cardId} .gis-card-toggle`);
    icon.className = icon.className.includes('up') ? 'fas fa-chevron-down gis-card-toggle' : 'fas fa-chevron-up gis-card-toggle';
}

function toggleGisLayer(layerType) {
    if (layerType === 'traffic') {
        if (gisTrafficLayer) {
            gisMap.removeLayer(gisTrafficLayer);
            gisTrafficLayer = null;
            alert('Traffic simulation OFF.');
        } else {
            // Simulate traffic with a heatmap
            const trafficPoints = Array.from({length: 100}, () => [
                25.2854 + (Math.random() - 0.5) * 0.1,
                51.5310 + (Math.random() - 0.5) * 0.1,
                Math.random()
            ]);
            gisTrafficLayer = L.heatLayer(trafficPoints, {radius: 25}).addTo(gisMap);
            alert('Traffic simulation ON.');
        }
    } else if (layerType === 'weather') {
        if (gisWeatherLayer) {
            gisMap.removeLayer(gisWeatherLayer);
            gisWeatherLayer = null;
            alert('Weather simulation OFF.');
        } else {
            // Simulate weather with a blue overlay for rain
            const bounds = gisMap.getBounds().pad(0.1);
            gisWeatherLayer = L.rectangle(bounds, {color: "#007bff", weight: 1, fillOpacity: 0.2}).addTo(gisMap);
            alert('Weather simulation ON (Rain).');
        }
    }
}


function addSimulationPoint() {
    const coordsStr = document.getElementById('sim-coords').value;
    const coords = coordsStr.split(',').map(c => parseFloat(c));
    if (coords.length === 2 && !isNaN(coords[0]) && !isNaN(coords[1])) {
        L.marker(coords).addTo(gisMap).bindPopup('Simulation Point');
        gisMap.panTo(coords);
    } else {
        alert("Invalid coordinates. Use format: lat, lng");
    }
}

function importGisData(event) {
     const file = event.target.files[0];
     if (!file) return;
     
     if (file.name.endsWith('.csv')) {
         Papa.parse(file, {
             header: true,
             complete: function(results) {
                 results.data.forEach(row => {
                     const lat = row.lat || row.latitude;
                     const lng = row.lng || row.longitude;
                     if (lat && lng) {
                         L.marker([lat, lng]).addTo(gisMap).bindPopup(row.name || 'Imported Point');
                     }
                 });
                 alert('CSV data imported.');
             }
         });
     } else {
         alert('KML/KMZ import is a complex feature (Simulated).');
     }
}

// --- CAD EDITOR (FABRIC.JS) ---
function initCadEditor() {
    if (cadCanvas) return;
    const canvasEl = document.getElementById('cad-canvas');
    const wrapper = canvasEl.parentElement;
    
    cadCanvas = new fabric.Canvas('cad-canvas', {
        width: wrapper.clientWidth,
        height: wrapper.clientHeight,
        isDrawingMode: false,
        backgroundColor: '#ffffff'
    });

    window.addEventListener('resize', () => {
        cadCanvas.setWidth(wrapper.clientWidth);
        cadCanvas.setHeight(wrapper.clientHeight);
        cadCanvas.renderAll();
    });
}

function setCadTool(tool) {
    cadCanvas.isDrawingMode = tool === 'line';
    if(cadCanvas.isDrawingMode) {
        cadCanvas.freeDrawingBrush.color = document.getElementById('cad-color-picker').value;
        cadCanvas.freeDrawingBrush.width = 2;
    }

    if(tool === 'rect') {
        const rect = new fabric.Rect({ left: 100, top: 100, fill: document.getElementById('cad-color-picker').value, width: 60, height: 70 });
        cadCanvas.add(rect);
    }
    if(tool === 'circle') {
        const circle = new fabric.Circle({ radius: 20, fill: document.getElementById('cad-color-picker').value, left: 150, top: 150 });
        cadCanvas.add(circle);
    }
    if(tool === 'text') {
        const text = new fabric.IText('Text', { left: 200, top: 200, fill: document.getElementById('cad-color-picker').value });
        cadCanvas.add(text);
    }
}

function deleteSelectedCadObject() {
    cadCanvas.remove(cadCanvas.getActiveObject());
}

function importToCad(event) {
    const file = event.target.files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        if (file.name.endsWith('.svg')) {
            fabric.loadSVGFromString(e.target.result, (objects, options) => {
                const obj = fabric.util.groupSVGElements(objects, options);
                cadCanvas.add(obj).renderAll();
            });
        } else if (file.name.endsWith('.json')) {
            cadCanvas.loadFromJSON(e.target.result, cadCanvas.renderAll.bind(cadCanvas));
        }
    };
    reader.readAsText(file);
}

function exportFromCad(format) {
    if (format === 'svg') {
        const svg = cadCanvas.toSVG();
        downloadFile(svg, 'drawing.svg', 'image/svg+xml');
    } else if (format === 'png') {
        const dataURL = cadCanvas.toDataURL({ format: 'png', quality: 1 });
        downloadFile(dataURL, 'drawing.png', 'image/png', true);
    } else if (format === 'json') {
         const json = JSON.stringify(cadCanvas.toJSON());
         downloadFile(json, 'drawing.json', 'application/json');
    }
}

// --- INSPECTION & COST ---
let inspectionData = [];
let costData = [];
let inspectionPhotos = [];
let inspectionLocation = { lat: 25.28, lng: 51.53 };

function initInspectionCost() { /* Functions below are called on demand */ }

function openTab(event, tabName) {
    document.querySelectorAll('.tab-content').forEach(tab => tab.classList.remove('active'));
    document.querySelectorAll('.tab-button').forEach(btn => btn.classList.remove('active'));
    document.getElementById(tabName).classList.add('active');
    event.currentTarget.classList.add('active');
}

function addInspectionRow() {
    const asset = document.getElementById('asset-description').value;
    if(!asset) { alert('Asset description is required.'); return; }

    const row = {
        id: Date.now(),
        asset,
        status: document.getElementById('asset-status').value,
        photos: inspectionPhotos.length,
        location: `${inspectionLocation.lat.toFixed(4)}, ${inspectionLocation.lng.toFixed(4)}`
    };
    inspectionData.push(row);
    renderInspectionTable();
    inspectionPhotos = []; // Clear photos for next entry
    document.getElementById('photo-previews').innerHTML = '';
}

function renderInspectionTable() {
    const tbody = document.getElementById('inspection-tbody');
    tbody.innerHTML = inspectionData.map((row, i) => `
        <tr>
            <td>${i+1}</td>
            <td>${row.asset}</td>
            <td>${row.status}</td>
            <td>${row.photos}</td>
            <td>${row.location}</td>
            <td><button class="btn btn-danger" onclick="deleteInspectionRow(${row.id})">Del</button></td>
        </tr>
    `).join('');
}

function deleteInspectionRow(id) {
    inspectionData = inspectionData.filter(row => row.id !== id);
    renderInspectionTable();
}

function addBOQRow() {
    const ref = document.getElementById('boq-select').value;
    if(!ref) { alert('BOQ Reference is required.'); return; }
    
    const row = {
        id: Date.now(),
        ref,
        description: document.getElementById('boq-description').value,
        qty: document.getElementById('boq-quantity').value,
        rate: document.getElementById('boq-rate').value,
        amount: document.getElementById('boq-amount').value,
    };
    costData.push(row);
    renderCostTable();
}

function renderCostTable() {
    const tbody = document.getElementById('cost-tbody');
    let total = 0;
    tbody.innerHTML = costData.map(row => {
        total += parseFloat(row.amount) || 0;
        return `
            <tr>
                <td>${row.ref}</td>
                <td>${row.description}</td>
                <td>${row.qty}</td>
                <td>${row.rate}</td>
                <td>${row.amount}</td>
                <td><button class="btn btn-danger" onclick="deleteCostRow(${row.id})">Del</button></td>
            </tr>`;
    }).join('');
    document.getElementById('total-amount').textContent = `QR ${total.toFixed(2)}`;
}

function deleteCostRow(id) {
    costData = costData.filter(row => row.id !== id);
    renderCostTable();
}

function updateBOQDetails() {
    const opt = document.querySelector('#boq-select option:checked');
    document.getElementById('boq-description').value = opt.dataset.desc || '';
    document.getElementById('boq-unit').value = opt.dataset.unit || '';
    document.getElementById('boq-rate').value = opt.dataset.rate || '';
    calculateBOQAmount();
}

function calculateBOQAmount() {
    const qty = parseFloat(document.getElementById('boq-quantity').value) || 0;
    const rate = parseFloat(document.getElementById('boq-rate').value) || 0;
    document.getElementById('boq-amount').value = (qty * rate).toFixed(2);
}

function handleInspectionPhotos(event) {
    const files = event.target.files;
    const previews = document.getElementById('photo-previews');
    previews.innerHTML = '';
    inspectionPhotos = Array.from(files);
    inspectionPhotos.forEach(file => {
        const reader = new FileReader();
        reader.onload = (e) => {
            const img = document.createElement('img');
            img.src = e.target.result;
            img.style.width = '100px';
            img.style.height = '100px';
            img.style.objectFit = 'cover';
            previews.appendChild(img);
        };
        reader.readAsDataURL(file);
    });
}

function getInspectionCurrentLocation() {
    navigator.geolocation.getCurrentPosition(pos => {
        inspectionLocation.lat = pos.coords.latitude;
        inspectionLocation.lng = pos.coords.longitude;
        document.getElementById('current-lat').value = inspectionLocation.lat.toFixed(5);
        document.getElementById('current-lng').value = inspectionLocation.lng.toFixed(5);
    }, err => alert('Could not get location.'));
}

// --- SETTINGS ---
function setTheme(theme) {
    document.body.dataset.theme = theme;
    const icon = document.querySelector('.theme-toggle i');
    icon.className = theme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
}

function toggleTheme() {
    const currentTheme = document.body.dataset.theme;
    setTheme(currentTheme === 'light' ? 'dark' : 'light');
}

function setFontSize(size) {
    document.documentElement.style.setProperty('--font-size', `${size}px`);
}

function setBackgroundImage(event) {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        document.body.style.setProperty('background-image', `url(${e.target.result})`);
    };
    reader.readAsDataURL(file);
}

// --- NOTIFICATIONS & TELEGRAM ---
function sendNotification(channel, message) {
    // SIMULATED: API call to notification service
    alert(`[${channel.toUpperCase()}] Notification Sent: ${message}`);
}

function sendFileToTelegram(file, recipient = 'default') {
    // SIMULATED: API call to Telegram Bot
    console.log(`Sending file ${file.name} to ${recipient} via Telegram...`);
    alert(`File "${file.name}" sent to Telegram successfully (Simulated).`);
    sendNotification('telegram', `File shared: ${file.name}`);
}

function shareCadViaTelegram() {
    const dataUrl = cadCanvas.toDataURL({format: 'png'});
    sendFileToTelegram({name: 'cad-drawing.png', content: dataUrl});
}

// --- UTILITIES ---
function hideModal(modalId) {
    document.getElementById(modalId).classList.remove('active');
}

function downloadFile(content, fileName, mimeType, isDataURL = false) {
    const a = document.createElement('a');
    if(isDataURL) {
        a.href = content;
    } else {
        const blob = new Blob([content], { type: mimeType });
        a.href = URL.createObjectURL(blob);
    }
    a.download = fileName;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
}

</script>

</body>
</html>
