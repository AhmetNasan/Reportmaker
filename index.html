<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>

    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #34495e;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --warning-color: #f39c12;
        }

        /* Base & Bilingual Support */
        html[dir="rtl"] { font-family: 'Tahoma', sans-serif; }
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Page Visibility */
        .page {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
            flex-grow: 1;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Layouts */
        .main-container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .centered-container {
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .app-grid {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 20px;
            height: calc(100vh - 120px);
        }

        /* Card Style */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }
        html[dir="rtl"] .card { text-align: right; }

        /* Forms & Buttons */
        .form-card { max-width: 450px; width: 100%; }
        h1, h2, h3 { color: var(--primary-color); }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea { min-height: 120px; resize: vertical; }

        button, .btn {
            padding: 12px 20px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--secondary-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover, .btn:hover { background-color: #2980b9; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #1a252f; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #229954; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #a93226; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 1.5em; }
        .header-actions { display: flex; gap: 15px; align-items: center; }

        /* Sidebar Navigation */
        .sidebar { padding: 20px; background: var(--card-bg); border-radius: var(--border-radius); }
        .sidebar .nav-btn {
            display: block; width: 100%; text-align: left;
            margin-bottom: 10px; background: none; color: var(--text-color);
            font-weight: 500; padding: 15px;
        }
        .sidebar .nav-btn.active, .sidebar .nav-btn:hover { background-color: #ecf0f1; color: var(--primary-color); }

        /* Map Container */
        #map-container { height: 100%; width: 100%; border-radius: var(--border-radius); }
        .leaflet-popup-content-wrapper { padding: 10px; }

        /* Tables */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        td[contenteditable="true"] { background-color: #fdfde2; }

        /* Popups / Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; padding: 30px; border-radius: var(--border-radius);
            width: 90%; max-width: 600px; position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 30px; cursor: pointer; border: none; background: none; color: #7f8c8d;
        }

        /* Specific Component Styles */
        #contract-selection-list, #saved-contracts-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 20px;
        }
        .contract-card { border: 1px solid #ecf0f1; padding: 20px; border-radius: var(--border-radius); cursor: pointer; transition: all 0.3s; }
        .contract-card:hover { border-color: var(--secondary-color); box-shadow: var(--shadow); }

        .message {
            padding: 15px; border-radius: var(--border-radius); margin-top: 15px;
            text-align: center;
        }
        .message.error { background-color: #fbeae5; color: var(--danger-color); }
        .message.success { background-color: #eaf7eb; color: var(--success-color); }
        .message.pending { background-color: #fef9e7; color: var(--warning-color); }

        .toggle-link {
            display: block; text-align: center; margin-top: 20px;
            color: var(--secondary-color); text-decoration: none;
        }

        /* Footer */
        .footer { text-align: center; padding: 20px; color: #7f8c8d; }

    </style>
</head>
<body>

    <div id="login-page" class="page active centered-container">
        <div class="form-card card">
            <h1>Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇ</h1>
            <p>Smart tools for managing maps, data, inspections, and reports for engineers and managers.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%;">Sign In</button>
                <div id="login-message" class="message" style="display:none;"></div>
            </form>
            <a href="#" class="toggle-link" id="show-signup-link">Need an account? Sign Up</a>
        </div>
    </div>

    <div id="app-container" class="page">
        <header class="header">
            <h1 id="app-main-title">Project Dashboard</h1>
            <div class="header-actions">
                <span id="current-user-email"></span>
                <select id="language-switcher" onchange="switchLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
                <button class="btn-danger" onclick="signOut()"><i class="fa-solid fa-right-from-bracket"></i> Sign Out</button>
            </div>
        </header>

        <div class="main-container app-grid">
            <aside class="sidebar">
                <button id="nav-contracts" class="nav-btn active" onclick="showAppPage('contracts-page')"><i class="fa-solid fa-file-contract"></i> Contracts</button>
                <button id="nav-map" class="nav-btn" onclick="showAppPage('map-page')"><i class="fa-solid fa-map-location-dot"></i> GIS Map</button>
                <button id="nav-tables" class="nav-btn" onclick="showAppPage('tables-page')"><i class="fa-solid fa-table"></i> Data Tables</button>
                <button id="nav-ai" class="nav-btn" onclick="showAppPage('ai-page')"><i class="fa-solid fa-robot"></i> AI Analysis</button>
                <button id="nav-notifications" class="nav-btn" onclick="showAppPage('notifications-page')"><i class="fa-solid fa-bell"></i> Notifications</button>
                <button id="nav-admin" class="nav-btn" onclick="showAppPage('admin-page')" style="display: none;"><i class="fa-solid fa-user-shield"></i> Admin Panel</button>
            </aside>

            <main id="app-content-area">
                <div id="contracts-page" class="app-content active">
                    <div class="card">
                        <h2><i class="fa-solid fa-file-contract"></i> Contract Management</h2>
                        <p>Select a saved contract or add a new one.</p>
                        <button class="btn-success" onclick="showModal('contract-form-modal')"><i class="fa-solid fa-plus"></i> Add New Contract</button>
                    </div>
                    <div class="card">
                        <h3>Saved Contracts</h3>
                        <div id="saved-contracts-list">
                            <p>No contracts found. Add one to get started.</p>
                        </div>
                    </div>
                </div>
                <div id="map-page" class="app-content" style="display:none; height:100%;">
                    <div id="map-container"></div>
                </div>
                <div id="tables-page" class="app-content" style="display:none;">
                     <div class="card">
                        <h2><i class="fa-solid fa-table"></i> Bill of Quantities (BOQ)</h2>
                        <div style="display:flex; gap: 10px; margin-bottom: 20px;">
                             <button class="btn-success" onclick="addBoqRow()"><i class="fa-solid fa-plus"></i> Add Row</button>
                             <button class="btn" onclick="exportTableToCsv('boq-table.csv')"><i class="fa-solid fa-file-csv"></i> Export to Excel</button>
                             <button class="btn" onclick="exportTableToPdf()"><i class="fa-solid fa-file-pdf"></i> Export to PDF</button>
                        </div>
                        <div class="table-container" id="boq-table-container">
                             <table id="boq-table">
                                <thead>
                                    <tr>
                                        <th>BOQ Ref.</th>
                                        <th>Asset</th>
                                        <th>Description</th>
                                        <th>Dimensions (L x W x H)</th>
                                        <th>Unit</th>
                                        <th>Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="boq-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="ai-page" class="app-content" style="display:none;">
                    <div class="card">
                         <h2><i class="fa-solid fa-robot"></i> AI Road Defect Analysis</h2>
                         <p>Upload a road surface image to analyze for defects.</p>
                         <input type="file" id="ai-image-upload" accept="image/*">
                         <button class="btn-primary" onclick="handleAIAnalysis()"><i class="fa-solid fa-magnifying-glass"></i> Analyze with AI</button>
                    </div>
                    <div class="card" id="ai-results-card" style="display:none;">
                        <h3>Analysis Result</h3>
                        <div id="ai-spinner" style="display:none; text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p>Analyzing...</p></div>
                        <div id="ai-results-table" class="table-container"></div>
                    </div>
                    <div class="card" id="ai-prompt-card" style="display:none;">
                        <h3><i class="fa-solid fa-file-pen"></i> Edit AI Prompt (Admin)</h3>
                        <textarea id="ai-prompt-textarea"></textarea>
                        <button class="btn-success" onclick="saveAIPrompt()"><i class="fa-solid fa-save"></i> Save Prompt</button>
                    </div>
                </div>
                <div id="notifications-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-bell"></i> Notifications</h2>
                        <div class="table-container">
                            <table id="notifications-table">
                                <thead><tr><th>Date</th><th>Type</th><th>Message</th></tr></thead>
                                <tbody id="notifications-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="admin-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-user-shield"></i> Admin Panel - User Approval</h2>
                        <p>Review and manage new user registration requests.</p>
                         <div class="table-container">
                            <table id="admin-requests-table">
                                <thead><tr><th>Email</th><th>Date Requested</th><th>Actions</th></tr></thead>
                                <tbody id="admin-requests-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>


    <div id="signup-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideModal('signup-modal')">&times;</button>
            <h2>Create Your Account</h2>
            <p>After signing up, an administrator will need to approve your account before you can log in.</p>
            <form id="signup-form">
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" class="btn-primary" style="width:100%;">Sign Up</button>
                 <div id="signup-message" class="message" style="display:none;"></div>
            </form>
        </div>
    </div>

    <div id="contract-form-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideModal('contract-form-modal')">&times;</button>
            <h2>Add New Contract</h2>
            <form id="contract-form">
                <input type="text" id="contract-title" placeholder="Contract Title" required>
                <input type="text" id="contract-number" placeholder="Contract Number" required>
                <label>Start Date:</label>
                <input type="date" id="contract-start" required>
                <label>End Date:</label>
                <input type="date" id="contract-end" required>
                <label>BOQ Upload (.csv):</label>
                <input type="file" id="contract-boq" accept=".csv" required>
                <small>Note: This BOQ will be used in the Data Tables page.</small>
                <div style="display:flex; justify-content: space-between; align-items: center; margin-top:10px;">
                    <a href="#" onclick="downloadBoqTemplate()">Download BOQ Template</a>
                    <button type="submit" class="btn-success">Save Contract</button>
                </div>
            </form>
        </div>
    </div>

    <footer class="footer">
        <p><strong>Developed by Eng. Ahmet Nasan</strong> | Civil Engineer & Software Developer</p>
        <em>"Blending engineering precision with modern tech."</em>
    </footer>

<script>
// ======== SCRIPT START ========

// ======== 0. UTILS & HELPERS ========
const getEl = (id) => document.getElementById(id);
const show = (id) => getEl(id).style.display = 'flex';
const hide = (id) => getEl(id).style.display = 'none';

const showModal = (id) => getEl(id).classList.add('active');
const hideModal = (id) => getEl(id).classList.remove('active');

const showPage = (pageId) => {
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    getEl(pageId).classList.add('active');
};

const showAppPage = (pageId) => {
    document.querySelectorAll('.app-content').forEach(p => hide(p.id));
    getEl(pageId).style.display = 'block';

    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const navButtonId = pageId.replace('-page', '');
    getEl(`nav-${navButtonId}`).classList.add('active');

    // Special handler for map initialization
    if (pageId === 'map-page' && !window.mapInitialized) {
        initializeMap();
    }
};

const displayMessage = (elementId, text, type) => {
    const el = getEl(elementId);
    el.textContent = text;
    el.className = `message ${type}`;
    el.style.display = 'block';
    setTimeout(() => el.style.display = 'none', 5000);
};

const addNotification = (type, message) => {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    notifications.unshift({ date: new Date().toLocaleString(), type, message });
    localStorage.setItem('notifications', JSON.stringify(notifications));
    loadNotifications();
};

// ======== 1. DATABASE SIMULATION (localStorage) ========
const DB = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    set: (key, value) => localStorage.setItem(key, JSON.stringify(value)),
    init: () => {
        if (!localStorage.getItem('users')) {
            // Add a default admin user
            DB.set('users', [{ email: 'admin@demo.com', password: 'admin', is_admin: true, is_approved: true }]);
        }
        if (!localStorage.getItem('user_requests')) DB.set('user_requests', []);
        if (!localStorage.getItem('contracts')) DB.set('contracts', []);
        if (!localStorage.getItem('notifications')) DB.set('notifications', []);
        if (!localStorage.getItem('ai_prompt')) {
             localStorage.setItem('ai_prompt', `You are a civil engineering expert trained to analyze road surface images for pavement condition assessment. Examine the input image and identify all visible road surface defects. Use precise civil engineering terminology for each defect type. For every defect detected, provide the following details in tabular format:
1. Defect Type
2. Severity Level (Low/Med/High)
3. Location in image
4. Technical Description
5. Recommended Action
If no defects are found, return 'No visible defects detected'. Present result in structured table.`);
        }
    }
};

// ======== 2. AUTHENTICATION ========
const Auth = {
    currentUser: null,
    handleLogin: (e) => {
        e.preventDefault();
        const email = getEl('login-email').value;
        const password = getEl('login-password').value;
        const users = DB.get('users');

        const foundUser = users.find(u => u.email === email && u.password === password);

        if (foundUser) {
            if (foundUser.is_approved) {
                Auth.currentUser = foundUser;
                localStorage.setItem('currentUser', JSON.stringify(foundUser));
                showPage('app-container');
                initializeApp();
            } else {
                displayMessage('login-message', 'Your account is pending administrator approval.', 'pending');
            }
        } else {
            // Check if user is in requests
            const requests = DB.get('user_requests');
            if(requests.some(r => r.email === email)) {
                 displayMessage('login-message', 'Your account is pending administrator approval.', 'pending');
            } else {
                displayMessage('login-message', 'Invalid email or password.', 'error');
            }
        }
    },
    handleSignup: (e) => {
        e.preventDefault();
        const email = getEl('signup-email').value;
        const password = getEl('signup-password').value;
        const users = DB.get('users');
        const requests = DB.get('user_requests');

        if (users.some(u => u.email === email) || requests.some(r => r.email === email)) {
            displayMessage('signup-message', 'This email is already registered or pending approval.', 'error');
            return;
        }

        requests.push({ email, password, date: new Date().toISOString() });
        DB.set('user_requests', requests);
        displayMessage('signup-message', 'Sign up successful! An admin will approve your account shortly.', 'success');
        addNotification('New User', `New user request from ${email}.`);
        setTimeout(() => hideModal('signup-modal'), 2000);
    },
    signOut: () => {
        Auth.currentUser = null;
        localStorage.removeItem('currentUser');
        showPage('login-page');
        location.reload(); // To reset state
    },
    checkSession: () => {
        const user = localStorage.getItem('currentUser');
        if(user) {
            Auth.currentUser = JSON.parse(user);
            showPage('app-container');
            initializeApp();
        } else {
            showPage('login-page');
        }
    }
};

// ======== 3. APP INITIALIZATION ========
const initializeApp = () => {
    getEl('current-user-email').textContent = Auth.currentUser.email;
    if (Auth.currentUser.is_admin) {
        getEl('nav-admin').style.display = 'block';
        getEl('ai-prompt-card').style.display = 'block';
    }
    loadContracts();
    loadAdminRequests();
    loadNotifications();
    loadAIPrompt();
};

// ======== 4. CONTRACTS ========
const handleSaveContract = (e) => {
    e.preventDefault();
    const title = getEl('contract-title').value;
    const number = getEl('contract-number').value;
    const start = getEl('contract-start').value;
    const end = getEl('contract-end').value;
    const boqFile = getEl('contract-boq').files[0];

    if (!title || !number || !start || !end || !boqFile) {
        alert('Please fill all fields and upload a BOQ file.');
        return;
    }

    Papa.parse(boqFile, {
        header: true,
        complete: (results) => {
            const contracts = DB.get('contracts');
            const newContract = {
                id: `C${Date.now()}`,
                title, number, start, end,
                boq: results.data
            };
            contracts.push(newContract);
            DB.set('contracts', contracts);
            hideModal('contract-form-modal');
            loadContracts();
            addNotification('Contract', `New contract "${title}" added.`);
        },
        error: (err) => {
            alert('Error parsing CSV file: ' + err.message);
        }
    });
};

const loadContracts = () => {
    const contracts = DB.get('contracts');
    const container = getEl('saved-contracts-list');
    container.innerHTML = '';
    if (contracts.length === 0) {
        container.innerHTML = '<p>No contracts found. Add one to get started.</p>';
        return;
    }
    contracts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'contract-card';
        card.innerHTML = `
            <h3>${c.title}</h3>
            <p><strong>Ref:</strong> ${c.number}</p>
            <p><strong>Dates:</strong> ${c.start} to ${c.end}</p>
        `;
        card.onclick = () => openContract(c.id);
        container.appendChild(card);
    });
};

const openContract = (contractId) => {
    const contracts = DB.get('contracts');
    const contract = contracts.find(c => c.id === contractId);
    if (!contract) return;

    localStorage.setItem('activeContractId', contractId);
    getEl('app-main-title').textContent = contract.title;
    loadBoqTable(contract.boq);
    showAppPage('tables-page');
};

const downloadBoqTemplate = () => {
    const header = "BOQ Ref.,Asset,Description,Dimensions (L x W x H),Unit,Rate\n";
    const blob = new Blob([header], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", "BOQ_Template.csv");
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

// ======== 5. DATA TABLES (BOQ) ========
const loadBoqTable = (boqData) => {
    const tableBody = getEl('boq-table-body');
    tableBody.innerHTML = '';
    boqData.forEach((row, index) => {
        if(row['BOQ Ref.']) { // Check if row is not empty
            addBoqRow(row);
        }
    });
};

const addBoqRow = (rowData = {}) => {
    const tableBody = getEl('boq-table-body');
    const newRow = tableBody.insertRow();
    newRow.innerHTML = `
        <td contenteditable="true">${rowData['BOQ Ref.'] || ''}</td>
        <td contenteditable="true">${rowData['Asset'] || ''}</td>
        <td contenteditable="true">${rowData['Description'] || ''}</td>
        <td contenteditable="true" oninput="handleUnitInput(event)">${rowData['Dimensions (L x W x H)'] || ''}</td>
        <td>${rowData['Unit'] || ''}</td>
        <td contenteditable="true">${rowData['Rate'] || ''}</td>
        <td><button class="btn-danger" onclick="deleteRow(this)"><i class="fa-solid fa-trash"></i></button></td>
    `;
};

const deleteRow = (btn) => {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
};

const handleUnitInput = (event) => {
    const cell = event.target;
    const dimensions = cell.textContent.trim();
    const unitCell = cell.nextElementSibling;

    if (dimensions.includes('x')) {
        const parts = dimensions.split('x').map(p => parseFloat(p.trim())).filter(p => !isNaN(p));
        if (parts.length >= 2) {
            const area = parts.reduce((a, b) => a * b, 1);
            unitCell.textContent = parts.length === 2 ? `${area.toFixed(2)} m¬≤` : `${area.toFixed(2)} m¬≥`;
        }
    }
};

const exportTableToCsv = (filename) => {
    const table = getEl('boq-table');
    const rows = Array.from(table.querySelectorAll('tr'));
    const csvContent = rows.map(row => {
        const cells = Array.from(row.querySelectorAll('th, td'));
        return cells.slice(0, -1).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',');
    }).join('\n');

    const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement("a");
    const url = URL.createObjectURL(blob);
    link.setAttribute("href", url);
    link.setAttribute("download", filename);
    link.style.visibility = 'hidden';
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
};

const exportTableToPdf = () => {
    const element = getEl('boq-table-container');
    html2canvas(element).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF();
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 210;
        const pageHeight = 295;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        let heightLeft = imgHeight;

        let position = 0;
        pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
        heightLeft -= pageHeight;

        while (heightLeft >= 0) {
            position = heightLeft - imgHeight;
            pdf.addPage();
            pdf.addImage(imgData, 'PNG', 0, position, imgWidth, imgHeight);
            heightLeft -= pageHeight;
        }
        pdf.save('boq-table.pdf');
    });
};

// ======== 6. AI ANALYSIS ========
const handleAIAnalysis = () => {
    const fileInput = getEl('ai-image-upload');
    if (!fileInput.files[0]) {
        alert('Please select an image first.');
        return;
    }

    getEl('ai-results-card').style.display = 'block';
    getEl('ai-spinner').style.display = 'block';
    getEl('ai-results-table').innerHTML = '';

    // Simulate AI analysis with mock results
    setTimeout(() => {
        getEl('ai-spinner').style.display = 'none';
        const mockResults = [
            { defect: 'Pothole', severity: 'High', location: 'Center-left', description: 'Deep circular depression', action: 'Immediate repair required' },
            { defect: 'Cracking', severity: 'Medium', location: 'Right edge', description: 'Longitudinal cracks', action: 'Monitor and seal' }
        ];

        let tableHTML = '<table><thead><tr><th>Defect Type</th><th>Severity</th><th>Location</th><th>Description</th><th>Recommended Action</th></tr></thead><tbody>';
        mockResults.forEach(result => {
            tableHTML += `<tr><td>${result.defect}</td><td>${result.severity}</td><td>${result.location}</td><td>${result.description}</td><td>${result.action}</td></tr>`;
        });
        tableHTML += '</tbody></table>';
        getEl('ai-results-table').innerHTML = tableHTML;

        addNotification('AI Analysis', 'Road defect analysis completed.');
    }, 3000);
};

const loadAIPrompt = () => {
    const prompt = localStorage.getItem('ai_prompt') || '';
    getEl('ai-prompt-textarea').value = prompt;
};

const saveAIPrompt = () => {
    const prompt = getEl('ai-prompt-textarea').value;
    localStorage.setItem('ai_prompt', prompt);
    alert('AI prompt saved successfully!');
};

// ======== 7. ADMIN PANEL ========
const loadAdminRequests = () => {
    const requests = DB.get('user_requests');
    const tbody = getEl('admin-requests-body');
    tbody.innerHTML = '';

    requests.forEach((request, index) => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${request.email}</td>
            <td>${new Date(request.date).toLocaleDateString()}</td>
            <td>
                <button class="btn-success" onclick="approveUser(${index})"><i class="fa-solid fa-check"></i> Approve</button>
                <button class="btn-danger" onclick="rejectUser(${index})"><i class="fa-solid fa-times"></i> Reject</button>
            </td>
        `;
    });
};

const approveUser = (index) => {
    const requests = DB.get('user_requests');
    const users = DB.get('users');
    const request = requests[index];

    users.push({
        email: request.email,
        password: request.password,
        is_admin: false,
        is_approved: true
    });

    requests.splice(index, 1);
    DB.set('users', users);
    DB.set('user_requests', requests);

    loadAdminRequests();
    addNotification('User Approved', `User ${request.email} has been approved.`);
};

const rejectUser = (index) => {
    const requests = DB.get('user_requests');
    const request = requests[index];
    requests.splice(index, 1);
    DB.set('user_requests', requests);
    loadAdminRequests();
    addNotification('User Rejected', `User ${request.email} has been rejected.`);
};

// ======== 8. NOTIFICATIONS ========
const loadNotifications = () => {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const tbody = getEl('notifications-table-body');
    tbody.innerHTML = '';

    notifications.forEach(notification => {
        const row = tbody.insertRow();
        row.innerHTML = `
            <td>${notification.date}</td>
            <td>${notification.type}</td>
            <td>${notification.message}</td>
        `;
    });
};

// ======== 9. MAP INITIALIZATION ========
let map;
window.mapInitialized = false;

const initializeMap = () => {
    if (window.mapInitialized) return;

    map = L.map('map-container').setView([25.2048, 55.2708], 13);
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    map.pm.addControls({
        position: 'topleft',
        drawCircle: false,
    });

    window.mapInitialized = true;
    setTimeout(() => map.invalidateSize(), 100);
};

// ======== 10. LANGUAGE SWITCHING ========
const switchLanguage = (lang) => {
    if (lang === 'ar') {
        document.documentElement.setAttribute('dir', 'rtl');
        document.documentElement.setAttribute('lang', 'ar');
    } else {
        document.documentElement.setAttribute('dir', 'ltr');
        document.documentElement.setAttribute('lang', 'en');
    }
};

// ======== 11. EVENT LISTENERS ========
getEl('login-form').addEventListener('submit', Auth.handleLogin);
getEl('signup-form').addEventListener('submit', Auth.handleSignup);
getEl('contract-form').addEventListener('submit', handleSaveContract);

getEl('show-signup-link').addEventListener('click', (e) => {
    e.preventDefault();
    showModal('signup-modal');
});

// Global functions for HTML onclick handlers
window.showModal = showModal;
window.hideModal = hideModal;
window.showAppPage = showAppPage;
window.signOut = Auth.signOut;
window.switchLanguage = switchLanguage;
window.addBoqRow = addBoqRow;
window.deleteRow = deleteRow;
window.handleUnitInput = handleUnitInput;
window.exportTableToCsv = exportTableToCsv;
window.exportTableToPdf = exportTableToPdf;
window.downloadBoqTemplate = downloadBoqTemplate;
window.handleAIAnalysis = handleAIAnalysis;
window.saveAIPrompt = saveAIPrompt;
window.approveUser = approveUser;
window.rejectUser = rejectUser;

// ======== 12. INITIALIZATION ========
document.addEventListener('DOMContentLoaded', () => {
    DB.init();
    Auth.checkSession();
});

// ======== SCRIPT END ========
</script>
</body>
</html>
