<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script defer src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script defer src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff; 
            --background-color: #f0f4f8;
            --glass-bg: rgba(255, 255, 255, 0.7); 
            --glass-border: rgba(200, 210, 220, 0.5);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1); 
            --text-color: #2c3e50; 
            --border-radius: 12px;
            --success-color: #28a745;
            --danger-color: #dc3545;
        }

        /* Base & Bilingual Support */
        html[dir="rtl"] { font-family: 'Tahoma', sans-serif; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            margin: 0; 
            color: var(--text-color); 
            min-height: 100vh;
        }
        
        /* Page Visibility */
        .page { 
            display: none; 
            animation: fadeIn 0.5s; 
        }
        .page.active { 
            display: block; 
        }
        @keyframes fadeIn { 
            from { opacity: 0; transform: translateY(10px); } 
            to { opacity: 1; transform: translateY(0); } 
        }

        /* Layouts */
        .main-container { 
            max-width: 1800px; 
            margin: 0 auto; 
            padding: 20px; 
        }
        .centered-container { 
            display: flex; 
            flex-direction: column; 
            justify-content: center; 
            align-items: center; 
            min-height: 100vh; 
            padding: 20px; 
            box-sizing: border-box; 
        }

        /* Glass Card Style */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px); 
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 25px; 
            border-radius: var(--border-radius);
            box-shadow: var(--shadow); 
            margin-bottom: 20px;
        }
        html[dir="rtl"] .glass-card { 
            text-align: right; 
        }

        /* Forms & Buttons */
        .form-card { 
            max-width: 480px; 
            width: 100%; 
            position: relative; 
        }
        .form-card h1, .form-card p { 
            text-align: center; 
        }
        html[dir="rtl"] .form-card h1, html[dir="rtl"] .form-card p { 
            text-align: center; 
        }
        
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], input[type="file"] {
            width: 100%; 
            padding: 12px; 
            margin-bottom: 15px; 
            border: 1px solid #ccc; 
            border-radius: 8px; 
            box-sizing: border-box;
            font-size: 16px;
        }
        
        button {
            padding: 12px 20px; 
            border-radius: 8px; 
            border: none; 
            background-color: var(--primary-color);
            color: white; 
            font-size: 16px; 
            cursor: pointer; 
            transition: all 0.3s;
            font-weight: 500;
        }
        button:hover { 
            background-color: #0056b3; 
            transform: translateY(-2px);
        }
        button:disabled { 
            background-color: #aaa; 
            cursor: not-allowed; 
            transform: none;
        }
        
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #218838; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #c82333; }
        
        /* Header */
        .header { 
            display: flex; 
            justify-content: space-between; 
            align-items: center; 
            padding: 15px 20px; 
            margin-bottom: 20px; 
            flex-wrap: wrap;
        }
        .header h1 { 
            margin: 0; 
            font-size: 1.5em; 
            color: var(--primary-color);
        }
        .header-actions {
            display: flex;
            gap: 10px;
            align-items: center;
            flex-wrap: wrap;
        }
        
        /* Contract Selection */
        .contract-selection-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr)); 
            gap: 20px; 
            margin-top: 20px; 
        }
        .contract-select-card { 
            background: rgba(255, 255, 255, 0.9);
            padding: 25px; 
            border-radius: var(--border-radius); 
            text-align: center; 
            cursor: pointer; 
            transition: all 0.3s; 
            border: 2px solid transparent;
        }
        .contract-select-card:hover { 
            transform: translateY(-5px); 
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            border-color: var(--primary-color);
        }
        .contract-select-card h3 { 
            margin-top: 0; 
            color: var(--primary-color);
        }
        .contract-select-card p {
            margin: 10px 0;
            opacity: 0.8;
        }

        /* App Content */
        .app-page-content {
            min-height: 60vh;
        }
        
        /* Map Container */
        #map-container {
            height: 600px;
            width: 100%;
            border-radius: var(--border-radius);
            overflow: hidden;
            box-shadow: var(--shadow);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            margin: 20px 0;
        }
        table {
            width: 100%;
            border-collapse: collapse;
            background: white;
            border-radius: var(--border-radius);
            overflow: hidden;
        }
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #eee;
        }
        th {
            background-color: var(--primary-color);
            color: white;
            font-weight: 600;
        }
        tr:hover {
            background-color: #f8f9fa;
        }

        /* Popup Styles */
        .popup-overlay {
            position: fixed; 
            top: 0; 
            left: 0; 
            width: 100%; 
            height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none;
            justify-content: center; 
            align-items: center;
            z-index: 1000; 
            animation: fadeIn 0.3s;
        }
        .popup-close-btn {
            position: absolute; 
            top: 10px; 
            right: 20px; 
            font-size: 30px;
            color: #555; 
            cursor: pointer; 
            border: none; 
            background: none;
        }

        /* Error/Success Messages */
        .error-message {
            color: var(--danger-color);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }
        .success-message {
            color: var(--success-color);
            font-size: 14px;
            margin-top: 10px;
            text-align: center;
        }

        /* Links */
        .toggle-link {
            display: block;
            text-align: center;
            margin-top: 15px;
            color: var(--primary-color);
            text-decoration: none;
            font-size: 14px;
        }
        .toggle-link:hover {
            text-decoration: underline;
        }

        /* Footer */
        .footer { 
            text-align: center; 
            margin-top: 50px; 
            padding: 20px; 
            color: rgba(255, 255, 255, 0.8);
        }
        .footer em {
            font-style: italic;
            opacity: 0.7;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .header {
                flex-direction: column;
                gap: 15px;
            }
            .header-actions {
                justify-content: center;
            }
            .contract-selection-grid {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="page active centered-container">
        <div class="form-card glass-card">
            <h1 data-translate="welcome_title">Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è</h1>
            <p data-translate="welcome_subtitle">Smart tools for managing maps, data, inspections, and reports for engineers and managers.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_in">Sign In</button>
                <p class="error-message" id="login-error-message"></p>
                <a href="#" class="toggle-link" onclick="showPopup('signup-popup')" data-translate="need_account">Need an account? Sign Up</a>
            </form>
        </div>
    </div>

    <!-- Contract Selection Page -->
    <div id="contract-selection-page" class="page main-container">
        <div class="glass-card">
            <h1 data-translate="select_contract_title">Select a Contract</h1>
            <p data-translate="select_contract_subtitle">Choose a contract to access the project dashboard.</p>
            <div id="contract-selection-list" class="contract-selection-grid">
                <!-- Sample contracts will be loaded here -->
            </div>
        </div>
    </div>

    <!-- Main App Container -->
    <div id="app-container" class="page main-container">
        <div class="header glass-card">
            <h1 id="app-main-title">Project Dashboard</h1>
            <div class="header-actions">
                <button id="map-nav-btn" onclick="showAppPage('map-page-content')">üó∫Ô∏è Map</button>
                <button id="tables-nav-btn" onclick="showAppPage('tables-page-content')">üìä Tables</button>
                <button id="reports-nav-btn" onclick="showAppPage('reports-page-content')">üìÑ Reports</button>
                <button id="contracts-nav-btn" onclick="showAppPage('contracts-page-content')">üìã Contracts</button>
                <span style="border-left: 1px solid #ccc; height: 30px; margin: 0 10px;"></span>
                <select id="language-switcher" onchange="switchLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
                <button class="btn-danger" onclick="signOut()" data-translate="sign_out">Sign Out</button>
            </div>
        </div>
        
        <div id="app-content">
            <!-- Map Page -->
            <div id="map-page-content" class="app-page-content">
                <div class="glass-card">
                    <h2>üó∫Ô∏è Interactive Map</h2>
                    <div class="table-container">
                        <button class="btn-success" onclick="initializeMap()">Initialize Map</button>
                        <button onclick="exportMapToPDF()">üìÑ Export to PDF</button>
                        <button onclick="saveMapState()">üíæ Save Map</button>
                        <button onclick="loadMapState()">üìÇ Load Map</button>
                    </div>
                    <div id="map-container"></div>
                </div>
            </div>

            <!-- Tables Page -->
            <div id="tables-page-content" class="app-page-content" style="display: none;">
                <div class="glass-card">
                    <h2>üìä Data Tables</h2>
                    <div class="table-container">
                        <button class="btn-success" onclick="addTableRow()">‚ûï Add Row</button>
                        <button onclick="exportTableToPDF()">üìÑ Export to PDF</button>
                        <button onclick="exportTableToExcel()">üìä Export to Excel</button>
                        <button onclick="importFromCSV()">üì• Import CSV</button>
                    </div>
                    <div class="table-container">
                        <table id="main-table">
                            <thead>
                                <tr>
                                    <th>Item</th>
                                    <th>Description</th>
                                    <th>Quantity</th>
                                    <th>Unit</th>
                                    <th>Rate</th>
                                    <th>Total</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody id="table-body">
                                <tr>
                                    <td contenteditable="true">001</td>
                                    <td contenteditable="true">Sample Item</td>
                                    <td contenteditable="true">10</td>
                                    <td contenteditable="true">m¬≤</td>
                                    <td contenteditable="true">100</td>
                                    <td>1000</td>
                                    <td><button class="btn-danger" onclick="deleteRow(this)">‚ùå</button></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Reports Page -->
            <div id="reports-page-content" class="app-page-content" style="display: none;">
                <div class="glass-card">
                    <h2>üìÑ Reports Generation</h2>
                    <div class="table-container">
                        <button class="btn-success" onclick="generateReport()">üìã Generate Report</button>
                        <button onclick="exportReportToPDF()">üìÑ Export to PDF</button>
                        <button onclick="saveReport()">üíæ Save Report</button>
                    </div>
                    <div id="report-content">
                        <h3>Project Report</h3>
                        <p><strong>Date:</strong> <span id="report-date"></span></p>
                        <p><strong>Project:</strong> <span id="report-project"></span></p>
                        <div id="report-summary">
                            <h4>Summary</h4>
                            <p>This report contains the current status of the selected project including maps, tables, and analysis results.</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Contracts Page -->
            <div id="contracts-page-content" class="app-page-content" style="display: none;">
                <div class="glass-card">
                    <h2>üìã Contract Management</h2>
                    <div class="table-container">
                        <button class="btn-success" onclick="addNewContract()">‚ûï Add Contract</button>
                        <button onclick="downloadBOQTemplate()">üì• Download BOQ Template</button>
                    </div>
                    <div id="contracts-list">
                        <h3>Saved Contracts</h3>
                        <div class="contract-selection-grid" id="saved-contracts">
                            <!-- Saved contracts will be loaded here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Sign Up Popup -->
    <div id="signup-popup" class="popup-overlay">
        <div class="form-card glass-card">
            <button class="popup-close-btn" onclick="hidePopup('signup-popup')">&times;</button>
            <h1 data-translate="create_account">Create Your Account</h1>
            <form id="signup-form">
                <input type="text" id="signup-name" placeholder="Full Name" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_up">Sign Up</button>
                <p id="signup-message" class="error-message"></p>
                <a href="#" class="toggle-link" onclick="hidePopup('signup-popup')" data-translate="have_account">Already have an account? Sign In</a>
            </form>
        </div>
    </div>

    <!-- Contract Form Popup -->
    <div id="contract-form-popup" class="popup-overlay">
        <div class="form-card glass-card" style="max-width: 600px;">
            <button class="popup-close-btn" onclick="hidePopup('contract-form-popup')">&times;</button>
            <h1>Add New Contract</h1>
            <form id="contract-form">
                <input type="text" id="contract-title" placeholder="Contract Title" required>
                <input type="text" id="contract-number" placeholder="Contract Number" required>
                <input type="date" id="contract-start" required>
                <input type="date" id="contract-end" required>
                <input type="number" id="contract-value" placeholder="Project Value" required>
                <input type="text" id="contract-company" placeholder="Company Name" required>
                <input type="text" id="contract-client" placeholder="Client Name" required>
                <div>
                    <label>Upload BOQ (CSV):</label>
                    <input type="file" id="contract-boq" accept=".csv" />
                    <small>Note: This BOQ will be used in the Cost Estimation page.</small>
                </div>
                <button type="submit" class="btn-success">Save Contract</button>
            </form>
        </div>
    </div>
    
    <div class="footer">
        <p><strong>Developed by Eng. Ahmet Nasan</strong></p>
        <p>Civil Engineer & Software Developer</p>
        <em>"Blending engineering precision with modern tech."</em>
    </div>

    <script>
        // --- GLOBAL STATE ---
        let currentUser = null;
        let selectedContract = null;
        let mapInstance = null;
        let tableData = [];
        let contractsData = [];

        // --- BILINGUAL DICTIONARY ---
        const translations = {
            en: {
                welcome_title: "Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è",
                welcome_subtitle: "Smart tools for managing maps, data, inspections, and reports for engineers and managers.",
                sign_in: "Sign In",
                need_account: "Need an account? Sign Up",
                create_account: "Create Your Account",
                sign_up: "Sign Up",
                have_account: "Already have an account? Sign In",
                sign_out: "Sign Out",
                select_contract_title: "Select a Contract",
                select_contract_subtitle: "Choose a contract to access the project dashboard."
            },
            ar: {
                welcome_title: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ ŸÅŸä ŸÖŸÜÿµÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸáŸÜÿØÿ≥Ÿäÿ© üë∑‚Äç‚ôÇÔ∏è",
                welcome_subtitle: "ÿ£ÿØŸàÿßÿ™ ÿ∞ŸÉŸäÿ© ŸÑÿ•ÿØÿßÿ±ÿ© ÿßŸÑÿÆÿ±ÿßÿ¶ÿ∑ ŸàÿßŸÑÿ®ŸäÿßŸÜÿßÿ™ ŸàÿßŸÑÿ™ŸÅÿ™Ÿäÿ¥ ŸàÿßŸÑÿ™ŸÇÿßÿ±Ÿäÿ± ŸÑŸÑŸÖŸáŸÜÿØÿ≥ŸäŸÜ ŸàÿßŸÑŸÖÿØŸäÿ±ŸäŸÜ.",
                sign_in: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                need_account: "ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ≠ÿ≥ÿßÿ®ÿü ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                create_account: "ÿ£ŸÜÿ¥ÿ¶ ÿ≠ÿ≥ÿßÿ®ŸÉ",
                sign_up: "ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                have_account: "ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                sign_out: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                select_contract_title: "ÿßÿÆÿ™ÿ± ÿπŸÇÿØŸãÿß",
                select_contract_subtitle: "ÿßÿÆÿ™ÿ± ÿπŸÇÿØŸãÿß ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ."
            }
        };

        // --- SAMPLE DATA ---
        const sampleContracts = [
            {
                id: 1,
                title: "Highway Construction Project",
                number: "HC-2024-001",
                startDate: "2024-01-15",
                endDate: "2024-12-31",
                value: 5000000,
                company: "ABC Engineering",
                client: "Ministry of Transport"
            },
            {
                id: 2,
                title: "Bridge Renovation Project",
                number: "BR-2024-002",
                startDate: "2024-03-01",
                endDate: "2024-08-30",
                value: 2500000,
                company: "XYZ Construction",
                client: "City Council"
            },
            {
                id: 3,
                title: "Water Treatment Plant",
                number: "WTP-2024-003",
                startDate: "2024-02-01",
                endDate: "2024-11-30",
                value: 8000000,
                company: "Water Solutions Ltd",
                client: "Water Authority"
            }
        ];

        // --- UTILITY FUNCTIONS ---
        function showPopup(popupId) {
            const popup = document.getElementById(popupId);
            if(popup) popup.style.display = 'flex';
        }

        function hidePopup(popupId) {
            const popup = document.getElementById(popupId);
            if(popup) popup.style.display = 'none';
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');
        }

        function showAppPage(pageId) {
            document.querySelectorAll('.app-page-content').forEach(p => p.style.display = 'none');
            const page = document.getElementById(pageId);
            if (page) page.style.display = 'block';
        }

        function switchLanguage(lang) {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                if (translations[lang] && translations[lang][key]) {
                    el.innerText = translations[lang][key];
                }
            });
        }

        function signOut() {
            currentUser = null;
            selectedContract = null;
            showPage('login-page');
        }

        // --- AUTH FUNCTIONS ---
        function handleLogin(email, password) {
            // Simulate login - replace with actual authentication
            if (email && password) {
                currentUser = { email: email, name: email.split('@')[0] };
                showPage('contract-selection-page');
                loadContractsForSelection();
                document.getElementById('login-error-message').innerText = '';
                return true;
            }
            return false;
        }

        function handleSignup(name, email, password) {
            // Simulate signup - replace with actual registration
            if (name && email && password) {
                const messageEl = document.getElementById('signup-message');
                messageEl.innerText = 'Account created successfully! Please sign in.';
                messageEl.className = 'success-message';
                setTimeout(() => {
                    hidePopup('signup-popup');
                    messageEl.innerText = '';
                    messageEl.className = 'error-message';
                }, 2000);
                return true;
            }
            return false;
        }

        // --- CONTRACT FUNCTIONS ---
        function loadContractsForSelection() {
            const listContainer = document.getElementById('contract-selection-list');
            listContainer.innerHTML = '';

            sampleContracts.forEach(contract => {
                const card = document.createElement('div');
                card.className = 'contract-select-card';
                card.innerHTML = `
                    <h3>${contract.title}</h3>
                    <p><strong>Contract #:</strong> ${contract.number}</p>
                    <p><strong>Value:</strong> $${contract.value.toLocaleString()}</p>
                    <p><strong>Client:</strong> ${contract.client}</p>
                    <p><strong>Duration:</strong> ${contract.startDate} to ${contract.endDate}</p>
                `;
                card.onclick = () => selectContract(contract);
                listContainer.appendChild(card);
            });
        }

        function selectContract(contract) {
            selectedContract = contract;
            document.getElementById('app-main-title').innerText = `${contract.title}`;
            showPage('app-container');
            showAppPage('map-page-content');
            loadSavedContracts();
        }

        function loadSavedContracts() {
            const savedContracts = JSON.parse(localStorage.getItem('savedContracts') || '[]');
            contractsData = [...sampleContracts, ...savedContracts];
            
            const container = document.getElementById('saved-contracts');
            container.innerHTML = '';
            
            contractsData.forEach(contract => {
                const card = document.createElement('div');
                card.className = 'contract-select-card';
                card.innerHTML = `
                    <h3>${contract.title}</h3>
                    <p><strong>Contract #:</strong> ${contract.number}</p>
                    <p><strong>Value:</strong> $${contract.value.toLocaleString()}</p>
                    <div style="margin-top: 15px;">
                        <button class="btn-success" onclick="editContract(${contract.id})">Edit</button>
                        <button class="btn-danger" onclick="deleteContract(${contract.id})">Delete</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function addNewContract() {
            showPopup('contract-form-popup');
        }

        function saveContract(contractData) {
            const savedContracts = JSON.parse(localStorage.getItem('savedContracts') || '[]');
            contractData.id = Date.now();
            savedContracts.push(contractData);
            localStorage.setItem('savedContracts', JSON.stringify(savedContracts));
            loadSavedContracts();
            hidePopup('contract-form-popup');
        }

        function editContract(id) {
            alert('Edit functionality will be implemented');
        }

        function deleteContract(id) {
            if (confirm('Are you sure you want to delete this contract?')) {
                const savedContracts = JSON.parse(localStorage.getItem('savedContracts') || '[]');
                const filtered = savedContracts.filter(c => c.id !== id);
                localStorage.setItem('savedContracts', JSON.stringify(filtered));
                loadSavedContracts();
            }
        }

        function downloadBOQTemplate() {
            const csvContent = "BOQ Ref.,Asset,Description,Unit,Rate\n001,Foundation,Concrete Foundation,m¬≥,150\n002,Walls,Brick Walls,m¬≤,45\n003,Roofing,Metal Roofing,m¬≤,75";
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'BOQ_Template.csv';
            a.click();
            window.URL.revokeObjectURL(url);
        }

        // --- MAP FUNCTIONS ---
        function initializeMap() {
            if (mapInstance) {
                mapInstance.remove();
            }
            
            const mapContainer = document.getElementById('map-container');
            mapInstance = L.map(mapContainer).setView([25.2854, 51.5310], 10); // Doha coordinates
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(mapInstance);
            
            // Add drawing controls
            mapInstance.pm.addControls({
                position: 'topleft',
                drawCircle: true,
                drawMarker
