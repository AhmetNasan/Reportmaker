<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>
   
    <style>
        /* ===================================
           ENHANCED STYLES FOR ENGINEERING PLATFORM
           =================================== */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --success-color: #27ae60;
            --warning-color: #f39c12;
            --error-color: #e74c3c;
            --info-color: #3498db;
            
            --text-primary: #2c3e50;
            --text-secondary: #7f8c8d;
            --text-muted: #bdc3c7;
            
            --bg-primary: #ffffff;
            --bg-secondary: #f8f9fa;
            --bg-card: #ffffff;
            --bg-overlay: rgba(255, 255, 255, 0.95);
            
            --border-color: #e1e8ed;
            --shadow-light: 0 2px 10px rgba(0, 0, 0, 0.1);
            --shadow-medium: 0 4px 20px rgba(0, 0, 0, 0.15);
            --shadow-heavy: 0 8px 30px rgba(0, 0, 0, 0.2);
            
            --border-radius: 12px;
            --transition: all 0.3s ease;
        }

        /* Dark Theme */
        .theme-dark {
            --text-primary: #ecf0f1;
            --text-secondary: #bdc3c7;
            --text-muted: #7f8c8d;
            
            --bg-primary: #2c3e50;
            --bg-secondary: #34495e;
            --bg-card: #34495e;
            --bg-overlay: rgba(52, 73, 94, 0.95);
            
            --border-color: #4a5f7a;
        }

        /* Font Sizes */
        .font-size-small { font-size: 0.9rem; }
        .font-size-medium { font-size: 1rem; }
        .font-size-large { font-size: 1.1rem; }

        /* High Contrast Mode */
        .high-contrast {
            --text-primary: #000000;
            --bg-primary: #ffffff;
            --border-color: #000000;
        }

        /* ===================================
           FLOATING UI COMPONENTS
           =================================== */

        .floating-cards-container {
            position: absolute;
            top: 0;
            right: 0;
            z-index: 1000;
            pointer-events: none;
        }

        .floating-card {
            position: absolute;
            right: 20px;
            background: var(--bg-overlay);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-medium);
            min-width: 280px;
            max-width: 320px;
            pointer-events: auto;
            transition: var(--transition);
        }

        .floating-card .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid var(--border-color);
            background: rgba(102, 126, 234, 0.1);
            border-radius: var(--border-radius) var(--border-radius) 0 0;
        }

        .floating-card .card-header h6 {
            margin: 0;
            color: var(--text-primary);
            font-weight: 600;
        }

        .floating-card .card-toggle {
            background: none;
            border: none;
            font-size: 18px;
            cursor: pointer;
            color: var(--text-secondary);
            transition: var(--transition);
        }

        .floating-card .card-toggle:hover {
            color: var(--primary-color);
            transform: scale(1.1);
        }

        .floating-card .card-content {
            padding: 16px;
            max-height: 400px;
            overflow-y: auto;
        }

        /* Position floating cards */
        #info-display-card { top: 20px; }
        #data-entry-card { top: 200px; }
        #qnas-metadata-card { top: 380px; }
        #overlays-card { top: 560px; }

        /* Hamburger Menu */
        .map-hamburger {
            position: absolute;
            top: 20px;
            right: 20px;
            z-index: 1001;
        }

        .hamburger-btn {
            background: var(--bg-overlay);
            backdrop-filter: blur(8px);
            border: 1px solid var(--border-color);
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .hamburger-btn:hover {
            background: var(--primary-color);
            color: white;
            transform: scale(1.05);
        }

        /* ===================================
           CHAT SYSTEM STYLES
           =================================== */

        .chat-panel {
            position: fixed;
            right: -400px;
            top: 80px;
            width: 400px;
            height: calc(100vh - 100px);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius) 0 0 var(--border-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1200;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .chat-panel.active {
            right: 0;
        }

        .chat-panel.minimized {
            height: 60px;
        }

        .chat-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .chat-conversations {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .conversation-list {
            width: 120px;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .conversation-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            cursor: pointer;
            transition: var(--transition);
        }

        .conversation-item:hover {
            background: var(--bg-overlay);
        }

        .conversation-item.active {
            background: var(--primary-color);
            color: white;
        }

        .chat-messages {
            flex: 1;
            display: flex;
            flex-direction: column;
        }

        .messages-container {
            flex: 1;
            overflow-y: auto;
            padding: 16px;
        }

        .message {
            margin-bottom: 16px;
            max-width: 80%;
        }

        .message.sent {
            margin-left: auto;
            text-align: right;
        }

        .message.sent .message-content {
            background: var(--primary-color);
            color: white;
        }

        .message.received .message-content {
            background: var(--bg-secondary);
            color: var(--text-primary);
        }

        .message-content {
            padding: 12px 16px;
            border-radius: var(--border-radius);
            word-wrap: break-word;
        }

        .message-meta {
            font-size: 0.8rem;
            color: var(--text-muted);
            margin-top: 4px;
        }

        .chat-input {
            padding: 16px;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-attachments {
            display: flex;
            gap: 8px;
            margin-top: 8px;
        }

        .file-message, .photo-message, .location-message {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 8px;
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
        }

        .photo-message img {
            max-width: 200px;
            max-height: 150px;
            border-radius: 8px;
            cursor: pointer;
        }

        /* ===================================
           FILE MANAGER STYLES
           =================================== */

        .file-manager-panel {
            position: fixed;
            left: -500px;
            top: 80px;
            width: 500px;
            height: calc(100vh - 100px);
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: 0 var(--border-radius) var(--border-radius) 0;
            box-shadow: var(--shadow-heavy);
            z-index: 1200;
            transition: var(--transition);
            display: flex;
            flex-direction: column;
        }

        .file-manager-panel.active {
            left: 0;
        }

        .file-manager-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .file-explorer {
            flex: 1;
            display: flex;
            overflow: hidden;
        }

        .folder-tree {
            width: 200px;
            border-right: 1px solid var(--border-color);
            background: var(--bg-secondary);
            padding: 16px;
        }

        .folder-item {
            margin-bottom: 8px;
        }

        .folder-header {
            padding: 8px;
            cursor: pointer;
            border-radius: 6px;
            transition: var(--transition);
        }

        .folder-header:hover {
            background: var(--bg-overlay);
        }

        .file-listing {
            flex: 1;
            padding: 16px;
        }

        .file-controls {
            display: flex;
            gap: 12px;
            margin-bottom: 16px;
        }

        .file-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .file-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 8px;
            transition: var(--transition);
        }

        .file-item:hover {
            background: var(--bg-secondary);
            transform: translateY(-2px);
            box-shadow: var(--shadow-light);
        }

        .file-info {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .file-actions {
            display: flex;
            gap: 8px;
        }

        /* ===================================
           VEHICLE TRACKING STYLES
           =================================== */

        .tracking-dashboard {
            display: grid;
            grid-template-columns: 300px 1fr;
            gap: 20px;
            height: 600px;
        }

        .vehicle-list {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            overflow-y: auto;
        }

        .tracking-map-container {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        #tracking-map {
            width: 100%;
            height: 100%;
        }

        .status-indicator {
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 600;
            text-transform: uppercase;
        }

        .status-indicator.online {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        /* ===================================
           MODAL STYLES
           =================================== */

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.6);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 2000;
            animation: fadeIn 0.3s ease;
        }

        .modal-content {
            background: var(--bg-card);
            border-radius: var(--border-radius);
            padding: 24px;
            max-width: 90vw;
            max-height: 90vh;
            overflow-y: auto;
            box-shadow: var(--shadow-heavy);
            animation: slideUp 0.3s ease;
        }

        .dashboard-modal {
            width: 90vw;
            height: 80vh;
        }

        .modal-actions {
            display: flex;
            gap: 12px;
            justify-content: flex-end;
            margin-top: 24px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        @keyframes slideUp {
            from { transform: translateY(30px); opacity: 0; }
            to { transform: translateY(0); opacity: 1; }
        }

        /* ===================================
           DASHBOARD BUILDER STYLES
           =================================== */

        .dashboard-builder-interface {
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 20px;
            height: 60vh;
        }

        .widget-palette {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .widget-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .widget-item {
            padding: 12px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            cursor: grab;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .widget-item:hover {
            background: var(--primary-color);
            color: white;
            transform: translateY(-2px);
        }

        .widget-item:active {
            cursor: grabbing;
        }

        .dashboard-canvas {
            background: var(--bg-secondary);
            border-radius: var(--border-radius);
            padding: 16px;
        }

        .drop-zone {
            border: 2px dashed var(--border-color);
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            color: var(--text-muted);
            min-height: 400px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .drop-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .dashboard-widget {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            margin-bottom: 16px;
            overflow: hidden;
        }

        .widget-header {
            padding: 12px 16px;
            background: var(--bg-secondary);
            border-bottom: 1px solid var(--border-color);
            font-weight: 600;
        }

        .widget-content {
            padding: 16px;
        }

        /* ===================================
           NOTIFICATION STYLES
           =================================== */

        .notification-center {
            position: fixed;
            top: 80px;
            right: 20px;
            width: 350px;
            max-height: 500px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-heavy);
            z-index: 1100;
            overflow: hidden;
            transform: translateX(100%);
            transition: var(--transition);
        }

        .notification-center.active {
            transform: translateX(0);
        }

        .notification-header {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notification-list {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification {
            padding: 16px;
            border-bottom: 1px solid var(--border-color);
            display: flex;
            align-items: start;
            gap: 12px;
            transition: var(--transition);
        }

        .notification:hover {
            background: var(--bg-secondary);
        }

        .notification.unread {
            background: rgba(102, 126, 234, 0.1);
            border-left: 4px solid var(--primary-color);
        }

        .notification-close {
            background: none;
            border: none;
            color: var(--text-muted);
            cursor: pointer;
            padding: 4px;
            border-radius: 4px;
            transition: var(--transition);
        }

        .notification-close:hover {
            background: var(--bg-secondary);
            color: var(--error-color);
        }

        /* ===================================
           MOBILE RESPONSIVE STYLES
           =================================== */

        .mobile-nav-toggle {
            position: fixed;
            top: 20px;
            left: 20px;
            z-index: 1300;
        }

        @media (max-width: 768px) {
            .main-container {
                padding-left: 0;
            }
            
            .sidebar {
                position: fixed;
                left: -280px;
                top: 0;
                height: 100vh;
                z-index: 1250;
                transition: var(--transition);
            }
            
            .sidebar.mobile-open {
                left: 0;
            }
            
            .floating-cards-container {
                position: relative;
                right: auto;
                top: auto;
            }
            
            .floating-card {
                position: relative;
                right: auto;
                margin-bottom: 16px;
                width: 100%;
                max-width: none;
            }
            
            .chat-panel {
                width: 100vw;
                right: -100vw;
                top: 0;
                height: 100vh;
                border-radius: 0;
            }
            
            .file-manager-panel {
                width: 100vw;
                left: -100vw;
                top: 0;
                height: 100vh;
                border-radius: 0;
            }
            
            .tracking-dashboard {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .dashboard-builder-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .modal-content {
                margin: 20px;
                max-width: calc(100vw - 40px);
            }
        }

        /* Touch-friendly interactions */
        .mobile-device .btn,
        .mobile-device .nav-btn,
        .mobile-device .card {
            min-height: 44px;
            padding: 12px 16px;
        }

        .touch-active {
            transform: scale(0.95);
            opacity: 0.8;
        }

        /* ===================================
           LOADING AND ANIMATION STYLES
           =================================== */

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 3000;
        }

        .loading-spinner {
            text-align: center;
            color: white;
        }

        .loading-spinner i {
            font-size: 3rem;
            margin-bottom: 16px;
            display: block;
        }

        /* Drag and drop styles */
        .drag-over {
            border-color: var(--primary-color) !important;
            background: rgba(102, 126, 234, 0.1) !important;
        }

        /* Activity feed styles */
        .activity-feed {
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            border-radius: var(--border-radius);
            padding: 16px;
            margin-bottom: 20px;
        }

        .activity-item {
            padding: 12px;
            border-bottom: 1px solid var(--border-color);
            transition: var(--transition);
        }

        .activity-item:hover {
            background: var(--bg-secondary);
        }

        .activity-item:last-child {
            border-bottom: none;
        }

        /* Settings tabs */
        .settings-tabs {
            display: flex;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 24px;
        }

        .settings-tab {
            padding: 12px 24px;
            background: none;
            border: none;
            border-bottom: 2px solid transparent;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-secondary);
        }

        .settings-tab:hover {
            color: var(--text-primary);
            background: var(--bg-secondary);
        }

        .settings-tab.active {
            color: var(--primary-color);
            border-bottom-color: var(--primary-color);
        }

        .settings-panel {
            display: none;
        }

        .settings-panel.active {
            display: block;
        }

        /* Theme selector */
        .theme-options {
            display: flex;
            gap: 16px;
            margin-bottom: 16px;
        }

        .theme-option {
            text-align: center;
            cursor: pointer;
            padding: 16px;
            border: 2px solid var(--border-color);
            border-radius: var(--border-radius);
            transition: var(--transition);
        }

        .theme-option:hover {
            border-color: var(--primary-color);
        }

        .theme-option.selected {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .theme-preview {
            width: 60px;
            height: 40px;
            border-radius: 6px;
            margin-bottom: 8px;
        }

        .light-theme { background: linear-gradient(45deg, #ffffff, #f8f9fa); }
        .dark-theme { background: linear-gradient(45deg, #2c3e50, #34495e); }
        .custom-theme { background: linear-gradient(45deg, #667eea, #764ba2); }

        /* Export buttons */
        .export-buttons {
            display: flex;
            gap: 8px;
            margin-top: 16px;
        }

        .export-buttons .btn {
            flex: 1;
            font-size: 0.85rem;
        }

        /* Utility classes */
        .text-center { text-align: center; }
        .text-left { text-align: left; }
        .text-right { text-align: right; }

        .mt-2 { margin-top: 8px; }
        .mt-3 { margin-top: 16px; }
        .mt-4 { margin-top: 24px; }

        .mb-2 { margin-bottom: 8px; }
        .mb-3 { margin-bottom: 16px; }
        .mb-4 { margin-bottom: 24px; }

        .w-100 { width: 100%; }

        .d-flex { display: flex; }
        .justify-content-between { justify-content: space-between; }
        .align-items-center { align-items: center; }

        /* Print styles */
        @media print {
            .no-print,
            .sidebar,
            .header,
            .floating-cards-container,
            .chat-panel,
            .file-manager-panel,
            .mobile-nav-toggle {
                display: none !important;
            }
            
            .main-content {
                margin: 0;
                width: 100%;
            }
            
            .page {
                break-inside: avoid;
            }
        }

        /* Enhanced focus styles for accessibility */
        button:focus,
        input:focus,
        select:focus,
        textarea:focus {
            outline: 2px solid var(--primary-color);
            outline-offset: 2px;
        }

        /* High contrast focus styles */
        .high-contrast button:focus,
        .high-contrast input:focus,
        .high-contrast select:focus,
        .high-contrast textarea:focus {
            outline: 3px solid #000000;
        }

        /* Smooth scrolling */
        html {
            scroll-behavior: smooth;
        }

        /* Custom scrollbar */
        ::-webkit-scrollbar {
            width: 8px;
        }

        ::-webkit-scrollbar-track {
            background: var(--bg-secondary);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border-color);
            border-radius: 4px;
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--text-muted);
        }
       
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/marzipano@6.1.1/dist/marzipano.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/v2.15.0/mapbox-gl.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
<script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
<script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    </style>
</head>
<body>
    <header class="header">
        <h1><i class="fas fa-building"></i> <span id="app-title" contenteditable="true" onclick="this.focus()">Engineering Project Platform</span></h1>
        <div class="header-actions">
            <div class="user-profile">
                <span id="user-name">Loading...</span>
                <button class="btn btn-outline-light btn-sm" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i> Logout
                </button>
            </div>
            <div class="dropdown">
                <button class="btn btn-secondary menu-button" id="global-menu-btn">
                    <i class="fas fa-ellipsis-v"></i>
                </button>
                <div class="dropdown-menu" id="global-menu">
                    <button onclick="changeLanguage()">
                        <i class="fas fa-globe"></i> Language Selection
                    </button>
                    <button onclick="newProject()">
                        <i class="fas fa-file"></i> New File
                    </button>
                    <button onclick="saveProject()">
                        <i class="fas fa-save"></i> Save Project
                    </button>
                    <button onclick="exportJSON()">
                        <i class="fas fa-download"></i> Export JSON
                    </button>
                    <button onclick="importJSON()">
                        <i class="fas fa-upload"></i> Import JSON
                    </button>
                    <button onclick="importHTML()">
                        <i class="fas fa-file-import"></i> Import HTML
                    </button>
                    <button onclick="exportHTML()">
                        <i class="fas fa-file-export"></i> Export HTML
                    </button>
                    <button onclick="openBackupManager()">
                        <i class="fas fa-cloud"></i> Backup & Sync
                    </button>
                </div>
            </div>
        </div>
    </header>

    <div class="project-name-bar">
        <strong id="current-project-name">New Project</strong>
        <div class="project-actions">
            <button class="btn btn-sm btn-outline-primary" onclick="openFileManager()">
                <i class="fas fa-folder"></i> Files
            </button>
            <button class="btn btn-sm btn-outline-success" onclick="openChatPanel()">
                <i class="fas fa-comments"></i> Chat
            </button>
        </div>
    </div>

    <div class="mobile-nav-toggle d-lg-none">
        <button class="btn btn-primary" onclick="toggleMobileNav()">
            <i class="fas fa-bars"></i>
        </button>
    </div>

    <div class="main-container">
        <div id="dashboard-page" class="page active">
            <div class="app-grid">
                <aside class="sidebar" id="main-sidebar">
                    <nav>
                        <button class="nav-btn active" onclick="showPage('dashboard-page')">
                            <i class="fas fa-home"></i> Dashboard
                        </button>
                        <button class="nav-btn" onclick="showPage('contracts-page')">
                            <i class="fas fa-file-contract"></i> Contracts & BOQ
                        </button>
                        <button class="nav-btn" onclick="showPage('inspection-page')">
                            <i class="fas fa-clipboard-check"></i> Inspection Reports
                        </button>
                        <button class="nav-btn" onclick="showPage('cost-estimation-page')">
                            <i class="fas fa-calculator"></i> Cost Estimation
                        </button>
                        <button class="nav-btn" onclick="showPage('mapping-page')">
                            <i class="fas fa-map"></i> GIS Mapping
                        </button>
                        <button class="nav-btn" onclick="showPage('ai-detection-page')">
                            <i class="fas fa-brain"></i> AI Detection
                        </button>
                        <button class="nav-btn" onclick="showPage('notebooks-page')">
                            <i class="fas fa-book"></i> Notebooks
                        </button>
                        <button class="nav-btn" onclick="showPage('drawing-page')">
                            <i class="fas fa-draw-polygon"></i> CAD Editor
                        </button>
                        <button class="nav-btn" onclick="showPage('tracking-page')">
                            <i class="fas fa-route"></i> Vehicle Tracking
                        </button>
                        <button class="nav-btn" onclick="showPage('timeline-page')">
                            <i class="fas fa-calendar-alt"></i> Project Timeline
                        </button>
                        <button class="nav-btn" onclick="showPage('logistics-page')">
                            <i class="fas fa-boxes"></i> Material Logistics
                        </button>
                        <button class="nav-btn" onclick="showPage('fabrication-page')">
                            <i class="fas fa-tools"></i> Sign Fabrication
                        </button>
                        <button class="nav-btn" onclick="showPage('custom-reports-page')">
                            <i class="fas fa-file-alt"></i> Custom Reports
                        </button>
                        <button class="nav-btn" onclick="showPage('settings-page')">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </nav>
                </aside>

                <main class="main-content">
                    <div class="dashboard-header">
                        <h2>Platform Overview</h2>
                        <div class="dashboard-actions">
                            <button class="btn btn-primary" onclick="openCustomDashboard()">
                                <i class="fas fa-chart-line"></i> Custom Dashboard
                            </button>
                            <button class="btn btn-success" onclick="generatePlatformReport()">
                                <i class="fas fa-file-pdf"></i> Generate Report
                            </button>
                        </div>
                    </div>
                    
                    <div class="dashboard-stats">
                        <div class="stat-card">
                            <div class="stat-number" id="total-projects">0</div>
                            <div class="stat-label">Active Projects</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-locations">0</div>
                            <div class="stat-label">Mapped Locations</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-reports">0</div>
                            <div class="stat-label">Generated Reports</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-number" id="total-files">0</div>
                            <div class="stat-label">Stored Files</div>
                        </div>
                    </div>
                    
                    <div class="activity-feed">
                        <h5>Recent Activity</h5>
                        <div id="activity-list">
                            </div>
                    </div>
                    
                    <canvas id="dashboard-chart" width="400" height="200"></canvas>
                </main>
            </div>
        </div>

        <div id="tracking-page" class="page">
            <div class="app-grid">
                <aside class="sidebar">
                    <nav>
                        <button class="nav-btn" onclick="showPage('dashboard-page')">
                            <i class="fas fa-home"></i> Dashboard
                        </button>
                        <button class="nav-btn active" onclick="showPage('tracking-page')">
                            <i class="fas fa-route"></i> Vehicle Tracking
                        </button>
                        </nav>
                    
                    <div class="tracking-controls mt-4">
                        <h6>Vehicle Controls</h6>
                        <button class="btn btn-sm btn-primary mb-2 w-100" onclick="startTracking()">
                            <i class="fas fa-play"></i> Start Tracking
                        </button>
                        <button class="btn btn-sm btn-danger mb-2 w-100" onclick="stopTracking()">
                            <i class="fas fa-stop"></i> Stop Tracking
                        </button>
                        <button class="btn btn-sm btn-info mb-2 w-100" onclick="viewHistory()">
                            <i class="fas fa-history"></i> View History
                        </button>
                        <button class="btn btn-sm btn-warning mb-2 w-100" onclick="setGeofence()">
                            <i class="fas fa-map-marked"></i> Set Geofence
                        </button>
                    </div>
                </aside>

                <main class="main-content">
                    <div class="tracking-header">
                        <h2>Live Vehicle Tracking</h2>
                        <div class="tracking-status">
                            <span id="tracking-status" class="status-indicator offline">Offline</span>
                        </div>
                    </div>
                    
                    <div class="tracking-dashboard">
                        <div class="vehicle-list">
                            <h5>Active Vehicles</h5>
                            <div id="vehicle-list">
                                </div>
                        </div>
                        
                        <div class="tracking-map-container">
                            <div id="tracking-map"></div>
                        </div>
                    </div>
                </main>
            </div>
        </div>

        <div id="chat-panel" class="chat-panel">
            <div class="chat-header">
                <h5><i class="fas fa-comments"></i> Team Chat</h5>
                <div class="chat-actions">
                    <button class="btn btn-sm btn-outline-light" onclick="minimizeChatPanel()">
                        <i class="fas fa-minus"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closeChatPanel()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="chat-conversations">
                <div class="conversation-list">
                    <h6>Conversations</h6>
                    <div id="conversation-list">
                        </div>
                    <button class="btn btn-sm btn-primary w-100 mt-2" onclick="startNewConversation()">
                        <i class="fas fa-plus"></i> New Chat
                    </button>
                </div>
                
                <div class="chat-messages">
                    <div id="chat-messages" class="messages-container">
                        </div>
                    
                    <div class="chat-input">
                        <div class="input-group">
                            <input type="text" id="chat-message-input" class="form-control" placeholder="Type a message...">
                            <button class="btn btn-primary" onclick="sendMessage()">
                                <i class="fas fa-paper-plane"></i>
                            </button>
                        </div>
                        <div class="chat-attachments">
                            <button class="btn btn-sm btn-outline-secondary" onclick="attachFile()">
                                <i class="fas fa-paperclip"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="attachPhoto()">
                                <i class="fas fa-camera"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-secondary" onclick="shareLocation()">
                                <i class="fas fa-map-marker-alt"></i>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="file-manager-panel" class="file-manager-panel">
            <div class="file-manager-header">
                <h5><i class="fas fa-folder"></i> File Manager</h5>
                <div class="file-manager-actions">
                    <button class="btn btn-sm btn-primary" onclick="uploadFile()">
                        <i class="fas fa-upload"></i> Upload
                    </button>
                    <button class="btn btn-sm btn-outline-light" onclick="closeFileManager()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            </div>
            
            <div class="file-manager-content">
                <div class="file-explorer">
                    <div class="folder-tree">
                        <h6>Project Folders</h6>
                        <div id="folder-tree">
                            </div>
                    </div>
                    
                    <div class="file-listing">
                        <div class="file-controls">
                            <input type="text" id="file-search" class="form-control form-control-sm" placeholder="Search files...">
                            <select id="file-filter" class="form-select form-select-sm">
                                <option value="">All Files</option>
                                <option value="pdf">PDF</option>
                                <option value="xlsx">Excel</option>
                                <option value="dwg">CAD Files</option>
                                <option value="images">Images</option>
                            </select>
                        </div>
                        
                        <div id="file-list" class="file-list">
                            </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="notification-center" class="notification-center">
            <div class="notification-header">
                <h6><i class="fas fa-bell"></i> Notifications</h6>
                <button class="btn btn-sm btn-outline-secondary" onclick="markAllAsRead()">
                    Mark All Read
                </button>
            </div>
            <div id="notification-list" class="notification-list">
                </div>
        </div>
        
        <div id="contracts-page" class="page">
            </div>

        <div id="inspection-page" class="page">
            </div>

        <div id="settings-page" class="page">
            <div class="app-grid">
                <aside class="sidebar">
                    <nav>
                        <button class="nav-btn" onclick="showPage('dashboard-page')">
                            <i class="fas fa-home"></i> Dashboard
                        </button>
                        <button class="nav-btn active" onclick="showPage('settings-page')">
                            <i class="fas fa-cog"></i> Settings
                        </button>
                    </nav>
                </aside>

                <main class="main-content">
                    <div class="settings-container">
                        <h2>Application Settings</h2>
                        
                        <div class="settings-tabs">
                            <button class="settings-tab active" onclick="showSettingsTab('general')">General</button>
                            <button class="settings-tab" onclick="showSettingsTab('theme')">Theme & UI</button>
                            <button class="settings-tab" onclick="showSettingsTab('ai')">AI Configuration</button>
                            <button class="settings-tab" onclick="showSettingsTab('notifications')">Notifications</button>
                            <button class="settings-tab" onclick="showSettingsTab('security')">Security</button>
                        </div>
                        
                        <div id="general-settings" class="settings-panel active">
                            <form id="settings-form">
                                <div class="mb-3">
                                    <label for="api-key" class="form-label">Map API Key</label>
                                    <input type="password" class="form-control" id="api-key" placeholder="Enter your mapping API key">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="default-location" class="form-label">Default Map Location</label>
                                    <input type="text" class="form-control" id="default-location" placeholder="Latitude, Longitude" value="40.7128, -74.0060">
                                </div>
                                
                                <div class="mb-3">
                                    <label for="zoom-level" class="form-label">Default Zoom Level</label>
                                    <input type="range" class="form-range" id="zoom-level" min="1" max="18" value="10">
                                    <span id="zoom-display">10</span>
                                </div>
                                
                                <div class="mb-3">
                                    <div class="form-check">
                                        <input class="form-check-input" type="checkbox" id="auto-save">
                                        <label class="form-check-label" for="auto-save">
                                            Auto-save changes
                                        </label>
                                    </div>
                                </div>
                                
                                <button type="submit" class="btn btn-primary">
                                    <i class="fas fa-save"></i> Save Settings
                                </button>
                            </form>
                        </div>
                        
                        <div id="theme-settings" class="settings-panel">
                            <h5>Theme Personalization</h5>
                            
                            <div class="theme-selector mb-4">
                                <label class="form-label">Choose Theme</label>
                                <div class="theme-options">
                                    <div class="theme-option" onclick="setTheme('light')">
                                        <div class="theme-preview light-theme"></div>
                                        <span>Light</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('dark')">
                                        <div class="theme-preview dark-theme"></div>
                                        <span>Dark</span>
                                    </div>
                                    <div class="theme-option" onclick="setTheme('custom')">
                                        <div class="theme-preview custom-theme"></div>
                                        <span>Custom</span>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="mb-3">
                                <label for="custom-background" class="form-label">Custom Background Image</label>
                                <input type="file" class="form-control" id="custom-background" accept="image/*" onchange="handleBackgroundUpload(event)">
                            </div>
                            
                            <div class="mb-3">
                                <label for="font-size" class="form-label">Font Size</label>
                                <select id="font-size" class="form-select" onchange="adjustFontSize(this.value)">
                                    <option value="small">Small</option>
                                    <option value="medium" selected>Medium</option>
                                    <option value="large">Large</option>
                                </select>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="high-contrast">
                                    <label class="form-check-label" for="high-contrast">
                                        High Contrast Mode
                                    </label>
                                </div>
                            </div>
                        </div>
                        
                        <div id="ai-settings" class="settings-panel">
                            <h5>AI Analysis Configuration</h5>
                            
                            <div class="mb-3">
                                <label for="ai-prompt" class="form-label">AI Analysis Prompt</label>
                                <textarea id="ai-prompt" class="form-control" rows="10" placeholder="Enter the AI prompt for image analysis...">
You are an expert civil engineer specializing in road defect detection. Analyze the provided road image and identify any defects such as:

1. Cracks (longitudinal, transverse, alligator)
2. Potholes
3. Rutting
4. Bleeding
5. Raveling
6. Edge deterioration

For each defect found, provide:
- Type of defect
- Severity level (Low, Medium, High)
- Recommended action
- Estimated repair cost category

Be precise and professional in your assessment.
                                </textarea>
                            </div>
                            
                            <div class="mb-3">
                                <label for="ai-confidence" class="form-label">Detection Confidence Threshold</label>
                                <input type="range" class="form-range" id="ai-confidence" min="0.1" max="1" step="0.1" value="0.7">
                                <span id="confidence-display">70%</span>
                            </div>
                            
                            <div class="mb-3">
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="auto-ai-analysis">
                                    <label class="form-check-label" for="auto-ai-analysis">
                                        Auto-analyze uploaded images
                                    </label>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="saveAISettings()">
                                <i class="fas fa-save"></i> Save AI Configuration
                            </button>
                            
                            <button class="btn btn-secondary" onclick="testAIPrompt()">
                                <i class="fas fa-test-tube"></i> Test Prompt
                            </button>
                        </div>
                        
                        <div id="notification-settings" class="settings-panel">
                            <h5>Notification Preferences</h5>
                            
                            <div class="notification-section">
                                <h6>Email Notifications</h6>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email-new-files">
                                    <label class="form-check-label" for="email-new-files">
                                        New file uploads
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email-chat-messages">
                                    <label class="form-check-label" for="email-chat-messages">
                                        New chat messages
                                    </label>
                                </div>
                                <div class="form-check">
                                    <input class="form-check-input" type="checkbox" id="email-ai-results">
                                    <label class="form-check-label" for="email-ai-results">
                                        AI analysis results
                                    </label>
                                </div>
                            </div>
                            
                            <div class="notification-section">
                                <h6>Telegram Integration</h6>
                                <div class="mb-3">
                                    <label for="telegram-bot-token" class="form-label">Bot Token</label>
                                    <input type="password" class="form-control" id="telegram-bot-token" placeholder="Enter Telegram bot token">
                                </div>
                                <div class="mb-3">
                                    <label for="telegram-chat-id" class="form-label">Chat ID</label>
                                    <input type="text" class="form-control" id="telegram-chat-id" placeholder="Enter Telegram chat ID">
                                </div>
                                <button class="btn btn-success" onclick="testTelegramConnection()">
                                    <i class="fas fa-test"></i> Test Connection
                                </button>
                            </div>
                        </div>
                        
                        <div id="security-settings" class="settings-panel">
                            <h5>Security & Access Control</h5>
                            
                            <div class="mb-3">
                                <label for="session-timeout" class="form-label">Session Timeout (minutes)</label>
                                <input type="number" class="form-control" id="session-timeout" value="60" min="15" max="480">
                            </div>
                            
                            <div class="mb-3">
                                <label for="file-retention" class="form-label">File Retention Period (days)</label>
                                <input type="number" class="form-control" id="file-retention" value="30" min="1" max="365">
                            </div>
                            
                            <div class="form-check">
                                <input class="form-check-input" type="checkbox" id="require-2fa">
                                <label class="form-check-label" for="require-2fa">
                                    Require Two-Factor Authentication
                                </label>
                            </div>
                            
                            <button class="btn btn-primary" onclick="saveSecuritySettings()">
                                <i class="fas fa-shield-alt"></i> Save Security Settings
                            </button>
                        </div>
                    </div>
                </main>
            </div>
        </div>
    </div>

    <div id="message-container"></div>

    <div id="loading-overlay" class="loading-overlay">
        <div class="loading-spinner">
            <i class="fas fa-spinner fa-spin fa-3x"></i>
            <p>Loading...</p>
        </div>
    </div>

    <script>
// Mapbox global variables
let mapboxMap = null;
let mapboxDraw = null;
let mapboxConfig = {
    accessToken: 'YOUR_MAPBOX_TOKEN_PLACEHOLDER',
    style: 'mapbox://styles/mapbox/satellite-streets-v12',
    center: [-74.0060, 40.7128],
    zoom: 10
};

let gisData = {
    shapes: [],
    markers: [],
    overlays: {
        traffic: false,
        weather: false,
        riskZones: false
    }
};

// Initialize when mapping page is shown
document.addEventListener('DOMContentLoaded', function() {
    // Initialize Mapbox when mapping page is accessed
    setupMapboxIntegration();
});

// ===================================
// MAPBOX INITIALIZATION
// ===================================

function setupMapboxIntegration() {
    // Override the original map initialization
    if (typeof showPage === 'function') {
        const originalShowPage = showPage;
        showPage = function(pageId) {
            originalShowPage(pageId);
            if (pageId === 'mapping-page') {
                setTimeout(initializeMapboxMap, 100);
            }
        };
    }
}

function initializeMapboxMap() {
    const mapContainer = document.getElementById('map-container');
    if (!mapContainer || mapboxMap) return;

    // Set Mapbox access token
    if (window.mapboxgl) {
        mapboxgl.accessToken = mapboxConfig.accessToken;
        
        try {
            // Create Mapbox map
            mapboxMap = new mapboxgl.Map({
                container: 'map-container',
                style: mapboxConfig.style,
                center: mapboxConfig.center,
                zoom: mapboxConfig.zoom,
                attributionControl: false
            });

            // Add navigation controls
            mapboxMap.addControl(new mapboxgl.NavigationControl(), 'top-left');
            
            // Add scale control
            mapboxMap.addControl(new mapboxgl.ScaleControl(), 'bottom-left');

            // Initialize drawing tools
            initializeMapboxDraw();
            
            // Setup floating UI cards
            createFloatingUICards();
            
            // Load saved GIS data
            loadGISData();
            
            // Setup event listeners
            setupMapboxEventListeners();
            
            console.log('Mapbox map initialized successfully');
            
        } catch (error) {
            console.error('Mapbox initialization failed:', error);
            // Fallback to original Leaflet map
            initializeLeafletFallback();
        }
    } else {
        console.warn('Mapbox GL JS not loaded, using Leaflet fallback');
        initializeLeafletFallback();
    }
}

function initializeMapboxDraw() {
    if (!window.MapboxDraw) {
        console.warn('Mapbox Draw not available');
        return;
    }

    mapboxDraw = new MapboxDraw({
        displayControlsDefault: false,
        controls: {
            polygon: true,
            line_string: true,
            point: true,
            trash: true
        }
    });

    mapboxMap.addControl(mapboxDraw, 'top-left');
}

function initializeLeafletFallback() {
    // Use original Leaflet implementation if Mapbox fails
    if (typeof initializeMap === 'function') {
        initializeMap();
    }
}

// ===================================
// FLOATING UI CARDS
// ===================================

function createFloatingUICards() {
    const cardsHTML = `
        <div id="info-display-card" class="floating-card">
            <div class="card-header">
                <h6><i class="fas fa-info-circle"></i> Shape Information</h6>
                <button class="card-toggle" onclick="toggleCard('info-display-card')"></button>
            </div>
            <div class="card-content">
                <div class="info-item">
                    <label>Area (m):</label>
                    <span id="shape-area">0</span>
                </div>
                <div class="info-item">
                    <label>Perimeter (m):</label>
                    <span id="shape-perimeter">0</span>
                </div>
                <div class="info-item">
                    <label>Length (m):</label>
                    <span id="shape-length">0</span>
                </div>
                <div class="info-item">
                    <label>Coordinates:</label>
                    <span id="shape-coordinates">Select a shape</span>
                </div>
                <div class="export-buttons">
                    <button class="btn btn-sm btn-primary" onclick="exportGIS('pdf')">PDF</button>
                    <button class="btn btn-sm btn-success" onclick="exportGIS('kml')">KML</button>
                    <button class="btn btn-sm btn-info" onclick="exportGIS('csv')">CSV</button>
                    <button class="btn btn-sm btn-warning" onclick="exportGIS('dxf')">DXF</button>
                </div>
            </div>
        </div>

        <div id="data-entry-card" class="floating-card">
            <div class="card-header">
                <h6><i class="fas fa-keyboard"></i> Data Entry</h6>
                <button class="card-toggle" onclick="toggleCard('data-entry-card')"></button>
            </div>
            <div class="card-content">
                <div class="form-group">
                    <label>Manual Coordinates</label>
                    <input type="text" id="manual-coords" placeholder="lat1,lng1 lat2,lng2..." class="form-control">
                    <button class="btn btn-sm btn-primary mt-2" onclick="addManualShape()">Add Shape</button>
                </div>
                <div class="form-group">
                    <label>Import Data</label>
                    <input type="file" id="gis-file-import" accept=".csv,.kml,.kmz,.geojson" onchange="handleGISImport(event)">
                    <button class="btn btn-sm btn-secondary mt-2" onclick="downloadCSVTemplate()">Download Template</button>
                </div>
            </div>
        </div>

        <div id="qnas-metadata-card" class="floating-card">
            <div class="card-header">
                <h6><i class="fas fa-tags"></i> Point Metadata</h6>
                <button class="card-toggle" onclick="toggleCard('qnas-metadata-card')"></button>
            </div>
            <div class="card-content">
                <div class="form-group">
                    <label>Point ID</label>
                    <input type="text" id="point-id" class="form-control">
                </div>
                <div class="form-group">
                    <label>Description</label>
                    <textarea id="point-description" class="form-control" rows="3"></textarea>
                </div>
                <div class="form-group">
                    <label>Coordinates</label>
                    <input type="text" id="point-coords" class="form-control" readonly>
                </div>
                <button class="btn btn-sm btn-success" onclick="savePointMetadata()">Save Metadata</button>
            </div>
        </div>

        <div id="overlays-card" class="floating-card">
            <div class="card-header">
                <h6><i class="fas fa-layer-group"></i> Map Overlays</h6>
                <button class="card-toggle" onclick="toggleCard('overlays-card')"></button>
            </div>
            <div class="card-content">
                <div class="overlay-controls">
                    <div class="form-check">
                        <input type="checkbox" id="traffic-overlay" onchange="toggleOverlay('traffic', this.checked)">
                        <label for="traffic-overlay">Traffic</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="weather-overlay" onchange="toggleOverlay('weather', this.checked)">
                        <label for="weather-overlay">Weather</label>
                    </div>
                    <div class="form-check">
                        <input type="checkbox" id="risk-overlay" onchange="toggleOverlay('risk', this.checked)">
                        <label for="risk-overlay">Risk Zones</label>
                    </div>
                </div>
                <div class="simulation-buttons">
                    <button class="btn btn-sm btn-warning" onclick="simulateTrafficAlert()">Simulate Traffic Alert</button>
                    <button class="btn btn-sm btn-info" onclick="simulateWeatherAlert()">Simulate Weather Alert</button>
                </div>
            </div>
        </div>

        <div id="map-hamburger-menu" class="map-hamburger">
            <button class="hamburger-btn" onclick="toggleAllCards()">
                <i class="fas fa-bars"></i>
            </button>
        </div>
    `;

    // Add cards to map container
    const mapContainer = document.getElementById('map-container');
    if (mapContainer) {
        const cardsContainer = document.createElement('div');
        cardsContainer.className = 'floating-cards-container';
        cardsContainer.innerHTML = cardsHTML;
        mapContainer.appendChild(cardsContainer);
    }
}

// ===================================
// SHAPE CALCULATIONS
// ===================================

function calculateShapeInfo(feature) {
    if (!feature || !feature.geometry) return;

    const geometry = feature.geometry;
    let area = 0, perimeter = 0, length = 0;

    try {
        if (geometry.type === 'Polygon') {
            area = turf.area(feature);
            perimeter = turf.length(turf.polygonToLine(feature), { units: 'meters' });
        } else if (geometry.type === 'LineString') {
            length = turf.length(feature, { units: 'meters' });
        }

        updateInfoDisplay(area, perimeter, length, geometry.coordinates);
    } catch (error) {
        console.error('Error calculating shape info:', error);
    }
}

function updateInfoDisplay(area, perimeter, length, coordinates) {
    document.getElementById('shape-area').textContent = Math.round(area || 0);
    document.getElementById('shape-perimeter').textContent = Math.round(perimeter || 0);
    document.getElementById('shape-length').textContent = Math.round(length || 0);
    
    const coordText = coordinates ? formatCoordinates(coordinates) : 'No shape selected';
    document.getElementById('shape-coordinates').textContent = coordText;
}

function formatCoordinates(coords) {
    if (coords.length === 1) {
        // Point
        return `${coords[0][1].toFixed(6)}, ${coords[0][0].toFixed(6)}`;
    } else if (coords.length > 1) {
        // Line or polygon - show first few points
        const first = coords[0];
        const coordPairs = Array.isArray(first[0]) ? first : coords;
        return `${coordPairs.length} points (${coordPairs[0][1].toFixed(6)}, ${coordPairs[0][0].toFixed(6)}...)`;
    }
    return 'Invalid coordinates';
}

// ===================================
// EVENT HANDLERS
// ===================================

function setupMapboxEventListeners() {
    if (!mapboxMap) return;

    // Map load event
    mapboxMap.on('load', function() {
        loadProjectMarkers();
        setupMapInteractions();
    });

    // Draw events
    if (mapboxDraw) {
        mapboxMap.on('draw.create', function(e) {
            const feature = e.features[0];
            calculateShapeInfo(feature);
            saveGISShape(feature);
        });

        mapboxMap.on('draw.update', function(e) {
            const feature = e.features[0];
            calculateShapeInfo(feature);
            updateGISShape(feature);
        });

        mapboxMap.on('draw.delete', function(e) {
            deleteGISShape(e.features[0].id);
            updateInfoDisplay(0, 0, 0, null);
        });

        mapboxMap.on('draw.selectionchange', function(e) {
            if (e.features.length > 0) {
                calculateShapeInfo(e.features[0]);
            } else {
                updateInfoDisplay(0, 0, 0, null);
            }
        });
    }

    // Click events for markers
    mapboxMap.on('click', function(e) {
        handleMapClick(e);
    });
}

function handleMapClick(e) {
    const coords = e.lngLat;
    
    // Update QNAS card with clicked coordinates
    document.getElementById('point-coords').value = `${coords.lat.toFixed(6)}, ${coords.lng.toFixed(6)}`;
    
    // Show QNAS card if hidden
    showCard('qnas-metadata-card');
}

// ===================================
// OVERLAY MANAGEMENT
// ===================================

function toggleOverlay(type, enabled) {
    gisData.overlays[type] = enabled;
    
    switch (type) {
        case 'traffic':
            toggleTrafficOverlay(enabled);
            break;
        case 'weather':
            toggleWeatherOverlay(enabled);
            break;
        case 'risk':
            toggleRiskOverlay(enabled);
            break;
    }
}

function toggleTrafficOverlay(enabled) {
    if (!mapboxMap) return;
    
    if (enabled) {
        // Add traffic layer (simulation)
        mapboxMap.addSource('traffic-data', {
            type: 'geojson',
            data: generateTrafficData()
        });
        
        mapboxMap.addLayer({
            id: 'traffic-layer',
            type: 'line',
            source: 'traffic-data',
            paint: {
                'line-color': ['get', 'color'],
                'line-width': 5,
                'line-opacity': 0.7
            }
        });
    } else {
        if (mapboxMap.getLayer('traffic-layer')) {
            mapboxMap.removeLayer('traffic-layer');
            mapboxMap.removeSource('traffic-data');
        }
    }
}

function toggleWeatherOverlay(enabled) {
    if (!mapboxMap || !enabled) return;
    
    // Simulate weather overlay
    const weatherPopup = new mapboxgl.Popup()
        .setLngLat(mapboxMap.getCenter())
        .setHTML('<div class="weather-popup"> Rain: 65% | Temp: 22C</div>')
        .addTo(mapboxMap);
    
    setTimeout(() => weatherPopup.remove(), 5000);
}

function toggleRiskOverlay(enabled) {
    if (!mapboxMap) return;
    
    if (enabled) {
        // Add risk zones
        mapboxMap.addSource('risk-zones', {
            type: 'geojson',
            data: generateRiskZones()
        });
        
        mapboxMap.addLayer({
            id: 'risk-layer',
            type: 'fill',
            source: 'risk-zones',
            paint: {
                'fill-color': ['get', 'color'],
                'fill-opacity': 0.3
            }
        });
    } else {
        if (mapboxMap.getLayer('risk-layer')) {
            mapboxMap.removeLayer('risk-layer');
            mapboxMap.removeSource('risk-zones');
        }
    }
}

// ===================================
// IMPORT/EXPORT FUNCTIONS
// ===================================

function handleGISImport(event) {
    const file = event.target.files[0];
    if (!file) return;

    const extension = file.name.split('.').pop().toLowerCase();
    
    switch (extension) {
        case 'csv':
            importCSVData(file);
            break;
        case 'kml':
        case 'kmz':
            importKMLData(file);
            break;
        case 'geojson':
            importGeoJSONData(file);
            break;
        default:
            showMessage('Unsupported file format', 'error');
    }
}

function importCSVData(file) {
    Papa.parse(file, {
        header: true,
        complete: function(results) {
            const data = results.data;
            
            data.forEach(row => {
                if (row.lat && row.lng) {
                    const marker = new mapboxgl.Marker()
                        .setLngLat([parseFloat(row.lng), parseFloat(row.lat)])
                        .setPopup(new mapboxgl.Popup().setHTML(`
                            <h6>${row.name || 'Imported Point'}</h6>
                            <p>${row.description || 'No description'}</p>
                        `))
                        .addTo(mapboxMap);
                    
                    gisData.markers.push({
                        id: generateId(),
                        coordinates: [parseFloat(row.lng), parseFloat(row.lat)],
                        metadata: row
                    });
                }
            });
            
            showMessage(`Imported ${data.length} points from CSV`, 'success');
            saveGISData();
        }
    });
}

function exportGIS(format) {
    const shapes = mapboxDraw ? mapboxDraw.getAll() : { features: [] };
    
    switch (format) {
        case 'pdf':
            exportToPDF();
            break;
        case 'kml':
            exportToKML(shapes);
            break;
        case 'csv':
            exportToCSV(shapes);
            break;
        case 'dxf':
            exportToDXF(shapes);
            break;
    }
}

function exportToPDF() {
    html2canvas(document.getElementById('map-container')).then(canvas => {
        const { jsPDF } = window.jspdf;
        const pdf = new jsPDF('landscape', 'mm', 'a4');
        
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = 297;
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save('gis-map-export.pdf');
        
        showMessage('Map exported to PDF', 'success');
    });
}

function exportToKML(shapes) {
    // Simple KML export
    let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
<Document>
<name>GIS Export</name>`;

    shapes.features.forEach((feature, index) => {
        const coords = feature.geometry.coordinates;
        const name = `Shape ${index + 1}`;
        
        if (feature.geometry.type === 'Point') {
            kml += `
<Placemark>
    <name>${name}</name>
    <Point>
        <coordinates>${coords[0]},${coords[1]}</coordinates>
    </Point>
</Placemark>`;
        }
    });

    kml += `
</Document>
</kml>`;

    downloadFile(kml, 'gis-export.kml', 'application/vnd.google-earth.kml+xml');
}

// ===================================
// UTILITY FUNCTIONS
// ===================================

function toggleCard(cardId) {
    const card = document.getElementById(cardId);
    const content = card.querySelector('.card-content');
    const toggle = card.querySelector('.card-toggle');
    
    if (content.style.display === 'none') {
        content.style.display = 'block';
        toggle.textContent = '';
    } else {
        content.style.display = 'none';
        toggle.textContent = '+';
    }
}

function toggleAllCards() {
    const cards = document.querySelectorAll('.floating-card');
    const isAnyVisible = Array.from(cards).some(card => 
        card.querySelector('.card-content').style.display !== 'none'
    );
    
    cards.forEach(card => {
        const content = card.querySelector('.card-content');
        const toggle = card.querySelector('.card-toggle');
        
        if (isAnyVisible) {
            content.style.display = 'none';
            toggle.textContent = '+';
        } else {
            content.style.display = 'block';
            toggle.textContent = '';
        }
    });
}

function showCard(cardId) {
    const card = document.getElementById(cardId);
    if (card) {
        const content = card.querySelector('.card-content');
        const toggle = card.querySelector('.card-toggle');
        content.style.display = 'block';
        toggle.textContent = '';
    }
}

function saveGISData() {
    localStorage.setItem('gisData', JSON.stringify(gisData));
}

function loadGISData() {
    const saved = localStorage.getItem('gisData');
    if (saved) {
        try {
            gisData = { ...gisData, ...JSON.parse(saved) };
        } catch (error) {
            console.error('Error loading GIS data:', error);
        }
    }
}

function downloadFile(content, filename, mimeType) {
    const blob = new Blob([content], { type: mimeType });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = filename;
    link.click();
    URL.revokeObjectURL(link.href);
}

function generateTrafficData() {
    // Generate mock traffic data
    return {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'LineString',
                    coordinates: [[-74.006, 40.7128], [-74.0, 40.72]]
                },
                properties: { color: '#ff0000' }
            }
        ]
    };
}

function generateRiskZones() {
    // Generate mock risk zones
     return {
        type: 'FeatureCollection',
        features: [
            {
                type: 'Feature',
                geometry: {
                    type: 'Polygon',
                    coordinates: [[[-74.01, 40.71], [-74.00, 40.71], [-74.00, 40.72], [-74.01, 40.72], [-74.01, 40.71]]]
                },
                properties: { color: '#ffaa00' }
            }
        ]
    };
}

// Missing utility functions for Mapbox integration
function saveGISShape(feature) {
    gisData.shapes.push({
        id: feature.id || generateId(),
        feature: feature,
        createdAt: new Date().toISOString()
    });
    saveGISData();
}

function updateGISShape(feature) {
    const index = gisData.shapes.findIndex(s => s.id === feature.id);
    if (index !== -1) {
        gisData.shapes[index].feature = feature;
        gisData.shapes[index].updatedAt = new Date().toISOString();
        saveGISData();
    }
}

function deleteGISShape(featureId) {
    gisData.shapes = gisData.shapes.filter(s => s.id !== featureId);
    saveGISData();
}

function loadProjectMarkers() {
    // Load project markers on map
    const projects = JSON.parse(localStorage.getItem('engineeringProjects') || '[]');
    projects.forEach(project => {
        if (project.coordinates && mapboxMap) {
            const marker = new mapboxgl.Marker()
                .setLngLat(project.coordinates)
                .setPopup(new mapboxgl.Popup().setHTML(`
                    <h6>${project.name}</h6>
                    <p>${project.description || 'No description'}</p>
                `))
                .addTo(mapboxMap);
        }
    });
}

function setupMapInteractions() {
    // Setup additional map interactions
    if (mapboxMap) {
        mapboxMap.on('moveend', function() {
            // Save map position
            const center = mapboxMap.getCenter();
            const zoom = mapboxMap.getZoom();
            localStorage.setItem('mapPosition', JSON.stringify({
                center: [center.lng, center.lat],
                zoom: zoom
            }));
        });
    }
}

function addManualShape() {
    const coordsInput = document.getElementById('manual-coords');
    if (!coordsInput || !coordsInput.value) return;

    try {
        const coords = coordsInput.value.split(' ').map(pair => {
            const [lat, lng] = pair.split(',').map(Number);
            return [lng, lat]; // GeoJSON format
        });

        if (coords.length >= 2) {
            const feature = {
                type: 'Feature',
                geometry: {
                    type: coords.length > 2 ? 'Polygon' : 'LineString',
                    coordinates: coords.length > 2 ? [coords] : coords
                }
            };

            if (mapboxDraw) {
                mapboxDraw.add(feature);
            }
            coordsInput.value = '';
            showMessage('Shape added successfully', 'success');
        }
    } catch (error) {
        showMessage('Invalid coordinate format', 'error');
    }
}

function downloadCSVTemplate() {
    const template = 'name,description,lat,lng\nSample Point,Description,40.7128,-74.0060';
    downloadFile(template, 'gis-template.csv', 'text/csv');
}

function savePointMetadata() {
    const pointId = document.getElementById('point-id').value;
    const description = document.getElementById('point-description').value;
    const coords = document.getElementById('point-coords').value;

    if (pointId && coords) {
        const metadata = {
            id: pointId,
            description: description,
            coordinates: coords,
            timestamp: new Date().toISOString()
        };

        const points = JSON.parse(localStorage.getItem('gisPoints') || '[]');
        points.push(metadata);
        localStorage.setItem('gisPoints', JSON.stringify(points));

        showMessage('Point metadata saved', 'success');

        // Clear form
        document.getElementById('point-id').value = '';
        document.getElementById('point-description').value = '';
    }
}

function importKMLData(file) {
    // Mock KML import
    showMessage('KML import not fully implemented in demo', 'warning');
}

function importGeoJSONData(file) {
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const geojson = JSON.parse(e.target.result);
            if (mapboxDraw && geojson.features) {
                geojson.features.forEach(feature => {
                    mapboxDraw.add(feature);
                });
            }
            showMessage(`Imported ${geojson.features?.length || 0} features from GeoJSON`, 'success');
        } catch (error) {
            showMessage('Invalid GeoJSON format', 'error');
        }
    };
    reader.readAsText(file);
}

function exportToCSV(shapes) {
    let csv = 'type,coordinates,area,length\n';

    shapes.features.forEach(feature => {
        const coords = JSON.stringify(feature.geometry.coordinates);
        const area = feature.geometry.type === 'Polygon' ? 
            (window.turf ? turf.area(feature) : 0) : '';
        const length = feature.geometry.type === 'LineString' ? 
            (window.turf ? turf.length(feature, { units: 'meters' }) : 0) : '';

        csv += `${feature.geometry.type},"${coords}",${area},${length}\n`;
    });

    downloadFile(csv, 'gis-export.csv', 'text/csv');
}

function exportToDXF(shapes) {
    // Mock DXF export
    showMessage('DXF export not fully implemented in demo', 'warning');
}

function simulateTrafficAlert() {
    showMessage(' Traffic Alert: Heavy congestion detected on main route', 'warning');
    if (typeof showNotification === 'function') {
        showNotification('Traffic Alert', 'Heavy congestion detected', 'warning');
    }
}

function simulateWeatherAlert() {
    showMessage(' Weather Alert: Rain expected in 30 minutes', 'info');
    if (typeof showNotification === 'function') {
        showNotification('Weather Alert', 'Rain expected in 30 minutes', 'info');
    }
}

// Export for use in other modules
window.mapboxIntegration = {
    initializeMapboxMap,
    exportGIS,
    toggleOverlay
};

// Telegram configuration
let telegramConfig = {
    botToken: 'YOUR_TELEGRAM_BOT_TOKEN_PLACEHOLDER',
    chatId: 'YOUR_TELEGRAM_CHAT_ID_PLACEHOLDER',
    webhookUrl: 'YOUR_WEBHOOK_URL_PLACEHOLDER',
    adminChatId: 'YOUR_ADMIN_CHAT_ID_PLACEHOLDER'
};

let telegramBot = {
    connected: false,
    lastUpdate: null,
    messageQueue: [],
    analysisQueue: []
};

// Initialize Telegram integration
document.addEventListener('DOMContentLoaded', function() {
    initializeTelegramBot();
    setupTelegramCommands();
    loadTelegramSettings();
});

// ===================================
// TELEGRAM BOT INITIALIZATION
// ===================================

function initializeTelegramBot() {
    // Load saved Telegram settings
    const savedSettings = localStorage.getItem('telegramSettings');
    if (savedSettings) {
        try {
            const settings = JSON.parse(savedSettings);
            telegramConfig = { ...telegramConfig, ...settings };
        } catch (error) {
            console.error('Error loading Telegram settings:', error);
        }
    }
    
    // Set up webhook if token is available
    if (telegramConfig.botToken && telegramConfig.botToken !== 'YOUR_TELEGRAM_BOT_TOKEN_PLACEHOLDER') {
        setupTelegramWebhook();
    }
    
    console.log('Telegram integration initialized');
}

async function setupTelegramWebhook() {
    try {
        // In production, set up webhook
        // For demo, simulate connection
        telegramBot.connected = true;
        updateTelegramStatus();
        
        // Start polling for demo
        startTelegramPolling();
        
    } catch (error) {
        console.error('Telegram webhook setup failed:', error);
        telegramBot.connected = false;
        updateTelegramStatus();
    }
}

function startTelegramPolling() {
    // Simulate polling for demo
    setInterval(() => {
        processTelegramQueue();
    }, 5000);
}

// ===================================
// AI ANALYSIS VIA TELEGRAM
// ===================================

async function sendImageToTelegramAI(imageData, metadata = {}) {
    const analysisRequest = {
        id: generateId(),
        image: imageData,
        metadata: metadata,
        timestamp: new Date().toISOString(),
        status: 'pending'
    };
    
    telegramBot.analysisQueue.push(analysisRequest);
    
    try {
        // Send image to Telegram bot for AI analysis
        await sendTelegramMessage(' Analyzing uploaded image for defect detection...', 'photo', imageData);
        
        // Simulate AI analysis response
        setTimeout(() => {
            simulateAIAnalysisResponse(analysisRequest);
        }, 3000);
        
        showMessage('Image sent to Telegram AI for analysis', 'info');
        logActivity('AI Analysis', 'Image sent to Telegram bot for defect detection');
        
    } catch (error) {
        console.error('Failed to send image to Telegram:', error);
        showMessage('Failed to send image to Telegram bot', 'error');
    }
}

function simulateAIAnalysisResponse(request) {
    // Simulate AI analysis results
    const defects = [
        { type: 'Surface Cracking', severity: 'Medium', confidence: 0.85 },
        { type: 'Edge Deterioration', severity: 'Low', confidence: 0.72 }
    ];
    
    const analysisResult = {
        requestId: request.id,
        defects: defects,
        overallSeverity: 'Medium',
        recommendedAction: 'Schedule repair within 30 days',
        confidence: 0.78,
        timestamp: new Date().toISOString()
    };
    
    // Send results back via Telegram
    const resultMessage = ` *AI Analysis Complete*\n\n` +
        ` Defects Found: ${defects.length}\n` +
        defects.map(d => ` ${d.type} (${d.severity}) - ${Math.round(d.confidence * 100)}%`).join('\n') +
        `\n\n Overall Severity: ${analysisResult.overallSeverity}\n` +
        ` Recommended Action: ${analysisResult.recommendedAction}`;
    
    sendTelegramMessage(resultMessage);
    
    // Store in AI results
    if (typeof aiResults !== 'undefined') {
        aiResults.push({
            id: generateId(),
            image: request.image,
            coordinates: request.metadata.coordinates || 'Unknown',
            timestamp: new Date().toLocaleString(),
            defects: defects.map(d => d.type),
            severity: analysisResult.overallSeverity,
            action: analysisResult.recommendedAction
        });
        
        // Update AI results table if visible
        if (typeof renderAIResultsTable === 'function') {
            renderAIResultsTable();
        }
    }
    
    showNotification('AI Analysis Complete', `Found ${defects.length} defects with ${analysisResult.overallSeverity} severity`, 'info');
}

// ===================================
// SMART FAQ AND SUPPORT BOT
// ===================================

function setupTelegramCommands() {
    const commands = {
        '/start': handleStartCommand,
        '/help': handleHelpCommand,
        '/status': handleStatusCommand,
        '/upload': handleUploadCommand,
        '/summary': handleSummaryCommand,
        '/defects': handleDefectsCommand,
        '/backup': handleBackupCommand,
        '/weather': handleWeatherCommand,
        '/location': handleLocationCommand
    };
    
    window.telegramCommands = commands;
}

function handleStartCommand(chatId, messageText) {
    const welcomeMessage = ` *Welcome to Engineering Platform Bot!*\n\n` +
        `I can help you with:\n` +
        ` AI defect analysis\n` +
        ` Project summaries\n` +
        ` Location services\n` +
        ` Data backup\n` +
        ` Status reports\n\n` +
        `Type /help for more commands.`;
    
    sendTelegramMessage(welcomeMessage, 'text', null, chatId);
}

function handleHelpCommand(chatId, messageText) {
    const helpMessage = ` *Available Commands:*\n\n` +
        `/start - Welcome message\n` +
        `/help - Show this help\n` +
        `/status - Platform status\n` +
        `/upload - Upload image for analysis\n` +
        `/summary [today/week] - Get reports\n` +
        `/defects - Latest defect detections\n` +
        `/backup - Create data backup\n` +
        `/weather [location] - Weather info\n` +
        `/location - Share location`;
    
    sendTelegramMessage(helpMessage, 'text', null, chatId);
}

function handleStatusCommand(chatId, messageText) {
    const stats = {
        projects: JSON.parse(localStorage.getItem('engineeringProjects') || '[]').length,
        files: JSON.parse(localStorage.getItem('engineeringFiles') || '[]').length,
        inspections: JSON.parse(localStorage.getItem('engineeringInspections') || '[]').length,
        defects: JSON.parse(localStorage.getItem('engineeringAIResults') || '[]').length
    };
    
    const statusMessage = ` *Platform Status*\n\n` +
        ` Active Projects: ${stats.projects}\n` +
        ` Stored Files: ${stats.files}\n` +
        ` Inspections: ${stats.inspections}\n` +
        ` Detected Defects: ${stats.defects}\n\n` +
        ` Last Update: ${new Date().toLocaleTimeString()}`;
    
    sendTelegramMessage(statusMessage, 'text', null, chatId);
}

function handleSummaryCommand(chatId, messageText) {
    const period = messageText.split(' ')[1] || 'today';
    
    // Generate summary based on period
    const summaryData = generatePlatformSummary(period);
    
    const summaryMessage = ` *${period.charAt(0).toUpperCase() + period.slice(1)} Summary*\n\n` +
        ` Images Analyzed: ${summaryData.imagesAnalyzed}\n` +
        ` New Defects: ${summaryData.newDefects}\n` +
        ` Reports Generated: ${summaryData.reportsGenerated}\n` +
        ` Files Uploaded: ${summaryData.filesUploaded}\n\n` +
        ` Priority Items: ${summaryData.priorityItems}`;
    
    sendTelegramMessage(summaryMessage, 'text', null, chatId);
}

// ===================================
// REPORT GENERATOR VIA TELEGRAM
// ===================================

async function sendDailySummaryReport() {
    const summary = generatePlatformSummary('today');
    
    const reportMessage = ` *Daily Summary Report*\n` +
        ` ${new Date().toLocaleDateString()}\n\n` +
        ` *AI Analysis:*\n` +
        ` Images processed: ${summary.imagesAnalyzed}\n` +
        ` Defects detected: ${summary.newDefects}\n` +
        ` Critical issues: ${summary.criticalIssues}\n\n` +
        ` *File Activity:*\n` +
        ` Files uploaded: ${summary.filesUploaded}\n` +
        ` Files shared: ${summary.filesShared}\n\n` +
        ` *Project Updates:*\n` +
        ` Inspections completed: ${summary.inspectionsCompleted}\n` +
        ` Reports generated: ${summary.reportsGenerated}`;
    
    await sendTelegramMessage(reportMessage);
    
    // Also send as file if there's data
    if (summary.imagesAnalyzed > 0 || summary.filesUploaded > 0) {
        const reportData = generateDetailedReport('daily');
        await sendTelegramFile(reportData, `daily-report-${new Date().toISOString().split('T')[0]}.json`);
    }
}

function generatePlatformSummary(period) {
    const now = new Date();
    let startDate;
    
    switch (period) {
        case 'today':
            startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            break;
        case 'week':
            startDate = new Date(now.getTime() - 7 * 24 * 60 * 60 * 1000);
            break;
        default:
            startDate = new Date(now.getTime() - 24 * 60 * 60 * 1000);
    }
    
    // Analyze data from localStorage
    const activities = JSON.parse(localStorage.getItem('activities') || '[]');
    const recentActivities = activities.filter(a => new Date(a.timestamp) >= startDate);
    
    return {
        imagesAnalyzed: recentActivities.filter(a => a.action === 'AI Analysis').length,
        newDefects: recentActivities.filter(a => a.action === 'AI Analysis').length * 2, // Estimate
        reportsGenerated: recentActivities.filter(a => a.action.includes('Report')).length,
        filesUploaded: recentActivities.filter(a => a.action === 'File Upload').length,
        filesShared: recentActivities.filter(a => a.action === 'File Share').length,
        inspectionsCompleted: recentActivities.filter(a => a.description.includes('inspection')).length,
        criticalIssues: Math.floor(Math.random() * 3), // Random for demo
        priorityItems: Math.floor(Math.random() * 5) + 1
    };
}

// ===================================
// FILE DELIVERY VIA TELEGRAM
// ===================================

async function sendFileViaTelegram(fileId, recipientChatId = null) {
    const file = getFileById(fileId);
    if (!file) {
        showMessage('File not found', 'error');
        return;
    }
    
    try {
        const chatId = recipientChatId || telegramConfig.chatId;
        
        // Send file notification first
        const fileMessage = ` *File Delivery*\n\n` +
            ` Name: ${file.originalName}\n` +
            ` Size: ${formatFileSize(file.size)}\n` +
            ` Uploaded: ${new Date(file.uploadedAt).toLocaleDateString()}\n` +
            ` Contract: ${file.contractNumber}`;
        
        await sendTelegramMessage(fileMessage, 'text', null, chatId);
        
        // Send actual file
        await sendTelegramFile(file.content, file.originalName, chatId);
        
        showMessage(`File sent to Telegram successfully`, 'success');
        logActivity('Telegram Delivery', `Sent ${file.originalName} via Telegram`);
        
    } catch (error) {
        console.error('Failed to send file via Telegram:', error);
        showMessage('Failed to send file via Telegram', 'error');
    }
}

async function sendTelegramFile(fileData, filename, chatId = null) {
    // For demo, simulate file sending
    console.log(`Would send file ${filename} to Telegram chat ${chatId || telegramConfig.chatId}`);
    
    // In production, use Telegram Bot API sendDocument
    const apiUrl = `https://api.telegram.org/bot${telegramConfig.botToken}/sendDocument`;
    
    // Mock successful response
    return new Promise((resolve) => {
        setTimeout(() => {
            resolve({ ok: true, result: { message_id: Date.now() } });
        }, 1000);
    });
}

// ===================================
// BACKUP & DATA EXPORT VIA TELEGRAM
// ===================================

async function createTelegramBackup() {
    try {
        showMessage('Creating backup for Telegram delivery...', 'info');
        
        // Create comprehensive backup
        const backupData = {
            timestamp: new Date().toISOString(),
            projects: JSON.parse(localStorage.getItem('engineeringProjects') || '[]'),
            contracts: JSON.parse(localStorage.getItem('engineeringContracts') || '[]'),
            inspections: JSON.parse(localStorage.getItem('engineeringInspections') || '[]'),
            costEstimations: JSON.parse(localStorage.getItem('engineeringCostEstimations') || '[]'),
            aiResults: JSON.parse(localStorage.getItem('engineeringAIResults') || '[]'),
            files: JSON.parse(localStorage.getItem('engineeringFiles') || '[]').map(f => ({
                ...f,
                content: null // Exclude content for size
            })),
            settings: {
                theme: localStorage.getItem('selectedTheme'),
                aiSettings: JSON.parse(localStorage.getItem('aiSettings') || '{}')
            }
        };
        
        const backupJson = JSON.stringify(backupData, null, 2);
        const filename = `engineering-backup-${new Date().toISOString().split('T')[0]}.json`;
        
        // Send backup message
        const backupMessage = ` *Automated Backup*\n\n` +
            ` Date: ${new Date().toLocaleDateString()}\n` +
            ` Projects: ${backupData.projects.length}\n` +
            ` Files: ${backupData.files.length}\n` +
            ` Inspections: ${backupData.inspections.length}\n` +
            ` Cost Estimates: ${backupData.costEstimations.length}\n\n` +
            ` Backup file attached below.`;
        
        await sendTelegramMessage(backupMessage);
        await sendTelegramFile(backupJson, filename);
        
        showMessage('Backup sent to Telegram successfully', 'success');
        logActivity('Telegram Backup', 'Full platform backup sent via Telegram');
        
    } catch (error) {
        console.error('Telegram backup failed:', error);
        showMessage('Failed to create Telegram backup', 'error');
    }
}

function scheduleAutomaticBackup() {
    // Schedule daily backups
    const now = new Date();
    const tomorrow = new Date(now);
    tomorrow.setDate(tomorrow.getDate() + 1);
    tomorrow.setHours(2, 0, 0, 0); // 2 AM
    
    const msUntilTomorrow = tomorrow.getTime() - now.getTime();
    
    setTimeout(() => {
        createTelegramBackup();
        // Schedule next backup
        setInterval(createTelegramBackup, 24 * 60 * 60 * 1000); // Daily
    }, msUntilTomorrow);
}

// ===================================
// MAP INTEGRATION VIA TELEGRAM
// ===================================

function handleLocationCommand(chatId, messageText) {
    // Send current platform location or request user location
    const locationMessage = ` *Location Services*\n\n` +
        ` Share your location to:\n` +
        ` Find nearby projects\n` +
        ` Get weather updates\n` +
        ` Locate construction sites\n\n` +
        `Use the location button below or send coordinates.`;
    
    sendTelegramMessage(locationMessage, 'text', null, chatId);
}

async function processLocationFromTelegram(location) {
    const { latitude, longitude } = location;
    
    // Find nearby projects
    const projects = JSON.parse(localStorage.getItem('engineeringProjects') || '[]');
    const nearbyProjects = projects.filter(project => {
        if (!project.coordinates) return false;
        
        const distance = calculateDistance(
            latitude, longitude,
            project.coordinates[0], project.coordinates[1]
        );
        
        return distance < 10; // Within 10km
    });
    
    let responseMessage = ` *Location Received*\n` +
        `Coordinates: ${latitude.toFixed(6)}, ${longitude.toFixed(6)}\n\n`;
    
    if (nearbyProjects.length > 0) {
        responseMessage += ` *Nearby Projects (${nearbyProjects.length}):*\n`;
        nearbyProjects.forEach(project => {
            responseMessage += ` ${project.name} - ${project.location}\n`;
        });
    } else {
        responseMessage += `No projects found within 10km of your location.`;
    }
    
    await sendTelegramMessage(responseMessage);
    
    // Get weather for location
    await sendWeatherUpdate(latitude, longitude);
}

async function sendWeatherUpdate(lat, lng) {
    // Mock weather data
    const weatherData = {
        temperature: Math.round(Math.random() * 30 + 10),
        humidity: Math.round(Math.random() * 40 + 40),
        condition: ['Sunny', 'Cloudy', 'Rainy', 'Partly Cloudy'][Math.floor(Math.random() * 4)],
        windSpeed: Math.round(Math.random() * 20 + 5)
    };
    
    const weatherMessage = ` *Weather Update*\n\n` +
        ` Location: ${lat.toFixed(4)}, ${lng.toFixed(4)}\n` +
        ` Temperature: ${weatherData.temperature}C\n` +
        ` Humidity: ${weatherData.humidity}%\n` +
        ` Condition: ${weatherData.condition}\n` +
        ` Wind: ${weatherData.windSpeed} km/h\n\n` +
        `Suitable for outdoor construction work.`;
    
    await sendTelegramMessage(weatherMessage);
}

// ===================================
// TELEGRAM MESSAGE HANDLING
// ===================================

async function sendTelegramMessage(text, type = 'text', attachment = null, chatId = null) {
    const message = {
        chat_id: chatId || telegramConfig.chatId,
        text: text,
        parse_mode: 'Markdown'
    };
    
    // Add to queue for processing
    telegramBot.messageQueue.push({
        message,
        type,
        attachment,
        timestamp: new Date().toISOString()
    });
    
    // For demo, just log
    console.log('Telegram message queued:', text);
    
    return new Promise((resolve) => {
        setTimeout(resolve, 500);
    });
}

function processTelegramQueue() {
    if (telegramBot.messageQueue.length === 0) return;
    
    const message = telegramBot.messageQueue.shift();
    console.log('Processing Telegram message:', message.message.text);
    
    // In production, send via Telegram Bot API
    // For demo, simulate processing
}

function updateTelegramStatus() {
    const statusElements = document.querySelectorAll('.telegram-connection-status');
    statusElements.forEach(element => {
        element.textContent = telegramBot.connected ? 'Connected' : 'Disconnected';
        element.className = `telegram-connection-status ${telegramBot.connected ? 'connected' : 'disconnected'}`;
    });
}

// ===================================
// UTILITY FUNCTIONS
// ===================================

function calculateDistance(lat1, lng1, lat2, lng2) {
    const R = 6371; // Earth's radius in km
    const dLat = (lat2 - lat1) * Math.PI / 180;
    const dLng = (lng2 - lng1) * Math.PI / 180;
    const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
        Math.cos(lat1 * Math.PI / 180) * Math.cos(lat2 * Math.PI / 180) *
        Math.sin(dLng/2) * Math.sin(dLng/2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
    return R * c;
}

function generateDetailedReport(period) {
    return {
        period,
        generated: new Date().toISOString(),
        summary: generatePlatformSummary(period),
        activities: JSON.parse(localStorage.getItem('activities') || '[]').slice(0, 50)
    };
}

function loadTelegramSettings() {
    // Load settings from localStorage
    const settings = JSON.parse(localStorage.getItem('telegramSettings') || '{}');
    telegramConfig = { ...telegramConfig, ...settings };
}

function saveTelegramSettings() {
    localStorage.setItem('telegramSettings', JSON.stringify(telegramConfig));
}

// ===================================
// ENHANCED FUNCTIONS FOR OTHER MODULES
// ===================================

// Override file sharing to include Telegram option
function enhancedSendTelegramShare(shareRecord, file) {
    sendFileViaTelegram(file.id, shareRecord.sharedWith);
}

// Override AI image upload to include Telegram analysis
function enhancedHandleAIImageUpload(event) {
    const files = event.target.files;
    
    Array.from(files).forEach(async (file) => {
        // Original AI processing
        if (typeof handleAIImageUpload === 'function') {
            handleAIImageUpload(event);
        }
        
        // Enhanced Telegram AI analysis
        const imageData = await fileToBase64(file);
        const metadata = {
            filename: file.name,
            size: file.size,
            uploadTime: new Date().toISOString()
        };
        
        await sendImageToTelegramAI(imageData, metadata);
    });
}

// Auto-schedule backups
scheduleAutomaticBackup();

// Export for global use
window.telegramIntegration = {
    sendFileViaTelegram,
    createTelegramBackup,
    sendImageToTelegramAI,
    sendDailySummaryReport,
    saveTelegramSettings,
    loadTelegramSettings
};

// Initialize chat system
document.addEventListener('DOMContentLoaded', function() {
    initializeChatSystem();
    loadChatSettings();
    loadChatHistory();
    setupChatEventListeners();
});

// ===================================
// CHAT INITIALIZATION
// ===================================

function initializeChatSystem() {
    // For demo purposes, simulate WebSocket connection
    // In production, use actual WebSocket server
    setupMockWebSocket();
    
    // Load saved conversations
    loadConversations();
    
    // Initialize chat UI
    updateConversationsList();
    
    // Setup file download directory
    setupFileDownloadDirectory();
}

function setupMockWebSocket() {
    // Mock WebSocket for demo
    chatSocket = {
        send: function(data) {
            console.log('Mock send:', data);
            // Simulate echo back for demo
            setTimeout(() => {
                const message = JSON.parse(data);
                if (message.type === 'chat_message') {
                    simulateIncomingMessage(message);
                }
            }, 500);
        },
        close: function() {
            chatConnected = false;
            updateConnectionStatus();
        }
    };
    
    chatConnected = true;
    updateConnectionStatus();
    
    console.log('Mock chat system initialized');
}

function connectToRealTimeChat() {
    // For production WebSocket connection
    const wsUrl = 'wss://your-websocket-server/chat';
    
    try {
        chatSocket = new WebSocket(wsUrl);
        
        chatSocket.onopen = function() {
            chatConnected = true;
            updateConnectionStatus();
            console.log('Connected to chat server');
        };
        
        chatSocket.onmessage = function(event) {
            const message = JSON.parse(event.data);
            handleIncomingMessage(message);
        };
        
        chatSocket.onclose = function() {
            chatConnected = false;
            updateConnectionStatus();
            // Attempt to reconnect after 5 seconds
            setTimeout(connectToRealTimeChat, 5000);
        };
        
        chatSocket.onerror = function(error) {
            console.error('Chat connection error:', error);
            chatConnected = false;
            updateConnectionStatus();
        };
        
    } catch (error) {
        console.error('Failed to connect to chat server:', error);
        // Fall back to mock system
        setupMockWebSocket();
    }
}

// ===================================
// CHAT UI MANAGEMENT
// ===================================

function openChatPanel() {
    const panel = document.getElementById('chat-panel');
    if (panel) {
        panel.classList.add('active');
        loadConversations();
        updateConversationsList();
    }
}

function closeChatPanel() {
    const panel = document.getElementById('chat-panel');
    if (panel) {
        panel.classList.remove('active');
    }
}

function minimizeChatPanel() {
    const panel = document.getElementById('chat-panel');
    if (panel) {
        panel.classList.toggle('minimized');
    }
}

function updateConnectionStatus() {
    const statusElements = document.querySelectorAll('.chat-connection-status');
    statusElements.forEach(element => {
        element.textContent = chatConnected ? 'Connected' : 'Disconnected';
        element.className = `chat-connection-status ${chatConnected ? 'connected' : 'disconnected'}`;
    });
}

// ===================================
// CONVERSATION MANAGEMENT
// ===================================

function loadConversations() {
    const stored = localStorage.getItem('chatConversations');
    if (stored) {
        try {
            conversations = JSON.parse(stored);
        } catch (error) {
            console.error('Error loading conversations:', error);
            conversations = [];
        }
    }
}

function saveConversations() {
    try {
        localStorage.setItem('chatConversations', JSON.stringify(conversations));
    } catch (error) {
        console.error('Error saving conversations:', error);
    }
}

function updateConversationsList() {
    const container = document.getElementById('conversation-list');
    if (!container) return;
    
    container.innerHTML = '';
    
    conversations.forEach(conversation => {
        const element = document.createElement('div');
        element.className = `conversation-item ${currentConversation?.id === conversation.id ? 'active' : ''}`;
        element.onclick = () => selectConversation(conversation.id);
        
        const lastMessage = conversation.messages[conversation.messages.length - 1];
        const lastMessageText = lastMessage ? 
            (lastMessage.type === 'text' ? lastMessage.content : `[${lastMessage.type}]`) : 
            'No messages';
        
        element.innerHTML = `
            <div class="conversation-avatar">
                <i class="fas fa-user"></i>
            </div>
            <div class="conversation-info">
                <div class="conversation-name">${conversation.name}</div>
                <div class="conversation-last-message">${lastMessageText}</div>
                <div class="conversation-time">${lastMessage ? formatTime(lastMessage.timestamp) : ''}</div>
            </div>
            ${conversation.unreadCount > 0 ? `<div class="unread-badge">${conversation.unreadCount}</div>` : ''}
        `;
        
        container.appendChild(element);
    });
}

function selectConversation(conversationId) {
    const conversation = conversations.find(c => c.id === conversationId);
    if (!conversation) return;
    
    currentConversation = conversation;
    conversation.unreadCount = 0;
    
    updateConversationsList();
    loadChatMessages();
    saveConversations();
}

function startNewConversation() {
    const participantEmail = prompt('Enter participant email or username:');
    if (!participantEmail) return;
    
    const newConversation = {
        id: generateChatId(),
        name: participantEmail,
        participants: [currentUser.email, participantEmail],
        messages: [],
        createdAt: new Date().toISOString(),
        unreadCount: 0
    };
    
    conversations.push(newConversation);
    saveConversations();
    updateConversationsList();
    selectConversation(newConversation.id);
    
    showMessage(`Started new conversation with ${participantEmail}`, 'success');
}

// ===================================
// MESSAGE HANDLING
// ===================================

function loadChatMessages() {
    const container = document.getElementById('chat-messages');
    if (!container || !currentConversation) return;
    
    container.innerHTML = '';
    
    currentConversation.messages.forEach(message => {
        const messageElement = createMessageElement(message);
        container.appendChild(messageElement);
    });
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

function createMessageElement(message) {
    const element = document.createElement('div');
    element.className = `message ${message.senderId === currentUser.id ? 'sent' : 'received'}`;
    
    let content = '';
    
    switch (message.type) {
        case 'text':
            content = `<p>${escapeHtml(message.content)}</p>`;
            break;
        case 'file':
            content = createFileMessageContent(message);
            break;
        case 'photo':
            content = createPhotoMessageContent(message);
            break;
        case 'location':
            content = createLocationMessageContent(message);
            break;
    }
    
    element.innerHTML = `
        <div class="message-content">
            ${content}
        </div>
        <div class="message-meta">
            <span class="message-time">${formatTime(message.timestamp)}</span>
            ${message.senderId === currentUser.id ? '<i class="fas fa-check message-status"></i>' : ''}
        </div>
    `;
    
    return element;
}

function createFileMessageContent(message) {
    const fileInfo = message.fileInfo;
    return `
        <div class="file-message">
            <div class="file-icon">
                <i class="fas fa-file"></i>
            </div>
            <div class="file-details">
                <div class="file-name">${fileInfo.name}</div>
                <div class="file-size">${formatFileSize(fileInfo.size)}</div>
            </div>
            <button class="btn btn-sm btn-primary" onclick="downloadChatFile('${message.id}')">
                <i class="fas fa-download"></i>
            </button>
        </div>
    `;
}

function createPhotoMessageContent(message) {
    return `
        <div class="photo-message">
            <img src="${message.content}" alt="Shared photo" onclick="openPhotoModal('${message.content}')">
            <button class="btn btn-sm btn-primary" onclick="downloadChatPhoto('${message.id}')">
                <i class="fas fa-download"></i>
            </button>
        </div>
    `;
}

function createLocationMessageContent(message) {
    const location = message.location;
    return `
        <div class="location-message">
            <div class="location-info">
                <i class="fas fa-map-marker-alt"></i>
                <div>
                    <div class="location-coords">${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}</div>
                    <div class="location-address">${location.address || 'Unknown location'}</div>
                </div>
            </div>
            <button class="btn btn-sm btn-primary" onclick="openLocationOnMap(${location.lat}, ${location.lng})">
                <i class="fas fa-map"></i> Open on Map
            </button>
        </div>
    `;
}

function sendMessage() {
    const input = document.getElementById('chat-message-input');
    const messageText = input.value.trim();
    
    if (!messageText || !currentConversation) return;
    
    const message = {
        id: generateChatId(),
        conversationId: currentConversation.id,
        senderId: currentUser.id,
        senderName: currentUser.email,
        type: 'text',
        content: messageText,
        timestamp: new Date().toISOString()
    };
    
    // Add to current conversation
    currentConversation.messages.push(message);
    saveConversations();
    
    // Update UI
    loadChatMessages();
    input.value = '';
    
    // Send to server (or mock)
    sendToChat(message);
    
    // Log activity
    logActivity('Chat Message', `Sent message to ${currentConversation.name}`);
}

function sendToChat(message) {
    if (chatSocket && chatConnected) {
        chatSocket.send(JSON.stringify(message));
    }
    
    // Save to offline storage
    saveChatMessageOffline(message);
}

function handleIncomingMessage(message) {
    const conversation = conversations.find(c => c.id === message.conversationId);
    if (!conversation) {
        // Create new conversation if it doesn't exist
        createConversationFromMessage(message);
        return;
    }
    
    // Add message to conversation
    conversation.messages.push(message);
    
    // Update unread count if not current conversation
    if (currentConversation?.id !== conversation.id) {
        conversation.unreadCount = (conversation.unreadCount || 0) + 1;
    }
    
    saveConversations();
    updateConversationsList();
    
    // Update messages if this is the current conversation
    if (currentConversation?.id === conversation.id) {
        loadChatMessages();
    }
    
    // Show notification
    showChatNotification(message, conversation);
    
    // Save offline
    saveChatMessageOffline(message);
}

function simulateIncomingMessage(originalMessage) {
    // Simulate a response for demo
    const response = {
        id: generateChatId(),
        conversationId: originalMessage.conversationId,
        senderId: 'demo-other-user',
        senderName: 'Demo User',
        type: 'text',
        content: `Echo: ${originalMessage.content}`,
        timestamp: new Date().toISOString()
    };
    
    handleIncomingMessage(response);
}

// ===================================
// FILE ATTACHMENTS
// ===================================

function attachFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = fileStorageConfig.allowedExtensions.map(ext => `.${ext}`).join(',');
    
    input.onchange = function(e) {
        const files = Array.from(e.target.files);
        files.forEach(file => sendFileMessage(file));
    };
    
    input.click();
}

async function sendFileMessage(file) {
    if (!currentConversation) return;
    
    if (!validateFile(file)) return;
    
    try {
        // Convert file to base64 for storage
        const fileData = await fileToBase64(file);
        
        const message = {
            id: generateChatId(),
            conversationId: currentConversation.id,
            senderId: currentUser.id,
            senderName: currentUser.email,
            type: 'file',
            content: fileData,
            fileInfo: {
                name: file.name,
                size: file.size,
                type: file.type
            },
            timestamp: new Date().toISOString()
        };
        
        // Add to conversation
        currentConversation.messages.push(message);
        saveConversations();
        
        // Update UI
        loadChatMessages();
        
        // Send to chat
        sendToChat(message);
        
        showMessage(`File ${file.name} sent successfully`, 'success');
        
    } catch (error) {
        console.error('Error sending file:', error);
        showMessage(`Failed to send file ${file.name}`, 'error');
    }
}

function attachPhoto() {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.capture = 'environment'; // Prefer rear camera on mobile
    
    input.onchange = function(e) {
        const file = e.target.files[0];
        if (file) {
            sendPhotoMessage(file);
        }
    };
    
    input.click();
}

async function sendPhotoMessage(file) {
    if (!currentConversation) return;
    
    try {
        // Extract EXIF data if available
        const exifData = await extractPhotoMetadata(file);
        
        // Convert to base64
        const photoData = await fileToBase64(file);
        
        const message = {
            id: generateChatId(),
            conversationId: currentConversation.id,
            senderId: currentUser.id,
            senderName: currentUser.email,
            type: 'photo',
            content: photoData,
            photoInfo: {
                name: file.name,
                size: file.size,
                exif: exifData
            },
            timestamp: new Date().toISOString()
        };
        
        // Add to conversation
        currentConversation.messages.push(message);
        saveConversations();
        
        // Update UI
        loadChatMessages();
        
        // Send to chat
        sendToChat(message);
        
        showMessage('Photo sent successfully', 'success');
        
    } catch (error) {
        console.error('Error sending photo:', error);
        showMessage('Failed to send photo', 'error');
    }
}

// ===================================
// LOCATION SHARING
// ===================================

function shareLocation() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Share Location</h3>
            <div class="location-options">
                <button class="btn btn-primary" onclick="shareCurrentLocation()">
                    <i class="fas fa-crosshairs"></i> Current Location
                </button>
                <button class="btn btn-secondary" onclick="shareManualLocation()">
                    <i class="fas fa-map-pin"></i> Enter Coordinates
                </button>
                <button class="btn btn-info" onclick="shareGoogleMapsLink()">
                    <i class="fas fa-external-link-alt"></i> Google Maps Link
                </button>
            </div>
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeLocationModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function shareCurrentLocation() {
    if (!navigator.geolocation) {
        showMessage('Geolocation is not supported by this browser', 'error');
        return;
    }
    
    navigator.geolocation.getCurrentPosition(
        position => {
            const location = {
                lat: position.coords.latitude,
                lng: position.coords.longitude,
                accuracy: position.coords.accuracy
            };
            
            sendLocationMessage(location);
            closeLocationModal();
        },
        error => {
            showMessage('Error getting location: ' + error.message, 'error');
        }
    );
}

function shareManualLocation() {
    const lat = prompt('Enter latitude:');
    const lng = prompt('Enter longitude:');
    
    if (lat && lng) {
        const location = {
            lat: parseFloat(lat),
            lng: parseFloat(lng)
        };
        
        if (!isNaN(location.lat) && !isNaN(location.lng)) {
            sendLocationMessage(location);
            closeLocationModal();
        } else {
            showMessage('Invalid coordinates', 'error');
        }
    }
}

function shareGoogleMapsLink() {
    const link = prompt('Paste Google Maps link:');
    if (!link) return;
    
    const location = parseGoogleMapsLink(link);
    if (location) {
        sendLocationMessage(location);
        closeLocationModal();
    } else {
        showMessage('Invalid Google Maps link. Please use links with coordinates.', 'error');
    }
}

function sendLocationMessage(location) {
    if (!currentConversation) return;
    
    const message = {
        id: generateChatId(),
        conversationId: currentConversation.id,
        senderId: currentUser.id,
        senderName: currentUser.email,
        type: 'location',
        content: `Location: ${location.lat.toFixed(6)}, ${location.lng.toFixed(6)}`,
        location: location,
        timestamp: new Date().toISOString()
    };
    
    // Add to conversation
    currentConversation.messages.push(message);
    saveConversations();
    
    // Update UI
    loadChatMessages();
    
    // Send to chat
    sendToChat(message);
    
    showMessage('Location shared successfully', 'success');
}

function parseGoogleMapsLink(link) {
    // Parse different Google Maps link formats
    let match;
    
    // Format: ?q=lat,lng
    match = link.match(/[?&]q=(-?\d+\.?\d*),(-?\d+\.?\d*)/);
    if (match) {
        return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
    }
    
    // Format: @lat,lng
    match = link.match(/@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
    if (match) {
        return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
    }
    
    // Format: /maps/place/.../@lat,lng
    match = link.match(/\/maps\/place\/[^@]*@(-?\d+\.?\d*),(-?\d+\.?\d*)/);
    if (match) {
        return { lat: parseFloat(match[1]), lng: parseFloat(match[2]) };
    }
    
    return null;
}

function closeLocationModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ===================================
// OFFLINE STORAGE
// ===================================

function saveChatMessageOffline(message) {
    if (!chatSettings.saveToLocalStorage) return;
    
    const offlineMessages = JSON.parse(localStorage.getItem('chatMessagesOffline') || '[]');
    offlineMessages.push(message);
    
    // Keep only last 1000 messages
    if (offlineMessages.length > 1000) {
        offlineMessages.splice(0, offlineMessages.length - 1000);
    }
    
    localStorage.setItem('chatMessagesOffline', JSON.stringify(offlineMessages));
}

function loadChatHistory() {
    // Load chat history from localStorage
    const history = JSON.parse(localStorage.getItem('chatMessagesOffline') || '[]');
    
    // Organize messages by conversation
    history.forEach(message => {
        const conversation = conversations.find(c => c.id === message.conversationId);
        if (conversation) {
            // Check if message already exists to avoid duplicates
            const exists = conversation.messages.find(m => m.id === message.id);
            if (!exists) {
                conversation.messages.push(message);
            }
        }
    });
    
    // Sort messages by timestamp
    conversations.forEach(conversation => {
        conversation.messages.sort((a, b) => new Date(a.timestamp) - new Date(b.timestamp));
    });
    
    saveConversations();
}

// ===================================
// FILE DOWNLOAD MANAGEMENT
// ===================================

function setupFileDownloadDirectory() {
    // For web browsers, we can't set a specific download directory
    // But we can provide naming conventions
    const savedDirectory = localStorage.getItem('chatDownloadDirectory');
    if (savedDirectory) {
        chatSettings.downloadDirectory = savedDirectory;
    }
}

function downloadChatFile(messageId) {
    const message = findMessageById(messageId);
    if (!message || message.type !== 'file') {
        showMessage('File not found', 'error');
        return;
    }
    
    try {
        // Create download link
        const link = document.createElement('a');
        link.href = message.content; // Base64 data URL
        
        // Generate filename with timestamp
        const timestamp = new Date(message.timestamp).toISOString().replace(/[:.]/g, '-').split('T');
        const dateStr = timestamp[0];
        const timeStr = timestamp[1].split('.')[0].replace(/-/g, '');
        const fileName = `chat_${message.fileInfo.name.split('.')[0]}_${dateStr}_${timeStr}.${message.fileInfo.name.split('.').pop()}`;
        
        link.download = fileName;
        link.click();
        
        showMessage(`Downloaded ${fileName}`, 'success');
        logActivity('File Download', `Downloaded chat file: ${fileName}`);
        
    } catch (error) {
        console.error('Download failed:', error);
        showMessage('Failed to download file', 'error');
    }
}

function downloadChatPhoto(messageId) {
    const message = findMessageById(messageId);
    if (!message || message.type !== 'photo') {
        showMessage('Photo not found', 'error');
        return;
    }

    try {
        // Create download link for photo
        const link = document.createElement('a');
        link.href = message.content; // Base64 data URL

        // Generate filename with timestamp
        const timestamp = new Date(message.timestamp).toISOString().replace(/[:.]/g, '-').split('T');
        const dateStr = timestamp[0];
        const timeStr = timestamp[1].split('.')[0].replace(/-/g, '');
        const fileName = `chat_photo_${dateStr}_${timeStr}.jpg`;

        link.download = fileName;
        link.click();

        showMessage(`Downloaded ${fileName}`, 'success');
        logActivity('Photo Download', `Downloaded chat photo: ${fileName}`);

    } catch (error) {
        console.error('Photo download failed:', error);
        showMessage('Failed to download photo', 'error');
    }
}

// Missing utility functions for chat system
function generateChatId() {
    return 'chat_' + Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function findMessageById(messageId) {
    for (const conversation of conversations) {
        const message = conversation.messages.find(m => m.id === messageId);
        if (message) return message;
    }
    return null;
}

function formatTime(timestamp) {
    const date = new Date(timestamp);
    const now = new Date();
    const diffInHours = (now - date) / (1000 * 60 * 60);
    
    if (diffInHours < 24) {
        return date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    } else if (diffInHours < 24 * 7) {
        return date.toLocaleDateString([], { weekday: 'short', hour: '2-digit', minute: '2-digit' });
    } else {
        return date.toLocaleDateString([], { month: 'short', day: 'numeric', hour: '2-digit', minute: '2-digit' });
    }
}

function formatFileSize(bytes) {
    if (bytes === 0) return '0 Bytes';
    const k = 1024;
    const sizes = ['Bytes', 'KB', 'MB', 'GB'];
    const i = Math.floor(Math.log(bytes) / Math.log(k));
    return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
}

function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

function extractPhotoMetadata(file) {
    return new Promise((resolve) => {
        if (window.EXIF && window.EXIF.getData) {
            window.EXIF.getData(file, function() {
                const exifData = {
                    make: window.EXIF.getTag(this, 'Make'),
                    model: window.EXIF.getTag(this, 'Model'),
                    dateTime: window.EXIF.getTag(this, 'DateTime'),
                    gps: {
                        lat: window.EXIF.getTag(this, 'GPSLatitude'),
                        lng: window.EXIF.getTag(this, 'GPSLongitude'),
                        latRef: window.EXIF.getTag(this, 'GPSLatitudeRef'),
                        lngRef: window.EXIF.getTag(this, 'GPSLongitudeRef')
                    }
                };
                resolve(exifData);
            });
        } else {
            resolve({});
        }
    });
}

function createConversationFromMessage(message) {
    const newConversation = {
        id: message.conversationId,
        name: message.senderName,
        participants: [message.senderId, currentUser.id],
        messages: [message],
        createdAt: message.timestamp,
        unreadCount: 1
    };
    
    conversations.push(newConversation);
    saveConversations();
    updateConversationsList();
}

function showChatNotification(message, conversation) {
    // Don't show notification for own messages
    if (message.senderId === currentUser.id) return;
    
    let title = `New message from ${message.senderName}`;
    let body = '';
    
    switch (message.type) {
        case 'text':
            body = message.content;
            break;
        case 'file':
            body = `Sent a file: ${message.fileInfo.name}`;
            break;
        case 'photo':
            body = 'Sent a photo';
            break;
        case 'location':
            body = 'Shared location';
            break;
    }
    
    // Show in-app notification
    showNotification(title, body, 'info');
    
    // Play notification sound if enabled
    if (chatSettings.notificationSound) {
        playNotificationSound();
    }
    
    // Browser notification
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: body,
            icon: '/favicon.ico',
            tag: `chat-${message.conversationId}`
        });
    }
}

function playNotificationSound() {
    // Create a simple notification sound
    const audioContext = window.AudioContext || window.webkitAudioContext;
    if (audioContext) {
        const context = new audioContext();
        const oscillator = context.createOscillator();
        const gainNode = context.createGain();
        
        oscillator.connect(gainNode);
        gainNode.connect(context.destination);
        
        oscillator.frequency.setValueAtTime(800, context.currentTime);
        oscillator.frequency.setValueAtTime(600, context.currentTime + 0.1);
        
        gainNode.gain.setValueAtTime(0.1, context.currentTime);
        gainNode.gain.exponentialRampToValueAtTime(0.01, context.currentTime + 0.2);
        
        oscillator.start(context.currentTime);
        oscillator.stop(context.currentTime + 0.2);
    }
}

// ===================================
// CHAT SETTINGS
// ===================================

function loadChatSettings() {
    const saved = localStorage.getItem('chatSettings');
    if (saved) {
        try {
            chatSettings = { ...chatSettings, ...JSON.parse(saved) };
        } catch (error) {
            console.error('Error loading chat settings:', error);
        }
    }
}

function saveChatSettings() {
    localStorage.setItem('chatSettings', JSON.stringify(chatSettings));
}

function openChatSettings() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Chat Settings</h3>
            <div class="settings-section">
                <div class="form-check">
                    <input type="checkbox" id="chat-auto-download" ${chatSettings.autoDownload ? 'checked' : ''}>
                    <label for="chat-auto-download">Auto-download files</label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" id="chat-notification-sound" ${chatSettings.notificationSound ? 'checked' : ''}>
                    <label for="chat-notification-sound">Notification sound</label>
                </div>
                
                <div class="form-check">
                    <input type="checkbox" id="chat-save-local" ${chatSettings.saveToLocalStorage ? 'checked' : ''}>
                    <label for="chat-save-local">Save messages locally</label>
                </div>
                
                <div class="mb-3">
                    <label>Download naming pattern:</label>
                    <select id="chat-naming-pattern" class="form-control">
                        <option value="timestamp">filename_YYYY-MM-DD_HHMM</option>
                        <option value="simple">filename</option>
                        <option value="detailed">chat_filename_sender_timestamp</option>
                    </select>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="saveChatSettingsModal()">Save</button>
                <button class="btn btn-secondary" onclick="closeChatSettingsModal()">Cancel</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function saveChatSettingsModal() {
    chatSettings.autoDownload = document.getElementById('chat-auto-download').checked;
    chatSettings.notificationSound = document.getElementById('chat-notification-sound').checked;
    chatSettings.saveToLocalStorage = document.getElementById('chat-save-local').checked;
    
    saveChatSettings();
    closeChatSettingsModal();
    showMessage('Chat settings saved', 'success');
}

function closeChatSettingsModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

function openLocationOnMap(lat, lng) {
    // If mapping page exists, switch to it and center on location
    if (typeof showPage === 'function') {
        showPage('mapping-page');
        
        // Wait for map to initialize then center on location
        setTimeout(() => {
            if (window.map) {
                map.setView([lat, lng], 15);
                L.marker([lat, lng])
                    .addTo(map)
                    .bindPopup('Shared location from chat')
                    .openPopup();
            }
        }, 500);
    } else {
        // Open in external map
        const url = `https://maps.google.com/?q=${lat},${lng}`;
        window.open(url, '_blank');
    }
}

function openPhotoModal(photoSrc) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay photo-modal';
    modal.innerHTML = `
        <div class="modal-content photo-modal-content">
            <button class="modal-close-btn" onclick="this.closest('.modal-overlay').remove()"></button>
            <img src="${photoSrc}" alt="Shared photo" style="max-width: 100%; max-height: 90vh;">
        </div>
    `;
    
    document.body.appendChild(modal);
    
    // Close on click outside
    modal.addEventListener('click', function(e) {
        if (e.target === modal) {
            modal.remove();
        }
    });
}

// Setup event listeners
function setupChatEventListeners() {
    // Enter key to send message
    document.addEventListener('keypress', function(e) {
        if (e.target.id === 'chat-message-input' && e.key === 'Enter') {
            e.preventDefault();
            sendMessage();
        }
    });
    
    // Auto-resize chat input
    const chatInput = document.getElementById('chat-message-input');
    if (chatInput) {
        chatInput.addEventListener('input', function() {
            this.style.height = 'auto';
            this.style.height = Math.min(this.scrollHeight, 100) + 'px';
        });
    }
}

// Export functions for use in other modules
window.chatSystem = {
    openChatPanel,
    closeChatPanel,
    sendMessage,
    shareLocation,
    attachFile,
    attachPhoto
};

// Global enhanced variables
let supabaseClient;
let currentUser = null;
let fileStorageConfig = {
    baseUrl: '/storage/',
    maxFileSize: 20 * 1024 * 1024 * 1024, // 20GB
    allowedExtensions: ['pdf', 'xlsx', 'xls', 'dwg', 'dxf', 'jpg', 'jpeg', 'png', 'kml', 'kmz', 'csv'],
    contractFolders: ['Contracts', 'BOQ', 'GISReports', 'ChatMedia', 'Inspections', 'CostEstimations']
};

// Initialize enhanced features
document.addEventListener('DOMContentLoaded', function() {
    initializeSupabase();
    initializeEnhancedAuth();
    initializeFileManager();
    initializeThemeSystem();
    loadUserPreferences();
    setupMobileSupport();
    initializeNotificationSystem();
    checkPrintTooltips();
    
    // Load existing functionality
    if (typeof initializeApp === 'function') {
        initializeApp();
    }
});

// ===================================
// SUPABASE INTEGRATION
// ===================================

function initializeSupabase() {
    const supabaseUrl = 'YOUR_SUPABASE_URL_PLACEHOLDER';
    const supabaseKey = 'YOUR_SUPABASE_ANON_KEY_PLACEHOLDER';
    
    try {
        supabaseClient = window.supabase.createClient(supabaseUrl, supabaseKey);
        console.log('Supabase initialized successfully');
    } catch (error) {
        console.error('Supabase initialization failed:', error);
        // Fallback to localStorage for demo
        supabaseClient = createFallbackStorage();
    }
}

function createFallbackStorage() {
    return {
        auth: {
            getSession: () => Promise.resolve({ data: { session: null } }),
            signOut: () => Promise.resolve(),
            onAuthStateChange: (callback) => {
                // Simulate auth state
                setTimeout(() => callback('SIGNED_IN', { user: { email: 'demo@example.com' } }), 100);
                return { data: { subscription: { unsubscribe: () => {} } } };
            }
        },
        from: (table) => ({
            select: () => ({ data: [], error: null }),
            insert: () => ({ data: [], error: null }),
            update: () => ({ data: [], error: null }),
            delete: () => ({ data: [], error: null })
        })
    };
}

// ===================================
// ENHANCED AUTHENTICATION
// ===================================

function initializeEnhancedAuth() {
    // Check for existing session
    checkAuthState();
    
    // Setup auth state listener
    if (supabaseClient && supabaseClient.auth) {
        supabaseClient.auth.onAuthStateChange((event, session) => {
            if (event === 'SIGNED_IN') {
                currentUser = session.user;
                updateUserInterface();
                loadUserData();
            } else if (event === 'SIGNED_OUT') {
                currentUser = null;
                redirectToLogin();
            }
        });
    }
}

async function checkAuthState() {
    try {
        const { data: { session } } = await supabaseClient.auth.getSession();
        if (session) {
            currentUser = session.user;
            updateUserInterface();
            loadUserData();
        } else {
            // For demo purposes, create a mock user
            currentUser = { email: 'demo@example.com', id: 'demo-user-id' };
            updateUserInterface();
        }
    } catch (error) {
        console.error('Auth check failed:', error);
        // Fallback for demo
        currentUser = { email: 'demo@example.com', id: 'demo-user-id' };
        updateUserInterface();
    }
}

function updateUserInterface() {
    if (currentUser) {
        const userNameElement = document.getElementById('user-name');
        if (userNameElement) {
            userNameElement.textContent = currentUser.email || 'Demo User';
        }
    }
}

async function logout() {
    try {
        await supabaseClient.auth.signOut();
        redirectToLogin();
    } catch (error) {
        console.error('Logout failed:', error);
        // Fallback redirect
        redirectToLogin();
    }
}

function redirectToLogin() {
    window.location.href = 'index.html';
}

// ===================================
// FILE MANAGEMENT SYSTEM
// ===================================

function initializeFileManager() {
    setupFileDropZones();
    loadProjectFolders();
    updateStorageStats();
}

function setupFileDropZones() {
    const dropZones = document.querySelectorAll('.upload-zone, .drop-zone');
    
    dropZones.forEach(zone => {
        zone.addEventListener('dragover', handleDragOver);
        zone.addEventListener('drop', handleFileDrop);
        zone.addEventListener('dragleave', handleDragLeave);
    });
}

function handleDragOver(e) {
    e.preventDefault();
    e.currentTarget.classList.add('drag-over');
}

function handleDragLeave(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
}

function handleFileDrop(e) {
    e.preventDefault();
    e.currentTarget.classList.remove('drag-over');
    
    const files = Array.from(e.dataTransfer.files);
    uploadFiles(files);
}

async function uploadFiles(files, contractNumber = null) {
    if (!contractNumber) {
        contractNumber = prompt('Enter contract number for file organization:') || 'GENERAL';
    }
    
    for (const file of files) {
        if (validateFile(file)) {
            await uploadSingleFile(file, contractNumber);
        }
    }
    
    updateFileManager();
    updateStorageStats();
}

function validateFile(file) {
    // Check file size
    if (file.size > fileStorageConfig.maxFileSize) {
        showMessage(`File ${file.name} is too large. Maximum size is 20GB.`, 'error');
        return false;
    }
    
    // Check file extension
    const extension = file.name.split('.').pop().toLowerCase();
    if (!fileStorageConfig.allowedExtensions.includes(extension)) {
        showMessage(`File type .${extension} is not allowed.`, 'error');
        return false;
    }
    
    return true;
}

async function uploadSingleFile(file, contractNumber) {
    const timestamp = new Date().toISOString().replace(/[:.]/g, '-').split('T');
    const dateStr = timestamp[0];
    const timeStr = timestamp[1].split('.')[0].replace(/-/g, '');
    
    const fileName = `${contractNumber}_${file.name.split('.')[0]}_${dateStr}_${timeStr}.${file.name.split('.').pop()}`;
    const folderPath = determineFolderPath(file, contractNumber);
    const fullPath = `${folderPath}/${fileName}`;
    
    try {
        // For demo, store file metadata in localStorage
        const fileMetadata = {
            id: generateId(),
            originalName: file.name,
            fileName: fileName,
            path: fullPath,
            size: file.size,
            type: file.type,
            contractNumber: contractNumber,
            uploadedBy: currentUser.id,
            uploadedAt: new Date().toISOString(),
            expiresAt: null, // Set when sharing
            isShared: false
        };
        
        // Store in localStorage for demo
        const storedFiles = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
        storedFiles.push(fileMetadata);
        localStorage.setItem('engineeringFiles', JSON.stringify(storedFiles));
        
        // Store actual file data (for demo - in production, use proper file storage)
        const fileData = await fileToBase64(file);
        localStorage.setItem(`file_${fileMetadata.id}`, fileData);
        
        showMessage(`File ${file.name} uploaded successfully as ${fileName}`, 'success');
        
        // Log activity
        logActivity('File Upload', `Uploaded ${fileName} to ${folderPath}`);
        
    } catch (error) {
        console.error('Upload failed:', error);
        showMessage(`Failed to upload ${file.name}`, 'error');
    }
}

function determineFolderPath(file, contractNumber) {
    const extension = file.name.split('.').pop().toLowerCase();
    
    let subFolder = 'GISReports'; // Default
    
    if (['pdf', 'doc', 'docx'].includes(extension)) {
        subFolder = 'Contracts';
    } else if (['xlsx', 'xls', 'csv'].includes(extension)) {
        subFolder = 'BOQ';
    } else if (['jpg', 'jpeg', 'png', 'gif'].includes(extension)) {
        subFolder = 'ChatMedia';
    } else if (['dwg', 'dxf', 'kml', 'kmz'].includes(extension)) {
        subFolder = 'GISReports';
    }
    
    return `/storage/${contractNumber}/${subFolder}`;
}

function fileToBase64(file) {
    return new Promise((resolve, reject) => {
        const reader = new FileReader();
        reader.readAsDataURL(file);
        reader.onload = () => resolve(reader.result);
        reader.onerror = error => reject(error);
    });
}

// ===================================
// FILE SHARING SYSTEM
// ===================================

function shareFile(fileId, options = {}) {
    const file = getFileById(fileId);
    if (!file) {
        showMessage('File not found', 'error');
        return;
    }
    
    const shareModal = createShareModal(file, options);
    document.body.appendChild(shareModal);
}

function createShareModal(file, options) {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3>Share File: ${file.originalName}</h3>
            <div class="share-options">
                <div class="mb-3">
                    <label>Share with:</label>
                    <select id="share-type" class="form-control">
                        <option value="internal">Internal User</option>
                        <option value="email">External Email</option>
                        <option value="whatsapp">WhatsApp</option>
                        <option value="telegram">Telegram</option>
                    </select>
                </div>
                
                <div class="mb-3">
                    <label>Recipient:</label>
                    <input type="text" id="share-recipient" class="form-control" placeholder="Enter email, phone, or username">
                </div>
                
                <div class="mb-3">
                    <label>Expiration Time:</label>
                    <select id="share-duration" class="form-control">
                        <option value="10">10 minutes</option>
                        <option value="30">30 minutes</option>
                        <option value="60">1 hour</option>
                        <option value="1440">24 hours</option>
                        <option value="10080">7 days</option>
                        <option value="custom">Custom</option>
                    </select>
                </div>
                
                <div id="custom-duration" class="mb-3" style="display: none;">
                    <input type="datetime-local" id="custom-expiry" class="form-control">
                </div>
                
                <div class="mb-3">
                    <label>Message (optional):</label>
                    <textarea id="share-message" class="form-control" rows="3" placeholder="Add a message..."></textarea>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-primary" onclick="executeFileShare('${file.id}')">Share File</button>
                <button class="btn btn-secondary" onclick="closeShareModal()">Cancel</button>
            </div>
        </div>
    `;
    
    // Setup event listeners
    modal.querySelector('#share-duration').addEventListener('change', function() {
        const customDiv = modal.querySelector('#custom-duration');
        customDiv.style.display = this.value === 'custom' ? 'block' : 'none';
    });
    
    return modal;
}

async function executeFileShare(fileId) {
    const file = getFileById(fileId);
    const shareType = document.getElementById('share-type').value;
    const recipient = document.getElementById('share-recipient').value;
    const duration = document.getElementById('share-duration').value;
    const message = document.getElementById('share-message').value;
    
    if (!recipient) {
        showMessage('Please enter a recipient', 'error');
        return;
    }
    
    // Calculate expiration time
    let expiresAt;
    if (duration === 'custom') {
        expiresAt = document.getElementById('custom-expiry').value;
    } else {
        const now = new Date();
        now.setMinutes(now.getMinutes() + parseInt(duration));
        expiresAt = now.toISOString();
    }
    
    try {
        // Create share record
        const shareRecord = {
            id: generateId(),
            fileId: fileId,
            sharedBy: currentUser.id,
            sharedWith: recipient,
            shareType: shareType,
            expiresAt: expiresAt,
            message: message,
            createdAt: new Date().toISOString(),
            accessCount: 0,
            isActive: true
        };
        
        // Store share record
        const shares = JSON.parse(localStorage.getItem('fileShares') || '[]');
        shares.push(shareRecord);
        localStorage.setItem('fileShares', JSON.stringify(shares));
        
        // Send notification based on share type
        await sendShareNotification(shareRecord, file);
        
        showMessage(`File shared successfully with ${recipient}`, 'success');
        closeShareModal();
        
        // Log activity
        logActivity('File Share', `Shared ${file.originalName} with ${recipient} via ${shareType}`);
        
    } catch (error) {
        console.error('Share failed:', error);
        showMessage('Failed to share file', 'error');
    }
}

async function sendShareNotification(shareRecord, file) {
    switch (shareRecord.shareType) {
        case 'email':
            await sendEmailShare(shareRecord, file);
            break;
        case 'whatsapp':
            await sendWhatsAppShare(shareRecord, file);
            break;
        case 'telegram':
            await sendTelegramShare(shareRecord, file);
            break;
        case 'internal':
            await sendInternalShare(shareRecord, file);
            break;
    }
}

function closeShareModal() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ===================================
// THEME SYSTEM
// ===================================

function initializeThemeSystem() {
    loadSavedTheme();
    setupThemeControls();
}

function loadSavedTheme() {
    const savedTheme = localStorage.getItem('selectedTheme') || 'light';
    const customBackground = localStorage.getItem('customBackground');
    const fontSize = localStorage.getItem('fontSize') || 'medium';
    const highContrast = localStorage.getItem('highContrast') === 'true';
    
    setTheme(savedTheme);
    if (customBackground) {
        setCustomBackground(customBackground);
    }
    adjustFontSize(fontSize);
    if (highContrast) {
        toggleHighContrast(true);
    }
}

function setTheme(themeName) {
    document.body.className = document.body.className.replace(/theme-\w+/g, '');
    document.body.classList.add(`theme-${themeName}`);
    localStorage.setItem('selectedTheme', themeName);
    
    // Update theme selector UI
    const themeOptions = document.querySelectorAll('.theme-option');
    themeOptions.forEach(option => {
        option.classList.remove('selected');
        if (option.onclick.toString().includes(themeName)) {
            option.classList.add('selected');
        }
    });
}

function handleBackgroundUpload(event) {
    const file = event.target.files[0];
    if (file) {
        const reader = new FileReader();
        reader.onload = function(e) {
            setCustomBackground(e.target.result);
            localStorage.setItem('customBackground', e.target.result);
        };
        reader.readAsDataURL(file);
    }
}

function setCustomBackground(imageData) {
    document.body.style.backgroundImage = `url(${imageData})`;
    document.body.style.backgroundSize = 'cover';
    document.body.style.backgroundAttachment = 'fixed';
}

function adjustFontSize(size) {
    document.body.className = document.body.className.replace(/font-size-\w+/g, '');
    document.body.classList.add(`font-size-${size}`);
    localStorage.setItem('fontSize', size);
}

function toggleHighContrast(enable) {
    if (enable) {
        document.body.classList.add('high-contrast');
    } else {
        document.body.classList.remove('high-contrast');
    }
    localStorage.setItem('highContrast', enable.toString());
}

// ===================================
// MOBILE SUPPORT
// ===================================

function setupMobileSupport() {
    detectMobileDevice();
    setupMobileNavigation();
    setupTouchGestures();
}

function detectMobileDevice() {
    const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
    if (isMobile) {
        document.body.classList.add('mobile-device');
    }
}

function toggleMobileNav() {
    const sidebar = document.getElementById('main-sidebar');
    if (sidebar) {
        sidebar.classList.toggle('mobile-open');
    }
}

function setupMobileNavigation() {
    // Close mobile nav when clicking outside
    document.addEventListener('click', function(e) {
        const sidebar = document.getElementById('main-sidebar');
        const toggleBtn = document.querySelector('.mobile-nav-toggle');
        
        if (sidebar && sidebar.classList.contains('mobile-open')) {
            if (!sidebar.contains(e.target) && !toggleBtn.contains(e.target)) {
                sidebar.classList.remove('mobile-open');
            }
        }
    });
}

function setupTouchGestures() {
    // Add touch-friendly interactions
    const clickableElements = document.querySelectorAll('.btn, .nav-btn, .card');
    clickableElements.forEach(element => {
        element.addEventListener('touchstart', function() {
            this.classList.add('touch-active');
        });
        
        element.addEventListener('touchend', function() {
            this.classList.remove('touch-active');
        });
    });
}

// ===================================
// NOTIFICATION SYSTEM
// ===================================

function initializeNotificationSystem() {
    setupNotificationPermissions();
    loadNotifications();
}

function setupNotificationPermissions() {
    if ('Notification' in window && Notification.permission === 'default') {
        Notification.requestPermission();
    }
}

function showNotification(title, message, type = 'info') {
    // In-app notification
    const notification = createNotificationElement(title, message, type);
    const container = document.getElementById('notification-list');
    if (container) {
        container.appendChild(notification);
    }
    
    // Browser notification
    if ('Notification' in window && Notification.permission === 'granted') {
        new Notification(title, {
            body: message,
            icon: '/favicon.ico'
        });
    }
    
    // Store notification
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    notifications.unshift({
        id: generateId(),
        title,
        message,
        type,
        timestamp: new Date().toISOString(),
        read: false
    });
    
    // Keep only last 50 notifications
    if (notifications.length > 50) {
        notifications.splice(50);
    }
    
    localStorage.setItem('notifications', JSON.stringify(notifications));
}

function createNotificationElement(title, message, type) {
    const notification = document.createElement('div');
    notification.className = `notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <h6>${title}</h6>
            <p>${message}</p>
            <small>${new Date().toLocaleTimeString()}</small>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
    
    return notification;
}

function markAllAsRead() {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    notifications.forEach(n => n.read = true);
    localStorage.setItem('notifications', JSON.stringify(notifications));
    
    // Update UI
    const notificationElements = document.querySelectorAll('.notification.unread');
    notificationElements.forEach(el => el.classList.remove('unread'));
}

// ===================================
// SETTINGS MANAGEMENT
// ===================================

function showSettingsTab(tabName) {
    // Hide all panels
    const panels = document.querySelectorAll('.settings-panel');
    panels.forEach(panel => panel.classList.remove('active'));
    
    // Show selected panel
    const targetPanel = document.getElementById(`${tabName}-settings`);
    if (targetPanel) {
        targetPanel.classList.add('active');
    }
    
    // Update tab buttons
    const tabs = document.querySelectorAll('.settings-tab');
    tabs.forEach(tab => tab.classList.remove('active'));
    event.target.classList.add('active');
}

function saveAISettings() {
    const prompt = document.getElementById('ai-prompt').value;
    const confidence = document.getElementById('ai-confidence').value;
    const autoAnalysis = document.getElementById('auto-ai-analysis').checked;
    
    const aiSettings = {
        prompt,
        confidence: parseFloat(confidence),
        autoAnalysis,
        updatedAt: new Date().toISOString()
    };
    
    localStorage.setItem('aiSettings', JSON.stringify(aiSettings));
    showMessage('AI settings saved successfully!', 'success');
    
    // Update confidence display
    document.getElementById('confidence-display').textContent = `${Math.round(confidence * 100)}%`;
}

function testAIPrompt() {
    const prompt = document.getElementById('ai-prompt').value;
    if (!prompt.trim()) {
        showMessage('Please enter an AI prompt first', 'error');
        return;
    }
    
    showMessage('AI prompt test initiated. This would send a test image for analysis.', 'info');
    
    // In a real implementation, this would send a test image to the AI service
    setTimeout(() => {
        showMessage('AI test completed successfully! Prompt is working correctly.', 'success');
    }, 2000);
}

function saveSecuritySettings() {
    const sessionTimeout = document.getElementById('session-timeout').value;
    const fileRetention = document.getElementById('file-retention').value;
    const require2FA = document.getElementById('require-2fa').checked;

    const securitySettings = {
        sessionTimeout: parseInt(sessionTimeout),
        fileRetention: parseInt(fileRetention),
        require2FA,
        updatedAt: new Date().toISOString()
    };

    localStorage.setItem('securitySettings', JSON.stringify(securitySettings));
    showMessage('Security settings saved successfully!', 'success');
}

// Missing utility and helper functions
function getFileById(fileId) {
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    return files.find(f => f.id === fileId);
}

function loadUserPreferences() {
    // Load user preferences from storage
    const preferences = localStorage.getItem('userPreferences');
    if (preferences) {
        try {
            const prefs = JSON.parse(preferences);
            // Apply preferences to UI
        } catch (error) {
            console.error('Error loading user preferences:', error);
        }
    }
}

function loadUserData() {
    // Load user-specific data
    if (currentUser) {
        // Load user projects, files, etc.
    }
}

function loadProjectFolders() {
    // Load and display project folder structure
    const folders = JSON.parse(localStorage.getItem('projectFolders') || '[]');
    // Update folder tree UI
}

function updateStorageStats() {
    // Update storage statistics display
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    const totalSize = files.reduce((sum, file) => sum + file.size, 0);
    // Update UI with stats
}

function updateFileManager() {
    // Update file manager display
    loadProjectFolders();
    updateStorageStats();
}

function setupThemeControls() {
    // Setup theme control event listeners
    const themeButtons = document.querySelectorAll('.theme-option');
    themeButtons.forEach(button => {
        button.addEventListener('click', function() {
            const theme = this.dataset.theme;
            if (theme) setTheme(theme);
        });
    });
}

function loadNotifications() {
    // Load and display notifications
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const container = document.getElementById('notification-list');
    if (container) {
        container.innerHTML = '';
        notifications.forEach(notification => {
            const element = createNotificationElement(
                notification.title,
                notification.message,
                notification.type
            );
            container.appendChild(element);
        });
    }
}

function checkPrintTooltips() {
    // Check and setup print functionality tooltips
    const printButtons = document.querySelectorAll('[data-print]');
    printButtons.forEach(button => {
        button.title = 'Click to print this section';
    });
}

// Missing file sharing functions
async function sendEmailShare(shareRecord, file) {
    // Mock email sharing
    console.log(`Would send ${file.originalName} via email to ${shareRecord.sharedWith}`);
}

async function sendWhatsAppShare(shareRecord, file) {
    // Mock WhatsApp sharing
    const message = `Check out this file: ${file.originalName}`;
    const whatsappUrl = `https://wa.me/?text=${encodeURIComponent(message)}`;
    window.open(whatsappUrl, '_blank');
}

async function sendTelegramShare(shareRecord, file) {
    // Mock Telegram sharing
    if (typeof sendFileViaTelegram === 'function') {
        sendFileViaTelegram(file.id, shareRecord.sharedWith);
    }
}

async function sendInternalShare(shareRecord, file) {
    // Mock internal sharing
    showNotification('Internal Share', `File shared with ${shareRecord.sharedWith}`, 'info');
}

// ===================================
// ACTIVITY LOGGING
// ===================================

function logActivity(action, description, metadata = {}) {
    const activity = {
        id: generateId(),
        action,
        description,
        userId: currentUser?.id || 'anonymous',
        timestamp: new Date().toISOString(),
        metadata
    };
    
    const activities = JSON.parse(localStorage.getItem('activities') || '[]');
    activities.unshift(activity);
    
    // Keep only last 100 activities
    if (activities.length > 100) {
        activities.splice(100);
    }
    
    localStorage.setItem('activities', JSON.stringify(activities));
    updateActivityFeed();
}

function updateActivityFeed() {
    const container = document.getElementById('activity-list');
    if (!container) return;
    
    const activities = JSON.parse(localStorage.getItem('activities') || '[]');
    container.innerHTML = '';
    
    activities.slice(0, 10).forEach(activity => {
        const element = document.createElement('div');
        element.className = 'activity-item';
        element.innerHTML = `
            <div class="activity-content">
                <strong>${activity.action}</strong>
                <p>${activity.description}</p>
                <small>${new Date(activity.timestamp).toLocaleString()}</small>
            </div>
        `;
        container.appendChild(element);
    });
}

// ===================================
// UTILITY FUNCTIONS
// ===================================

function generateId() {
    return Date.now().toString(36) + Math.random().toString(36).substr(2);
}

function loadUserPreferences() {
    // Load and apply user preferences
    const preferences = JSON.parse(localStorage.getItem('userPreferences') || '{}');
    
    // Apply saved preferences
    if (preferences.theme) {
        setTheme(preferences.theme);
    }
    if (preferences.fontSize) {
        adjustFontSize(preferences.fontSize);
    }
}

function updateStorageStats() {
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    const totalFiles = files.length;
    const totalSize = files.reduce((sum, file) => sum + (file.size || 0), 0);
    
    // Update dashboard stats
    const totalFilesElement = document.getElementById('total-files');
    if (totalFilesElement) {
        totalFilesElement.textContent = totalFiles;
    }
}

function getFileById(fileId) {
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    return files.find(file => file.id === fileId);
}

function loadProjectFolders() {
    // Create project folder structure display
    const folderTree = document.getElementById('folder-tree');
    if (!folderTree) return;
    
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    const contracts = [...new Set(files.map(f => f.contractNumber))];
    
    folderTree.innerHTML = '';
    contracts.forEach(contract => {
        const folderElement = document.createElement('div');
        folderElement.className = 'folder-item';
        folderElement.innerHTML = `
            <div class="folder-header" onclick="toggleFolder('${contract}')">
                <i class="fas fa-folder"></i> ${contract}
            </div>
            <div class="folder-contents" id="folder-${contract}">
                ${fileStorageConfig.contractFolders.map(folder => 
                    `<div class="subfolder"><i class="fas fa-folder-open"></i> ${folder}</div>`
                ).join('')}
            </div>
        `;
        folderTree.appendChild(folderElement);
    });
}

function toggleFolder(contractNumber) {
    const folder = document.getElementById(`folder-${contractNumber}`);
    if (folder) {
        folder.style.display = folder.style.display === 'none' ? 'block' : 'none';
    }
}

// ===================================
// FIX PRINT TOOLTIP ISSUE
// ===================================

function checkPrintTooltips() {
    // Find all elements with print-related tooltips and fix them
    const elementsWithPrintTooltip = document.querySelectorAll('[title*="Print functionality will be implemented"]');
    
    elementsWithPrintTooltip.forEach(element => {
        // Remove the problematic tooltip
        element.removeAttribute('title');
        
        // Add proper print functionality
        if (element.onclick === null) {
            element.onclick = function() {
                if (this.textContent.includes('Print') || this.innerHTML.includes('fa-print')) {
                    printCurrentPage();
                } else {
                    // For other buttons, remove the tooltip
                    showMessage('Feature available - tooltip fixed!', 'success');
                }
            };
        }
    });
    
    // Fix any Bootstrap tooltips
    const tooltipElements = document.querySelectorAll('[data-bs-title*="Print functionality"]');
    tooltipElements.forEach(element => {
        element.removeAttribute('data-bs-title');
        element.removeAttribute('data-toggle');
        element.removeAttribute('data-placement');
    });
}

function printCurrentPage() {
    // Smart print function
    const currentPage = document.querySelector('.page.active');
    if (currentPage) {
        const pageTitle = currentPage.querySelector('h2')?.textContent || 'Engineering Platform Page';
        
        // Create print-friendly version
        const printWindow = window.open('', '_blank');
        printWindow.document.write(`
            <!DOCTYPE html>
            <html>
            <head>
                <title>${pageTitle}</title>
                <style>
                    body { font-family: Arial, sans-serif; margin: 20px; }
                    .no-print { display: none; }
                    table { border-collapse: collapse; width: 100%; }
                    table, th, td { border: 1px solid #ddd; }
                    th, td { padding: 8px; text-align: left; }
                    h1, h2, h3 { color: #333; }
                    .stat-card { display: inline-block; margin: 10px; padding: 15px; border: 1px solid #ccc; }
                </style>
            </head>
            <body>
                <h1>${pageTitle}</h1>
                <p>Generated on: ${new Date().toLocaleString()}</p>
                ${currentPage.innerHTML}
            </body>
            </html>
        `);
        
        printWindow.document.close();
        printWindow.focus();
        
        setTimeout(() => {
            printWindow.print();
            printWindow.close();
        }, 250);
    } else {
        window.print();
    }
    
    showMessage('Print dialog opened', 'success');
}

// ===================================
// BACKUP AND SYNC MANAGER
// ===================================

function openBackupManager() {
    const modal = document.createElement('div');
    modal.className = 'modal-overlay';
    modal.innerHTML = `
        <div class="modal-content">
            <h3><i class="fas fa-cloud"></i> Backup & Sync Manager</h3>
            
            <div class="backup-options">
                <div class="backup-section">
                    <h5>Manual Backup</h5>
                    <button class="btn btn-primary" onclick="createBackup()">
                        <i class="fas fa-download"></i> Create Full Backup
                    </button>
                    <button class="btn btn-secondary" onclick="restoreBackup()">
                        <i class="fas fa-upload"></i> Restore from Backup
                    </button>
                </div>
                
                <div class="backup-section">
                    <h5>Auto-Backup Settings</h5>
                    <div class="form-check">
                        <input type="checkbox" id="auto-backup-enabled" class="form-check-input">
                        <label for="auto-backup-enabled" class="form-check-label">
                            Enable automatic backups
                        </label>
                    </div>
                    <select id="backup-frequency" class="form-control mt-2">
                        <option value="daily">Daily</option>
                        <option value="weekly">Weekly</option>
                        <option value="monthly">Monthly</option>
                    </select>
                </div>
                
                <div class="backup-section">
                    <h5>Cloud Sync</h5>
                    <button class="btn btn-info" onclick="syncToTelegram()">
                        <i class="fab fa-telegram"></i> Sync to Telegram
                    </button>
                    <button class="btn btn-success" onclick="syncToEmail()">
                        <i class="fas fa-envelope"></i> Email Backup
                    </button>
                </div>
            </div>
            
            <div class="modal-actions">
                <button class="btn btn-secondary" onclick="closeBackupManager()">Close</button>
            </div>
        </div>
    `;
    
    document.body.appendChild(modal);
}

function createBackup() {
    const backupData = {
        projects: JSON.parse(localStorage.getItem('engineeringProjects') || '[]'),
        contracts: JSON.parse(localStorage.getItem('engineeringContracts') || '[]'),
        inspections: JSON.parse(localStorage.getItem('engineeringInspections') || '[]'),
        costEstimations: JSON.parse(localStorage.getItem('engineeringCostEstimations') || '[]'),
        files: JSON.parse(localStorage.getItem('engineeringFiles') || '[]'),
        settings: {
            theme: localStorage.getItem('selectedTheme'),
            aiSettings: JSON.parse(localStorage.getItem('aiSettings') || '{}'),
            userPreferences: JSON.parse(localStorage.getItem('userPreferences') || '{}')
        },
        timestamp: new Date().toISOString(),
        version: '1.0'
    };
    
    const dataStr = JSON.stringify(backupData, null, 2);
    const dataBlob = new Blob([dataStr], {type: 'application/json'});
    
    const link = document.createElement('a');
    link.href = URL.createObjectURL(dataBlob);
    link.download = `engineering-platform-backup-${new Date().toISOString().split('T')[0]}.json`;
    link.click();
    
    showMessage('Backup created successfully!', 'success');
    logActivity('Backup Created', 'Full platform backup downloaded');
}

function closeBackupManager() {
    const modal = document.querySelector('.modal-overlay');
    if (modal) {
        modal.remove();
    }
}

// ===================================
// PLACEHOLDER IMPLEMENTATIONS
// ===================================

// File Manager functions
function openFileManager() {
    const panel = document.getElementById('file-manager-panel');
    if (panel) {
        panel.classList.add('active');
        loadProjectFolders();
        updateFileList();
    }
}

function closeFileManager() {
    const panel = document.getElementById('file-manager-panel');
    if (panel) {
        panel.classList.remove('active');
    }
}

function uploadFile() {
    const input = document.createElement('input');
    input.type = 'file';
    input.multiple = true;
    input.accept = fileStorageConfig.allowedExtensions.map(ext => `.${ext}`).join(',');
    input.onchange = function(e) {
        uploadFiles(Array.from(e.target.files));
    };
    input.click();
}

function updateFileList() {
    const fileList = document.getElementById('file-list');
    if (!fileList) return;
    
    const files = JSON.parse(localStorage.getItem('engineeringFiles') || '[]');
    fileList.innerHTML = '';
    
    files.forEach(file => {
        const fileElement = document.createElement('div');
        fileElement.className = 'file-item';
        fileElement.innerHTML = `
            <div class="file-info">
                <i class="fas fa-file"></i>
                <span class="file-name">${file.originalName}</span>
                <span class="file-size">${formatFileSize(file.size)}</span>
            </div>
            <div class="file-actions">
                <button class="btn btn-sm btn-primary" onclick="shareFile('${file.id}')">
                    <i class="fas fa-share"></i>
                </button>
                <button class="btn btn-sm btn-danger" onclick="deleteFile('${file.id}')">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        `;
        fileList.appendChild(fileElement);
    });
}

// Notification placeholders for different services
async function sendEmailShare(shareRecord, file) {
    console.log('Would send email to:', shareRecord.sharedWith);
    showMessage('Email notification sent (demo)', 'info');
}

async function sendWhatsAppShare(shareRecord, file) {
    console.log('Would send WhatsApp message to:', shareRecord.sharedWith);
    showMessage('WhatsApp notification sent (demo)', 'info');
}

async function sendTelegramShare(shareRecord, file) {
    console.log('Would send Telegram message to:', shareRecord.sharedWith);
    showMessage('Telegram notification sent (demo)', 'info');
}

async function sendInternalShare(shareRecord, file) {
    showNotification('File Shared', `${file.originalName} has been shared with you`, 'info');
}

function testTelegramConnection() {
    const token = document.getElementById('telegram-bot-token').value;
    const chatId = document.getElementById('telegram-chat-id').value;
    
    if (!token || !chatId) {
        showMessage('Please enter both bot token and chat ID', 'error');
        return;
    }
    
    // Mock test
    showMessage('Testing Telegram connection...', 'info');
    setTimeout(() => {
        showMessage('Telegram connection test successful!', 'success');
    }, 2000);
}

// Initialize everything when DOM is loaded
document.addEventListener('DOMContentLoaded', function() {
    // Set up confidence slider display
    const confidenceSlider = document.getElementById('ai-confidence');
    if (confidenceSlider) {
        confidenceSlider.addEventListener('input', function() {
            const display = document.getElementById('confidence-display');
            if (display) {
                display.textContent = `${Math.round(this.value * 100)}%`;
            }
        });
    }
    
    // Load saved AI settings
    const savedAISettings = JSON.parse(localStorage.getItem('aiSettings') || '{}');
    if (savedAISettings.prompt) {
        const promptTextarea = document.getElementById('ai-prompt');
        if (promptTextarea) {
            promptTextarea.value = savedAISettings.prompt;
        }
    }
    if (savedAISettings.confidence) {
        const confidenceSlider = document.getElementById('ai-confidence');
        if (confidenceSlider) {
            confidenceSlider.value = savedAISettings.confidence;
            document.getElementById('confidence-display').textContent = `${Math.round(savedAISettings.confidence * 100)}%`;
        }
    }
    if (savedAISettings.autoAnalysis) {
        const autoCheckbox = document.getElementById('auto-ai-analysis');
        if (autoCheckbox) {
            autoCheckbox.checked = savedAISettings.autoAnalysis;
        }
    }
});
</script>
</body>
</html>
