<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Asset & Cost Report</title>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>
    <script src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script src="https://unpkg.com/leaflet-geometryutil"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4js/2.9.0/proj4.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/proj4leaflet/1.0.2/proj4leaflet.js"></script>
    
    <script src="https://unpkg.com/tokml@0.4.0/tokml.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff;
            --primary-color-rgb: 0, 123, 255;
            --background-color: #f0f4f8;
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(200, 210, 220, 0.7);
            --shadow: 0 4px 20px rgba(0, 0, 0, 0.12);
            --text-color: #2c3e50;
            --border-radius: 12px;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            margin: 0;
            padding: 10px;
            background-color: var(--background-color);
            color: var(--text-color);
            display: flex;
            flex-direction: column;
            align-items: center;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .main-container {
            width: 100%;
            max-width: 1400px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .glass-card {
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
        }

        /* Header & Tabs */
        .main-header { display: flex; justify-content: space-between; align-items: center; }
        .main-title { font-size: clamp(18px, 5vw, 24px); font-weight: bold; color: var(--text-color); }
        .tabs { display: flex; flex-wrap: wrap; gap: 5px; margin-bottom: -1px; }
        .tab-button {
            padding: 8px 15px; border: 1px solid var(--glass-border);
            border-bottom: none; border-radius: 10px 10px 0 0;
            cursor: pointer; background-color: rgba(255,255,255,0.3);
            font-size: 15px; font-weight: 500;
        }
        .tab-button.active { background-color: var(--glass-bg); border-bottom: 1px solid transparent; font-weight: bold;}
        .tab-content { display: none; }
        .tab-content.active { display: flex; flex-direction: column; gap: 15px; }
        
        /* Header Card with new Date Position */
        .info-card { 
            display: flex; 
            justify-content: space-between; 
            align-items: center;
            gap: 15px;
            position: relative; /* For date positioning */
            padding-bottom: 40px; /* Space for the date */
        }
        .logo-container { flex-shrink: 0; }
        .logo-container img { max-height: 80px; max-width: 150px; object-fit: contain; cursor: pointer; }
        .title-container { flex-grow: 1; text-align: center; }
        .report-title-row { font-size: clamp(1.5em, 4vw, 2em); font-weight: 900; line-height: 1.1;}
        .small-title { margin-top: 15px; background-color: #5a7b9c; color: white; padding: 8px 20px; border-radius: 5px; font-size: 1em; display: inline-block; }
        .report-date-label {
            position: absolute;
            bottom: 10px;
            left: 15px;
        }
        .report-date-label input[type="date"] {
            background: transparent; border: none; font-family: inherit; font-size: 1.1em; color: #333; font-weight: bold;
        }

        /* Forms & Inputs */
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card h3 {
            margin: 0 0 10px 0; color: var(--primary-color);
            border-bottom: 1px solid rgba(var(--primary-color-rgb), 0.2); padding-bottom: 8px; font-size: 18px;
        }
        .form-group { display: flex; flex-direction: column; gap: 10px; }
        input[type="text"], input[type="number"], input[type="url"], select, input[type="search"] {
            width: 100%; padding: 10px; border-radius: 8px; box-sizing: border-box;
            border: 1px solid var(--glass-border); background-color: rgba(255, 255, 255, 0.9);
        }
        
        /* Buttons */
        button, .form-button {
            border: 1px solid rgba(100, 100, 100, 0.3); background-color: rgba(255, 255, 255, 0.2);
            backdrop-filter: blur(8px); -webkit-backdrop-filter: blur(8px);
            border-radius: 8px; color: var(--text-color); cursor: pointer;
            padding: 10px 15px; font-weight: bold; font-size: 14px; transition: all 0.2s ease;
            display: inline-flex; align-items: center; justify-content: center; gap: 8px;
        }
        button:hover, .form-button:hover { transform: translateY(-2px); box-shadow: 0 4px 10px rgba(0,0,0,0.1); }
        .btn-insert { background-color: rgba(40, 167, 69, 0.7); color: white; }
        .btn-delete { background-color: rgba(220, 53, 69, 0.7); color: white; }
        .btn-action { background-color: rgba(0, 123, 255, 0.7); color: white; }
        .btn-neutral { background-color: rgba(108, 117, 125, 0.7); color: white; }

        /* Table */
        .table-container { overflow-x: auto; width: 100%; }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: rgba(var(--primary-color-rgb), 0.1); padding: 10px; text-align: center; white-space: nowrap;}
        td { border-top: 1px solid var(--glass-border); padding: 8px; text-align: center; vertical-align: middle; }
        .photo-wrapper { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; align-items: center; }
        .photo-wrapper img { max-height: 100px; border-radius: 5px; cursor: pointer; object-fit: cover; }
        
        /* Cost Estimation Tab */
        .boq-entry-card .form-grid-est { display: grid; grid-template-columns: repeat(auto-fit, minmax(150px, 1fr)); gap: 10px; align-items: end; }
        .boq-entry-card .description-group { grid-column: 1 / -1; }
        #cost-estimation-table th, #cost-estimation-table td { border: 1px solid black; padding: 4px 8px; }
        #cost-estimation-table tfoot td { font-weight: bold; }
        #calculated-quantity-display { margin-top: 10px; font-weight: bold; color: var(--primary-color); }
        
        /* --- Map Page Redesign --- */
        #map-tab { position: relative; height: 85vh; overflow: hidden; }
        #vehicle-map { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1; }
        .map-sidebar {
            position: absolute; top: 15px; left: 15px; z-index: 1000;
            width: 350px; max-height: calc(100% - 30px);
            display: flex; flex-direction: column; gap: 10px;
            overflow-y: auto;
        }
        .map-sidebar .glass-card { width: 100%; box-sizing: border-box; }
        .sidebar-section h4 { margin: 0 0 10px 0; border-bottom: 1px solid var(--glass-border); padding-bottom: 5px; }
        .form-row-map { display: flex; gap: 5px; }
        .form-row-map input { flex-grow: 1; }
        #map-bottom-bar {
            position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); z-index: 1000;
            padding: 8px 15px;
        }
        .leaflet-draw-toolbar a { background-size: 20px 20px !important; width: 30px !important; height: 30px !important; }
        .leaflet-draw-actions a { font-size: 14px !important; }
        .fa-ruler-combined::before { content: "\f546"; } /* Custom icon class */


        /* Modals */
        .modal { display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%; overflow: auto; background-color: rgba(0,0,0,0.5); align-items: center; justify-content: center; }
        .modal-content { padding: 20px; width: 90%; max-width: 450px; display: flex; flex-direction: column; gap: 10px; }
        
        @media (max-width: 768px) {
            .map-sidebar { width: calc(100% - 30px); max-height: 50%; }
            #map-tab { height: 100vh; }
        }
    </style>
    
    <style>
        /* CSS for printing */
        @media print {
            body { -webkit-print-color-adjust: exact; color-adjust: exact; }
            .info-card { padding-bottom: 50px !important; } /* Ensure space for date */
            .report-date-label { display: block !important; }
        }
    </style>

</head>
<body>

    <div class="main-container" id="main-content-wrapper">
        <header class="main-header glass-card">
            <h1 class="main-title" contenteditable="true">Project Dashboard</h1>
        </header>

        <div class="tabs">
            <button class="tab-button active" onclick="openTab(event, 'main-report')">Inspection Report</button>
            <button class="tab-button" onclick="openTab(event, 'cost-estimation-tab')">Cost Estimation</button>
            <button class="tab-button" onclick="openTab(event, 'map-tab')">Map</button>
        </div>
        
        <div id="main-report" class="tab-content active">
             <div class="printable-area">
                <div class="info-card glass-card">
                    <div class="logo-container">
                        <img id="client-logo-inspection" src="https://i.imgur.com/W1f3q2y.png" alt="Client Logo">
                    </div>
                    <div class="title-container">
                        <div id="inspection-title-1" class="report-title-row" contenteditable="true">Maintenance of Strategic</div>
                        <div id="inspection-title-2" class="report-title-row" contenteditable="true">Highways Qatar North</div>
                        <div id="inspection-title-3" class="report-title-row" contenteditable="true">ZF_093</div>
                    </div>
                    <div class="logo-container">
                        <img id="company-logo-inspection" src="https://i.imgur.com/1s3a1H4.png" alt="Company Logo">
                    </div>
                     <label class="report-date-label">
                        <input type="date" id="display-date">
                    </label>
                </div>
                 </div>
        </div>
        
        <div id="cost-estimation-tab" class="tab-content">
            <div class="card glass-card boq-entry-card">
                <h3>BOQ Item Entry</h3>
                <div class="form-grid-est">
                    <div class="form-group-est">
                        <label>BOQ Ref.</label>
                        <div class="boq-ref-group">
                            <input type="search" id="boq-search" placeholder="Search Ref...">
                            <select id="boq-ref-select"></select>
                        </div>
                    </div>
                    <div class="form-group-est description-group">
                        <label>Description</label>
                        <input type="text" id="boq-desc" readonly>
                    </div>
                    <div class="form-group-est">
                        <label>Unit</label>
                        <input type="text" id="boq-unit" readonly>
                    </div>
                    <div class="form-group-est">
                        <label>Rate</label>
                        <input type="text" id="boq-rate" readonly>
                    </div>
                    <div class="form-group-est">
                        <label>Amount (QR)</label>
                        <input type="text" id="boq-amount" readonly>
                    </div>
                     <div class="form-group-est description-group">
                        <label>Remarks</label>
                        <input type="text" id="boq-remarks">
                    </div>
                </div>
                <div style="display: flex; align-items: center; gap: 20px; margin-top: 15px;">
                     <button class="btn-action" onclick="showQuantityModal()"><i class="fa-solid fa-calculator"></i> Calculate Quantity</button>
                     <div id="calculated-quantity-display"></div>
                </div>
                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                    <button class="btn-neutral" onclick="document.getElementById('boq-csv-input').click()"><i class="fa-solid fa-file-csv"></i> Import BOQ</button>
                    <input type="file" id="boq-csv-input" style="display:none;" accept=".csv">
                    <button class="btn-insert" onclick="insertBOQRow()"><i class="fa-solid fa-plus"></i> Insert Row</button>
                    <button class="btn-action" onclick="exportTableToCSV('cost-estimation-table', 'cost-estimation.csv')"><i class="fa-solid fa-download"></i> Export CSV</button>
                </div>
            </div>
            
            <div class="printable-area">
                <div class="info-card glass-card">
                     <div class="logo-container">
                        <img id="client-logo-estimation" src="https://i.imgur.com/W1f3q2y.png" alt="Client Logo">
                    </div>
                    <div class="title-container">
                        <div id="estimation-title-1" class="report-title-row" contenteditable="true">Maintenance of Strategic</div>
                        <div id="estimation-title-2" class="report-title-row" contenteditable="true">Highways Qatar North</div>
                        <div id="estimation-title-3" class="report-title-row" contenteditable="true">ZF_093</div>
                    </div>
                    <div class="logo-container">
                        <img id="company-logo-estimation" src="https://i.imgur.com/1s3a1H4.png" alt="Company Logo">
                    </div>
                    <label class="report-date-label">
                        <input type="date" id="estimation-date">
                    </label>
                </div>
                 <div class="table-container">
                    <table id="cost-estimation-table">
                        <thead>
                            <tr>
                                <th>BOQ Ref.</th><th>Description</th><th>Unit</th>
                                <th>NR</th><th>Length</th><th>Width</th><th>Height</th>
                                <th>Total Qty.</th><th>Rate</th><th>Amount</th><th>Remarks</th><th>Action</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                        <tfoot>
                            <tr><td colspan="9" style="text-align: right;">TOTAL Amount</td><td id="total-amount-cell">QAR 0.00</td><td colspan="2"></td></tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>
        
        <div id="map-tab" class="tab-content">
            <div id="vehicle-map"></div>
            
            <div class="map-sidebar">
                <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-layer-group"></i> Map Layers</h4>
                    <div id="layer-control-container"></div>
                </div>

                <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-location-crosshairs"></i> Navigation</h4>
                    <div class="form-row-map">
                         <input type="text" id="goto-coords-input" placeholder="Lat, Lng">
                         <button id="goto-coords-btn" class="btn-action" title="Go to Coordinates"><i class="fa-solid fa-arrow-right"></i></button>
                    </div>
                </div>

                <div class="glass-card sidebar-section">
                     <h4><i class="fa-solid fa-map-pin"></i> Data Input</h4>
                     <label>Pin by Coordinates:</label>
                     <div class="form-row-map">
                        <input type="number" id="manual-lat-input" placeholder="Latitude">
                        <input type="number" id="manual-lng-input" placeholder="Longitude">
                     </div>
                     <input type="text" id="manual-pin-title" placeholder="Pin Title (Optional)" style="margin-top: 5px;">
                     <button id="add-manual-pin-btn" class="btn-insert" style="width: 100%; margin-top: 5px;">Add Pin to Map</button>
                </div>
                
                 <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-server"></i> QNAS Lookup</h4>
                    <p style="font-size: 12px; margin: -5px 0 10px 0; color: #dc3545;"><strong>Note:</strong> QNAS requires a valid token to work.</p>
                    <select id="qnas-zone"></select>
                    <select id="qnas-street" style="margin-top: 5px;"></select>
                    <select id="qnas-building" style="margin-top: 5px;"></select>
                </div>
                
                <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-square-root-variable"></i> Measurement</h4>
                    <div id="measurement-output">Click a measure tool to start.</div>
                </div>
                
                <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-database"></i> Data Output</h4>
                    <label>Last Clicked/Placed Pin:</label>
                    <p><strong>Degrees:</strong> <span id="output-deg">N/A</span></p>
                    <p><strong>Metric (UTM):</strong> <span id="output-utm">N/A</span></p>
                </div>

                <div class="glass-card sidebar-section">
                    <h4><i class="fa-solid fa-file-export"></i> Export</h4>
                    <div style="display: flex; gap: 5px;">
                         <button id="export-map-pdf-btn" class="btn-action"><i class="fa-solid fa-file-pdf"></i> Export PDF</button>
                         <button id="export-kml-btn" class="btn-action"><i class="fa-solid fa-globe"></i> Export KML</button>
                         <button id="clear-map-btn" class="btn-delete"><i class="fa-solid fa-trash"></i> Clear Map</button>
                    </div>
                </div>
            </div>
            
            <div id="map-bottom-bar" class="glass-card">
                <span id="map-coords-display">Map Center: N/A</span>
            </div>
        </div>
    </div>

    <div id="quantityModal" class="modal">
        <div class="modal-content glass-card">
            <h3>Enter Quantity Details</h3>
            <input type="number" id="length" placeholder="Length (m)">
            <input type="number" id="width" placeholder="Width (m)">
            <input type="number" id="depth" placeholder="Depth (m)">
            <input type="number" id="repetitions" placeholder="Repetitions (NR)">
            <div style="display:flex; gap: 10px;">
                <button onclick="setQuantity()" class="btn-insert" style="flex: 1;">Set Quantity</button>
                <button onclick="closeQuantityModal()" class="btn-delete" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>
    
    <script>
        // --- GLOBAL VARIABLES & CONFIG ---
        let vehicleMap, drawnItems, baseLayers, userMarker;
        let tempQuantityDetails = {};
        
        // IMPORTANT: Replace with your actual QNAS token
        const QNAS_TOKEN = 'YOUR_TOKEN'; 
        const API_BASE = 'https://qnas.qa/api';

        // Define UTM Zone for Qatar (UTM Zone 39N)
        proj4.defs("EPSG:32639", "+proj=utm +zone=39 +datum=WGS84 +units=m +no_defs");

        // --- INITIALIZATION ---
        document.addEventListener('DOMContentLoaded', () => {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('display-date').value = today;
            document.getElementById('estimation-date').value = today;
            
            setupEventListeners();
            openTab({ currentTarget: document.querySelector('.tab-button.active') }, 'main-report');
        });

        function setupEventListeners() {
            // Map Buttons
            document.getElementById('goto-coords-btn').addEventListener('click', goToCoords);
            document.getElementById('add-manual-pin-btn').addEventListener('click', addManualPin);
            document.getElementById('export-map-pdf-btn').addEventListener('click', exportMapAsPDF);
            document.getElementById('export-kml-btn').addEventListener('click', exportToKML);
            document.getElementById('clear-map-btn').addEventListener('click', clearMap);

            // QNAS Dropdowns
            document.getElementById('qnas-zone').addEventListener('change', e => getStreets(e.target.value));
            document.getElementById('qnas-street').addEventListener('change', e => getBuildings(document.getElementById('qnas-zone').value, e.target.value));
            document.getElementById('qnas-building').addEventListener('change', e => getLocationDetails(document.getElementById('qnas-zone').value, document.getElementById('qnas-street').value, e.target.value));
        }
        
        // --- TAB MANAGEMENT ---
        function openTab(evt, tabName) {
            document.querySelectorAll(".tab-content").forEach(tc => tc.style.display = 'none');
            document.querySelectorAll(".tab-button").forEach(tb => tb.classList.remove('active'));
            document.getElementById(tabName).style.display = "flex";
            evt.currentTarget.classList.add("active");

            if (tabName === 'map-tab' && !vehicleMap) {
                initializeVehicleMap();
            }
        }
        
        // --- COST ESTIMATION LOGIC ---
        function showQuantityModal() { document.getElementById('quantityModal').style.display = 'flex'; }
        function closeQuantityModal() { document.getElementById('quantityModal').style.display = 'none'; }
        
        function setQuantity() {
            const nr = parseFloat(document.getElementById('repetitions').value) || 1;
            const length = parseFloat(document.getElementById('length').value) || 0;
            const width = parseFloat(document.getElementById('width').value) || 0;
            const height = parseFloat(document.getElementById('depth').value) || 0;
            
            let qty = nr;
            if (length > 0 && width > 0 && height > 0) qty = nr * length * width * height;
            else if (length > 0 && width > 0) qty = nr * length * width;
            else if (length > 0) qty = nr * length;

            tempQuantityDetails = { nr, length, width, height, totalQty: qty };
            
            document.getElementById('calculated-quantity-display').textContent = `Qty: ${qty.toFixed(3)}`;
            calculateBOQAmount(); // Recalculate amount based on new quantity
            closeQuantityModal();
        }

        function calculateBOQAmount() {
            const rate = parseFloat(document.getElementById('boq-rate').value) || 0;
            const quantity = tempQuantityDetails.totalQty || 0;
            document.getElementById('boq-amount').value = (rate * quantity).toFixed(2);
        }

        function insertBOQRow() {
            if (Object.keys(tempQuantityDetails).length === 0) {
                alert("Please calculate a quantity first.");
                return;
            }
            const tbody = document.querySelector('#cost-estimation-table tbody');
            const newRow = tbody.insertRow();
            
            const data = {
                ref: document.getElementById('boq-ref-select').value,
                desc: document.getElementById('boq-desc').value,
                unit: document.getElementById('boq-unit').value,
                ...tempQuantityDetails,
                rate: document.getElementById('boq-rate').value,
                amount: document.getElementById('boq-amount').value,
                remarks: document.getElementById('boq-remarks').value
            };

            newRow.innerHTML = `
                <td>${data.ref}</td><td>${data.desc}</td><td>${data.unit}</td>
                <td>${data.nr}</td><td>${data.length}</td><td>${data.width}</td><td>${data.height}</td>
                <td>${data.totalQty.toFixed(3)}</td><td>${data.rate}</td><td>${data.amount}</td>
                <td>${data.remarks}</td>
                <td><button class="btn-delete" onclick="this.parentNode.parentNode.remove(); calculateCostEstimationTotal();"><i class="fa-solid fa-trash"></i></button></td>
            `;

            calculateCostEstimationTotal();
            // Reset fields for next entry
            tempQuantityDetails = {};
            document.getElementById('calculated-quantity-display').textContent = '';
            document.getElementById('boq-remarks').value = '';
            document.getElementById('boq-amount').value = '0.00';
        }
        
        function calculateCostEstimationTotal() { /* ... */ }

        function exportTableToCSV(tableId, filename) {
            let csv = [];
            const rows = document.querySelectorAll(`#${tableId} tr`);
            for (const row of rows) {
                const cols = row.querySelectorAll('td, th');
                const rowData = Array.from(cols).map(col => `"${col.innerText.replace(/"/g, '""')}"`);
                csv.push(rowData.join(','));
            }
            const csvFile = new Blob([csv.join('\n')], { type: 'text/csv' });
            const downloadLink = document.createElement('a');
            downloadLink.download = filename;
            downloadLink.href = window.URL.createObjectURL(csvFile);
            downloadLink.style.display = 'none';
            document.body.appendChild(downloadLink);
            downloadLink.click();
            document.body.removeChild(downloadLink);
        }

        // --- MAP PAGE LOGIC ---
        function initializeVehicleMap() {
            // Define Base Layers
            baseLayers = {
                "Streets": L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png'),
                "Satellite": L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}'),
                "Topographic": L.tileLayer('https://{s}.tile.opentopomap.org/{z}/{x}/{y}.png'),
                "Dark": L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png')
            };

            vehicleMap = L.map('vehicle-map', {
                center: [25.2854, 51.5310],
                zoom: 12,
                layers: [baseLayers.Streets] // Default layer
            });

            // Layer Control
            L.control.layers(baseLayers, null, { collapsed: false }).addTo(vehicleMap).getContainer().parentNode.replaceWith(document.getElementById('layer-control-container'));
            
            // Drawn Items Layer Group
            drawnItems = new L.FeatureGroup().addTo(vehicleMap);

            // Draw Control
            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems },
                draw: {
                    polygon: { title: 'Draw a polygon to measure area' },
                    polyline: { title: 'Draw a line to measure distance' },
                    rectangle: false,
                    circle: false,
                    circlemarker: false,
                    marker: { title: 'Add a placemark' }
                }
            });
            vehicleMap.addControl(drawControl);

            // Map Events
            vehicleMap.on(L.Draw.Event.CREATED, handleDrawCreate);
            vehicleMap.on('move', updateMapCenterCoords);
            vehicleMap.on('click', e => updateOutputCoords(e.latlng));

            // Initial setup
            updateMapCenterCoords();
            getZones();
        }

        function handleDrawCreate(event) {
            const layer = event.layer;
            const type = event.layerType;

            if (type === 'marker') {
                const title = prompt("Enter a title for this placemark:", "My Placemark");
                if(title) layer.bindPopup(`<b>${title}</b>`);
                layer.on('click', () => updateOutputCoords(layer.getLatLng()));
            }
            if (type === 'polyline') {
                const distance = L.GeometryUtil.length(layer.getLatLngs());
                layer.bindPopup(`Distance: ${distance.toFixed(2)} m`);
                document.getElementById('measurement-output').innerHTML = `<strong>Distance:</strong> ${distance.toFixed(2)} m`;
            }
            if (type === 'polygon') {
                const area = L.GeometryUtil.geodesicArea(layer.getLatLngs()[0]);
                layer.bindPopup(`Area: ${area.toFixed(2)} m²`);
                 document.getElementById('measurement-output').innerHTML = `<strong>Area:</strong> ${area.toFixed(2)} m²`;
            }
            drawnItems.addLayer(layer);
        }

        function updateOutputCoords(latlng) {
            document.getElementById('output-deg').textContent = `${latlng.lat.toFixed(6)}, ${latlng.lng.toFixed(6)}`;
            const utmCoords = proj4('EPSG:4326', 'EPSG:32639', [latlng.lng, latlng.lat]);
            document.getElementById('output-utm').textContent = `${utmCoords[0].toFixed(6)}, ${utmCoords[1].toFixed(6)}`;
        }

        function updateMapCenterCoords() {
            const center = vehicleMap.getCenter();
            const zoom = vehicleMap.getZoom();
            document.getElementById('map-coords-display').textContent = `Center: ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)} | Zoom: ${zoom}`;
        }
        
        function goToCoords() {
            const coordsStr = document.getElementById('goto-coords-input').value;
            const parts = coordsStr.split(',').map(c => parseFloat(c.trim()));
            if (parts.length === 2 && !isNaN(parts[0]) && !isNaN(parts[1])) {
                vehicleMap.flyTo(parts, 16);
            } else {
                alert("Invalid format. Please use 'latitude, longitude'.");
            }
        }
        
        function addManualPin() {
            const lat = parseFloat(document.getElementById('manual-lat-input').value);
            const lng = parseFloat(document.getElementById('manual-lng-input').value);
            const title = document.getElementById('manual-pin-title').value || "Manual Pin";
            if (!isNaN(lat) && !isNaN(lng)) {
                const marker = L.marker([lat, lng]).bindPopup(`<b>${title}</b>`).addTo(drawnItems);
                vehicleMap.flyTo([lat, lng], 16);
                updateOutputCoords(marker.getLatLng());
            } else {
                alert("Please enter valid latitude and longitude.");
            }
        }

        function clearMap() {
            if(confirm("Are you sure you want to clear all drawings and pins from the map?")) {
                drawnItems.clearLayers();
                document.getElementById('measurement-output').textContent = 'Measurements cleared.';
            }
        }

        async function exportMapAsPDF() {
            alert("Generating PDF of the map. Please wait...");
            const mapContainer = document.getElementById('vehicle-map');
            const canvas = await html2canvas(mapContainer, { useCORS: true });
            const imgData = canvas.toDataURL('image/png');
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF({
                orientation: canvas.width > canvas.height ? 'landscape' : 'portrait',
                unit: 'px',
                format: [canvas.width, canvas.height]
            });
            pdf.addImage(imgData, 'PNG', 0, 0, canvas.width, canvas.height);
            pdf.save('map-export.pdf');
        }

        function exportToKML() {
            if (drawnItems.getLayers().length === 0) {
                alert("No items on the map to export.");
                return;
            }
            const geojson = drawnItems.toGeoJSON();
            // Add name property for placemarks from popup content
            geojson.features.forEach(feature => {
                if (feature.geometry.type === "Point") {
                    const layer = drawnItems.getLayers().find(l => l.toGeoJSON() === feature);
                    if (layer && layer.getPopup()) {
                        feature.properties.name = layer.getPopup().getContent().replace(/<[^>]*>/g, ''); // Strip HTML
                    }
                }
            });
            const kmlString = tokml(geojson);
            
            const blob = new Blob([kmlString], { type: 'application/vnd.google-earth.kml+xml' });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = 'map-data.kml';
            link.click();
        }

        // --- QNAS API LOGIC ---
        async function qnasFetch(endpoint) { /* ... same as before ... */ }
        async function getZones() { /* ... same as before ... */ }
        async function getStreets(zoneNo) { /* ... same as before ... */ }
        async function getBuildings(zoneNo, streetNo) { /* ... same as before ... */ }
        async function getLocationDetails(zone, street, building) {
             if(!zone || !street || !building) return;
             const data = await qnasFetch(`/get_location/${zone}/${street}/${building}`);
             if (data?.location) {
                 const loc = data.location;
                 const latlng = [loc.latitude, loc.longitude];
                 const marker = L.marker(latlng).addTo(drawnItems);
                 marker.bindPopup(`<b>Building ${loc.building_no}</b><br>${loc.street_en_name}<br>Zone: ${loc.zone_no}`).openPopup();
                 marker.on('click', () => updateOutputCoords(latlng));
                 vehicleMap.flyTo(latlng, 18);
                 updateOutputCoords(L.latLng(latlng));
             }
        }
    </script>
</body>
</html>
