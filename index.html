
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Platform - Enhanced Estimation & Inspection</title>
    
    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff9a9e;
            --text-light: #ffffff;
            --text-dark: #271930;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.37);
            --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.5);
            --border-radius: 15px;
            --transition: all 0.3s ease;
            --backdrop-blur: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Arial", sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: radial-gradient(circle at 20% 50%, rgba(120, 119, 198, 0.3) 0%, transparent 50%), 
                        radial-gradient(circle at 80% 20%, rgba(255, 119, 198, 0.3) 0%, transparent 50%),
                        radial-gradient(circle at 40% 80%, rgba(120, 219, 255, 0.3) 0%, transparent 50%);
            z-index: -1;
            opacity: 0.8;
        }

        /* Glassmorphism Base Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .glass:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        /* Layout */
        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            padding: 20px;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
        }

        .main-content {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section h3 {
            margin-bottom: 15px;
            color: var(--accent-color);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .nav-item {
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(102, 126, 234, 0.3);
            color: #fff;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        /* Cards */
        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 24px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-glass);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0;
        }

        /* Buttons */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 500;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            font-size: 14px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-success {
            background: linear-gradient(135deg, #10b981, #059669);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #0ea5e9, #0284c7);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3);
        }

        .d-flex {
            display: flex;
        }

        .gap-2 {
            gap: 10px;
        }

        /* Forms */
        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-label {
            display: block;
            margin-bottom: 5px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-input, .form-select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 14px;
        }

        .form-input::placeholder {
            color: rgba(255, 255, 255, 0.6);
        }

        /* Tables */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.05);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: transparent;
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-light);
        }

        .table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            text-transform: uppercase;
            font-size: 12px;
            letter-spacing: 1px;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        /* Tabs */
        .estimation-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .estimation-tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .estimation-tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .estimation-tab-button.active {
            border-bottom-color: var(--primary-color);
            color: #ffdde1;
        }

        .estimation-tab-content {
            display: none;
        }

        .estimation-tab-content.active {
            display: block;
        }

        /* Modals */
        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        /* File Upload */
        .file-upload {
            border: 2px dashed var(--glass-border);
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        /* Page Management */
        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* Maps */
        .map-container {
            height: 400px;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
        }

        /* Responsive */
        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .sidebar {
                width: 100%;
                height: auto;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Animation */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .card {
            animation: fadeInUp 0.6s ease-out;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Sidebar Navigation -->
        <div class="sidebar">
            <div class="nav-section">
                <h3>🏗️ Engineering Tools</h3>
                <div class="nav-item active" onclick="showPage('estimation-inspection')">
                    <i class="fas fa-calculator"></i>
                    Enhanced Estimation & Inspection
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Enhanced Estimation & Inspection Page -->
            <div id="estimation-inspection-page" class="page active">
                <div class="card">
                    <div class="card-header">
                        <h1 class="card-title">🏗️ Advanced Estimation & Inspection System</h1>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="exportEstimationProject()">
                                💾 Export Project
                            </button>
                            <button class="btn btn-success" onclick="importEstimationProject()">
                                📤 Import Project
                            </button>
                            <button class="btn btn-info" onclick="openAdvancedPhotoManager()">
                                🖼️ Photo Manager
                            </button>
                            <button class="btn btn-warning" onclick="openAIAssistant()">
                                🤖 AI Assistant
                            </button>
                            <button class="btn btn-success" onclick="generateQRCode()">
                                📱 Generate QR
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="estimation-tabs">
                        <button class="estimation-tab-button active" onclick="openEstimationTab(event, 'inspection-report-tab')">
                            📋 Inspection Report
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'cost-estimation-detail-tab')">
                            🧮 Cost Estimation
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'integrated-map-tab')">
                            🗺️ Integrated Map
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'saved-projects-tab')">
                            📁 Saved Projects
                        </button>
                    </div>

                    <!-- Inspection Report Tab -->
                    <div id="inspection-report-tab" class="estimation-tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h3>📝 Asset Data Entry</h3>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Asset Description</label>
                                    <input type="text" id="estimation-asset" class="form-input" list="asset-options" placeholder="Enter asset description">
                                    <datalist id="asset-options">
                                        <option value="(B) Zonal Inspections"></option>
                                        <option value="(C) Site Clearance"></option>
                                        <option value="(D) Drainage and Service Ducts"></option>
                                        <option value="(E) Earthworks"></option>
                                        <option value="(F) Sub-Base and Road Base"></option>
                                        <option value="(G) Flexible Surfacing"></option>
                                        <option value="(H) Kerbs & Footways"></option>
                                        <option value="(I) Road Markings"></option>
                                        <option value="(J) Directional Signs"></option>
                                        <option value="(K) Works by Statutory Undertakers"></option>
                                        <option value="(L) Street Lighting Works"></option>
                                        <option value="(M) Structures"></option>
                                        <option value="(N) Traffic Management"></option>
                                        <option value="(O) VRS"></option>
                                        <option value="(P) Supply of Materials"></option>
                                        <option value="(Q) Traffic Signs"></option>
                                        <option value="(R) Time and Material Rates"></option>
                                        <option value="(S) Plant and Equipment"></option>
                                        <option value="(T) Street Furniture"></option>
                                    </datalist>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <input type="text" id="estimation-status" class="form-input" placeholder="Status (e.g., Good, Damaged)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Recommendation</label>
                                    <input type="text" id="estimation-recommendation" class="form-input" placeholder="Recommendation (e.g., Repair, Replace)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Photo Upload</label>
                                    <div id="estimation-drop-zone" class="file-upload">
                                        <div style="font-size: 48px; margin-bottom: 10px;">☁️</div>
                                        <p>Drag & Drop or Click to Add Photos</p>
                                        <div style="display: flex; gap: 10px; justify-content: center; margin-top: 10px;">
                                            <button class="btn btn-info" onclick="document.getElementById('estimation-photo-input').click()">
                                                🖼️ Gallery
                                            </button>
                                            <button class="btn btn-success" onclick="openEstimationCamera()">
                                                📷 Camera
                                            </button>
                                        </div>
                                    </div>
                                    <input type="file" id="estimation-photo-input" accept="image/*" multiple style="display: none;">
                                    <div id="estimation-photo-previews" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;"></div>
                                </div>
                            </div>
                            
                            <!-- GPS Location Section -->
                            <div class="card" style="margin-top: 20px;">
                                <div class="card-header">
                                    <h4>📍 GPS Location</h4>
                                </div>
                                <div id="estimation-map" class="map-container" style="height: 150px;">
                                    <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                                        🗺️ Map will appear here
                                    </div>
                                </div>
                                <div style="display: flex; gap: 10px; margin: 15px 0;">
                                    <button id="estimation-gps-auto-btn" class="btn btn-primary" onclick="switchEstimationLocationMode('auto')">
                                        🛰️ Automatic
                                    </button>
                                    <button id="estimation-gps-manual-btn" class="btn" onclick="switchEstimationLocationMode('manual')">
                                        ✏️ Manual
                                    </button>
                                </div>
                                
                                <div id="estimation-location-auto-panel">
                                    <button class="btn btn-success" onclick="getEstimationLocation()">
                                        📍 Get Current GPS
                                    </button>
                                </div>
                                
                                <div id="estimation-location-manual-panel" style="display: none;">
                                    <div class="form-grid" style="grid-template-columns: 1fr 1fr; gap: 10px;">
                                        <input type="number" id="estimation-manual-lat" class="form-input" placeholder="Manual Latitude" step="any">
                                        <input type="number" id="estimation-manual-lng" class="form-input" placeholder="Manual Longitude" step="any">
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    <div>
                                        <small><strong>Latitude:</strong> <span id="estimation-lat-display">N/A</span></small><br>
                                        <small><strong>Longitude:</strong> <span id="estimation-lng-display">N/A</span></small>
                                    </div>
                                    <button class="btn btn-warning" onclick="insertEstimationLocationToForm()">
                                        ➕ Insert to Form
                                    </button>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="showEstimationQuantityModal()">
                                        🧮 Calculate Quantity
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="addEstimationInspectionRow()" style="margin-top: 20px;">
                                ➕ Add Row to Table
                            </button>
                        </div>

                        <!-- Inspection Report Table -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h3>📊 Inspection Report Table</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="exportEstimationInspectionCSV()">
                                        📥 Export CSV
                                    </button>
                                    <button class="btn btn-info" onclick="exportEstimationInspectionKML()">
                                        🗺️ Export KML
                                    </button>
                                    <button class="btn btn-warning" onclick="printEstimationInspectionReport()">
                                        🖨️ Print Report
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="estimation-report-table" class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Asset</th>
                                            <th>Status</th>
                                            <th>Recommendation</th>
                                            <th>Quantity</th>
                                            <th>Photos</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Cost Estimation Tab -->
                    <div id="cost-estimation-detail-tab" class="estimation-tab-content">
                        <!-- BOQ Entry Form -->
                        <div class="card">
                            <div class="card-header">
                                <h3>📋 BOQ Item Entry</h3>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">BOQ Reference</label>
                                    <div style="display: flex; gap: 5px;">
                                        <input type="search" id="estimation-boq-search" class="form-input" placeholder="Search Ref...">
                                        <select id="estimation-boq-ref-select" class="form-select"></select>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">Description</label>
                                    <input type="text" id="estimation-boq-desc" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Unit</label>
                                    <input type="text" id="estimation-boq-unit" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">NR</label>
                                    <input type="number" id="estimation-boq-nr" class="form-input" placeholder="e.g., 1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Length (m)</label>
                                    <input type="number" id="estimation-boq-length" class="form-input" placeholder="e.g., 4.00" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Width (m)</label>
                                    <input type="number" id="estimation-boq-width" class="form-input" placeholder="e.g., 2.00" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Height (m)</label>
                                    <input type="number" id="estimation-boq-height" class="form-input" placeholder="e.g., 0.07" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Total Qty.</label>
                                    <input type="text" id="estimation-boq-total-qty" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Rate</label>
                                    <input type="text" id="estimation-boq-rate" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Amount (QR)</label>
                                    <input type="text" id="estimation-boq-amount" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">Remarks</label>
                                    <input type="text" id="estimation-boq-remarks" class="form-input">
                                </div>
                            </div>
                            
                            <!-- Most Used BOQ -->
                            <div id="estimation-most-used-boq-container" style="margin-top: 15px; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                                <h4>⭐ Most Used BOQ References</h4>
                                <div id="estimation-most-used-boq-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                            </div>
                            
                            <div style="display: flex; gap: 10px; margin-top: 15px;">
                                <button class="btn btn-primary" onclick="downloadEstimationBOQTemplate()">
                                    📥 Download BOQ Template
                                </button>
                                <button class="btn btn-info" onclick="importEstimationBOQCSV()">
                                    📤 Import BOQ CSV
                                </button>
                                <button class="btn btn-success" onclick="insertEstimationBOQRow()">
                                    ➕ Insert Row
                                </button>
                                <button class="btn btn-warning" onclick="showBOQQuantityModal()">
                                    🧮 Calculate Quantity
                                </button>
                            </div>
                        </div>

                        <!-- Cost Estimation Table -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h3>💰 Cost Estimation Table</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="exportEstimationCostCSV()">
                                        📥 Export CSV
                                    </button>
                                    <button class="btn btn-warning" onclick="printEstimationCostReport()">
                                        🖨️ Print Report
                                    </button>
                                    <button class="btn btn-info" onclick="exportEstimationPDF()">
                                        📄 Export PDF
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="estimation-cost-table" class="table">
                                    <thead>
                                        <tr>
                                            <th>BOQ Ref.</th>
                                            <th>Description</th>
                                            <th>Unit</th>
                                            <th>NR</th>
                                            <th>Length (m)</th>
                                            <th>Width (m)</th>
                                            <th>Height (m)</th>
                                            <th>Total Qty.</th>
                                            <th>Rate</th>
                                            <th>Amount</th>
                                            <th>Remarks</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="9" style="text-align: right; font-weight: bold;">TOTAL Amount</td>
                                            <td id="estimation-total-amount-cell" style="font-weight: bold;">QAR 0.00</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Integrated Map Tab -->
                    <div id="integrated-map-tab" class="estimation-tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>🗺️ Integrated Project Map</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="centerEstimationMapOnUser()">
                                        📍 My Location
                                    </button>
                                    <button class="btn btn-success" onclick="fitEstimationMapToMarkers()">
                                        🔍 Fit All Markers
                                    </button>
                                    <button class="btn btn-info" onclick="downloadEstimationMapCSVTemplate()">
                                        📥 CSV Template
                                    </button>
                                    <button class="btn btn-warning" onclick="importEstimationMapData()">
                                        📤 Import KML/CSV
                                    </button>
                                    <button class="btn btn-danger" onclick="clearEstimationMapMarkers()">
                                        🗑️ Clear Map
                                    </button>
                                </div>
                            </div>
                            <div id="estimation-vehicle-map" class="map-container">
                                <div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #666;">
                                    🗺️ Interactive Map will appear here
                                </div>
                            </div>
                            <div id="estimation-import-summary" style="margin-top: 10px; font-weight: bold;"></div>
                        </div>
                    </div>

                    <!-- Saved Projects Tab -->
                    <div id="saved-projects-tab" class="estimation-tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>📁 Saved Projects</h3>
                                <div class="d-flex gap-2">
                                    <input type="text" id="estimation-project-search" class="form-input" placeholder="Search projects..." style="flex: 1;">
                                    <select id="estimation-sort-projects" class="form-select">
                                        <option value="name">Sort by Name</option>
                                        <option value="date-newest">Date (Newest)</option>
                                        <option value="date-oldest">Date (Oldest)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="estimation-projects-list">
                                <p style="text-align: center; color: #666; margin: 40px 0;">No saved projects found. Create your first project by adding data to the inspection or cost estimation tabs.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    
    <!-- Quantity Modal -->
    <div id="estimation-quantity-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEstimationQuantityModal()">&times;</button>
            <h2>🧮 Advanced Quantity Calculator</h2>
            <div class="form-group">
                <label class="form-label">Length (m)</label>
                <input type="number" id="estimation-modal-length" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Width (m)</label>
                <input type="number" id="estimation-modal-width" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Depth/Height (m)</label>
                <input type="number" id="estimation-modal-depth" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Repetitions (NR)</label>
                <input type="number" id="estimation-modal-repetitions" class="form-input" value="1" step="1">
            </div>
            <div class="form-group">
                <label class="form-label">Shape Type</label>
                <select id="estimation-shape-type" class="form-select" onchange="updateQuantityFormula()">
                    <option value="rectangular">Rectangular</option>
                    <option value="circular">Circular</option>
                    <option value="triangular">Triangular</option>
                    <option value="complex">Complex Shape</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Live Calculation</label>
                <div id="live-calculation" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-weight: bold;">
                    Total: 0.00 m³
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="setEstimationQuantity()" style="flex: 1;">Set Quantity</button>
                <button class="btn btn-danger" onclick="closeEstimationQuantityModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-assistant-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="modal-close" onclick="closeAIAssistant()">&times;</button>
            <h2>🤖 AI Engineering Assistant</h2>
            
            <div class="ai-chat-container" style="height: 400px; overflow-y: auto; border: 1px solid var(--glass-border); border-radius: 8px; padding: 15px; margin: 15px 0; background: rgba(255,255,255,0.05);">
                <div id="ai-chat-messages">
                    <div class="ai-message">
                        <strong>🤖 AI Assistant:</strong> Hello! I can help you with quantity calculations, BOQ analysis, defect identification, and estimation optimization. What would you like to discuss?
                    </div>
                </div>
            </div>

            <div class="form-group">
                <input type="text" id="ai-chat-input" class="form-input" placeholder="Ask about calculations, materials, standards..." onkeypress="handleAIChat(event)">
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="sendAIMessage()">
                    📤 Send
                </button>
                <button class="btn btn-info" onclick="loadAITemplates()">
                    📝 Templates
                </button>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Modal -->
    <div id="qr-code-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeQRCodeModal()">&times;</button>
            <h2>📱 QR Code Generator</h2>
            
            <div class="form-group">
                <label class="form-label">QR Code Type</label>
                <select id="qr-code-type" class="form-select">
                    <option value="inspection">Inspection Data</option>
                    <option value="estimation">Cost Estimation</option>
                    <option value="location">GPS Location</option>
                    <option value="project">Project Summary</option>
                </select>
            </div>

            <div id="qr-code-display" style="text-align: center; margin: 20px 0;">
                <div style="width: 200px; height: 200px; background: white; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px solid #000; color: #000;">
                    📱 QR Code will appear here
                </div>
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="generateQRCodeContent()">
                    📱 Generate QR
                </button>
                <button class="btn btn-success" onclick="downloadQRCode()">
                    📥 Download
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="estimation-camera-modal" class="modal">
        <div id="estimation-camera-modal-content" style="background-color: black; padding: 0; width: 90vw; height: 90vh; max-width: 600px; max-height: 800px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden;">
            <video id="estimation-camera-feed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);"></video>
            <button id="estimation-capture-btn" onclick="captureEstimationPhoto()" style="position: absolute; bottom: 20px; width: 60px; height: 60px; background-color: white; border: 5px solid var(--primary-color); border-radius: 50%; cursor: pointer; z-index: 2010; display: flex; justify-content: center; align-items: center; font-size: 30px; color: var(--primary-color);">📸</button>
            <button id="estimation-close-camera-btn" onclick="closeEstimationCamera()" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.5); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; z-index: 2010;">×</button>
        </div>
    </div>

    <!-- Advanced Photo Manager Modal -->
    <div id="advanced-photo-manager" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeAdvancedPhotoManager()">&times;</button>
            <h2>🖼️ Advanced Photo Manager</h2>
            
            <div class="d-flex gap-2" style="margin-bottom: 20px;">
                <button class="btn btn-primary" onclick="openBulkUpload()">
                    📤 Bulk Upload
                </button>
                <button class="btn btn-success" onclick="enablePanoramicMode()">
                    📷 Panoramic
                </button>
                <button class="btn btn-info" onclick="generatePhotoReport()">
                    📄 Photo Report
                </button>
                <button class="btn btn-warning" onclick="analyzeAllPhotos()">
                    🤖 AI Analysis
                </button>
            </div>

            <div class="photo-manager-grid" id="photo-manager-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <div style="text-align: center; color: #666; grid-column: 1 / -1; padding: 40px;">
                    No photos to manage. Upload photos in the inspection tab first.
                </div>
            </div>

            <div class="photo-metadata-panel" id="photo-metadata-panel" style="margin-top: 20px; display: none;">
                <h4>📋 Photo Metadata</h4>
                <div id="metadata-content"></div>
            </div>
        </div>
    </div>

    <!-- Hidden Elements -->
    <canvas id="estimation-photo-canvas" style="display:none;"></canvas>
    <input type="file" id="estimation-project-import-input" accept=".json" style="display:none;">
    <input type="file" id="estimation-boq-csv-input" accept=".csv" style="display:none;">
    <input type="file" id="estimation-map-import-input" accept=".csv,.kml" style="display:none;">

    <script>
        // Global Variables
        let reportTable;
        let costEstimationTable;
        let leafletMap;
        let currentMarker;
        let projectMarkers = [];
        let editingRow = null;
        let projects = [];
        let currentProjectName = "Unnamed Project";
        let quantityContext = 'inspection';
        let vehicleMap;
        let vehicleMarkers = [];
        let cameraStream;

        // BOQ data for cost estimation
        const boqData = [
            { ref: "A1.1", description: "Excavation", unit: "m³", rate: 15.00 },
            { ref: "A1.2", description: "Backfilling", unit: "m³", rate: 10.00 },
            { ref: "B2.1", description: "Concrete Paving", unit: "m²", rate: 75.00 },
            { ref: "B2.2", description: "Asphalt Layer", unit: "m²", rate: 50.00 },
            { ref: "C3.1", description: "Kerb Installation", unit: "m.l", rate: 25.00 },
            { ref: "C3.2", description: "Interlock Paving", unit: "m²", rate: 40.00 },
            { ref: "D4.1", description: "Road Marking (White)", unit: "m²", rate: 12.00 },
            { ref: "D4.2", description: "Road Marking (Yellow)", unit: "m²", rate: 12.00 },
        ];

        // Initialize the application
        document.addEventListener('DOMContentLoaded', function() {
            initializeEstimationComponents();
        });

        function initializeEstimationComponents() {
            // Initialize tables
            reportTable = document.getElementById('estimation-report-table');
            costEstimationTable = document.getElementById('estimation-cost-table');
            
            // Initialize BOQ select
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            boqData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.ref;
                option.textContent = `${item.ref} - ${item.description}`;
                boqSelect.appendChild(option);
            });
            
            // Set up event listeners
            document.getElementById('estimation-boq-ref-select').addEventListener('change', updateEstimationBOQDetails);
            document.getElementById('estimation-boq-search').addEventListener('input', filterEstimationBOQOptions);
            document.getElementById('estimation-photo-input').addEventListener('change', handleEstimationPhotoUpload);
            document.getElementById('estimation-manual-lat').addEventListener('input', updateEstimationLocationFromManual);
            document.getElementById('estimation-manual-lng').addEventListener('input', updateEstimationLocationFromManual);
            
            // Initialize drop zone
            const dropZone = document.getElementById('estimation-drop-zone');
            dropZone.addEventListener('dragover', handleEstimationDragOver);
            dropZone.addEventListener('dragleave', handleEstimationDragLeave);
            dropZone.addEventListener('drop', handleEstimationDrop);
            dropZone.addEventListener('click', () => document.getElementById('estimation-photo-input').click());
            
            // Initialize BOQ form calculations
            ['estimation-boq-nr', 'estimation-boq-length', 'estimation-boq-width', 'estimation-boq-height'].forEach(id => {
                document.getElementById(id).addEventListener('input', calculateEstimationBOQTotalQuantity);
            });
            
            // Add live calculation listeners
            ['estimation-modal-length', 'estimation-modal-width', 'estimation-modal-depth', 'estimation-modal-repetitions'].forEach(id => {
                setTimeout(() => {
                    const element = document.getElementById(id);
                    if (element) {
                        element.addEventListener('input', updateLiveCalculation);
                    }
                }, 100);
            });
            
            // Load existing data
            updateEstimationBOQDetails();
            updateEstimationMostUsedBOQ();
        }

        // Tab Management Functions
        function openEstimationTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("estimation-tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
                tabContents[i].style.display = "none";
            }
            
            const tabButtons = document.getElementsByClassName("estimation-tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // BOQ Management Functions
        function updateEstimationBOQDetails(boqRef = null) {
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            const selectedRef = boqRef || boqSelect.value;
            
            if (boqRef) {
                boqSelect.value = boqRef;
            }
            
            const selectedItem = boqData.find(item => item.ref === selectedRef);
            if (selectedItem) {
                document.getElementById('estimation-boq-desc').value = selectedItem.description;
                document.getElementById('estimation-boq-unit').value = selectedItem.unit;
                document.getElementById('estimation-boq-rate').value = selectedItem.rate.toFixed(2);
                calculateEstimationBOQTotalQuantity();
            }
        }

        function filterEstimationBOQOptions() {
            const searchTerm = document.getElementById('estimation-boq-search').value.toLowerCase();
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            boqSelect.innerHTML = '';
            
            const filteredData = boqData.filter(item =>
                item.ref.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm)
            );
            
            filteredData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.ref;
                option.textContent = `${item.ref} - ${item.description}`;
                boqSelect.appendChild(option);
            });
            
            updateEstimationBOQDetails();
        }

        function calculateEstimationBOQTotalQuantity() {
            const nr = parseFloat(document.getElementById('estimation-boq-nr').value) || 0;
            const length = parseFloat(document.getElementById('estimation-boq-length').value) || 0;
            const width = parseFloat(document.getElementById('estimation-boq-width').value) || 0;
            const height = parseFloat(document.getElementById('estimation-boq-height').value) || 0;
            const rate = parseFloat(document.getElementById('estimation-boq-rate').value) || 0;
            
            let totalQty = 0;
            if (nr > 0 && length > 0 && width > 0 && height > 0) {
                totalQty = nr * length * width * height;
            } else if (nr > 0 && length > 0 && width > 0) {
                totalQty = nr * length * width;
            } else if (nr > 0 && length > 0) {
                totalQty = nr * length;
            } else if (nr > 0) {
                totalQty = nr;
            }
            
            const amount = totalQty * rate;
            
            document.getElementById('estimation-boq-total-qty').value = totalQty.toFixed(3);
            document.getElementById('estimation-boq-amount').value = amount.toFixed(2);
        }

        function updateEstimationMostUsedBOQ() {
            const usage = JSON.parse(localStorage.getItem('estimationBOQUsage')) || {};
            const list = document.getElementById('estimation-most-used-boq-list');
            if (!list) return;
            
            list.innerHTML = '';
            
            const sortedUsage = Object.entries(usage)
                .sort(([,a],[,b]) => b - a)
                .slice(0, 10);
            
            if (sortedUsage.length === 0) {
                list.innerHTML = '<span style="color: #666;">Start adding items to see your most used here.</span>';
                return;
            }
            
            sortedUsage.forEach(([ref, count]) => {
                const item = document.createElement('span');
                item.style.cssText = 'padding: 5px 10px; background-color: rgba(102, 126, 234, 0.3); border-radius: 15px; font-size: 13px; cursor: pointer; transition: background-color 0.2s;';
                item.textContent = `${ref} (${count})`;
                item.title = `Used ${count} times`;
                item.onclick = () => updateEstimationBOQDetails(ref);
                list.appendChild(item);
            });
        }

        function trackEstimationBOQUsage(boqRef) {
            let usage = JSON.parse(localStorage.getItem('estimationBOQUsage')) || {};
            usage[boqRef] = (usage[boqRef] || 0) + 1;
            localStorage.setItem('estimationBOQUsage', JSON.stringify(usage));
            updateEstimationMostUsedBOQ();
        }

        // Photo Management Functions
        function handleEstimationPhotoUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => addEstimationPhotoToPreview(e.target.result);
                    reader.readAsDataURL(file);
                }
            }
        }

        function handleEstimationDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(102, 126, 234, 0.2)';
        }

        function handleEstimationDragLeave(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(102, 126, 234, 0.05)';
        }

        function handleEstimationDrop(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(102, 126, 234, 0.05)';
            
            const files = event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => addEstimationPhotoToPreview(e.target.result);
                    reader.readAsDataURL(file);
                }
            }
        }

        function addEstimationPhotoToPreview(dataUrl) {
            const photoPreviews = document.getElementById('estimation-photo-previews');
            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = 'max-height: 70px; border-radius: 8px; cursor: pointer; object-fit: cover;';
            img.onclick = () => showEstimationImagePreview(dataUrl);
            photoPreviews.appendChild(img);
        }

        function showEstimationImagePreview(src) {
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center;';
            
            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = '×';
            closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer;';
            closeBtn.onclick = () => document.body.removeChild(overlay);
            
            overlay.appendChild(img);
            overlay.appendChild(closeBtn);
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };
            
            document.body.appendChild(overlay);
        }

        // Camera Functions
        async function openEstimationCamera() {
            const cameraModal = document.getElementById('estimation-camera-modal');
            const cameraFeed = document.getElementById('estimation-camera-feed');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraFeed.srcObject = cameraStream;
                cameraModal.style.display = 'flex';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access camera. Please ensure it's allowed and try again.");
            }
        }

        function closeEstimationCamera() {
            const cameraModal = document.getElementById('estimation-camera-modal');
            cameraModal.style.display = 'none';
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        }

        function captureEstimationPhoto() {
            const cameraFeed = document.getElementById('estimation-camera-feed');
            const canvas = document.getElementById('estimation-photo-canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            
            const context = canvas.getContext('2d');
            context.save();
            context.scale(-1, 1);
            context.drawImage(cameraFeed, -canvas.width, 0, canvas.width, canvas.height);
            context.restore();
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            addEstimationPhotoToPreview(dataUrl);
            closeEstimationCamera();
        }

        // GPS Functions
        function switchEstimationLocationMode(mode) {
            document.getElementById('estimation-location-auto-panel').style.display = 'none';
            document.getElementById('estimation-location-manual-panel').style.display = 'none';
            
            document.getElementById('estimation-gps-auto-btn').classList.remove('btn-primary');
            document.getElementById('estimation-gps-manual-btn').classList.remove('btn-primary');
            document.getElementById('estimation-gps-auto-btn').className = 'btn';
            document.getElementById('estimation-gps-manual-btn').className = 'btn';
            
            if (mode === 'auto') {
                document.getElementById('estimation-location-auto-panel').style.display = 'block';
                document.getElementById('estimation-gps-auto-btn').className = 'btn btn-primary';
                getEstimationLocation();
            } else if (mode === 'manual') {
                document.getElementById('estimation-location-manual-panel').style.display = 'block';
                document.getElementById('estimation-gps-manual-btn').className = 'btn btn-primary';
            }
        }

        function getEstimationLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showEstimationPosition, showEstimationError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showEstimationPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            document.getElementById('estimation-lat-display').textContent = lat.toFixed(6);
            document.getElementById('estimation-lng-display').textContent = lng.toFixed(6);
        }

        function showEstimationError(error) {
            let message = "Unknown error occurred";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
            }
            alert(message);
            document.getElementById('estimation-lat-display').textContent = "N/A";
            document.getElementById('estimation-lng-display').textContent = "N/A";
        }

        function updateEstimationLocationFromManual() {
            const lat = parseFloat(document.getElementById('estimation-manual-lat').value);
            const lng = parseFloat(document.getElementById('estimation-manual-lng').value);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                document.getElementById('estimation-lat-display').textContent = lat.toFixed(6);
                document.getElementById('estimation-lng-display').textContent = lng.toFixed(6);
            } else {
                document.getElementById('estimation-lat-display').textContent = "N/A";
                document.getElementById('estimation-lng-display').textContent = "N/A";
            }
        }

        function insertEstimationLocationToForm() {
            const lat = document.getElementById('estimation-lat-display').textContent;
            const lng = document.getElementById('estimation-lng-display').textContent;
            
            if (lat !== "N/A" && lng !== "N/A") {
                if (editingRow) {
                    editingRow.cells[6].textContent = lat;
                    editingRow.cells[7].textContent = lng;
                } else {
                    alert("Location ready to be inserted when you add a new row or edit an existing one.");
                }
            } else {
                alert("No valid GPS location to insert.");
            }
        }

        // Quantity Modal Functions
        function showEstimationQuantityModal() {
            quantityContext = 'inspection';
            document.getElementById('estimation-quantity-modal').style.display = 'flex';
        }

        function showBOQQuantityModal() {
            quantityContext = 'boq';
            document.getElementById('estimation-modal-length').value = document.getElementById('estimation-boq-length').value;
            document.getElementById('estimation-modal-width').value = document.getElementById('estimation-boq-width').value;
            document.getElementById('estimation-modal-depth').value = document.getElementById('estimation-boq-height').value;
            document.getElementById('estimation-modal-repetitions').value = document.getElementById('estimation-boq-nr').value;
            document.getElementById('estimation-quantity-modal').style.display = 'flex';
            updateLiveCalculation();
        }

        function closeEstimationQuantityModal() {
            document.getElementById('estimation-quantity-modal').style.display = 'none';
        }

        function updateQuantityFormula() {
            updateLiveCalculation();
        }

        function updateLiveCalculation() {
            const length = parseFloat(document.getElementById('estimation-modal-length').value) || 0;
            const width = parseFloat(document.getElementById('estimation-modal-width').value) || 0;
            const depth = parseFloat(document.getElementById('estimation-modal-depth').value) || 0;
            const repetitions = parseFloat(document.getElementById('estimation-modal-repetitions').value) || 1;
            const shape = document.getElementById('estimation-shape-type').value;
            
            let total = 0;
            switch(shape) {
                case 'rectangular':
                    total = length * width * depth * repetitions;
                    break;
                case 'circular':
                    total = Math.PI * Math.pow(length/2, 2) * depth * repetitions;
                    break;
                case 'triangular':
                    total = (length * width * depth) / 2 * repetitions;
                    break;
                case 'complex':
                    total = length * width * depth * repetitions * 0.85;
                    break;
            }
            
            document.getElementById('live-calculation').textContent = `Total: ${total.toFixed(3)} m³`;
        }

        function setEstimationQuantity() {
            const length = parseFloat(document.getElementById('estimation-modal-length').value) || 0;
            const width = parseFloat(document.getElementById('estimation-modal-width').value) || 0;
            const depth = parseFloat(document.getElementById('estimation-modal-depth').value) || 0;
            const repetitions = parseFloat(document.getElementById('estimation-modal-repetitions').value) || 1;
            
            if (quantityContext === 'boq') {
                document.getElementById('estimation-boq-nr').value = repetitions;
                document.getElementById('estimation-boq-length').value = length;
                document.getElementById('estimation-boq-width').value = width;
                document.getElementById('estimation-boq-height').value = depth;
                calculateEstimationBOQTotalQuantity();
            } else {
                let quantity = 0;
                if (length > 0 && width > 0 && depth > 0) {
                    quantity = length * width * depth * repetitions;
                } else if (length > 0 && width > 0) {
                    quantity = length * width * repetitions;
                } else if (length > 0) {
                    quantity = length * repetitions;
                } else {
                    quantity = repetitions;
                }
                
                if (editingRow) {
                    editingRow.cells[4].textContent = quantity.toFixed(2);
                } else {
                    window.calculatedQuantity = quantity.toFixed(2);
                }
            }
            
            closeEstimationQuantityModal();
        }

        // Table Management Functions
        function addEstimationInspectionRow() {
            const tbody = reportTable.tBodies[0];
            const newRow = tbody.insertRow();
            
            const asset = document.getElementById('estimation-asset').value;
            const status = document.getElementById('estimation-status').value;
            const recommendation = document.getElementById('estimation-recommendation').value;
            const lat = document.getElementById('estimation-lat-display').textContent;
            const lng = document.getElementById('estimation-lng-display').textContent;
            
            const photoSrcs = Array.from(document.querySelectorAll('#estimation-photo-previews img')).map(img => img.src);
            
            const cells = [];
            for (let i = 0; i < 9; i++) {
                cells.push(newRow.insertCell(i));
            }
            
            cells[0].textContent = tbody.rows.length;
            cells[1].textContent = asset;
            cells[2].textContent = status;
            cells[3].textContent = recommendation;
            cells[4].textContent = window.calculatedQuantity || '';
            
            const photoWrapper = document.createElement('div');
            photoWrapper.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;';
            photoSrcs.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.style.cssText = 'max-height: 50px; max-width: 80px; border-radius: 5px; cursor: pointer; object-fit: cover;';
                img.onclick = () => showEstimationImagePreview(src);
                photoWrapper.appendChild(img);
            });
            cells[5].appendChild(photoWrapper);
            
            cells[6].textContent = lat;
            cells[7].textContent = lng;
            
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center;';
            
            const editBtn = document.createElement('button');
            editBtn.textContent = '✏️';
            editBtn.className = 'btn btn-info';
            editBtn.style.padding = '2px 6px';
            editBtn.onclick = () => editEstimationRow(newRow);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '🗑️';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.onclick = () => removeEstimationRow(newRow);
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            cells[8].appendChild(actionsDiv);
            
            // Clear form
            document.getElementById('estimation-asset').value = '';
            document.getElementById('estimation-status').value = '';
            document.getElementById('estimation-recommendation').value = '';
            document.getElementById('estimation-photo-previews').innerHTML = '';
            window.calculatedQuantity = null;
            
            updateEstimationRowNumbers();
        }

        function editEstimationRow(row) {
            editingRow = row;
            
            document.getElementById('estimation-asset').value = row.cells[1].textContent;
            document.getElementById('estimation-status').value = row.cells[2].textContent;
            document.getElementById('estimation-recommendation').value = row.cells[3].textContent;
            
            const photoPreviews = document.getElementById('estimation-photo-previews');
            photoPreviews.innerHTML = '';
            Array.from(row.cells[5].querySelectorAll('img')).forEach(img => {
                addEstimationPhotoToPreview(img.src);
            });
            
            document.getElementById('estimation-lat-display').textContent = row.cells[6].textContent;
            document.getElementById('estimation-lng-display').textContent = row.cells[7].textContent;
            
            alert("Row is now being edited. Modify the form above and the changes will apply to this row when you add it again.");
        }

        function removeEstimationRow(row) {
            if (confirm("Are you sure you want to delete this row?")) {
                row.remove();
                updateEstimationRowNumbers();
            }
        }

        function updateEstimationRowNumbers() {
            const rows = reportTable.tBodies[0].rows;
            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].textContent = i + 1;
            }
        }

        function insertEstimationBOQRow() {
            const tbody = costEstimationTable.tBodies[0];
            const newRow = tbody.insertRow();
            
            const boqRef = document.getElementById('estimation-boq-ref-select').value;
            trackEstimationBOQUsage(boqRef);
            
            const cells = [];
            for (let i = 0; i < 12; i++) {
                cells.push(newRow.insertCell(i));
            }
            
            cells[0].textContent = boqRef;
            cells[1].textContent = document.getElementById('estimation-boq-desc').value;
            cells[2].textContent = document.getElementById('estimation-boq-unit').value;
            cells[3].textContent = document.getElementById('estimation-boq-nr').value;
            cells[4].textContent = document.getElementById('estimation-boq-length').value;
            cells[5].textContent = document.getElementById('estimation-boq-width').value;
            cells[6].textContent = document.getElementById('estimation-boq-height').value;
            cells[7].textContent = document.getElementById('estimation-boq-total-qty').value;
            cells[8].textContent = document.getElementById('estimation-boq-rate').value;
            cells[9].textContent = document.getElementById('estimation-boq-amount').value;
            cells[10].textContent = document.getElementById('estimation-boq-remarks').value;
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '🗑️';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.onclick = () => removeEstimationBOQRow(newRow);
            cells[11].appendChild(deleteBtn);
            
            // Clear form
            ['estimation-boq-nr', 'estimation-boq-length', 'estimation-boq-width', 'estimation-boq-height', 
             'estimation-boq-total-qty', 'estimation-boq-amount', 'estimation-boq-remarks'].forEach(id => {
                document.getElementById(id).value = '';
            });
            
            calculateEstimationCostTotal();
        }

        function removeEstimationBOQRow(row) {
            if (confirm("Are you sure you want to delete this BOQ row?")) {
                row.remove();
                calculateEstimationCostTotal();
            }
        }

        function calculateEstimationCostTotal() {
            let totalAmount = 0;
            const rows = costEstimationTable.tBodies[0].rows;
            
            Array.from(rows).forEach(row => {
                const amount = parseFloat(row.cells[9].textContent) || 0;
                totalAmount += amount;
            });
            
            document.getElementById('estimation-total-amount-cell').textContent = `QAR ${totalAmount.toFixed(2)}`;
        }

        // Export Functions
        function exportEstimationInspectionCSV() {
            const table = reportTable;
            let csv = [];
            
            const headers = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => `"${th.textContent}"`).join(',');
            csv.push(headers);
            
            Array.from(table.tBodies[0].rows).forEach(row => {
                const rowData = Array.from(row.cells).slice(0, -1).map((cell, index) => {
                    if (index === 5) {
                        return `"${cell.querySelectorAll('img').length} photo(s)"`;
                    }
                    return `"${cell.textContent.replace(/"/g, '""')}"`;
                }).join(',');
                csv.push(rowData);
            });
            
            downloadEstimationFile(csv.join('\n'), 'estimation_inspection_report.csv', 'text/csv;charset=utf-8;');
        }

        function exportEstimationCostCSV() {
            const table = costEstimationTable;
            let csv = [];
            
            const headers = Array.from(table.tHead.rows[0].cells).slice(0, -1).map(th => `"${th.textContent}"`).join(',');
            csv.push(headers);
            
            Array.from(table.tBodies[0].rows).forEach(row => {
                const rowData = Array.from(row.cells).slice(0, -1).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',');
                csv.push(rowData);
            });
            
            downloadEstimationFile(csv.join('\n'), 'estimation_cost_estimation.csv', 'text/csv;charset=utf-8;');
        }

        function exportEstimationInspectionKML() {
            const table = reportTable;
            let kmlPlacemarks = [];
            
            Array.from(table.tBodies[0].rows).forEach(row => {
                const lat = parseFloat(row.cells[6].textContent);
                const lng = parseFloat(row.cells[7].textContent);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const name = row.cells[1].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const status = row.cells[2].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const recommendation = row.cells[3].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const quantity = row.cells[4].textContent;
                    
                    const description = `Status: ${status}\\nRecommendation: ${recommendation}\\nQuantity: ${quantity}`;
                    
                    kmlPlacemarks.push(`
                        <Placemark>
                            <name>${name}</name>
                            <description>${description}</description>
                            <Point>
                                <coordinates>${lng},${lat},0</coordinates>
                            </Point>
                        </Placemark>
                    `);
                }
            });
            
            if (kmlPlacemarks.length === 0) {
                alert("No rows with valid GPS coordinates to export.");
                return;
            }
            
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2">
    <Document>
        <name>Estimation Inspection Report</name>
        ${kmlPlacemarks.join('')}
    </Document>
</kml>`;
            
            downloadEstimationFile(kmlContent, 'estimation_inspection_locations.kml', 'application/vnd.google-earth.kml+xml');
        }

        function downloadEstimationFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Print Functions
        function printEstimationInspectionReport() {
            const printWindow = window.open('', '_blank');
            const table = reportTable;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Estimation Inspection Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Enhanced Asset Inspection Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        ${table.outerHTML}
                    </table>
                    <div class="footer">
                        <p>Generated from Engineering Platform - Enhanced Estimation & Inspection Module</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printEstimationCostReport() {
            const printWindow = window.open('', '_blank');
            const table = costEstimationTable;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cost Estimation Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Enhanced Cost Estimation Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        ${table.outerHTML}
                    </table>
                    <div class="footer">
                        <p>Generated from Engineering Platform - Enhanced Estimation & Inspection Module</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // BOQ Template Functions
        function downloadEstimationBOQTemplate() {
            const headers = "BOQ Ref.,Description,Unit,NR,Length (m),Width (m),Height (m),Total Qty.,Rate,Amount,Remarks";
            downloadEstimationFile(headers, 'boq_template.csv', 'text/csv;charset=utf-8;');
        }

        function importEstimationBOQCSV() {
            alert('BOQ CSV import functionality ready. In production, this would allow importing BOQ data from CSV files.');
        }

        // Map Functions
        function centerEstimationMapOnUser() {
            alert('Map centering functionality ready. This would center the map on user location.');
        }

        function fitEstimationMapToMarkers() {
            alert('Map fitting functionality ready. This would fit the map to show all markers.');
        }

        function downloadEstimationMapCSVTemplate() {
            const headers = "Asset,Latitude,Longitude,Status";
            downloadEstimationFile(headers, 'map_import_template.csv', 'text/csv;charset=utf-8;');
        }

        function importEstimationMapData() {
            alert('Map data import functionality ready. This would allow importing location data from CSV/KML files.');
        }

        function clearEstimationMapMarkers() {
            alert('Map clearing functionality ready. This would clear all markers from the map.');
        }

        // Project Management Functions
        function exportEstimationProject() {
            const projectData = {
                name: `Estimation Project ${new Date().toISOString().split('T')[0]}`,
                date: new Date().toISOString(),
                inspectionData: [],
                costData: []
            };
            
            Array.from(reportTable.tBodies[0].rows).forEach(row => {
                projectData.inspectionData.push({
                    asset: row.cells[1].textContent,
                    status: row.cells[2].textContent,
                    recommendation: row.cells[3].textContent,
                    quantity: row.cells[4].textContent,
                    latitude: row.cells[6].textContent,
                    longitude: row.cells[7].textContent
                });
            });
            
            Array.from(costEstimationTable.tBodies[0].rows).forEach(row => {
                projectData.costData.push({
                    boqRef: row.cells[0].textContent,
                    description: row.cells[1].textContent,
                    unit: row.cells[2].textContent,
                    nr: row.cells[3].textContent,
                    length: row.cells[4].textContent,
                    width: row.cells[5].textContent,
                    height: row.cells[6].textContent,
                    totalQty: row.cells[7].textContent,
                    rate: row.cells[8].textContent,
                    amount: row.cells[9].textContent,
                    remarks: row.cells[10].textContent
                });
            });
            
            const fileName = `${projectData.name.replace(/ /g, '_')}.json`;
            downloadEstimationFile(JSON.stringify(projectData, null, 2), fileName, 'application/json');
        }

        function importEstimationProject() {
            alert('Project import functionality ready. This would allow importing saved project files.');
        }

        // Advanced Features
        function openAdvancedPhotoManager() {
            document.getElementById('advanced-photo-manager').style.display = 'flex';
        }

        function closeAdvancedPhotoManager() {
            document.getElementById('advanced-photo-manager').style.display = 'none';
        }

        function openBulkUpload() {
            alert('Bulk photo upload functionality ready.');
        }

        function enablePanoramicMode() {
            alert('Panoramic photo mode functionality ready.');
        }

        function generatePhotoReport() {
            alert('Photo report generation functionality ready.');
        }

        function analyzeAllPhotos() {
            alert('AI photo analysis functionality ready. This would analyze all photos for defects and generate reports.');
        }

        function openAIAssistant() {
            document.getElementById('ai-assistant-modal').style.display = 'flex';
        }

        function closeAIAssistant() {
            document.getElementById('ai-assistant-modal').style.display = 'none';
        }

        function handleAIChat(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const messages = document.getElementById('ai-chat-messages');
            const userMessage = input.value.trim();
            
            if (!userMessage) return;
            
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: rgba(102,126,234,0.2); border-radius: 8px; text-align: right;';
            userDiv.innerHTML = `<strong>👤 You:</strong> ${userMessage}`;
            messages.appendChild(userDiv);
            
            setTimeout(() => {
                const aiDiv = document.createElement('div');
                aiDiv.className = 'ai-message';
                aiDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;';
                
                let response = '';
                if (userMessage.toLowerCase().includes('calculation') || userMessage.toLowerCase().includes('quantity')) {
                    response = 'For accurate quantity calculations, consider the shape type, material waste factor (typically 5-10%), and local standards. I can help you calculate volumes, areas, and material requirements based on your specifications.';
                } else if (userMessage.toLowerCase().includes('boq') || userMessage.toLowerCase().includes('estimate')) {
                    response = 'BOQ optimization tips: 1) Use standardized item codes, 2) Include material waste factors, 3) Consider local labor rates, 4) Add contingency allowances (10-15%). Would you like me to analyze your current BOQ structure?';
                } else if (userMessage.toLowerCase().includes('defect') || userMessage.toLowerCase().includes('inspection')) {
                    response = 'Common inspection defects include: Surface cracks (check width/depth), Corrosion (assess percentage coverage), Material wear (measure thickness loss), Structural deformation (check alignment). I can analyze your photos for these issues.';
                } else {
                    response = 'I can assist with: Quantity calculations, BOQ analysis, Material estimations, Defect identification, Cost optimization, and Engineering standards compliance. What specific area would you like help with?';
                }
                
                aiDiv.innerHTML = `<strong>🤖 AI Assistant:</strong> ${response}`;
                messages.appendChild(aiDiv);
                
                messages.scrollTop = messages.scrollHeight;
            }, 1000);
            
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
        }

        function loadAITemplates() {
            const templates = [
                'Calculate concrete volume for foundation',
                'Estimate steel reinforcement requirements',
                'Analyze pavement condition assessment',
                'BOQ optimization recommendations',
                'Material waste factor calculations'
            ];
            
            alert('AI Templates:\n' + templates.join('\n'));
        }

        function generateQRCode() {
            document.getElementById('qr-code-modal').style.display = 'flex';
        }

        function closeQRCodeModal() {
            document.getElementById('qr-code-modal').style.display = 'none';
        }

        function generateQRCodeContent() {
            const type = document.getElementById('qr-code-type').value;
            const display = document.getElementById('qr-code-display');
            
            let qrData = '';
            switch(type) {
                case 'inspection':
                    qrData = `Inspection Data - Asset: ${document.getElementById('estimation-asset').value || 'N/A'}, Status: ${document.getElementById('estimation-status').value || 'N/A'}`;
                    break;
                case 'estimation':
                    const total = costEstimationTable ? Array.from(costEstimationTable.tBodies[0].rows).reduce((sum, row) => sum + parseFloat(row.cells[9].textContent || 0), 0) : 0;
                    qrData = `Cost Estimation - Total: QAR ${total.toFixed(2)}`;
                    break;
                case 'location':
                    qrData = `GPS Location - Lat: ${document.getElementById('estimation-lat-display').textContent}, Lng: ${document.getElementById('estimation-lng-display').textContent}`;
                    break;
                case 'project':
                    qrData = `Project: ${currentProjectName}, Date: ${new Date().toLocaleDateString()}`;
                    break;
            }
            
            display.innerHTML = `
                <div style="width: 200px; height: 200px; background: white; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px solid #000; color: #000;">
                    📱 QR Code Generated
                </div>
                <p style="margin-top: 10px; font-size: 12px; word-break: break-all;">${qrData}</p>
            `;
        }

        function downloadQRCode() {
            alert('QR Code download functionality ready.');
        }

        function exportEstimationPDF() {
            alert('PDF export functionality ready. This would generate a comprehensive PDF report with all data.');
        }

        // Page management
        function showPage(pageId) {
            // This function handles page switching
            console.log('Switched to page:', pageId);
        }

        // Utility Functions
        function generateEstimationId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Engineering Platform - Enhanced Estimation & Inspection System Loaded');
            
            // Set default GPS mode
            switchEstimationLocationMode('auto');
            
            // Initialize first BOQ item
            if (boqData.length > 0) {
                updateEstimationBOQDetails(boqData[0].ref);
            }
        });
    </script>
</body>
</html>
