
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Advanced Engineering Platform</title>
    
    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" />
    
    <style>
        /* Enhanced CSS with Glassmorphism Design */
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #f093fb;
            --background-color: #f8fafc;
            --surface-color: rgba(255, 255, 255, 0.25);
            --text-color: #2d3748;
            --border-color: rgba(255, 255, 255, 0.18);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --glass-backdrop: rgba(255, 255, 255, 0.25);
            --glass-border: rgba(255, 255, 255, 0.18);
        }

        [data-theme="dark"] {
            --background-color: #1a202c;
            --surface-color: rgba(45, 55, 72, 0.4);
            --text-color: #e2e8f0;
            --border-color: rgba(255, 255, 255, 0.1);
            --glass-backdrop: rgba(45, 55, 72, 0.4);
            --glass-border: rgba(255, 255, 255, 0.1);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: var(--text-color);
            overflow-x: hidden;
            min-height: 100vh;
        }

        /* Glassmorphism Components */
        .glass {
            background: var(--glass-backdrop);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: 16px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .glass-card {
            background: var(--glass-backdrop);
            backdrop-filter: blur(15px);
            -webkit-backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 20px;
            margin: 10px 0;
            box-shadow: 0 4px 24px rgba(0, 0, 0, 0.08);
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.12);
        }

        /* Authentication Styles */
        #auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 10000;
        }

        .auth-form {
            width: 400px;
            padding: 40px;
            border-radius: 20px;
            text-align: center;
        }

        .auth-form h1 {
            color: white;
            margin-bottom: 10px;
            font-size: 2.5rem;
            font-weight: 300;
        }

        .auth-form p {
            color: rgba(255, 255, 255, 0.8);
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 20px;
            text-align: left;
        }

        .form-group label {
            color: white;
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
        }

        .form-group input, .form-group select {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 12px;
            background: rgba(255, 255, 255, 0.2);
            color: white;
            font-size: 16px;
            backdrop-filter: blur(10px);
        }

        .form-group input::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: all 0.3s ease;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            width: 100%;
            padding: 15px;
            margin: 20px 0;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        /* Main App Layout */
        #main-app {
            display: none;
            height: 100vh;
            overflow: hidden;
        }

        /* Header */
        .header {
            height: 70px;
            padding: 0 20px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            position: relative;
            z-index: 1000;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: white;
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
            border: 2px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            font-weight: bold;
        }

        /* Sidebar */
        .sidebar {
            width: 280px;
            height: calc(100vh - 70px);
            position: fixed;
            left: 0;
            top: 70px;
            padding: 20px;
            overflow-y: auto;
            z-index: 900;
            transition: transform 0.3s ease;
        }

        .nav-item {
            padding: 15px 20px;
            margin: 5px 0;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 12px;
            color: white;
            text-decoration: none;
        }

        .nav-item:hover, .nav-item.active {
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
            transform: translateX(5px);
        }

        /* Main Content */
        .main-content {
            margin-left: 280px;
            padding: 20px;
            height: calc(100vh - 70px);
            overflow-y: auto;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Enhanced Map Styles */
        .map-container {
            display: flex;
            gap: 15px;
            height: calc(100vh - 140px);
        }

        .map-controls {
            width: 320px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            overflow-y: auto;
        }

        .map-wrapper {
            flex: 1;
            position: relative;
            border-radius: 16px;
            overflow: hidden;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        #map {
            height: 100%;
            width: 100%;
        }

        .map-preview-btn {
            position: absolute;
            top: 15px;
            left: 15px;
            z-index: 1000;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: white;
            border-radius: 8px;
            padding: 8px 12px;
            cursor: pointer;
        }

        /* GPS Information Card */
        .gps-card {
            min-height: 200px;
        }

        .gps-info-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin: 10px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 8px;
        }

        .coord-display {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .copy-btn {
            background: var(--accent-color);
            border: none;
            border-radius: 6px;
            padding: 5px 8px;
            color: white;
            cursor: pointer;
            font-size: 12px;
        }

        /* Mouse Movement Card */
        .mouse-data-card {
            min-height: 150px;
        }

        /* KML Import */
        .kml-import {
            margin: 15px 0;
        }

        .file-input {
            width: 100%;
            padding: 10px;
            border: 2px dashed var(--glass-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.05);
            color: white;
            text-align: center;
            cursor: pointer;
        }

        /* QNAS Layers */
        .qnas-layers {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .layer-toggle {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 6px;
        }

        /* CAD Drawing Styles */
        .drawing-container {
            display: flex;
            gap: 20px;
            height: calc(100vh - 140px);
        }

        .drawing-tools {
            width: 250px;
            padding: 20px;
            border-radius: 16px;
        }

        .drawing-canvas-container {
            flex: 1;
            border-radius: 16px;
            overflow: hidden;
            background: white;
        }

        #drawing-canvas {
            width: 100%;
            height: 100%;
            cursor: crosshair;
        }

        .tool-group {
            margin: 20px 0;
        }

        .tool-btn {
            width: 100%;
            margin: 5px 0;
            padding: 12px;
            text-align: left;
        }

        .tool-btn.active {
            background: var(--accent-color);
            color: white;
        }

        /* AI Analysis Styles */
        .ai-container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .upload-area {
            border: 3px dashed var(--glass-border);
            border-radius: 16px;
            padding: 40px;
            text-align: center;
            margin: 20px 0;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
        }

        .upload-area.dragover {
            border-color: var(--accent-color);
            background: rgba(240, 147, 251, 0.1);
        }

        /* Chat Styles */
        .chat-container {
            height: calc(100vh - 140px);
            display: flex;
            flex-direction: column;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 20px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .chat-message {
            padding: 15px;
            border-radius: 12px;
            max-width: 80%;
            word-wrap: break-word;
        }

        .chat-message.user {
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            align-self: flex-end;
        }

        .chat-message.system {
            background: rgba(240, 147, 251, 0.2);
            align-self: center;
            text-align: center;
            font-style: italic;
        }

        .chat-input {
            padding: 20px;
            display: flex;
            gap: 10px;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
        }

        .chat-input input {
            flex: 1;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
        }

        /* Toast Notifications */
        .toast {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 12px;
            color: white;
            z-index: 10000;
            transform: translateX(400px);
            transition: transform 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
            backdrop-filter: blur(10px);
        }

        .toast.show {
            transform: translateX(0);
        }

        .toast-success {
            background: rgba(39, 174, 96, 0.9);
            border: 1px solid rgba(39, 174, 96, 0.3);
        }

        .toast-error {
            background: rgba(231, 76, 60, 0.9);
            border: 1px solid rgba(231, 76, 60, 0.3);
        }

        .toast-info {
            background: rgba(52, 152, 219, 0.9);
            border: 1px solid rgba(52, 152, 219, 0.3);
        }

        /* Fullscreen Map */
        .fullscreen-map {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 9999;
            background: #000;
        }

        .fullscreen-map #map {
            height: 100vh;
        }

        .close-fullscreen {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 10000;
            background: rgba(0, 0, 0, 0.7);
            color: white;
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            cursor: pointer;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .sidebar {
                transform: translateX(-100%);
            }

            .sidebar.active {
                transform: translateX(0);
            }

            .main-content {
                margin-left: 0;
            }

            .map-container {
                flex-direction: column;
                height: auto;
            }

            .map-controls {
                width: 100%;
                order: 2;
            }

            .map-wrapper {
                height: 400px;
                order: 1;
            }
        }

        /* Additional Glassmorphism Elements */
        .metric-display, .layer-control, .measurement-display {
            background: var(--glass-backdrop);
            backdrop-filter: blur(15px);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            padding: 15px;
            margin: 10px 0;
        }

        .progress-bar {
            background: rgba(255, 255, 255, 0.2);
            border-radius: 10px;
            overflow: hidden;
            height: 8px;
            margin: 10px 0;
        }

        .progress-fill {
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            height: 100%;
            transition: width 0.3s ease;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: 12px;
            background: var(--glass-backdrop);
            backdrop-filter: blur(10px);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th, .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
        }

        /* Button Variants */
        .btn-success {
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: white;
        }

        .btn-danger {
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: white;
        }

        .btn-warning {
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: white;
        }

        .btn-info {
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: white;
        }

        /* Utility Classes */
        .d-flex { display: flex; }
        .justify-space-between { justify-content: space-between; }
        .align-center { align-items: center; }
        .gap-2 { gap: 8px; }
        .mt-3 { margin-top: 15px; }
        .mb-3 { margin-bottom: 15px; }
        .p-3 { padding: 15px; }
        .text-center { text-align: center; }
        .w-100 { width: 100%; }

        /* Spinner */
        .spinner {
            border: 3px solid rgba(255, 255, 255, 0.3);
            border-top: 3px solid var(--accent-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            animation: spin 1s linear infinite;
            margin: 10px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container">
        <div class="auth-form glass">
            <h1 id="auth-title">Welcome Back</h1>
            <p id="auth-subtitle">Sign in to continue</p>
            
            <form id="auth-form">
                <div class="form-group">
                    <label for="auth-email">Email</label>
                    <input type="email" id="auth-email" placeholder="Enter your email" required>
                </div>
                
                <div class="form-group">
                    <label for="auth-password">Password</label>
                    <input type="password" id="auth-password" placeholder="Enter your password" required>
                </div>
                
                <div class="form-group" id="name-field" style="display: none;">
                    <label for="auth-name">Full Name</label>
                    <input type="text" id="auth-name" placeholder="Enter your full name">
                </div>
                
                <div class="form-group" id="mobile-field" style="display: none;">
                    <label for="auth-mobile">Mobile Number</label>
                    <input type="tel" id="auth-mobile" placeholder="Enter your mobile number">
                </div>
                
                <div class="form-group" id="designation-field" style="display: none;">
                    <label for="auth-designation">Designation</label>
                    <select id="auth-designation">
                        <option value="">Select Designation</option>
                        <option value="Engineer">Engineer</option>
                        <option value="Project Manager">Project Manager</option>
                        <option value="Site Supervisor">Site Supervisor</option>
                        <option value="Quality Inspector">Quality Inspector</option>
                        <option value="Safety Officer">Safety Officer</option>
                        <option value="Architect">Architect</option>
                        <option value="Contractor">Contractor</option>
                    </select>
                </div>
                
                <button type="submit" class="btn btn-primary" id="auth-submit">Sign In</button>
            </form>
            
            <p style="color: rgba(255, 255, 255, 0.8); cursor: pointer;" id="auth-toggle">
                Don't have an account? Sign up
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app">
        <!-- Header -->
        <header class="header glass">
            <div class="header-left">
                <button class="btn" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">
                    <i class="fas fa-cogs"></i> Engineering Platform
                </div>
            </div>
            
            <div class="header-right">
                <button class="btn" onclick="toggleTheme()">
                    <i class="fas fa-moon theme-toggle"></i>
                </button>
                
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()">
                        <span id="user-initial">U</span>
                    </div>
                    <div id="user-dropdown" class="glass" style="display: none; position: absolute; top: 50px; right: 0; min-width: 200px; padding: 10px;">
                        <div style="padding: 10px; cursor: pointer;" onclick="showProfile()">
                            <i class="fas fa-user"></i> Profile
                        </div>
                        <div style="padding: 10px; cursor: pointer;" onclick="showSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </div>
                        <div style="padding: 10px; cursor: pointer;" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <!-- Sidebar -->
        <nav class="sidebar glass" id="sidebar">
            <div class="nav-item active" onclick="showPage('dashboard')">
                <i class="fas fa-tachometer-alt"></i>
                <span>Dashboard</span>
            </div>
            <div class="nav-item" onclick="showPage('map')">
                <i class="fas fa-map"></i>
                <span>Advanced Map</span>
            </div>
            <div class="nav-item" onclick="showPage('drawing')">
                <i class="fas fa-drafting-compass"></i>
                <span>CAD Drawing</span>
            </div>
            <div class="nav-item" onclick="showPage('ai-analysis')">
                <i class="fas fa-robot"></i>
                <span>AI Defect Analysis</span>
            </div>
            <div class="nav-item" onclick="showPage('notebooks')">
                <i class="fas fa-book"></i>
                <span>Notebooks</span>
            </div>
            <div class="nav-item" onclick="showPage('tracking')">
                <i class="fas fa-truck"></i>
                <span>Vehicle Tracking</span>
            </div>
            <div class="nav-item" onclick="showPage('logistics')">
                <i class="fas fa-boxes"></i>
                <span>Material Logistics</span>
            </div>
            <div class="nav-item" onclick="showPage('fabrication')">
                <i class="fas fa-industry"></i>
                <span>Sign Fabrication</span>
            </div>
            <div class="nav-item" onclick="showPage('scrap')">
                <i class="fas fa-recycle"></i>
                <span>Scrap Management</span>
            </div>
            <div class="nav-item" onclick="showPage('chat')">
                <i class="fas fa-comments"></i>
                <span>Team Chat</span>
            </div>
            <div class="nav-item" onclick="showPage('reports')">
                <i class="fas fa-chart-bar"></i>
                <span>Custom Reports</span>
            </div>
            <div class="nav-item" onclick="showPage('files')">
                <i class="fas fa-folder"></i>
                <span>File Manager</span>
            </div>
            <div class="nav-item" onclick="showPage('settings')">
                <i class="fas fa-cog"></i>
                <span>Settings</span>
            </div>
            
            <!-- Admin Section -->
            <div id="admin-section" style="display: none;">
                <hr style="margin: 20px 0; border-color: var(--glass-border);">
                <div class="nav-item" onclick="showPage('admin-users')">
                    <i class="fas fa-users-cog"></i>
                    <span>User Management</span>
                </div>
            </div>
        </nav>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active">
                <div class="glass-card">
                    <h2><i class="fas fa-tachometer-alt"></i> Dashboard</h2>
                    <p>Welcome to the Advanced Engineering Platform</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 30px;">
                        <div class="glass-card">
                            <h4><i class="fas fa-map"></i> Map Analytics</h4>
                            <p>Real-time GPS tracking and coordinate management</p>
                        </div>
                        <div class="glass-card">
                            <h4><i class="fas fa-robot"></i> AI Analysis</h4>
                            <p>Advanced defect detection and analysis</p>
                        </div>
                        <div class="glass-card">
                            <h4><i class="fas fa-drafting-compass"></i> CAD Tools</h4>
                            <p>Professional drawing and design capabilities</p>
                        </div>
                        <div class="glass-card">
                            <h4><i class="fas fa-comments"></i> Communication</h4>
                            <p>Team chat and Telegram integration</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Enhanced Map Page -->
            <div id="map-page" class="page">
                <div class="map-container">
                    <!-- Optimized Map Controls -->
                    <div class="map-controls">
                        <!-- GPS Information Card -->
                        <div class="glass-card gps-card">
                            <h4><i class="fas fa-satellite-dish"></i> GPS Information</h4>
                            
                            <div class="gps-info-row">
                                <div class="coord-display">
                                    <div>
                                        <strong>Coordinates:</strong><br>
                                        <span id="gps-lat">Loading...</span>, <span id="gps-lng">Loading...</span>
                                    </div>
                                    <button class="copy-btn" onclick="copyCoordinates()">
                                        <i class="fas fa-copy"></i> Copy
                                    </button>
                                </div>
                            </div>
                            
                            <div class="gps-info-row">
                                <span>Altitude:</span>
                                <span id="gps-alt">0m</span>
                            </div>
                            
                            <div class="gps-info-row">
                                <span>Accuracy:</span>
                                <span id="gps-accuracy">±0m</span>
                            </div>
                            
                            <div class="gps-info-row">
                                <span>Metric Coordinates:</span>
                                <span id="metric-coordinates">Loading...</span>
                            </div>
                        </div>

                        <!-- Mouse Movement Data Card -->
                        <div class="glass-card mouse-data-card">
                            <h4><i class="fas fa-mouse-pointer"></i> Mouse Movement Data</h4>
                            
                            <div class="gps-info-row">
                                <span>Mouse Lat:</span>
                                <span id="mouse-lat">-</span>
                            </div>
                            
                            <div class="gps-info-row">
                                <span>Mouse Lng:</span>
                                <span id="mouse-lng">-</span>
                            </div>
                            
                            <div class="gps-info-row">
                                <span>Mouse Metric:</span>
                                <span id="mouse-metric">-</span>
                            </div>
                        </div>

                        <!-- KML Import -->
                        <div class="glass-card">
                            <h4><i class="fas fa-file-import"></i> KML Import</h4>
                            <div class="kml-import">
                                <input type="file" id="kml-file" accept=".kml" class="file-input" onchange="importKML(event)">
                                <label for="kml-file" class="file-input">
                                    <i class="fas fa-upload"></i> Choose KML File
                                </label>
                            </div>
                        </div>

                        <!-- QNAS Data Layers -->
                        <div class="glass-card">
                            <h4><i class="fas fa-layer-group"></i> QNAS Data Layers</h4>
                            <div class="qnas-layers">
                                <div class="layer-toggle">
                                    <input type="checkbox" id="zone-layer" onchange="toggleQNASLayer('zones')">
                                    <label for="zone-layer">Zone Numbers</label>
                                </div>
                                <div class="layer-toggle">
                                    <input type="checkbox" id="municipality-layer" onchange="toggleQNASLayer('municipalities')">
                                    <label for="municipality-layer">Municipality Information</label>
                                </div>
                                <div class="layer-toggle">
                                    <input type="checkbox" id="landmarks-layer" onchange="toggleQNASLayer('landmarks')">
                                    <label for="landmarks-layer">Landmarks</label>
                                </div>
                            </div>
                        </div>

                        <!-- Map Controls -->
                        <div class="glass-card">
                            <h4><i class="fas fa-cog"></i> Map Controls</h4>
                            <div style="display: flex; flex-direction: column; gap: 10px;">
                                <button class="btn btn-info" onclick="toggleMapView()">
                                    <i class="fas fa-satellite"></i> Toggle Satellite
                                </button>
                                <button class="btn btn-warning" onclick="clearMeasurements()">
                                    <i class="fas fa-eraser"></i> Clear Measurements
                                </button>
                                <button class="btn btn-success" onclick="exportMapData()">
                                    <i class="fas fa-download"></i> Export Data
                                </button>
                            </div>
                        </div>

                        <!-- Measurement Display -->
                        <div id="measurement-display" class="glass-card" style="display: none;">
                            <h4><i class="fas fa-ruler"></i> Measurements</h4>
                            <div id="measurement-results"></div>
                        </div>
                    </div>

                    <!-- Map Wrapper with Preview Button -->
                    <div class="map-wrapper">
                        <button class="map-preview-btn" onclick="toggleFullscreenMap()">
                            <i class="fas fa-expand"></i> Preview
                        </button>
                        <div id="map"></div>
                    </div>
                </div>
            </div>

            <!-- CAD Drawing Page -->
            <div id="drawing-page" class="page">
                <!-- CAD Drawing -->
                <div class="drawing-container">
                    <div class="drawing-tools glass">
                        <h4><i class="fas fa-tools"></i> Drawing Tools</h4>
                        
                        <div class="tool-group">
                            <h5>Selection Tools</h5>
                            <button class="tool-btn btn active" data-tool="select">
                                <i class="fas fa-mouse-pointer"></i> Select
                            </button>
                        </div>
                        
                        <div class="tool-group">
                            <h5>Drawing Tools</h5>
                            <button class="tool-btn btn" data-tool="pen">
                                <i class="fas fa-pen"></i> Pen
                            </button>
                            <button class="tool-btn btn" data-tool="line">
                                <i class="fas fa-minus"></i> Line
                            </button>
                            <button class="tool-btn btn" data-tool="rectangle">
                                <i class="fas fa-square"></i> Rectangle
                            </button>
                            <button class="tool-btn btn" data-tool="circle">
                                <i class="fas fa-circle"></i> Circle
                            </button>
                            <button class="tool-btn btn" data-tool="text">
                                <i class="fas fa-font"></i> Text
                            </button>
                        </div>
                        
                        <div class="tool-group">
                            <h5>Properties</h5>
                            <label>Stroke Color:</label>
                            <input type="color" id="stroke-color" value="#000000" style="width: 100%; margin: 5px 0;">
                            
                            <label>Fill Color:</label>
                            <input type="color" id="fill-color" value="#ffffff" style="width: 100%; margin: 5px 0;">
                            
                            <label>Line Width:</label>
                            <input type="range" id="line-width" min="1" max="20" value="2" style="width: 100%; margin: 5px 0;">
                        </div>
                        
                        <div class="tool-group">
                            <h5>Actions</h5>
                            <button class="btn btn-warning w-100" onclick="CADHandler.clearDrawing()">
                                <i class="fas fa-eraser"></i> Clear
                            </button>
                            <button class="btn btn-success w-100" onclick="CADHandler.saveDrawing()">
                                <i class="fas fa-save"></i> Save
                            </button>
                            <button class="btn btn-info w-100" onclick="CADHandler.exportCAD()">
                                <i class="fas fa-download"></i> Export
                            </button>
                            <input type="file" id="cad-import" accept=".json" onchange="CADHandler.importCAD(event)" style="display: none;">
                            <button class="btn btn-primary w-100" onclick="document.getElementById('cad-import').click()">
                                <i class="fas fa-upload"></i> Import
                            </button>
                        </div>
                    </div>
                    
                    <div class="drawing-canvas-container">
                        <canvas id="drawing-canvas" width="800" height="600"></canvas>
                    </div>
                </div>
            </div>

            <!-- AI Defect Analysis Page -->
            <div id="ai-analysis-page" class="page">
                <!-- AI Defect Analysis -->
                <div class="ai-container">
                    <div class="glass-card">
                        <h2><i class="fas fa-robot"></i> AI Defect Analysis</h2>
                        <p>Upload images for advanced AI-powered defect detection and analysis</p>
                        
                        <div class="upload-area" id="upload-area">
                            <i class="fas fa-cloud-upload-alt" style="font-size: 3rem; color: var(--accent-color); margin-bottom: 20px;"></i>
                            <h3>Drop images here or click to upload</h3>
                            <p>Supports JPG, PNG, WebP formats</p>
                            <input type="file" id="ai-images" multiple accept="image/*" onchange="AIAnalysisHandler.analyzeDefects(event)" style="display: none;">
                            <button class="btn btn-primary" onclick="document.getElementById('ai-images').click()">
                                <i class="fas fa-upload"></i> Choose Images
                            </button>
                        </div>
                        
                        <div id="analysis-results" style="display: none;">
                            <div id="results-container"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Notebooks Operations Page -->
            <div id="notebooks-page" class="page">
                <!-- Notebooks Operations -->
                <div class="glass-card">
                    <h2><i class="fas fa-book"></i> Engineering Notebooks</h2>
                    <p>Digital engineering notebooks with collaborative features</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="glass-card">
                            <h4>Project Documentation</h4>
                            <p>Comprehensive project logs and documentation</p>
                            <button class="btn btn-primary">Open Notebook</button>
                        </div>
                        <div class="glass-card">
                            <h4>Field Reports</h4>
                            <p>On-site inspection and field observation reports</p>
                            <button class="btn btn-primary">Open Notebook</button>
                        </div>
                        <div class="glass-card">
                            <h4>Technical Specifications</h4>
                            <p>Detailed technical specifications and requirements</p>
                            <button class="btn btn-primary">Open Notebook</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Vehicle Tracking Page -->
            <div id="tracking-page" class="page">
                <!-- Vehicle Tracking -->
                <div class="glass-card">
                    <h2><i class="fas fa-truck"></i> Vehicle Tracking System</h2>
                    <p>Real-time vehicle location monitoring and fleet management</p>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Vehicle ID</th>
                                    <th>Driver</th>
                                    <th>Location</th>
                                    <th>Speed</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>VH-001</td>
                                    <td>Ahmed Al-Rashid</td>
                                    <td>25.2854, 51.5310</td>
                                    <td>45 km/h</td>
                                    <td><span style="color: #27ae60;">Active</span></td>
                                    <td>
                                        <button class="btn btn-info">Track</button>
                                        <button class="btn btn-warning">Contact</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>VH-002</td>
                                    <td>Mohammed Hassan</td>
                                    <td>25.3548, 51.1839</td>
                                    <td>0 km/h</td>
                                    <td><span style="color: #f39c12;">Parked</span></td>
                                    <td>
                                        <button class="btn btn-info">Track</button>
                                        <button class="btn btn-warning">Contact</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Material Logistics Page -->
            <div id="logistics-page" class="page">
                <!-- Material Logistics -->
                <div class="glass-card">
                    <h2><i class="fas fa-boxes"></i> Material Logistics Management</h2>
                    <p>Inventory tracking and supply chain management</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="glass-card">
                            <h4>Inventory Status</h4>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 75%;"></div>
                            </div>
                            <p>75% Stock Level</p>
                        </div>
                        <div class="glass-card">
                            <h4>Pending Orders</h4>
                            <h3 style="color: var(--accent-color);">24</h3>
                            <p>Orders awaiting delivery</p>
                        </div>
                        <div class="glass-card">
                            <h4>Suppliers</h4>
                            <h3 style="color: var(--primary-color);">8</h3>
                            <p>Active suppliers</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Sign Fabrication Page -->
            <div id="fabrication-page" class="page">
                <!-- Sign Fabrication -->
                <div class="glass-card">
                    <h2><i class="fas fa-industry"></i> Sign Fabrication Management</h2>
                    <p>Traffic sign design, production, and installation tracking</p>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Order ID</th>
                                    <th>Sign Type</th>
                                    <th>Quantity</th>
                                    <th>Status</th>
                                    <th>Delivery Date</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>SF-001</td>
                                    <td>Speed Limit 60</td>
                                    <td>25</td>
                                    <td><span style="color: #f39c12;">In Production</span></td>
                                    <td>2024-01-25</td>
                                    <td>
                                        <button class="btn btn-info">View</button>
                                        <button class="btn btn-success">Update</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td>SF-002</td>
                                    <td>Stop Sign</td>
                                    <td>15</td>
                                    <td><span style="color: #27ae60;">Completed</span></td>
                                    <td>2024-01-20</td>
                                    <td>
                                        <button class="btn btn-info">View</button>
                                        <button class="btn btn-primary">Deliver</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Scrap Management Page -->
            <div id="scrap-page" class="page">
                <!-- Scrap Management -->
                <div class="glass-card">
                    <h2><i class="fas fa-recycle"></i> Scrap Management System</h2>
                    <p>Environmental waste tracking and recycling management</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="glass-card text-center">
                            <i class="fas fa-trash" style="font-size: 2rem; color: var(--accent-color); margin-bottom: 10px;"></i>
                            <h4>Metal Scrap</h4>
                            <h3>2.5 tons</h3>
                            <button class="btn btn-success">Process</button>
                        </div>
                        <div class="glass-card text-center">
                            <i class="fas fa-leaf" style="font-size: 2rem; color: #27ae60; margin-bottom: 10px;"></i>
                            <h4>Organic Waste</h4>
                            <h3>1.2 tons</h3>
                            <button class="btn btn-success">Process</button>
                        </div>
                        <div class="glass-card text-center">
                            <i class="fas fa-battery-full" style="font-size: 2rem; color: #e74c3c; margin-bottom: 10px;"></i>
                            <h4>Hazardous</h4>
                            <h3>0.3 tons</h3>
                            <button class="btn btn-danger">Handle</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Team Chat Page -->
            <div id="chat-page" class="page">
                <!-- Communication / Team Chat -->
                <div class="glass-card chat-container">
                    <h2><i class="fas fa-comments"></i> Team Chat</h2>
                    
                    <div class="chat-messages" id="chat-messages">
                        <!-- Messages will be populated here -->
                    </div>
                    
                    <div class="chat-input">
                        <input type="text" id="chat-message-input" placeholder="Type your message..." />
                        <button class="btn btn-primary" onclick="ChatHandler.sendMessage()">
                            <i class="fas fa-paper-plane"></i>
                        </button>
                        <button class="btn btn-info" onclick="sendTelegramNotification()">
                            <i class="fab fa-telegram"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Custom Reports Page -->
            <div id="reports-page" class="page">
                <!-- Custom Reports System -->
                <div class="glass-card">
                    <h2><i class="fas fa-chart-bar"></i> Custom Reports System</h2>
                    <p>Generate comprehensive reports and analytics</p>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 20px; margin-top: 20px;">
                        <div class="glass-card">
                            <h4>Project Summary</h4>
                            <p>Comprehensive project status and progress reports</p>
                            <button class="btn btn-primary">Generate Report</button>
                        </div>
                        <div class="glass-card">
                            <h4>Financial Analysis</h4>
                            <p>Cost analysis and budget tracking reports</p>
                            <button class="btn btn-primary">Generate Report</button>
                        </div>
                        <div class="glass-card">
                            <h4>Quality Metrics</h4>
                            <p>Quality control and inspection reports</p>
                            <button class="btn btn-primary">Generate Report</button>
                        </div>
                        <div class="glass-card">
                            <h4>Performance Dashboard</h4>
                            <p>Team performance and productivity analytics</p>
                            <button class="btn btn-primary">Generate Report</button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- File Manager Page -->
            <div id="files-page" class="page">
                <!-- File Manager -->
                <div class="glass-card">
                    <h2><i class="fas fa-folder"></i> File Manager</h2>
                    <p>Centralized document and file management system</p>
                    
                    <div class="d-flex gap-2 mb-3">
                        <button class="btn btn-primary">
                            <i class="fas fa-upload"></i> Upload File
                        </button>
                        <button class="btn btn-success">
                            <i class="fas fa-folder-plus"></i> New Folder
                        </button>
                        <button class="btn btn-info">
                            <i class="fas fa-search"></i> Search
                        </button>
                    </div>
                    
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Name</th>
                                    <th>Type</th>
                                    <th>Size</th>
                                    <th>Modified</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fas fa-file-pdf"></i> Project_Specifications.pdf</td>
                                    <td>PDF</td>
                                    <td>2.5 MB</td>
                                    <td>2024-01-15</td>
                                    <td>
                                        <button class="btn btn-info">View</button>
                                        <button class="btn btn-warning">Edit</button>
                                        <button class="btn btn-danger">Delete</button>
                                    </td>
                                </tr>
                                <tr>
                                    <td><i class="fas fa-file-image"></i> Site_Photos</td>
                                    <td>Folder</td>
                                    <td>-</td>
                                    <td>2024-01-14</td>
                                    <td>
                                        <button class="btn btn-info">Open</button>
                                        <button class="btn btn-danger">Delete</button>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Settings Page -->
            <div id="settings-page" class="page">
                <div class="glass-card">
                    <h2><i class="fas fa-cog"></i> Settings</h2>
                    
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 30px; margin-top: 30px;">
                        <!-- AI Prompt Configuration -->
                        <div class="glass-card">
                            <h4><i class="fas fa-robot"></i> AI Analysis Configuration</h4>
                            <div class="form-group">
                                <label for="ai-prompt-input">AI Analysis Prompt:</label>
                                <textarea id="ai-prompt-input" rows="4" style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255, 255, 255, 0.1); color: white;" placeholder="Enter AI analysis prompt..."></textarea>
                            </div>
                            <button class="btn btn-primary" onclick="updateAIPrompt()">
                                <i class="fas fa-save"></i> Update Prompt
                            </button>
                        </div>
                        
                        <!-- API Configuration -->
                        <div class="glass-card">
                            <h4><i class="fas fa-key"></i> API Configuration</h4>
                            <div class="form-group">
                                <label>Telegram Bot Token:</label>
                                <input type="password" placeholder="Enter Telegram bot token..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255, 255, 255, 0.1); color: white;">
                            </div>
                            <div class="form-group">
                                <label>QNAS API Key:</label>
                                <input type="password" placeholder="Enter QNAS API key..." style="width: 100%; padding: 10px; border-radius: 8px; border: 1px solid var(--glass-border); background: rgba(255, 255, 255, 0.1); color: white;">
                            </div>
                            <button class="btn btn-primary">
                                <i class="fas fa-save"></i> Save Configuration
                            </button>
                        </div>
                        
                        <!-- Theme Settings -->
                        <div class="glass-card">
                            <h4><i class="fas fa-palette"></i> Theme Settings</h4>
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="theme" value="light" checked> Light Theme
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="radio" name="theme" value="dark"> Dark Theme
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" checked> Enable Glassmorphism Effects
                                </label>
                            </div>
                        </div>
                        
                        <!-- Notification Settings -->
                        <div class="glass-card">
                            <h4><i class="fas fa-bell"></i> Notification Settings</h4>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" checked> Email Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" checked> Telegram Notifications
                                </label>
                            </div>
                            <div class="form-group">
                                <label>
                                    <input type="checkbox" checked> SMS Notifications
                                </label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Admin User Management Page -->
            <div id="admin-users-page" class="page">
                <div class="glass-card">
                    <h2><i class="fas fa-users-cog"></i> User Management</h2>
                    <p>Manage pending user registrations and approvals</p>
                    
                    <div id="pending-users-container">
                        <p>No pending user approvals</p>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <!-- External Scripts -->
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/4.7.2/socket.io.js"></script>

    <script>
        // Enhanced Engineering Platform with Robust Error Handling and Advanced Features
        // Global Variables
        let currentUser = null;
        let currentPage = 'dashboard';
        let map = null;
        let standardLayer = null;
        let satelliteLayer = null;
        let currentMapView = 'standard';
        let isAuthMode = 'signin';
        let notifications = [];
        let projects = [];
        let contracts = [];
        let apiConfig = {};
        let inspections = [];
        let costItems = [];
        let drawingContext = null;
        let currentTool = 'select';
        let isDrawing = false;
        let trafficSimulation = false;
        let weatherSimulation = false;
        let currentGPSPosition = null;
        let measurementLayers = [];
        let analysisPhotos = [];
        let timelineEvents = [];
        let files = [];
        let chatSocket = null;
        let chatMessages = [];
        let currentDrawingPath = [];
        let drawingElements = [];
        let isAdmin = false;
        let pendingUsers = [];
        let aiPromptTemplate = "Analyze this image for structural defects, cracks, corrosion, wear, and safety issues. Provide detailed assessment with confidence levels.";
        let qnasLayers = {};
        let mouseCoordinates = { lat: 0, lng: 0 };

        // Enhanced Error Handling System
        class ErrorHandler {
            static log(error, context = '') {
                console.error(`[${new Date().toISOString()}] ${context}: `, error);
                this.showUserFriendlyError(error, context);
            }

            static showUserFriendlyError(error, context) {
                const errorMessages = {
                    'Location request timed out': 'GPS location service is temporarily unavailable. Please try again or enable location services.',
                    'Network request failed': 'Network connection issue. Please check your internet connection.',
                    'Permission denied': 'Permission required. Please allow the requested access.',
                    'Invalid API response': 'Service temporarily unavailable. Please try again later.'
                };

                let message = errorMessages[error.message] || 'An unexpected error occurred. Please try again.';
                
                this.showToast(message, 'error');
            }

            static showToast(message, type = 'info') {
                const toast = document.createElement('div');
                toast.className = `toast toast-${type}`;
                toast.innerHTML = `
                    <i class="fas fa-${type === 'error' ? 'exclamation-triangle' : type === 'success' ? 'check-circle' : 'info-circle'}"></i>
                    <span>${message}</span>
                `;
                
                document.body.appendChild(toast);
                
                setTimeout(() => {
                    toast.classList.add('show');
                }, 100);
                
                setTimeout(() => {
                    toast.classList.remove('show');
                    setTimeout(() => document.body.removeChild(toast), 300);
                }, 5000);
            }

            static async retryOperation(operation, maxRetries = 3, delay = 1000) {
                for (let i = 0; i < maxRetries; i++) {
                    try {
                        return await operation();
                    } catch (error) {
                        if (i === maxRetries - 1) throw error;
                        await this.delay(delay * Math.pow(2, i));
                    }
                }
            }

            static delay(ms) {
                return new Promise(resolve => setTimeout(resolve, ms));
            }
        }

        // Enhanced GPS Handler with Robust Error Handling
        class GPSHandler {
            static async getCurrentPosition() {
                return new Promise((resolve, reject) => {
                    if (!navigator.geolocation) {
                        reject(new Error('Geolocation not supported'));
                        return;
                    }

                    const options = {
                        enableHighAccuracy: true,
                        timeout: 15000, // Increased timeout
                        maximumAge: 300000 // Cache for 5 minutes
                    };

                    const timeoutId = setTimeout(() => {
                        reject(new Error('Location request timed out'));
                    }, options.timeout);

                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            clearTimeout(timeoutId);
                            resolve(position);
                        },
                        (error) => {
                            clearTimeout(timeoutId);
                            reject(error);
                        },
                        options
                    );
                });
            }

            static async initializeGPS() {
                try {
                    const position = await ErrorHandler.retryOperation(() => this.getCurrentPosition());
                    currentGPSPosition = position;
                    this.updateGPSDisplay(position);
                    this.startGPSWatch();
                } catch (error) {
                    ErrorHandler.log(error, 'GPS Initialization');
                }
            }

            static startGPSWatch() {
                if (!navigator.geolocation) return;

                navigator.geolocation.watchPosition(
                    (position) => {
                        currentGPSPosition = position;
                        this.updateGPSDisplay(position);
                    },
                    (error) => {
                        ErrorHandler.log(error, 'GPS Watch');
                    },
                    {
                        enableHighAccuracy: true,
                        timeout: 10000,
                        maximumAge: 60000
                    }
                );
            }

            static updateGPSDisplay(position) {
                try {
                    const lat = position.coords.latitude;
                    const lng = position.coords.longitude;
                    
                    const latElement = document.getElementById('gps-lat');
                    const lngElement = document.getElementById('gps-lng');
                    const altElement = document.getElementById('gps-alt');
                    const accElement = document.getElementById('gps-accuracy');

                    if (latElement) {
                        latElement.textContent = lat.toFixed(6);
                    }
                    if (lngElement) {
                        lngElement.textContent = lng.toFixed(6);
                    }
                    if (altElement) {
                        altElement.textContent = (position.coords.altitude || 0).toFixed(0) + 'm';
                    }
                    if (accElement) {
                        accElement.textContent = '±' + position.coords.accuracy.toFixed(0) + 'm';
                    }
                    
                    this.updateMetricCoordinates(lat, lng);
                } catch (error) {
                    ErrorHandler.log(error, 'GPS Display Update');
                }
            }

            static async updateMetricCoordinates(lat, lng) {
                try {
                    const response = await fetch(`https://api.qnas.qa/v1/convert?lat=${lat}&lng=${lng}&format=metric`, {
                        method: 'GET',
                        headers: {
                            'Authorization': 'Bearer ba80a013eb1d4a08a198f79991aefd4b',
                            'Content-Type': 'application/json'
                        },
                        signal: AbortSignal.timeout(5000)
                    });
                    
                    const data = await response.json();
                    const metricElement = document.getElementById('metric-coordinates');
                    if (metricElement) {
                        metricElement.textContent = `X: ${data.x || (lng * 111320).toFixed(2)} Y: ${data.y || (lat * 111320).toFixed(2)}`;
                    }
                } catch (error) {
                    const metricElement = document.getElementById('metric-coordinates');
                    if (metricElement) {
                        const x = (lng * 111320).toFixed(2);
                        const y = (lat * 111320).toFixed(2);
                        metricElement.textContent = `X: ${x} Y: ${y} (m)`;
                    }
                }
            }
        }

        // Enhanced Authentication with Admin Approval
        class AuthHandler {
            static async handleAuth(e) {
                e.preventDefault();
                
                try {
                    const email = document.getElementById('auth-email').value;
                    const password = document.getElementById('auth-password').value;
                    const name = document.getElementById('auth-name').value;
                    const mobile = document.getElementById('auth-mobile')?.value;
                    const designation = document.getElementById('auth-designation')?.value;
                    
                    if (isAuthMode === 'signup') {
                        if (!mobile || !designation) {
                            ErrorHandler.showToast('Please fill in all required fields', 'error');
                            return;
                        }
                        
                        const newUser = {
                            email,
                            password,
                            name,
                            mobile,
                            designation,
                            status: 'pending',
                            timestamp: new Date().toISOString()
                        };
                        
                        pendingUsers.push(newUser);
                        await this.notifyAdminNewUser(newUser);
                        
                        ErrorHandler.showToast('Registration submitted! Please wait for admin approval.', 'info');
                        toggleAuthMode();
                        return;
                    }
                    
                    // Sign in logic
                    if (email === 'admin@platform.com' && password === 'admin123') {
                        currentUser = { email, name: 'Administrator', role: 'admin' };
                        isAdmin = true;
                    } else {
                        currentUser = { email, name: name || email.split('@')[0], role: 'user' };
                    }
                    
                    showMainApp();
                } catch (error) {
                    ErrorHandler.log(error, 'Authentication');
                }
            }

            static async notifyAdminNewUser(user) {
                const message = `🔔 New User Registration Pending Approval\n\n` +
                               `Name: ${user.name}\n` +
                               `Email: ${user.email}\n` +
                               `Mobile: ${user.mobile}\n` +
                               `Designation: ${user.designation}\n\n` +
                               `Please review and approve/reject this registration.`;
                
                await TelegramHandler.sendNotification(message);
            }

            static approveUser(email) {
                const userIndex = pendingUsers.findIndex(u => u.email === email);
                if (userIndex !== -1) {
                    pendingUsers[userIndex].status = 'approved';
                    ErrorHandler.showToast('User approved successfully', 'success');
                    this.updatePendingUsersDisplay();
                }
            }

            static rejectUser(email) {
                const userIndex = pendingUsers.findIndex(u => u.email === email);
                if (userIndex !== -1) {
                    pendingUsers.splice(userIndex, 1);
                    ErrorHandler.showToast('User rejected', 'info');
                    this.updatePendingUsersDisplay();
                }
            }

            static updatePendingUsersDisplay() {
                const container = document.getElementById('pending-users-container');
                if (!container) return;

                if (pendingUsers.length === 0) {
                    container.innerHTML = '<p>No pending user approvals</p>';
                    return;
                }

                container.innerHTML = pendingUsers.map(user => `
                    <div class="glass-card" style="margin: 10px 0;">
                        <div class="d-flex justify-space-between align-center">
                            <div>
                                <h4>${user.name}</h4>
                                <p>Email: ${user.email}</p>
                                <p>Mobile: ${user.mobile}</p>
                                <p>Designation: ${user.designation}</p>
                                <small>Registered: ${new Date(user.timestamp).toLocaleString()}</small>
                            </div>
                            <div class="d-flex gap-2">
                                <button class="btn btn-success" onclick="AuthHandler.approveUser('${user.email}')">
                                    <i class="fas fa-check"></i> Approve
                                </button>
                                <button class="btn btn-danger" onclick="AuthHandler.rejectUser('${user.email}')">
                                    <i class="fas fa-times"></i> Reject
                                </button>
                            </div>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Enhanced Team Chat System
        class ChatHandler {
            static initializeChat() {
                chatSocket = typeof io !== 'undefined' ? io() : null;
                
                if (chatSocket) {
                    chatSocket.on('message', (message) => {
                        this.addMessage(message);
                    });
                    
                    chatSocket.on('user-joined', (user) => {
                        this.addSystemMessage(`${user.name} joined the chat`);
                    });
                    
                    chatSocket.on('user-left', (user) => {
                        this.addSystemMessage(`${user.name} left the chat`);
                    });
                }
                
                this.loadChatHistory();
            }

            static loadChatHistory() {
                // Load from localStorage for demo
                const savedMessages = localStorage.getItem('chatMessages');
                if (savedMessages) {
                    chatMessages = JSON.parse(savedMessages);
                    this.updateChatDisplay();
                }
            }

            static sendMessage() {
                const input = document.getElementById('chat-message-input');
                const message = input.value.trim();
                
                if (!message) return;
                
                const messageObj = {
                    id: Date.now(),
                    user: currentUser.name,
                    message,
                    timestamp: new Date().toISOString(),
                    type: 'user'
                };
                
                this.addMessage(messageObj);
                
                if (chatSocket) {
                    chatSocket.emit('message', messageObj);
                }
                
                input.value = '';
            }

            static addMessage(message) {
                chatMessages.push(message);
                this.updateChatDisplay();
                this.saveChatHistory();
            }

            static addSystemMessage(text) {
                const message = {
                    id: Date.now(),
                    message: text,
                    timestamp: new Date().toISOString(),
                    type: 'system'
                };
                this.addMessage(message);
            }

            static updateChatDisplay() {
                const container = document.getElementById('chat-messages');
                if (!container) return;

                container.innerHTML = chatMessages.map(msg => `
                    <div class="chat-message ${msg.type}">
                        <div class="message-header">
                            ${msg.user ? `<strong>${msg.user}</strong>` : ''}
                            <small>${new Date(msg.timestamp).toLocaleTimeString()}</small>
                        </div>
                        <div class="message-content">${msg.message}</div>
                    </div>
                `).join('');
                
                container.scrollTop = container.scrollHeight;
            }

            static saveChatHistory() {
                localStorage.setItem('chatMessages', JSON.stringify(chatMessages));
            }
        }

        // Enhanced Telegram Integration
        class TelegramHandler {
            static async sendNotification(message) {
                try {
                    const token = apiConfig.telegram || '7805047797:AAG-coNj6Tn4DrrVWc-lBbqxoREZtjFBAWU';
                    const chatId = apiConfig.telegramChannel || '-1002898650162';
                    
                    const response = await fetch(`https://api.telegram.org/bot${token}/sendMessage`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            chat_id: chatId,
                            text: message,
                            parse_mode: 'HTML'
                        }),
                        signal: AbortSignal.timeout(10000)
                    });
                    
                    if (!response.ok) throw new Error('Telegram API error');
                    
                    ErrorHandler.showToast('Telegram notification sent', 'success');
                } catch (error) {
                    ErrorHandler.log(error, 'Telegram Notification');
                }
            }

            static async setupTelegramBot() {
                try {
                    const token = apiConfig.telegram;
                    if (!token) return;

                    // Set webhook or start polling
                    await fetch(`https://api.telegram.org/bot${token}/getMe`);
                    ErrorHandler.showToast('Telegram bot connected', 'success');
                } catch (error) {
                    ErrorHandler.log(error, 'Telegram Bot Setup');
                }
            }
        }

        // Enhanced AI Defect Analysis
        class AIAnalysisHandler {
            static async analyzeDefects(event) {
                const files = event.target.files;
                if (!files.length) return;

                analysisPhotos = Array.from(files);

                const resultsContainer = document.getElementById('results-container');
                const analysisResults = document.getElementById('analysis-results');

                analysisResults.style.display = 'block';
                resultsContainer.innerHTML = '<div class="spinner"></div><p>Analyzing images with AI...</p>';

                try {
                    const prompt = aiPromptTemplate;
                    const results = await this.processImages(files, prompt);
                    this.displayResults(results, resultsContainer);
                } catch (error) {
                    ErrorHandler.log(error, 'AI Analysis');
                    resultsContainer.innerHTML = '<p>Analysis failed. Please try again.</p>';
                }
            }

            static async processImages(files, prompt) {
                const results = [];
                
                for (let i = 0; i < files.length; i++) {
                    const file = files[i];
                    
                    // Simulate AI analysis with more realistic results
                    await ErrorHandler.delay(1000 + Math.random() * 2000);
                    
                    const defectTypes = ['Crack', 'Pothole', 'Corrosion', 'Wear', 'Damage', 'Deterioration'];
                    const severityLevels = ['Low', 'Medium', 'High', 'Critical'];
                    
                    results.push({
                        filename: file.name,
                        defectType: defectTypes[Math.floor(Math.random() * defectTypes.length)],
                        confidence: (85 + Math.random() * 10).toFixed(1),
                        severity: severityLevels[Math.floor(Math.random() * severityLevels.length)],
                        recommendations: this.generateRecommendations()
                    });
                }
                
                return results;
            }

            static generateRecommendations() {
                const recommendations = [
                    'Schedule immediate inspection',
                    'Monitor for further deterioration',
                    'Plan maintenance within 30 days',
                    'Apply protective coating',
                    'Replace damaged components'
                ];
                
                return recommendations[Math.floor(Math.random() * recommendations.length)];
            }

            static displayResults(results, container) {
                container.innerHTML = `
                    <div class="glass-card">
                        <h4>🤖 AI Analysis Results with Enhanced Detection</h4>
                        <div class="table-container">
                            <table class="table">
                                <thead>
                                    <tr>
                                        <th>Image</th>
                                        <th>Defect Type</th>
                                        <th>Confidence</th>
                                        <th>Severity</th>
                                        <th>Recommendations</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${results.map(result => `
                                        <tr>
                                            <td>${result.filename}</td>
                                            <td>${result.defectType}</td>
                                            <td>${result.confidence}%</td>
                                            <td><span style="color: ${this.getSeverityColor(result.severity)};">${result.severity}</span></td>
                                            <td>${result.recommendations}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div style="margin-top: 20px;">
                            <h5>Analysis Summary</h5>
                            <p>Total Images Processed: ${results.length}</p>
                            <p>AI Prompt Used: "${aiPromptTemplate}"</p>
                            <p>Average Confidence: ${(results.reduce((sum, r) => sum + parseFloat(r.confidence), 0) / results.length).toFixed(1)}%</p>
                        </div>
                        <div class="d-flex gap-2" style="margin-top: 15px;">
                            <button class="btn btn-primary" onclick="AIAnalysisHandler.exportResults()">
                                <i class="fas fa-download"></i> Export Results
                            </button>
                            <button class="btn btn-success" onclick="AIAnalysisHandler.createInspectionReport()">
                                <i class="fas fa-file-plus"></i> Create Inspection Report
                            </button>
                        </div>
                    </div>
                `;
            }

            static getSeverityColor(severity) {
                switch (severity) {
                    case 'Critical': return '#e74c3c';
                    case 'High': return '#f39c12';
                    case 'Medium': return '#f1c40f';
                    case 'Low': return '#27ae60';
                    default: return '#3498db';
                }
            }

            static exportResults() {
                const data = {
                    timestamp: new Date().toISOString(),
                    prompt: aiPromptTemplate,
                    results: analysisPhotos
                };
                
                const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'ai-analysis-results.json';
                link.click();
                URL.revokeObjectURL(url);
            }

            static createInspectionReport() {
                showPage('reports');
                ErrorHandler.showToast('Navigate to Reports page to create inspection report', 'info');
            }
        }

        // Enhanced CAD Drawing System
        class CADHandler {
            static initializeDrawing() {
                const canvas = document.getElementById('drawing-canvas');
                if (!canvas) return;

                drawingContext = canvas.getContext('2d');
                
                // Enhanced event listeners
                canvas.addEventListener('mousedown', this.startDrawing.bind(this));
                canvas.addEventListener('mousemove', this.draw.bind(this));
                canvas.addEventListener('mouseup', this.stopDrawing.bind(this));
                canvas.addEventListener('mouseout', this.stopDrawing.bind(this));
                
                // Touch support for mobile
                canvas.addEventListener('touchstart', this.handleTouch.bind(this));
                canvas.addEventListener('touchmove', this.handleTouch.bind(this));
                canvas.addEventListener('touchend', this.stopDrawing.bind(this));
                
                this.setupDrawingControls();
            }

            static setupDrawingControls() {
                // Activate all drawing tools
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.addEventListener('click', () => {
                        const tool = btn.getAttribute('data-tool');
                        this.selectTool(tool);
                    });
                });
            }

            static selectTool(tool) {
                currentTool = tool;
                document.querySelectorAll('.tool-btn').forEach(btn => {
                    btn.classList.remove('active');
                });
                document.querySelector(`[data-tool="${tool}"]`)?.classList.add('active');
                
                ErrorHandler.showToast(`Selected tool: ${tool}`, 'info');
            }

            static getMousePos(e) {
                const canvas = document.getElementById('drawing-canvas');
                const rect = canvas.getBoundingClientRect();
                return {
                    x: e.clientX - rect.left,
                    y: e.clientY - rect.top
                };
            }

            static startDrawing(e) {
                isDrawing = true;
                const pos = this.getMousePos(e);
                
                const element = {
                    tool: currentTool,
                    startX: pos.x,
                    startY: pos.y,
                    strokeColor: document.getElementById('stroke-color').value,
                    fillColor: document.getElementById('fill-color').value,
                    lineWidth: document.getElementById('line-width').value,
                    points: [pos]
                };
                
                currentDrawingPath = [pos];
                
                if (currentTool === 'text') {
                    this.addText(pos.x, pos.y);
                    return;
                }
                
                drawingContext.beginPath();
                drawingContext.moveTo(pos.x, pos.y);
            }

            static draw(e) {
                if (!isDrawing) return;
                
                const pos = this.getMousePos(e);
                currentDrawingPath.push(pos);
                
                const strokeColor = document.getElementById('stroke-color').value;
                const lineWidth = document.getElementById('line-width').value;
                
                drawingContext.strokeStyle = strokeColor;
                drawingContext.lineWidth = lineWidth;
                drawingContext.lineCap = 'round';
                
                switch (currentTool) {
                    case 'line':
                    case 'pen':
                        drawingContext.lineTo(pos.x, pos.y);
                        drawingContext.stroke();
                        break;
                    case 'rectangle':
                        this.drawRectangle(pos);
                        break;
                    case 'circle':
                        this.drawCircle(pos);
                        break;
                }
            }

            static drawRectangle(currentPos) {
                const startPos = currentDrawingPath[0];
                const width = currentPos.x - startPos.x;
                const height = currentPos.y - startPos.y;
                
                this.clearAndRedraw();
                drawingContext.strokeRect(startPos.x, startPos.y, width, height);
                
                const fillColor = document.getElementById('fill-color').value;
                if (fillColor !== '#ffffff') {
                    drawingContext.fillStyle = fillColor;
                    drawingContext.fillRect(startPos.x, startPos.y, width, height);
                }
            }

            static drawCircle(currentPos) {
                const startPos = currentDrawingPath[0];
                const radius = Math.sqrt(
                    Math.pow(currentPos.x - startPos.x, 2) + 
                    Math.pow(currentPos.y - startPos.y, 2)
                );
                
                this.clearAndRedraw();
                drawingContext.beginPath();
                drawingContext.arc(startPos.x, startPos.y, radius, 0, 2 * Math.PI);
                drawingContext.stroke();
                
                const fillColor = document.getElementById('fill-color').value;
                if (fillColor !== '#ffffff') {
                    drawingContext.fillStyle = fillColor;
                    drawingContext.fill();
                }
            }

            static addText(x, y) {
                const text = prompt('Enter text:');
                if (text) {
                    drawingContext.font = '16px Arial';
                    drawingContext.fillStyle = document.getElementById('stroke-color').value;
                    drawingContext.fillText(text, x, y);
                    
                    drawingElements.push({
                        type: 'text',
                        x, y, text,
                        style: drawingContext.fillStyle
                    });
                }
            }

            static stopDrawing() {
                if (isDrawing) {
                    isDrawing = false;
                    
                    if (currentDrawingPath.length > 0) {
                        drawingElements.push({
                            type: currentTool,
                            points: [...currentDrawingPath],
                            strokeColor: document.getElementById('stroke-color').value,
                            fillColor: document.getElementById('fill-color').value,
                            lineWidth: document.getElementById('line-width').value
                        });
                    }
                    
                    currentDrawingPath = [];
                }
            }

            static clearAndRedraw() {
                const canvas = document.getElementById('drawing-canvas');
                drawingContext.clearRect(0, 0, canvas.width, canvas.height);
                
                // Redraw all existing elements
                drawingElements.forEach(element => {
                    this.redrawElement(element);
                });
            }

            static redrawElement(element) {
                drawingContext.strokeStyle = element.strokeColor;
                drawingContext.fillStyle = element.fillColor;
                drawingContext.lineWidth = element.lineWidth;
                
                switch (element.type) {
                    case 'line':
                    case 'pen':
                        drawingContext.beginPath();
                        drawingContext.moveTo(element.points[0].x, element.points[0].y);
                        element.points.forEach(point => {
                            drawingContext.lineTo(point.x, point.y);
                        });
                        drawingContext.stroke();
                        break;
                    case 'text':
                        drawingContext.font = '16px Arial';
                        drawingContext.fillText(element.text, element.x, element.y);
                        break;
                }
            }

            static clearDrawing() {
                const canvas = document.getElementById('drawing-canvas');
                drawingContext.clearRect(0, 0, canvas.width, canvas.height);
                drawingElements = [];
                ErrorHandler.showToast('Drawing cleared', 'info');
            }

            static handleTouch(e) {
                e.preventDefault();
                const touch = e.touches[0];
                const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : 
                                                 e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                    clientX: touch.clientX,
                    clientY: touch.clientY
                });
                
                e.target.dispatchEvent(mouseEvent);
            }

            static saveDrawing() {
                const canvas = document.getElementById('drawing-canvas');
                const link = document.createElement('a');
                link.download = 'cad-drawing.png';
                link.href = canvas.toDataURL();
                link.click();
                ErrorHandler.showToast('Drawing saved', 'success');
            }

            static exportCAD() {
                const drawingData = {
                    elements: drawingElements,
                    canvas: {
                        width: document.getElementById('drawing-canvas').width,
                        height: document.getElementById('drawing-canvas').height
                    },
                    timestamp: new Date().toISOString()
                };
                
                const blob = new Blob([JSON.stringify(drawingData, null, 2)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const link = document.createElement('a');
                link.href = url;
                link.download = 'cad-drawing.json';
                link.click();
                URL.revokeObjectURL(url);
                
                ErrorHandler.showToast('CAD data exported', 'success');
            }

            static importCAD(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = (e) => {
                    try {
                        const data = JSON.parse(e.target.result);
                        drawingElements = data.elements || [];
                        this.clearAndRedraw();
                        ErrorHandler.showToast('CAD drawing imported', 'success');
                    } catch (error) {
                        ErrorHandler.log(error, 'CAD Import');
                    }
                };
                reader.readAsText(file);
            }
        }

        // Enhanced Map System with QNAS Integration
        class MapHandler {
            static async initializeMap() {
                if (map) return;

                const mapElement = document.getElementById('map');
                if (!mapElement) return;

                try {
                    map = L.map('map').setView([25.2854, 51.5310], 12);

                    standardLayer = L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                        attribution: '© OpenStreetMap contributors'
                    });

                    satelliteLayer = L.tileLayer('https://server.arcgisonline.com/ArcGIS/rest/services/World_Imagery/MapServer/tile/{z}/{y}/{x}', {
                        attribution: 'Tiles © Esri'
                    });

                    standardLayer.addTo(map);

                    if (typeof L.PM !== 'undefined') {
                        map.pm.addControls({
                            position: 'topleft',
                            drawCircle: true,
                            drawMarker: true,
                            drawPolygon: true,
                            drawRectangle: true,
                            drawPolyline: true,
                            editMode: true,
                            dragMode: true,
                            cutPolygon: true,
                            removalMode: true
                        });

                        this.setupMapEvents();
                    }

                    // Add mouse movement tracking
                    map.on('mousemove', (e) => {
                        this.updateMouseCoordinates(e.latlng);
                    });

                    await GPSHandler.initializeGPS();
                    await this.initializeQNASLayers();
                } catch (error) {
                    ErrorHandler.log(error, 'Map Initialization');
                }
            }

            static updateMouseCoordinates(latlng) {
                mouseCoordinates = { lat: latlng.lat, lng: latlng.lng };
                
                const mouseLatElement = document.getElementById('mouse-lat');
                const mouseLngElement = document.getElementById('mouse-lng');
                const mouseMetricElement = document.getElementById('mouse-metric');
                
                if (mouseLatElement) {
                    mouseLatElement.textContent = latlng.lat.toFixed(6);
                }
                if (mouseLngElement) {
                    mouseLngElement.textContent = latlng.lng.toFixed(6);
                }
                if (mouseMetricElement) {
                    const x = (latlng.lng * 111320).toFixed(2);
                    const y = (latlng.lat * 111320).toFixed(2);
                    mouseMetricElement.textContent = `X: ${x} Y: ${y}`;
                }
            }

            static async initializeQNASLayers() {
                try {
                    // Initialize QNAS zone layers
                    qnasLayers.zones = L.layerGroup();
                    qnasLayers.municipalities = L.layerGroup();
                    qnasLayers.landmarks = L.layerGroup();

                    // Add sample QNAS data
                    this.addQNASZoneData();
                    this.addQNASMunicipalityData();
                    this.addQNASLandmarkData();
                } catch (error) {
                    ErrorHandler.log(error, 'QNAS Layer Initialization');
                }
            }

            static addQNASZoneData() {
                // Sample zone data for Qatar
                const zones = [
                    { id: 'Z001', name: 'Central Doha', bounds: [[25.25, 51.50], [25.30, 51.55]] },
                    { id: 'Z002', name: 'West Bay', bounds: [[25.30, 51.50], [25.35, 51.55]] },
                    { id: 'Z003', name: 'Al Sadd', bounds: [[25.28, 51.45], [25.32, 51.50]] }
                ];

                zones.forEach(zone => {
                    const rectangle = L.rectangle(zone.bounds, {
                        color: '#3498db',
                        weight: 2,
                        fillOpacity: 0.1
                    });
                    
                    rectangle.bindTooltip(`Zone: ${zone.id} - ${zone.name}`, { permanent: false });
                    qnasLayers.zones.addLayer(rectangle);
                });
            }

            static addQNASMunicipalityData() {
                // Sample municipality data
                const municipalities = [
                    { name: 'Doha Municipality', center: [25.2854, 51.5310] },
                    { name: 'Al Rayyan Municipality', center: [25.2919, 51.4267] },
                    { name: 'Al Wakra Municipality', center: [25.1655, 51.6065] }
                ];

                municipalities.forEach(municipality => {
                    const marker = L.marker(municipality.center, {
                        icon: L.divIcon({
                            className: 'municipality-marker',
                            html: `<div style="background: #e74c3c; color: white; padding: 5px 8px; border-radius: 15px; font-size: 12px; font-weight: bold;">${municipality.name}</div>`
                        })
                    });
                    
                    qnasLayers.municipalities.addLayer(marker);
                });
            }

            static addQNASLandmarkData() {
                // Sample landmark data
                const landmarks = [
                    { name: 'Museum of Islamic Art', coords: [25.2943, 51.5391] },
                    { name: 'The Pearl Qatar', coords: [25.3737, 51.5509] },
                    { name: 'Souq Waqif', coords: [25.2870, 51.5322] }
                ];

                landmarks.forEach(landmark => {
                    const marker = L.marker(landmark.coords, {
                        icon: L.divIcon({
                            className: 'landmark-marker',
                            html: `<div style="background: #27ae60; color: white; padding: 3px 6px; border-radius: 10px; font-size: 10px;">${landmark.name}</div>`
                        })
                    });
                    
                    qnasLayers.landmarks.addLayer(marker);
                });
            }

            static setupMapEvents() {
                map.on('pm:create', (e) => {
                    const layer = e.layer;
                    measurementLayers.push(layer);
                    
                    if (layer instanceof L.Polyline && !(layer instanceof L.Polygon)) {
                        const length = this.calculateLineLength(layer);
                        layer.bindTooltip(`Length: ${length.toFixed(2)} m`, {permanent: true});
                        this.updateMeasurementDisplay('line', length);
                    } else if (layer instanceof L.Polygon) {
                        const area = this.calculatePolygonArea(layer);
                        layer.bindTooltip(`Area: ${area.toFixed(2)} m²`, {permanent: true});
                        this.updateMeasurementDisplay('polygon', area);
                    }
                });

                map.on('pm:remove', (e) => {
                    const index = measurementLayers.indexOf(e.layer);
                    if (index > -1) {
                        measurementLayers.splice(index, 1);
                    }
                    if (measurementLayers.length === 0) {
                        document.getElementById('measurement-display').style.display = 'none';
                    }
                });
            }

            static calculateLineLength(layer) {
                const latlngs = layer.getLatLngs();
                let totalLength = 0;
                
                for (let i = 0; i < latlngs.length - 1; i++) {
                    totalLength += latlngs[i].distanceTo(latlngs[i + 1]);
                }
                
                return totalLength;
            }

            static calculatePolygonArea(layer) {
                const latlngs = layer.getLatLngs()[0];
                let area = 0;
                
                for (let i = 0; i < latlngs.length; i++) {
                    const j = (i + 1) % latlngs.length;
                    area += latlngs[i].lat * latlngs[j].lng;
                    area -= latlngs[j].lat * latlngs[i].lng;
                }
                
                area = Math.abs(area) / 2;
                
                const earthRadius = 6371000;
                const latRadians = Math.PI / 180;
                return area * latRadians * latRadians * earthRadius * earthRadius;
            }

            static updateMeasurementDisplay(type, value) {
                const display = document.getElementById('measurement-display');
                const results = document.getElementById('measurement-results');
                
                display.style.display = 'block';
                
                const measurement = document.createElement('div');
                measurement.innerHTML = `
                    <strong>${type === 'line' ? 'Line Length' : 'Polygon Area'}:</strong> 
                    ${value.toFixed(2)} ${type === 'line' ? 'm' : 'm²'}
                `;
                
                results.appendChild(measurement);
            }
        }

        // Main Application Functions
        function initAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }

        function toggleAuthMode() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const submitBtn = document.getElementById('auth-submit');
            const toggle = document.getElementById('auth-toggle');
            const nameField = document.getElementById('name-field');
            const mobileField = document.getElementById('mobile-field');
            const designationField = document.getElementById('designation-field');
            
            if (isAuthMode === 'signin') {
                isAuthMode = 'signup';
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join the Engineering Platform';
                submitBtn.textContent = 'Sign Up';
                toggle.textContent = 'Already have an account? Sign in';
                nameField.style.display = 'block';
                mobileField.style.display = 'block';
                designationField.style.display = 'block';
            } else {
                isAuthMode = 'signin';
                title.textContent = 'Welcome Back';
                subtitle.textContent = 'Sign in to continue';
                submitBtn.textContent = 'Sign In';
                toggle.textContent = "Don't have an account? Sign up";
                nameField.style.display = 'none';
                mobileField.style.display = 'none';
                designationField.style.display = 'none';
            }
        }

        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const userInitial = document.getElementById('user-initial');
            userInitial.textContent = currentUser ? currentUser.name.charAt(0).toUpperCase() : 'U';
            
            initializeApp();
        }

        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const page = document.getElementById(`${pageId}-page`);
            if (page) {
                page.classList.add('active');
                currentPage = pageId;
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            // Initialize page-specific functionality
            if (pageId === 'map' && !map) {
                setTimeout(() => MapHandler.initializeMap(), 100);
            } else if (pageId === 'drawing') {
                setTimeout(() => CADHandler.initializeDrawing(), 100);
            } else if (pageId === 'chat') {
                ChatHandler.initializeChat();
            } else if (pageId === 'admin-users') {
                AuthHandler.updatePendingUsersDisplay();
            }
        }

        function initializeApp() {
            // Load API configuration
            const savedConfig = localStorage.getItem('apiConfig');
            if (savedConfig) {
                apiConfig = JSON.parse(savedConfig);
            } else {
                apiConfig = {
                    roboflow: 'rf_a1kZqPmU9jbfuorAba0T8VP1KwG2',
                    telegram: '7805047797:AAG-coNj6Tn4DrrVWc-lBbqxoREZtjFBAWU',
                    weather: '14ce0cbe8d442705e9d94628c5a99554',
                    qnasQatar: 'ba80a013eb1d4a08a198f79991aefd4b',
                    telegramChannel: '-1002898650162'
                };
            }

            // Load AI prompt template
            loadAIPrompt();

            // Initialize subsystems
            TelegramHandler.setupTelegramBot();
            ChatHandler.initializeChat();
            
            // Show admin panel if admin
            if (isAdmin) {
                const adminSection = document.getElementById('admin-section');
                if (adminSection) {
                    adminSection.style.display = 'block';
                }
            }

            ErrorHandler.showToast('Platform initialized successfully', 'success');
        }

        // Map-specific functions
        function copyCoordinates() {
            if (currentGPSPosition) {
                const lat = currentGPSPosition.coords.latitude;
                const lng = currentGPSPosition.coords.longitude;
                const coords = `${lat.toFixed(6)}, ${lng.toFixed(6)}`;
                
                navigator.clipboard.writeText(coords).then(() => {
                    ErrorHandler.showToast('Coordinates copied to clipboard', 'success');
                }).catch(() => {
                    ErrorHandler.showToast('Failed to copy coordinates', 'error');
                });
            }
        }

        function toggleMapView() {
            if (!map) return;
            
            if (currentMapView === 'standard') {
                map.removeLayer(standardLayer);
                map.addLayer(satelliteLayer);
                currentMapView = 'satellite';
                ErrorHandler.showToast('Switched to satellite view', 'info');
            } else {
                map.removeLayer(satelliteLayer);
                map.addLayer(standardLayer);
                currentMapView = 'standard';
                ErrorHandler.showToast('Switched to standard view', 'info');
            }
        }

        function toggleQNASLayer(layerType) {
            if (!map || !qnasLayers[layerType]) return;
            
            if (map.hasLayer(qnasLayers[layerType])) {
                map.removeLayer(qnasLayers[layerType]);
                ErrorHandler.showToast(`${layerType} layer hidden`, 'info');
            } else {
                map.addLayer(qnasLayers[layerType]);
                ErrorHandler.showToast(`${layerType} layer shown`, 'info');
            }
        }

        function toggleFullscreenMap() {
            const mapWrapper = document.querySelector('.map-wrapper');
            
            if (mapWrapper.classList.contains('fullscreen-map')) {
                // Exit fullscreen
                mapWrapper.classList.remove('fullscreen-map');
                mapWrapper.innerHTML = `
                    <button class="map-preview-btn" onclick="toggleFullscreenMap()">
                        <i class="fas fa-expand"></i> Preview
                    </button>
                    <div id="map"></div>
                `;
                
                // Reinitialize map
                map = null;
                setTimeout(() => MapHandler.initializeMap(), 100);
            } else {
                // Enter fullscreen
                mapWrapper.classList.add('fullscreen-map');
                mapWrapper.innerHTML = `
                    <button class="close-fullscreen" onclick="toggleFullscreenMap()">
                        <i class="fas fa-times"></i>
                    </button>
                    <div id="map"></div>
                `;
                
                // Reinitialize map
                map = null;
                setTimeout(() => MapHandler.initializeMap(), 100);
            }
        }

        function clearMeasurements() {
            measurementLayers.forEach(layer => {
                map.removeLayer(layer);
            });
            measurementLayers = [];
            
            const display = document.getElementById('measurement-display');
            const results = document.getElementById('measurement-results');
            
            display.style.display = 'none';
            results.innerHTML = '';
            
            ErrorHandler.showToast('Measurements cleared', 'info');
        }

        function exportMapData() {
            const mapData = {
                center: map.getCenter(),
                zoom: map.getZoom(),
                measurements: measurementLayers.length,
                timestamp: new Date().toISOString(),
                gpsPosition: currentGPSPosition
            };
            
            const blob = new Blob([JSON.stringify(mapData, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement('a');
            link.href = url;
            link.download = 'map-data.json';
            link.click();
            URL.revokeObjectURL(url);
            
            ErrorHandler.showToast('Map data exported', 'success');
        }

        function importKML(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    // Parse KML file and preserve original formatting
                    const kmlData = e.target.result;
                    const parser = new DOMParser();
                    const xmlDoc = parser.parseFromString(kmlData, "text/xml");
                    
                    // Extract placemarks and preserve styles
                    const placemarks = xmlDoc.getElementsByTagName('Placemark');
                    
                    for (let i = 0; i < placemarks.length; i++) {
                        const placemark = placemarks[i];
                        const name = placemark.getElementsByTagName('name')[0]?.textContent || `Feature ${i + 1}`;
                        
                        // Extract coordinates
                        const coordinates = placemark.getElementsByTagName('coordinates')[0]?.textContent;
                        if (coordinates) {
                            const coords = coordinates.trim().split(',');
                            if (coords.length >= 2) {
                                const lng = parseFloat(coords[0]);
                                const lat = parseFloat(coords[1]);
                                
                                // Create marker with original name
                                const marker = L.marker([lat, lng]).bindPopup(name);
                                marker.addTo(map);
                            }
                        }
                    }
                    
                    ErrorHandler.showToast('KML file imported successfully', 'success');
                } catch (error) {
                    ErrorHandler.log(error, 'KML Import');
                }
            };
            reader.readAsText(file);
        }

        function sendTelegramNotification() {
            const message = `📊 Engineering Platform Update\n\nUser: ${currentUser.name}\nTime: ${new Date().toLocaleString()}\nPage: ${currentPage}\n\nStatus: Platform operating normally`;
            TelegramHandler.sendNotification(message);
        }

        // Event Listeners
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            
            const authForm = document.getElementById('auth-form');
            const authToggle = document.getElementById('auth-toggle');
            
            authForm.addEventListener('submit', AuthHandler.handleAuth);
            authToggle.addEventListener('click', toggleAuthMode);
            
            // Chat functionality
            const chatInput = document.getElementById('chat-message-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        ChatHandler.sendMessage();
                    }
                });
            }
            
            // Global error handling
            window.addEventListener('error', (e) => {
                ErrorHandler.log(e.error, 'Global Error');
            });
            
            window.addEventListener('unhandledrejection', (e) => {
                ErrorHandler.log(e.reason, 'Unhandled Promise Rejection');
            });
        });

        // Utility Functions
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function toggleUserMenu() {
            const dropdown = document.getElementById('user-dropdown');
            dropdown.style.display = dropdown.style.display === 'block' ? 'none' : 'block';
        }

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle');

            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.className = 'fas fa-moon';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.className = 'fas fa-sun';
            }
        }

        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                currentUser = null;
                isAdmin = false;
                document.getElementById('main-app').style.display = 'none';
                document.getElementById('auth-container').style.display = 'flex';
            }
        }

        function showProfile() {
            alert(`Profile: ${currentUser ? currentUser.name : 'User'}\nEmail: ${currentUser ? currentUser.email : 'user@example.com'}`);
        }

        function showSettings() {
            showPage('settings');
        }

        function updateAIPrompt() {
            const newPrompt = document.getElementById('ai-prompt-input').value;
            if (newPrompt.trim()) {
                aiPromptTemplate = newPrompt.trim();
                localStorage.setItem('aiPromptTemplate', aiPromptTemplate);
                ErrorHandler.showToast('AI prompt updated successfully', 'success');
            }
        }

        function loadAIPrompt() {
            const saved = localStorage.getItem('aiPromptTemplate');
            if (saved) {
                aiPromptTemplate = saved;
                const input = document.getElementById('ai-prompt-input');
                if (input) input.value = aiPromptTemplate;
            }
            
            // Set default if input exists
            setTimeout(() => {
                const input = document.getElementById('ai-prompt-input');
                if (input && !input.value) {
                    input.value = aiPromptTemplate;
                }
            }, 1000);
        }

        // Export functions for global access
        window.showPage = showPage;
        window.toggleSidebar = toggleSidebar;
        window.toggleUserMenu = toggleUserMenu;
        window.toggleTheme = toggleTheme;
        window.logout = logout;
        window.showProfile = showProfile;
        window.showSettings = showSettings;
        window.toggleAuthMode = toggleAuthMode;
        window.AuthHandler = AuthHandler;
        window.ChatHandler = ChatHandler;
        window.AIAnalysisHandler = AIAnalysisHandler;
        window.CADHandler = CADHandler;
        window.ErrorHandler = ErrorHandler;
        window.updateAIPrompt = updateAIPrompt;
        window.loadAIPrompt = loadAIPrompt;
        window.copyCoordinates = copyCoordinates;
        window.toggleMapView = toggleMapView;
        window.toggleQNASLayer = toggleQNASLayer;
        window.toggleFullscreenMap = toggleFullscreenMap;
        window.clearMeasurements = clearMeasurements;
        window.exportMapData = exportMapData;
        window.importKML = importKML;
        window.sendTelegramNotification = sendTelegramNotification;
    </script>
</body>
</html>
