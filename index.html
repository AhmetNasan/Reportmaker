<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Engineering Project Platform</title>

    <link href="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.css" rel="stylesheet">
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css">
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.4.0/mapbox-gl.js"></script>
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://unpkg.com/papaparse@5.3.2/papaparse.min.js"></script>
    <script src="https://unpkg.com/@mapbox/togeojson@0.16.0/togeojson.js"></script> <script src="https://unpkg.com/dxf-viewer@1.1.6/dist/dxf-viewer.js"></script>
    
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.socket.io/4.7.4/socket.io.min.js"></script> <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff9a9e;
            --text-light: #ffffff;
            --text-dark: #271930;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.37);
            --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.5);
            --border-radius: 15px;
            --transition: all 0.3s ease;
            --backdrop-blur: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Open Sans", sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("https://i.postimg.cc/0jv27Qvw/20008380-645221846.jpg"), #000;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
            z-index: -1;
            opacity: 0.3;
            transition: background 0.5s ease;
        }

        /* Glassmorphism Base Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .glass:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        /* Authentication Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 0 10px;
        }

        .wrapper {
            width: 400px;
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .wrapper:hover {
            box-shadow: var(--shadow-hover);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
        }

        .auth-logo {
            font-size: 2.2rem;
            margin-bottom: 25px;
            color: var(--text-light);
            letter-spacing: 1px;
        }

        .input-field {
            position: relative;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            margin: 20px 0;
        }

        .input-field label {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
            pointer-events: none;
            transition: var(--transition);
        }

        .input-field input {
            width: 100%;
            height: 40px;
            background: transparent;
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--text-light);
            padding: 0 10px;
        }

        .input-field input:focus~label,
        .input-field input:valid~label {
            font-size: 0.9rem;
            top: 10px;
            transform: translateY(-150%);
            color: #ffdde1;
        }

        .auth-btn {
            background-color: var(--text-dark);
            color: var(--text-light);
            font-weight: 600;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 25px;
            font-size: 16px;
            border: 2px solid transparent;
            transition: var(--transition);
            margin-top: 20px;
        }

        .auth-btn:hover {
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--text-light);
        }

        .auth-toggle {
            color: #ffdde1;
            cursor: pointer;
            margin-top: 30px;
            text-decoration: none;
        }

        .auth-toggle:hover {
            text-decoration: underline;
        }

        /* Main App Styles */
        .main-app {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 0 0 20px 20px;
            padding: 15px 30px;
            box-shadow: var(--shadow-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffdde1, #ff9a9e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            transition: var(--transition);
            color: var(--text-light);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glass);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glass);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: var(--shadow-glass);
            min-width: 200px;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .user-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .app-layout {
            display: flex;
            min-height: calc(100vh - 90px);
            gap: 20px;
            padding: 0 20px;
        }

        .sidebar {
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            overflow-y: auto;
            transition: var(--transition);
            height: fit-content;
        }

        .sidebar-toggle {
            display: none;
            background: var(--secondary-color);
            color: var(--text-light);
            border: none;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .nav-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: #ffdde1;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: #ffdde1;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-light);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glass);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            border: none;
        }
        .btn-success { 
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: var(--text-light);
            border: none;
        }
        .btn-danger { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: var(--text-light);
            border: none;
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: var(--text-light);
            border: none;
        }
        .btn-info { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: var(--text-light);
            border: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-light);
        }
        
        .form-input option {
            background-color: var(--text-dark);
            color: var(--text-light);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #ffdde1;
            box-shadow: 0 0 0 3px rgba(255, 221, 225, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }
        
        /* Map Page Specific Styles */
        #map-page-container {
            position: relative;
            width: 100%;
            height: calc(100vh - 120px); /* Adjust based on header/footer */
            border-radius: var(--border-radius);
            overflow: hidden;
        }

        #map-container {
            position: absolute;
            top: 0;
            bottom: 0;
            width: 100%;
            height: 100%;
        }
        
        /* Mapbox Draw UI Customization */
        .mapboxgl-ctrl-group .mapboxgl-ctrl-icon {
            background-color: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
        }
        .mapbox-gl-draw_ctrl-draw-btn {
            background-color: rgba(255, 255, 255, 0.2) !important;
            color: white !important;
        }
        .mapbox-gl-draw_ctrl-draw-btn:hover {
            background-color: rgba(255, 255, 255, 0.3) !important;
        }

        .map-ui-container {
            position: absolute;
            top: 15px;
            right: 15px;
            display: flex;
            flex-direction: column;
            gap: 15px;
            z-index: 10;
            width: 320px;
            max-height: calc(100% - 30px);
            overflow-y: auto;
            transition: transform 0.3s ease-in-out;
        }
        
        .map-ui-container.hidden {
            transform: translateX(110%);
        }

        .map-card {
            background: rgba(40, 40, 60, 0.8);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: var(--border-radius);
            padding: 15px;
            box-shadow: var(--shadow-glass);
            color: var(--text-light);
        }
        
        .map-card h4 {
            font-size: 16px;
            border-bottom: 1px solid var(--glass-border);
            padding-bottom: 8px;
            margin-bottom: 12px;
            color: #ffdde1;
        }

        .map-card-content p {
            font-size: 13px;
            margin-bottom: 5px;
        }
        
        .map-card-content strong {
            color: #ffdde1;
            min-width: 90px;
            display: inline-block;
        }

        #map-hamburger-menu {
            position: absolute;
            top: 15px;
            right: 15px;
            z-index: 20;
            background: var(--glass-bg);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-light);
        }

        .table th {
            background: rgba(255, 221, 225, 0.1);
            color: var(--text-light);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }
        
        .table .action-buttons {
            display: flex;
            gap: 5px;
        }
        
        .table .action-buttons .btn {
            padding: 5px 10px;
            font-size: 12px;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-glass);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        /* CAD Drawing Styles */
        #dxf-container {
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: white;
            width: 100%;
            height: 600px;
            cursor: crosshair;
        }
        
        .drawing-tools {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }
        
        /* Chat System Styles */
        #chat-page .card {
            display: flex;
            flex-direction: column;
            height: calc(100vh - 160px);
        }
        #chat-messages {
            flex-grow: 1;
            overflow-y: auto;
            padding: 10px;
            display: flex;
            flex-direction: column-reverse; /* Newest messages at the bottom */
        }
        .chat-message {
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 10px;
            max-width: 70%;
            display: flex;
            flex-direction: column;
        }
        .chat-message.sent {
            background-color: var(--primary-color);
            align-self: flex-end;
            text-align: right;
        }
        .chat-message.received {
            background-color: var(--secondary-color);
            align-self: flex-start;
        }
        .message-sender {
            font-weight: bold;
            font-size: 0.8rem;
            margin-bottom: 4px;
        }
        .message-timestamp {
            font-size: 0.7rem;
            opacity: 0.8;
            margin-top: 4px;
        }
        #chat-input-container {
            display: flex;
            gap: 10px;
            padding-top: 15px;
            border-top: 1px solid var(--glass-border);
        }
        #chat-input { flex-grow: 1; }
        
        /* File Manager Styles */
        .file-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }

        .file-item {
            padding: 20px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
            position: relative;
        }
        .file-item .share-btn {
            position: absolute;
            top: 5px;
            right: 5px;
            padding: 5px;
            font-size: 10px;
            border-radius: 50%;
            line-height: 1;
        }

        .file-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glass);
        }

        .file-icon {
            font-size: 48px;
            margin-bottom: 10px;
            color: #ffdde1;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }

            .sidebar {
                width: 100%;
                order: 2;
                height: auto;
                max-height: 0;
                overflow: hidden;
                transition: max-height 0.5s ease-in-out;
            }
            .sidebar.active {
                max-height: 100vh; /* A large value */
            }

            .main-content {
                order: 1;
                padding-right: 0;
            }

            .header {
                padding: 10px 15px;
                border-radius: 0;
                margin-bottom: 10px;
            }

            .sidebar-toggle {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .wrapper {
                margin: 20px;
                padding: 30px 20px;
                width: calc(100% - 40px);
            }

            #map-page-container {
                height: calc(100vh - 180px);
            }
            .map-ui-container {
                width: calc(100% - 30px);
                max-height: 50%;
            }
        }
        
        /* Dark Theme */
        [data-theme="dark"] body::before {
             background: url("https://i.postimg.cc/8PZWBWA0/dark-theme-bg.jpg"), #000;
             opacity: 0.4;
        }
        [data-theme="dark"] {
            --glass-bg: rgba(30, 30, 30, 0.25);
            --glass-border: rgba(255, 255, 255, 0.1);
            --text-light: #e1e1e1;
            --text-dark: #f0f0f0;
             background: linear-gradient(135deg, #2d3436 0%, #000000 100%);
        }
        [data-theme="dark"] .form-input option {
             background-color: #2d3436;
        }

        /* Loading Spinner */
        .spinner {
            width: 40px;
            height: 40px;
            border: 4px solid var(--glass-border);
            border-top: 4px solid #ffdde1;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
    </style>
</head>
<body>
    <div id="auth-container" class="auth-container">
        <div class="wrapper">
            <div class="auth-logo">üèóÔ∏è</div>
            <h2 id="auth-title">Welcome to Engineering Platform</h2>
            <p id="auth-subtitle">Sign in to continue</p>
            <p id="auth-error" style="color: var(--accent-color); display: none;"></p>

            <form id="auth-form" class="auth-form">
                <div class="input-field">
                    <input type="email" id="auth-email" required>
                    <label for="auth-email">Email</label>
                </div>
                <div class="input-field">
                    <input type="password" id="auth-password" required>
                    <label for="auth-password">Password</label>
                </div>
                <div class="input-field" id="name-field" style="display: none;">
                    <input type="text" id="auth-name">
                    <label for="auth-name">Full Name</label>
                </div>
                <button type="submit" id="auth-submit" class="auth-btn">Sign In</button>
                <div id="auth-toggle" class="auth-toggle">Don't have an account? Sign up</div>
            </form>
        </div>
    </div>

    <div id="main-app" class="main-app">
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">Engineering Platform</div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()" title="Toggle Dark/Light Mode">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()">
                        <span id="user-initial">U</span>
                    </div>
                    <div id="user-dropdown" class="user-dropdown">
                        <div class="user-dropdown-item" onclick="showProfile()">
                            <i class="fas fa-user"></i> Profile
                        </div>
                        <div class="user-dropdown-item" onclick="showPage('settings')">
                            <i class="fas fa-cog"></i> Settings
                        </div>
                        <div class="user-dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="app-layout">
            <nav id="sidebar" class="sidebar">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item active" onclick="showPage('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </div>
                    <div class="nav-item" onclick="showPage('projects')">
                        <i class="fas fa-project-diagram"></i> Projects
                    </div>
                    <div class="nav-item" onclick="showPage('notifications')">
                        <i class="fas fa-bell"></i> Notifications
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Project Management</div>
                    <div class="nav-item" onclick="showPage('contracts')">
                        <i class="fas fa-file-contract"></i> Contracts & BOQ
                    </div>
                    <div class="nav-item" onclick="showPage('inspection')">
                        <i class="fas fa-clipboard-check"></i> Inspection Reports
                    </div>
                     <div class="nav-item" onclick="showPage('maintenance')">
                        <i class="fas fa-tools"></i> Repair & Maintenance
                    </div>
                    <div class="nav-item" onclick="showPage('cost-estimation')">
                        <i class="fas fa-calculator"></i> Cost Estimation
                    </div>
                    <div class="nav-item" onclick="showPage('timeline')">
                        <i class="fas fa-tasks"></i> Project Timeline
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Engineering Tools</div>
                    <div class="nav-item" onclick="showPage('map')">
                        <i class="fas fa-map-marked-alt"></i> GIS Mapping
                    </div>
                    <div class="nav-item" onclick="showPage('drawing')">
                        <i class="fas fa-drafting-compass"></i> CAD Editor
                    </div>
                     <div class="nav-item" onclick="showPage('engineering-tools')">
                        <i class="fas fa-cogs"></i> Calculators
                    </div>
                    <div class="nav-item" onclick="showPage('ai-defect')">
                        <i class="fas fa-robot"></i> AI Defect Analysis
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <div class="nav-item" onclick="showPage('vehicle-tracking')">
                        <i class="fas fa-truck"></i> Vehicle Tracking
                    </div>
                    <div class="nav-item" onclick="showPage('material-logistics')">
                        <i class="fas fa-boxes"></i> Material Logistics
                    </div>
                    <div class="nav-item" onclick="showPage('sign-fabrication')">
                        <i class="fas fa-sign"></i> Sign Fabrication
                    </div>
                    <div class="nav-item" onclick="showPage('scrap-management')">
                        <i class="fas fa-recycle"></i> Scrap Management
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Communication</div>
                    <div class="nav-item" onclick="showPage('chat')">
                        <i class="fas fa-comments"></i> Team Chat
                    </div>
                    <div class="nav-item" onclick="showPage('telegram')">
                        <i class="fab fa-telegram"></i> Telegram Integration
                    </div>
                    <div class="nav-item" onclick="showPage('reports')">
                        <i class="fas fa-chart-bar"></i> Custom Reports
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">System</div>
                    <div class="nav-item" onclick="showPage('file-manager')">
                        <i class="fas fa-folder"></i> File Manager
                    </div>
                    <div class="nav-item" onclick="showPage('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                </div>
            </nav>

            <main class="main-content">
                <div id="dashboard-page" class="page active">
                     <div class="card">
                        <div class="card-header">
                            <h3 class="card-title">Custom Dashboard</h3>
                        </div>
                        <div id="custom-dashboard-container" class="stats-grid">
                            <p>Go to Settings to configure your dashboard widgets.</p>
                        </div>
                    </div>
                </div>
                
                <div id="map-page" class="page">
                    <div id="map-page-container">
                        <div id="map-container"></div>
                        
                        <button id="map-hamburger-menu" class="btn" onclick="toggleMapSidePanel()">
                            <i class="fas fa-bars"></i>
                        </button>
                        
                        <div id="map-ui-container" class="map-ui-container">
                            <div class="map-card">
                                <h4><i class="fas fa-tags"></i> QNAS Metadata</h4>
                                <div class="map-card-content">
                                    <div class="form-group">
                                        <label class="form-label">Point ID / Label</label>
                                        <input type="text" id="qnas-point-id" class="form-input">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Coordinates</label>
                                        <input type="text" id="qnas-coords" class="form-input" placeholder="e.g., 25.28, 51.53" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Notes / Description</label>
                                        <textarea id="qnas-notes" class="form-textarea" rows="2"></textarea>
                                    </div>
                                    <button class="btn btn-primary w-100" onclick="saveQnasMetadata()">Save Metadata</button>
                                </div>
                            </div>
                            
                            <div class="map-card">
                                <h4><i class="fas fa-ruler-combined"></i> Shape Information</h4>
                                <div id="info-display-content" class="map-card-content">
                                    <p><strong>Area:</strong> <span id="info-area">0</span> m¬≤</p>
                                    <p><strong>Perimeter:</strong> <span id="info-perimeter">0</span> m</p>
                                    <p><strong>Length:</strong> <span id="info-length">0</span> m</p>
                                    <p><strong>Metric Coords:</strong> <span id="info-metric-coords">N/A</span></p>
                                    <p><strong>Degree Coords:</strong> <span id="info-degree-coords">N/A</span></p>
                                    <div class="d-flex gap-2 mt-3 flex-column">
                                        <button class="btn btn-info" onclick="exportGisData('pdf')"><i class="fas fa-file-pdf"></i> PDF</button>
                                        <button class="btn btn-info" onclick="exportGisData('csv')"><i class="fas fa-file-csv"></i> CSV</button>
                                        <button class="btn btn-info" onclick="exportGisData('kml')"><i class="fas fa-file-code"></i> KML</button>
                                        <button class="btn btn-info" onclick="exportGisData('geojson')"><i class="fas fa-file-alt"></i> GeoJSON</button>
                                    </div>
                                </div>
                            </div>

                            <div class="map-card">
                                <h4><i class="fas fa-file-import"></i> Data Entry / Import</h4>
                                <div class="map-card-content">
                                    <input type="file" id="gis-import-file" style="display:none;" accept=".csv,.kml,.kmz,.geojson" onchange="importGisData(event)">
                                    <button class="btn btn-success w-100" onclick="document.getElementById('gis-import-file').click()">
                                        <i class="fas fa-upload"></i> Import CSV/KML/GeoJSON
                                    </button>
                                    <a href="data:text/csv;charset=utf-8,latitude,longitude,name,description%0A25.2854,51.5310,Doha Center,Main office location" download="gis_template.csv" class="btn w-100 mt-2">
                                        <i class="fas fa-download"></i> Download CSV Template
                                    </a>
                                </div>
                            </div>

                            <div class="map-card">
                                <h4><i class="fas fa-layer-group"></i> Map Overlays</h4>
                                <div class="map-card-content d-flex gap-2 flex-column">
                                    <button class="btn" onclick="toggleMapOverlay('traffic')"><i class="fas fa-car-side"></i> Toggle Traffic</button>
                                    <button class="btn" onclick="toggleMapOverlay('weather')"><i class="fas fa-cloud-sun-rain"></i> Toggle Weather</button>
                                    <button class="btn" onclick="toggleMapOverlay('risk')"><i class="fas fa-exclamation-triangle"></i> Toggle Risk Zones</button>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="drawing-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">CAD Viewer/Editor (DXF)</h1>
                            <div class="d-flex gap-2">
                                <input type="file" id="cad-import" accept=".dxf" style="display: none;" onchange="importCAD(event)">
                                <button class="btn btn-info" onclick="document.getElementById('cad-import').click()">
                                    <i class="fas fa-upload"></i> Import DXF
                                </button>
                                <button class="btn btn-success" onclick="exportCAD('svg')">
                                    <i class="fas fa-download"></i> Export SVG
                                </button>
                                <button class="btn btn-primary" onclick="window.print()">
                                     <i class="fas fa-print"></i> Print
                                </button>
                            </div>
                        </div>
                        <div id="dxf-container">
                           <p style="text-align:center; padding-top:50px;">Upload a DXF file to view it here.</p>
                        </div>
                    </div>
                </div>
                
                <div id="chat-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Team Chat</h1>
                        </div>
                        <div id="chat-messages">
                           </div>
                        <div id="chat-input-container">
                            <input type="text" id="chat-input" class="form-input" placeholder="Type a message...">
                            <button class="btn" id="chat-attach-file" title="Attach File"><i class="fas fa-paperclip"></i></button>
                            <input type="file" id="chat-file-input" style="display: none;" />
                            <button class="btn" id="chat-share-location" title="Share Location"><i class="fas fa-map-marker-alt"></i></button>
                            <button class="btn btn-primary" id="chat-send-btn">Send</button>
                        </div>
                    </div>
                </div>
                
                <div id="file-manager-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">File Manager</h1>
                             <div class="form-group mb-0" style="width: 300px;">
                                <label for="file-manager-contract" class="form-label">Select Contract</label>
                                <select id="file-manager-contract" class="form-select" onchange="renderFileManager()">
                                    </select>
                            </div>
                        </div>
                        <div class="form-group">
                            <label class="form-label">Current Path: <strong id="current-path"></strong></label>
                            <input type="file" id="file-upload-input" multiple style="display: none;" onchange="uploadFiles(event)">
                            <button class="btn btn-primary" onclick="document.getElementById('file-upload-input').click()">
                                <i class="fas fa-upload"></i> Upload to Current Folder
                            </button>
                        </div>
                        <div id="file-breadcrumbs"></div>
                        <div class="file-grid" id="file-grid">
                            </div>
                    </div>
                </div>
                
                <div id="settings-page" class="page">
                    <div class="card">
                        <div class="card-header"><h1 class="card-title">Settings</h1></div>
                        
                        <div class="background-settings">
                            <h3><i class="fas fa-palette"></i> UI Theme Personalization</h3>
                            <div class="form-group">
                                <label class="form-label">Theme</label>
                                <button class="btn" onclick="toggleTheme()">Toggle Dark/Light Mode</button>
                            </div>
                            <div class="form-group">
                                <label class="form-label">Upload Custom Background Image</label>
                                <input type="file" id="custom-bg-image" class="form-input" accept="image/*" onchange="setCustomBackgroundImage(event)">
                            </div>
                        </div>
                        
                        <div class="card mt-3">
                            <h3><i class="fas fa-th-large"></i> Dashboard Customization</h3>
                             <div id="dashboard-widget-options" class="form-group">
                                </div>
                             <button class="btn btn-success" onclick="saveDashboardSettings()">Save Dashboard Layout</button>
                        </div>
                        
                        <div class="card mt-3">
                            <h3><i class="fas fa-brain"></i> AI Prompt Editor</h3>
                            <div class="form-group">
                                <label for="ai-prompt-editor" class="form-label">Edit the prompt used for AI Defect Analysis:</label>
                                <textarea id="ai-prompt-editor" class="form-textarea" rows="8"></textarea>
                            </div>
                            <button class="btn btn-success" onclick="saveAIPrompt()">Save AI Prompt</button>
                        </div>

                        <div class="card mt-3">
                            <h3><i class="fas fa-user-shield"></i> Admin Panel</h3>
                            <div class="form-group">
                                <label class="form-label">Admin Panel Access</label>
                                <input type="password" id="admin-password" class="form-input" placeholder="Enter admin password">
                                <button class="btn btn-primary mt-2" onclick="accessAdminPanel()">Access Admin Panel</button>
                            </div>
                            <div id="admin-panel" style="display: none;">
                                <h4>API Configuration</h4>
                                <div class="form-group">
                                    <label class="form-label">Mapbox Access Token</label>
                                    <input type="text" id="mapbox-token" class="form-input" placeholder="pk.YOUR_MAPBOX_TOKEN">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Telegram Bot Token</label>
                                    <input type="text" id="telegram-token" class="form-input" placeholder="YOUR_TELEGRAM_BOT_TOKEN">
                                </div>
                                <div class="form-group">
                                    <label class="form-label">Telegram Channel/Chat ID</label>
                                    <input type="text" id="telegram-channel" class="form-input" placeholder="-100...">
                                </div>
                                <button class="btn btn-success" onclick="saveAPIConfig()">Save Configuration</button>
                            </div>
                        </div>
                    </div>
                </div>

                <div id="projects-page" class="page"><div class="card"><h1>Projects</h1></div></div>
                <div id="notifications-page" class="page"><div class="card"><h1>Notifications</h1></div></div>
                <div id="contracts-page" class="page"><div class="card"><h1>Contracts & BOQ</h1></div></div>
                <div id="inspection-page" class="page"><div class="card"><h1>Inspection Reports</h1></div></div>
                <div id="maintenance-page" class="page"><div class="card"><h1>Repair & Maintenance</h1></div></div>
                <div id="cost-estimation-page" class="page"><div class="card"><h1>Cost Estimation</h1></div></div>
                <div id="timeline-page" class="page"><div class="card"><h1>Project Timeline</h1></div></div>
                <div id="engineering-tools-page" class="page"><div class="card"><h1>Engineering Calculators</h1></div></div>
                <div id="ai-defect-page" class="page"><div class="card"><h1>AI Defect Analysis</h1></div></div>
                <div id="vehicle-tracking-page" class="page"><div class="card"><h1>Vehicle Tracking</h1></div></div>
                <div id="material-logistics-page" class="page"><div class="card"><h1>Material Logistics</h1></div></div>
                <div id="sign-fabrication-page" class="page"><div class="card"><h1>Sign Fabrication</h1></div></div>
                <div id="scrap-management-page" class="page"><div class="card"><h1>Scrap Management</h1></div></div>
                <div id="telegram-page" class="page"><div class="card"><h1>Telegram Integration</h1></div></div>
                <div id="reports-page" class="page"><div class="card"><h1>Custom Reports</h1></div></div>

            </main>
        </div>
    </div>

    <div id="share-file-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="hideModal('share-file-modal')">&times;</button>
            <h2>Share File</h2>
            <p><strong>File:</strong> <span id="share-file-name"></span></p>
            <form id="share-file-form">
                <div class="form-group">
                    <label class="form-label">Share with (Internal User, Email, etc.):</label>
                    <input type="text" id="share-recipient" class="form-input" required>
                </div>
                 <div class="form-group">
                    <label class="form-label">Sharing Method:</label>
                    <select id="share-method" class="form-select">
                        <option value="email">Email</option>
                        <option value="telegram">Telegram</option>
                        <option value="whatsapp">WhatsApp</option>
                    </select>
                </div>
                <div class="form-group">
                    <label for="share-duration" class="form-label">Share Duration (minutes):</label>
                    <input type="number" id="share-duration" class="form-input" value="10" min="1">
                </div>
                <button type="submit" class="btn btn-primary">Share File</button>
            </form>
        </div>
    </div>


    <script>
        // --- PLACEHOLDER API KEYS ---
        const MAPBOX_ACCESS_TOKEN = 'pk.YOUR_MAPBOX_TOKEN'; // IMPORTANT: Replace with your actual Mapbox token
        const SUPABASE_URL = 'https://cykjjrrexaqmsqwrgnzp.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5a2pqcnJleGFxbXNxd3JnbnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MjUyMDksImV4cCI6MjA2NzIwMTIwOX0.Fx6f23TWCQQMCIkc5hcx8LqHyskVMm6WAhJl1UFZpMA';
        const TELEGRAM_BOT_TOKEN = 'YOUR_TELEGRAM_BOT_TOKEN'; // Replace
        const TELEGRAM_CHAT_ID = 'YOUR_TELEGRAM_CHAT_ID'; // Replace

        // --- GLOBAL VARIABLES & STATE ---
        let currentUser = null;
        let currentPage = 'dashboard';
        let isAuthMode = 'signin';
        let map = null;
        let mapDraw = null;
        let apiConfig = {};
        
        // --- INITIALIZE SUPABASE ---
        const supabase = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // --- AUTHENTICATION & SESSION MANAGEMENT ---
        document.addEventListener('DOMContentLoaded', async () => {
            // Check for active session
            const { data: { session } } = await supabase.auth.getSession();
            if (session) {
                currentUser = session.user;
                showMainApp();
            } else {
                showAuthContainer();
            }
            
            // Add auth form listeners
            document.getElementById('auth-form').addEventListener('submit', handleAuth);
            document.getElementById('auth-toggle').addEventListener('click', toggleAuthMode);
            
            // Add other global event listeners
            addGlobalEventListeners();
        });

        function showAuthContainer() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
        }
        
        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const userInitial = document.getElementById('user-initial');
            userInitial.textContent = currentUser.email.charAt(0).toUpperCase();
            
            initializeApp();
        }

        async function handleAuth(e) {
            e.preventDefault();
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            const submitBtn = document.getElementById('auth-submit');
            const authError = document.getElementById('auth-error');
            
            submitBtn.disabled = true;
            submitBtn.innerHTML = '<div class="spinner" style="width:20px;height:20px;margin:0 auto;"></div>';
            authError.style.display = 'none';

            let response;
            if (isAuthMode === 'signup') {
                response = await supabase.auth.signUp({ 
                    email, 
                    password,
                    options: { data: { full_name: name } }
                });
            } else {
                response = await supabase.auth.signInWithPassword({ email, password });
            }

            if (response.error) {
                authError.textContent = response.error.message;
                authError.style.display = 'block';
            } else {
                currentUser = response.data.user;
                showMainApp();
            }
            
            submitBtn.disabled = false;
            submitBtn.textContent = isAuthMode === 'signup' ? 'Sign Up' : 'Sign In';
        }

        function toggleAuthMode() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const submitBtn = document.getElementById('auth-submit');
            const toggle = document.getElementById('auth-toggle');
            const nameField = document.getElementById('name-field');
            
            isAuthMode = (isAuthMode === 'signin') ? 'signup' : 'signin';
            
            title.textContent = isAuthMode === 'signin' ? 'Welcome Back' : 'Create Account';
            subtitle.textContent = isAuthMode === 'signin' ? 'Sign in to continue' : 'Join the Engineering Platform';
            submitBtn.textContent = isAuthMode === 'signin' ? 'Sign In' : 'Sign Up';
            toggle.textContent = isAuthMode === 'signin' ? "Don't have an account? Sign up" : 'Already have an account? Sign in';
            nameField.style.display = isAuthMode === 'signin' ? 'none' : 'block';
        }

        async function logout() {
            if (confirm('Are you sure you want to logout?')) {
                await supabase.auth.signOut();
                currentUser = null;
                showAuthContainer();
            }
        }

        // --- MAIN APP INITIALIZATION ---
        function initializeApp() {
            // Load configs, user preferences, and initialize data
            loadAPIConfig();
            loadTheme();
            loadDashboardSettings();
            loadAIPrompt();
            
            // Populate dynamic elements
            populateContractsDropdown();
            renderFileManager();
            
            // Initialize chat
            initializeChat();
        }

        // --- PAGE NAVIGATION & UI TOGGLES ---
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            const page = document.getElementById(`${pageId}-page`);
            if (page) page.classList.add('active');
            
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            const navItem = document.querySelector(`.nav-item[onclick="showPage('${pageId}')"]`);
            if (navItem) navItem.classList.add('active');

            currentPage = pageId;

            // Page-specific initializers
            if (pageId === 'map' && !map) {
                setTimeout(initializeMap, 100);
            } else if (pageId === 'drawing') {
                // CAD viewer is initialized on file upload
            }
        }
        
        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function toggleUserMenu() {
            document.getElementById('user-dropdown').classList.toggle('active');
        }
        
        function addGlobalEventListeners() {
            document.addEventListener('click', (e) => {
                if (e.target.classList.contains('modal')) {
                    e.target.classList.remove('active');
                }
                if (!e.target.closest('.user-menu')) {
                    const dropdown = document.getElementById('user-dropdown');
                    if(dropdown) dropdown.classList.remove('active');
                }
            });
        }

        // --- THEME & SETTINGS ---
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            document.documentElement.setAttribute('data-theme', newTheme);
            document.body.setAttribute('data-theme', newTheme);
            localStorage.setItem('appTheme', newTheme);
            
            const themeIcon = document.querySelector('.theme-toggle i');
            themeIcon.className = newTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }

        function loadTheme() {
            const savedTheme = localStorage.getItem('appTheme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            document.body.setAttribute('data-theme', savedTheme);
            const themeIcon = document.querySelector('.theme-toggle i');
            if(themeIcon) themeIcon.className = savedTheme === 'dark' ? 'fas fa-sun' : 'fas fa-moon';
        }
        
        function setCustomBackgroundImage(event) {
            const file = event.target.files[0];
            if (file) {
                const reader = new FileReader();
                reader.onload = function(e) {
                    const bodyBefore = document.querySelector('body::before');
                    document.body.style.setProperty('--custom-bg-image', `url(${e.target.result})`);
                    // This is tricky with pseudo-elements. A better approach is to change a class or an attribute.
                    // For now, we'll just log it.
                    console.log("Custom background image set. Manual CSS adjustment might be needed for pseudo-elements.");
                };
                reader.readAsDataURL(file);
            }
        }
        
        function accessAdminPanel() {
            const password = document.getElementById('admin-password').value;
            // In a real app, this would be validated on the backend
            if (password === "admin123") {
                document.getElementById('admin-panel').style.display = 'block';
            } else {
                alert('Incorrect password.');
            }
        }

        function saveAPIConfig() {
            apiConfig.mapbox = document.getElementById('mapbox-token').value;
            apiConfig.telegramToken = document.getElementById('telegram-token').value;
            apiConfig.telegramChatId = document.getElementById('telegram-channel').value;
            localStorage.setItem('apiConfig', JSON.stringify(apiConfig));
            alert('API Configuration Saved!');
        }
        
        function loadAPIConfig() {
            const savedConfig = localStorage.getItem('apiConfig');
            if (savedConfig) {
                apiConfig = JSON.parse(savedConfig);
                document.getElementById('mapbox-token').value = apiConfig.mapbox || '';
                document.getElementById('telegram-token').value = apiConfig.telegramToken || '';
                document.getElementById('telegram-channel').value = apiConfig.telegramChatId || '';
            }
        }
        
        function saveAIPrompt() {
            const prompt = document.getElementById('ai-prompt-editor').value;
            localStorage.setItem('aiPrompt', prompt);
            alert('AI Prompt Saved!');
        }

        function loadAIPrompt() {
            const savedPrompt = localStorage.getItem('aiPrompt') || `Analyze the following image for civil engineering defects. Identify and classify any issues such as cracks, potholes, corrosion, or paint fading. Provide a summary of findings.`;
            document.getElementById('ai-prompt-editor').value = savedPrompt;
        }

        // --- DASHBOARD BUILDER ---
        const allWidgets = {
            activeProjects: { title: 'Active Projects', icon: 'fa-project-diagram' },
            pendingInspections: { title: 'Pending Inspections', icon: 'fa-clipboard-check' },
            vehiclesOnline: { title: 'Vehicles Online', icon: 'fa-truck' },
            aiAnalyses: { title: 'AI Analyses Today', icon: 'fa-robot' },
        };
        
        function loadDashboardSettings() {
            const container = document.getElementById('dashboard-widget-options');
            container.innerHTML = '';
            const savedSettings = JSON.parse(localStorage.getItem('dashboardSettings')) || Object.keys(allWidgets);
            
            for (const key in allWidgets) {
                const widget = allWidgets[key];
                const isChecked = savedSettings.includes(key);
                container.innerHTML += `
                    <label>
                        <input type="checkbox" class="dashboard-widget-toggle" value="${key}" ${isChecked ? 'checked' : ''}>
                        ${widget.title}
                    </label><br>
                `;
            }
            renderDashboard();
        }

        function saveDashboardSettings() {
            const selectedWidgets = [];
            document.querySelectorAll('.dashboard-widget-toggle:checked').forEach(input => {
                selectedWidgets.push(input.value);
            });
            localStorage.setItem('dashboardSettings', JSON.stringify(selectedWidgets));
            renderDashboard();
            alert('Dashboard layout saved!');
        }
        
        function renderDashboard() {
            const container = document.getElementById('custom-dashboard-container');
            container.innerHTML = '';
            const settings = JSON.parse(localStorage.getItem('dashboardSettings')) || Object.keys(allWidgets);
            
            if (settings.length === 0) {
                 container.innerHTML = '<p>No widgets selected. Go to Settings to add widgets to your dashboard.</p>';
                 return;
            }
            
            settings.forEach(key => {
                const widget = allWidgets[key];
                if (widget) {
                    container.innerHTML += `
                        <div class="stat-card">
                            <div class="stat-number">${Math.floor(Math.random() * 50)}</div>
                            <div class="stat-label">${widget.title}</div>
                        </div>
                    `;
                }
            });
        }


        // --- GIS MAPPING (MAPBOX) ---
        function initializeMap() {
            const mapboxToken = apiConfig.mapbox || MAPBOX_ACCESS_TOKEN;
            if (!mapboxToken || mapboxToken.includes('YOUR_MAPBOX_TOKEN')) {
                document.getElementById('map-container').innerHTML = '<h3 style="text-align:center; padding: 40px;">Mapbox Access Token is missing. Please set it in the Settings page.</h3>';
                return;
            }
        
            mapboxgl.accessToken = mapboxToken;
            map = new mapboxgl.Map({
                container: 'map-container',
                style: 'mapbox://styles/mapbox/satellite-streets-v12',
                center: [51.5310, 25.2854],
                zoom: 12
            });

            mapDraw = new MapboxDraw({
                displayControlsDefault: false,
                controls: {
                    polygon: true,
                    line_string: true,
                    point: true,
                    trash: true
                },
                defaultMode: 'draw_polygon'
            });

            map.addControl(mapDraw, 'top-left');
            map.addControl(new mapboxgl.NavigationControl(), 'top-left');

            map.on('draw.create', updateGisInfo);
            map.on('draw.update', updateGisInfo);
            map.on('draw.delete', clearGisInfo);
            map.on('click', (e) => {
                const features = map.queryRenderedFeatures(e.point, { layers: ['gl-draw-point-point-stroke-inactive'] });
                if(features.length > 0){
                    const featureId = features[0].properties.id;
                    populateQnasCardFromFeature(featureId);
                }
            });
        }
        
        function updateGisInfo(e) {
            const data = mapDraw.getAll();
            if (data.features.length > 0) {
                const feature = data.features[data.features.length - 1]; // Get the last drawn feature
                let area = 0, perimeter = 0, length = 0;
                
                if (feature.geometry.type === 'Polygon') {
                    area = turf.area(feature);
                    const line = turf.lineString(feature.geometry.coordinates[0]);
                    perimeter = turf.length(line, {units: 'meters'});
                } else if (feature.geometry.type === 'LineString') {
                    length = turf.length(feature, {units: 'meters'});
                }
                
                document.getElementById('info-area').textContent = area.toFixed(2);
                document.getElementById('info-perimeter').textContent = perimeter.toFixed(2);
                document.getElementById('info-length').textContent = length.toFixed(2);

                const coords = feature.geometry.coordinates;
                const firstCoord = Array.isArray(coords[0][0]) ? coords[0][0] : coords[0];
                document.getElementById('info-degree-coords').textContent = `${firstCoord[1].toFixed(4)}, ${firstCoord[0].toFixed(4)}`;

            }
        }
        
        function clearGisInfo() {
             document.getElementById('info-area').textContent = '0';
             document.getElementById('info-perimeter').textContent = '0';
             document.getElementById('info-length').textContent = '0';
             document.getElementById('info-metric-coords').textContent = 'N/A';
             document.getElementById('info-degree-coords').textContent = 'N/A';
        }
        
        function toggleMapSidePanel() {
            document.getElementById('map-ui-container').classList.toggle('hidden');
        }
        
        function saveQnasMetadata() {
            const pointId = document.getElementById('qnas-point-id').value;
            const notes = document.getElementById('qnas-notes').value;
            const coordsText = document.getElementById('qnas-coords').value;

            if (!coordsText) { // Create new point
                alert("Click on the map to place a point first, or draw one.");
                return;
            }

            const featureId = document.getElementById('qnas-point-id').dataset.featureId;
            if(featureId){
                 mapDraw.setFeatureProperty(featureId, 'notes', notes);
                 mapDraw.setFeatureProperty(featureId, 'label', pointId);
                 alert('Metadata updated!');
            } else {
                 alert('No feature selected to save metadata to.');
            }
        }
        
        function populateQnasCardFromFeature(featureId) {
            const feature = mapDraw.get(featureId);
            if(feature) {
                 document.getElementById('qnas-point-id').value = feature.properties.label || `Point ${featureId.substring(0, 5)}`;
                 document.getElementById('qnas-point-id').dataset.featureId = featureId;
                 document.getElementById('qnas-notes').value = feature.properties.notes || '';
                 const coords = feature.geometry.coordinates;
                 document.getElementById('qnas-coords').value = `${coords[1].toFixed(4)}, ${coords[0].toFixed(4)}`;
            }
        }
        
        function toggleMapOverlay(type) {
            const sourceId = `${type}-overlay-source`;
            const layerId = `${type}-overlay-layer`;
        
            if (map.getLayer(layerId)) {
                map.removeLayer(layerId);
                map.removeSource(sourceId);
                return;
            }
        
            // Simulate random data for demonstration
            const points = turf.randomPoint(100, { bbox: map.getBounds().toArray().flat() });
        
            map.addSource(sourceId, {
                'type': 'geojson',
                'data': points
            });
        
            map.addLayer({
                'id': layerId,
                'type': 'heatmap',
                'source': sourceId,
                'maxzoom': 15,
                'paint': {
                    'heatmap-intensity': 1,
                    'heatmap-color': [
                        'interpolate', ['linear'], ['heatmap-density'],
                        0, 'rgba(33,102,172,0)',
                        0.2, 'rgb(103,169,207)',
                        0.4, 'rgb(209,229,240)',
                        0.6, 'rgb(253,219,199)',
                        0.8, 'rgb(239,138,98)',
                        1, 'rgb(178,24,43)'
                    ],
                    'heatmap-radius': 20,
                    'heatmap-opacity': 0.7
                }
            });
        }
        
        // --- GIS IMPORT / EXPORT ---
        function importGisData(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = (e) => {
                const text = e.target.result;
                const extension = file.name.split('.').pop().toLowerCase();
                try {
                    let geojson;
                    if (extension === 'kml') {
                        const kml = new DOMParser().parseFromString(text, 'text/xml');
                        geojson = toGeoJSON.kml(kml);
                    } else if (extension === 'csv') {
                        const parsed = Papa.parse(text, { header: true });
                        geojson = {
                            type: "FeatureCollection",
                            features: parsed.data.map(row => {
                                const lat = parseFloat(row.latitude || row.lat);
                                const lon = parseFloat(row.longitude || row.lon || row.lng);
                                if (!isNaN(lat) && !isNaN(lon)) {
                                    return {
                                        type: "Feature",
                                        geometry: { type: "Point", coordinates: [lon, lat] },
                                        properties: row
                                    };
                                }
                                return null;
                            }).filter(f => f)
                        };
                    } else {
                        geojson = JSON.parse(text);
                    }
                    mapDraw.add(geojson);
                } catch (err) {
                    alert('Failed to parse file. Ensure it is a valid format.');
                    console.error(err);
                }
            };
            reader.readAsText(file);
        }

        async function exportGisData(format) {
             const data = mapDraw.getAll();
             if (data.features.length === 0) {
                 alert("No data to export.");
                 return;
             }
             
             if (format === 'pdf') {
                const { jsPDF } = window.jspdf;
                const pdf = new jsPDF('landscape');
                alert("Preparing PDF, please wait...");
                
                const mapCanvas = map.getCanvas();
                const imgData = mapCanvas.toDataURL('image/png');

                pdf.text("GIS Map Export", 10, 10);
                pdf.addImage(imgData, 'PNG', 10, 20, 280, 150); // Adjust dimensions
                pdf.save('map_export.pdf');
                 
             } else if (format === 'csv') {
                 const rows = [["type", "coordinates", "notes"]];
                 data.features.forEach(f => {
                     rows.push([f.geometry.type, JSON.stringify(f.geometry.coordinates), f.properties.notes || ""]);
                 });
                 const csvContent = "data:text/csv;charset=utf-8," + rows.map(e => e.join(",")).join("\n");
                 downloadFile(csvContent, 'export.csv');
                 
             } else if (format === 'kml') {
                 const kmlContent = toKML(data);
                 downloadFile("data:application/vnd.google-earth.kml+xml;charset=utf-8," + encodeURIComponent(kmlContent), 'export.kml');

             } else { // GeoJSON
                 const jsonContent = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(data));
                 downloadFile(jsonContent, 'export.geojson');
             }
        }
        
        // Helper to convert GeoJSON to KML (simplified)
        function toKML(geojson) {
            let kml = `<?xml version="1.0" encoding="UTF-8"?>
<kml xmlns="http://www.opengis.net/kml/2.2"><Document>`;
            geojson.features.forEach(feature => {
                kml += '<Placemark>';
                if (feature.properties.name) kml += `<name>${feature.properties.name}</name>`;
                if (feature.geometry.type === 'Point') {
                    kml += `<Point><coordinates>${feature.geometry.coordinates.join(',')},0</coordinates></Point>`;
                } else if (feature.geometry.type === 'LineString') {
                    kml += `<LineString><coordinates>${feature.geometry.coordinates.map(c => c.join(',') + ',0').join(' ')}</coordinates></LineString>`;
                } else if (feature.geometry.type === 'Polygon') {
                    kml += `<Polygon><outerBoundaryIs><LinearRing><coordinates>${feature.geometry.coordinates[0].map(c => c.join(',') + ',0').join(' ')}</coordinates></LinearRing></outerBoundaryIs></Polygon>`;
                }
                kml += '</Placemark>';
            });
            kml += '</Document></kml>';
            return kml;
        }
        
        function downloadFile(content, fileName) {
            const link = document.createElement("a");
            link.href = content;
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
        

        // --- CAD VIEWER ---
        function importCAD(event) {
            const file = event.target.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function (e) {
                const dxfContent = e.target.result;
                const container = document.getElementById('dxf-container');
                container.innerHTML = ''; // Clear previous drawing
                try {
                    const viewer = new DxfViewer(container, {
                        autoZoom: true,
                        clearColor: 0xffffff,
                    });
                    viewer.Load({ file: dxfContent });
                } catch (err) {
                    console.error('Error loading DXF:', err);
                    container.innerHTML = '<p style="color:red;text-align:center;padding-top:50px;">Failed to load DXF file.</p>';
                }
            };
            reader.readAsText(file);
        }

        function exportCAD(format) {
            // This is a viewer, direct editing/export is complex. We can export the view as an image.
            const viewerCanvas = document.querySelector('#dxf-container canvas');
            if (!viewerCanvas) {
                alert("No CAD drawing loaded to export.");
                return;
            }
            const link = document.createElement('a');
            link.download = `cad-export.png`;
            link.href = viewerCanvas.toDataURL();
            link.click();
        }
        
        
        // --- FILE MANAGER & STORAGE ---
        // Mock data structure. In a real app, this would be fetched from Supabase.
        const fileSystem = {
            "CONTRACT-0001": {
                "Contracts": [], "BOQ": [], "GISReports": [], "ChatMedia": []
            },
            "CONTRACT-0002": {
                "Contracts": [], "BOQ": [], "GISReports": []
            }
        };

        function populateContractsDropdown() {
            const select = document.getElementById('file-manager-contract');
            select.innerHTML = Object.keys(fileSystem).map(c => `<option value="${c}">${c}</option>`).join('');
        }

        function renderFileManager() {
            const contract = document.getElementById('file-manager-contract').value;
            const path = `/storage/${contract}/`;
            document.getElementById('current-path').textContent = path;
            const grid = document.getElementById('file-grid');
            grid.innerHTML = '';

            const folders = fileSystem[contract];
            for (const folderName in folders) {
                const files = folders[folderName];
                grid.innerHTML += `
                    <div class="file-item" onclick="viewFolder('${contract}', '${folderName}')">
                        <div class="file-icon"><i class="fas fa-folder"></i></div>
                        <div>${folderName} (${files.length})</div>
                    </div>
                `;
            }
        }
        
        function viewFolder(contract, folder) {
            alert(`Viewing /storage/${contract}/${folder}/\n\nThis would show a detailed file list.`);
            // A more complete implementation would re-render the grid with files.
        }

        function uploadFiles(event) {
            const files = event.target.files;
            if (!files.length) return;
            
            const contract = document.getElementById('file-manager-contract').value;
            // In a real app, this would iterate and upload each file via a backend API.
            // The backend would handle the naming convention and saving.
            for (const file of files) {
                const newName = generateFileName(contract, file.name);
                console.log(`Simulating upload of ${file.name} as ${newName}`);
            }
            
            alert(`${files.length} file(s) would be uploaded for ${contract}. Check console for details.`);
            // After upload, re-render the file manager
            // renderFileManager(); 
        }

        function generateFileName(contractNumber, originalName) {
            const now = new Date();
            const timestamp = `${now.getFullYear()}-${String(now.getMonth() + 1).padStart(2, '0')}-${String(now.getDate()).padStart(2, '0')}_${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}`;
            const nameWithoutExt = originalName.substring(0, originalName.lastIndexOf('.'));
            const extension = originalName.substring(originalName.lastIndexOf('.'));
            return `${contractNumber}_${nameWithoutExt}_${timestamp}${extension}`;
        }
        
        function showShareModal(fileName) {
            document.getElementById('share-file-name').textContent = fileName;
            showModal('share-file-modal');
        }

        document.getElementById('share-file-form')?.addEventListener('submit', function(e) {
            e.preventDefault();
            const recipient = document.getElementById('share-recipient').value;
            const method = document.getElementById('share-method').value;
            const duration = document.getElementById('share-duration').value;
            const fileName = document.getElementById('share-file-name').textContent;
            
            alert(`Simulating sharing ${fileName} with ${recipient} via ${method} for ${duration} minutes. A secure, time-limited link would be generated by the backend and sent.`);
            
            if (method === 'telegram') {
                sendTelegramNotification(`File shared: ${fileName} with ${recipient}`);
            }
            
            hideModal('share-file-modal');
        });

        // --- CHAT SYSTEM ---
        const DB_NAME = 'EngineeringAppDB';
        const DB_VERSION = 1;
        const MESSAGES_STORE = 'chatMessages';
        let db;

        function openDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                request.onerror = () => reject("Error opening DB");
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (e) => {
                    let db = e.target.result;
                    db.createObjectStore(MESSAGES_STORE, { keyPath: 'id' });
                };
            });
        }
        
        async function saveMessageToDB(message) {
            if (!db) await openDB();
            const tx = db.transaction(MESSAGES_STORE, 'readwrite');
            const store = tx.objectStore(MESSAGES_STORE);
            store.put(message);
            return tx.complete;
        }

        async function getMessagesFromDB() {
            if (!db) await openDB();
            const tx = db.transaction(MESSAGES_STORE, 'readonly');
            const store = tx.objectStore(MESSAGES_STORE);
            return store.getAll();
        }

        async function initializeChat() {
            await openDB();
            const localMessages = await getMessagesFromDB();
            localMessages.sort((a,b) => new Date(a.created_at) - new Date(b.created_at)).forEach(renderMessage);
            
            // Subscribe to Supabase Realtime channel for new messages
            supabase.channel('public:chat')
                .on('postgres_changes', { event: 'INSERT', schema: 'public', table: 'chat' }, payload => {
                    renderMessage(payload.new, true);
                    saveMessageToDB(payload.new);
                })
                .subscribe();
                
            document.getElementById('chat-send-btn').onclick = sendMessage;
            document.getElementById('chat-input').onkeyup = (e) => { if(e.key === 'Enter') sendMessage(); };
        }
        
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const text = input.value.trim();
            if (!text) return;

            const message = {
                user_id: currentUser.id,
                sender_email: currentUser.email,
                content: text,
                type: 'text'
            };
            
            // In a real app, this inserts into the 'chat' table which triggers the realtime subscription
            const { error } = await supabase.from('chat').insert(message);
            
            if(error) {
                console.error("Error sending message:", error);
                alert("Could not send message.");
            } else {
                input.value = '';
            }
            // For demonstration without RLS setup, we'll manually render the sent message.
            // The realtime listener would normally handle this for all clients.
             renderMessage({
                ...message,
                id: Date.now(), // temporary ID
                created_at: new Date().toISOString()
            }, true);
        }

        function renderMessage(msg, isNew = false) {
            const container = document.getElementById('chat-messages');
            const div = document.createElement('div');
            div.className = 'chat-message ' + (msg.user_id === currentUser.id ? 'sent' : 'received');
            div.innerHTML = `
                <div class="message-sender">${msg.sender_email}</div>
                <div class="message-content">${msg.content}</div>
                <div class="message-timestamp">${new Date(msg.created_at).toLocaleTimeString()}</div>
            `;
            container.prepend(div); // Prepend to keep scroll at bottom
        }

        // --- NOTIFICATIONS & TELEGRAM ---
        function sendTelegramNotification(message) {
            const token = apiConfig.telegramToken || TELEGRAM_BOT_TOKEN;
            const chatId = apiConfig.telegramChatId || TELEGRAM_CHAT_ID;
            
            if (token.includes('YOUR_') || chatId.includes('YOUR_')) {
                console.log("Telegram notification skipped: API keys not set.");
                return;
            }

            const url = `https://api.telegram.org/bot${token}/sendMessage`;
            fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ chat_id: chatId, text: message })
            }).catch(err => console.error("Telegram sending failed:", err));
        }
        
        // --- UTILITY FUNCTIONS ---
        function showModal(modalId) {
            document.getElementById(modalId)?.classList.add('active');
        }

        function hideModal(modalId) {
            document.getElementById(modalId)?.classList.remove('active');
        }
        
        function showProfile() {
            alert(`User: ${currentUser.email}\nRole: ${currentUser.role || 'Engineer'}`);
        }

    </script>
</body>
</html>
