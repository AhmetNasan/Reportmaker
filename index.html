
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced Engineering Platform with Estimation & Inspection</title>

    <!-- External Libraries -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Open+Sans:wght@200;300;400;500;600;700&display=swap" rel="stylesheet">

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>

    <style>
        :root {
            --primary-color: #667eea;
            --secondary-color: #764ba2;
            --accent-color: #ff9a9e;
            --text-light: #ffffff;
            --text-dark: #271930;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.37);
            --shadow-hover: 0 12px 48px rgba(0, 0, 0, 0.5);
            --border-radius: 15px;
            --transition: all 0.3s ease;
            --backdrop-blur: blur(20px);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: "Open Sans", sans-serif;
        }

        body {
            min-height: 100vh;
            background: linear-gradient(135deg, #ff9a9e 0%, #fad0c4 100%);
            color: var(--text-light);
            line-height: 1.6;
            overflow-x: hidden;
            position: relative;
        }

        body::before {
            content: "";
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url("https://i.postimg.cc/0jv27Qvw/20008380-645221846.jpg"), #000;
            background-position: center;
            background-size: cover;
            background-attachment: fixed;
            z-index: -1;
            opacity: 0.3;
        }

        /* Glassmorphism Base Components */
        .glass {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .glass:hover {
            box-shadow: var(--shadow-hover);
            transform: translateY(-2px);
        }

        /* Authentication Styles */
        .auth-container {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 10000;
            padding: 0 10px;
        }

        .wrapper {
            width: 400px;
            border-radius: var(--border-radius);
            padding: 40px;
            text-align: center;
            background: var(--glass-bg);
            border: 1px solid var(--glass-border);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .wrapper:hover {
            box-shadow: var(--shadow-hover);
        }

        .auth-form {
            display: flex;
            flex-direction: column;
        }

        .auth-logo {
            font-size: 2.2rem;
            margin-bottom: 25px;
            color: var(--text-light);
            letter-spacing: 1px;
        }

        .input-field {
            position: relative;
            border-bottom: 2px solid rgba(255, 255, 255, 0.3);
            margin: 20px 0;
        }

        .input-field label {
            position: absolute;
            top: 50%;
            left: 0;
            transform: translateY(-50%);
            color: var(--text-light);
            font-size: 16px;
            pointer-events: none;
            transition: var(--transition);
        }

        .input-field input {
            width: 100%;
            height: 40px;
            background: transparent;
            border: none;
            outline: none;
            font-size: 16px;
            color: var(--text-light);
            padding: 0 10px;
        }

        .input-field input:focus~label,
        .input-field input:valid~label {
            font-size: 0.9rem;
            top: 10px;
            transform: translateY(-150%);
            color: #ffdde1;
        }

        .auth-btn {
            background-color: var(--text-dark);
            color: var(--text-light);
            font-weight: 600;
            border: none;
            padding: 15px 20px;
            cursor: pointer;
            border-radius: 25px;
            font-size: 16px;
            border: 2px solid transparent;
            transition: var(--transition);
            margin-top: 20px;
        }

        .auth-btn:hover {
            color: var(--text-dark);
            background: rgba(255, 255, 255, 0.2);
            border-color: var(--text-light);
        }

        .auth-toggle {
            color: #ffdde1;
            cursor: pointer;
            margin-top: 30px;
            text-decoration: none;
        }

        .auth-toggle:hover {
            text-decoration: underline;
        }

        /* Main App Styles */
        .main-app {
            display: none;
            min-height: 100vh;
        }

        .header {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 0 0 20px 20px;
            padding: 15px 30px;
            box-shadow: var(--shadow-glass);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 1000;
            margin-bottom: 20px;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .logo {
            font-size: 24px;
            font-weight: bold;
            background: linear-gradient(135deg, #ffdde1, #ff9a9e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .header-actions {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .theme-toggle {
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            padding: 10px;
            transition: var(--transition);
            color: var(--text-light);
        }

        .theme-toggle:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glass);
        }

        .user-menu {
            position: relative;
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-light);
            font-weight: bold;
            cursor: pointer;
            transition: var(--transition);
        }

        .user-avatar:hover {
            transform: scale(1.1);
            box-shadow: var(--shadow-glass);
        }

        .user-dropdown {
            position: absolute;
            top: 100%;
            right: 0;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            box-shadow: var(--shadow-glass);
            min-width: 200px;
            display: none;
            z-index: 1001;
        }

        .user-dropdown.active {
            display: block;
        }

        .user-dropdown-item {
            padding: 12px 16px;
            cursor: pointer;
            transition: background-color 0.2s;
            display: flex;
            align-items: center;
            gap: 10px;
            color: var(--text-light);
        }

        .user-dropdown-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .app-layout {
            display: flex;
            min-height: calc(100vh - 90px);
            gap: 20px;
            padding: 0 20px;
        }

        .sidebar {
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            overflow-y: auto;
            transition: var(--transition);
            height: fit-content;
        }

        .sidebar-toggle {
            display: none;
            background: var(--secondary-color);
            color: var(--text-light);
            border: none;
            padding: 10px;
            margin: 10px;
            border-radius: 8px;
            cursor: pointer;
        }

        .nav-section {
            padding: 20px 0;
            border-bottom: 1px solid var(--glass-border);
        }

        .nav-section-title {
            padding: 0 20px 10px;
            font-size: 12px;
            text-transform: uppercase;
            color: #ffdde1;
            font-weight: 600;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 20px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
            text-decoration: none;
        }

        .nav-item:hover,
        .nav-item.active {
            background: rgba(255, 255, 255, 0.1);
            color: #ffdde1;
        }

        .nav-item i {
            width: 20px;
            text-align: center;
        }

        .main-content {
            flex: 1;
            overflow-y: auto;
            padding-right: 20px;
        }

        .page {
            display: none;
            animation: fadeIn 0.3s ease-in-out;
        }

        .page.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow-glass);
            transition: var(--transition);
        }

        .card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 15px;
            border-bottom: 1px solid var(--glass-border);
        }

        .card-title {
            font-size: 24px;
            font-weight: 600;
            margin: 0;
            color: var(--text-light);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border: 1px solid var(--glass-border);
            color: var(--text-light);
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-glass);
        }

        .btn-primary { 
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: var(--text-light);
            border: none;
        }
        .btn-success { 
            background: linear-gradient(135deg, #27ae60, #2ecc71);
            color: var(--text-light);
            border: none;
        }
        .btn-danger { 
            background: linear-gradient(135deg, #e74c3c, #c0392b);
            color: var(--text-light);
            border: none;
        }
        .btn-warning { 
            background: linear-gradient(135deg, #f39c12, #e67e22);
            color: var(--text-light);
            border: none;
        }
        .btn-info { 
            background: linear-gradient(135deg, #3498db, #2980b9);
            color: var(--text-light);
            border: none;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: var(--text-light);
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--glass-border);
            border-radius: 12px;
            font-size: 14px;
            transition: var(--transition);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            color: var(--text-light);
        }

        .form-input::placeholder,
        .form-textarea::placeholder {
            color: rgba(255, 255, 255, 0.7);
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: #ffdde1;
            box-shadow: 0 0 0 3px rgba(255, 221, 225, 0.1);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Table Styles */
        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
        }

        .table th,
        .table td {
            padding: 15px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
            color: var(--text-light);
        }

        .table th {
            background: rgba(255, 221, 225, 0.1);
            color: var(--text-light);
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        /* Enhanced Estimation & Inspection Styles */
        .estimation-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .estimation-card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            box-shadow: var(--shadow-glass);
        }

        .drop-zone {
            border: 2px dashed var(--glass-border);
            border-radius: var(--border-radius);
            padding: 30px;
            text-align: center;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            cursor: pointer;
            transition: var(--transition);
            margin-bottom: 20px;
        }

        .drop-zone:hover {
            border-color: #ffdde1;
            transform: translateY(-2px);
            box-shadow: var(--shadow-glass);
        }

        .drop-zone-buttons {
            display: flex;
            gap: 15px;
            justify-content: center;
            margin-top: 15px;
        }

        .icon-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary-color);
            background-color: var(--glass-bg);
            color: var(--primary-color);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: var(--transition);
        }

        .icon-button:hover {
            background-color: var(--primary-color);
            color: white;
            transform: scale(1.1);
        }

        .photo-previews {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .photo-preview {
            position: relative;
            border-radius: 8px;
            overflow: hidden;
        }

        .photo-preview img {
            width: 100px;
            height: 75px;
            object-fit: cover;
            cursor: pointer;
        }

        .photo-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }

        .photo-wrapper img {
            max-height: 80px;
            max-width: 120px;
            border-radius: 5px;
            cursor: pointer;
            object-fit: cover;
        }

        /* Map Styles */
        .map-container {
            height: 400px;
            border-radius: var(--border-radius);
            overflow: hidden;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
        }

        .map-controls {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            margin-bottom: 20px;
            padding: 15px;
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
        }

        .gps-info {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-glass);
        }

        .gps-coordinate {
            display: flex;
            justify-content: space-between;
            margin-bottom: 5px;
        }

        .location-mode-switcher {
            display: flex;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            margin-bottom: 15px;
        }

        .location-mode-btn {
            flex: 1;
            padding: 12px;
            border: none;
            background-color: var(--glass-bg);
            cursor: pointer;
            transition: var(--transition);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
        }

        .location-mode-btn:not(:last-child) {
            border-right: 1px solid var(--glass-border);
        }

        .location-mode-btn.active {
            background-color: var(--primary-color);
            color: white;
            font-weight: bold;
        }

        /* Modal Styles */
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0,0,0,0.6);
            display: none;
            justify-content: center;
            align-items: center;
            z-index: 2000;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 30px;
            width: 90%;
            max-width: 600px;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: var(--shadow-glass);
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: var(--text-light);
        }

        /* Stats Cards */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow-glass);
            text-align: center;
            position: relative;
            overflow: hidden;
            transition: var(--transition);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-hover);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
        }

        .stat-number {
            font-size: 36px;
            font-weight: bold;
            margin-bottom: 10px;
            background: linear-gradient(135deg, #ffdde1, #ff9a9e);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            color: var(--text-light);
            font-size: 14px;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        /* Tabs */
        .tabs {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            margin-bottom: 20px;
        }

        .tab-button {
            padding: 12px 20px;
            border: 1px solid var(--glass-border);
            border-bottom: none;
            border-radius: 10px 10px 0 0;
            cursor: pointer;
            background-color: var(--glass-bg);
            font-size: 14px;
            font-weight: 500;
            color: var(--text-light);
            transition: var(--transition);
        }

        .tab-button.active {
            background-color: rgba(255, 255, 255, 0.2);
            border-bottom: 1px solid transparent;
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* BOQ Styles */
        .boq-entry-card {
            background: var(--glass-bg);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: var(--shadow-glass);
        }

        .boq-form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            align-items: end;
        }

        .boq-ref-group {
            display: flex;
            gap: 5px;
            align-items: end;
        }

        .boq-ref-group select {
            flex-grow: 1;
        }

        .most-used-boq {
            margin-top: 15px;
            padding: 15px;
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            background: var(--glass-bg);
        }

        .most-used-boq h4 {
            margin: 0 0 10px 0;
            color: var(--text-light);
        }

        .most-used-boq-list {
            list-style: none;
            padding: 0;
            margin: 0;
            display: flex;
            flex-wrap: wrap;
            gap: 8px;
        }

        .most-used-boq-list li {
            padding: 5px 12px;
            background-color: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            font-size: 12px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
        }

        .most-used-boq-list li:hover {
            background-color: rgba(255, 255, 255, 0.2);
            font-weight: bold;
        }

        /* Print Styles */
        @media print {
            body > *:not(.main-app) {
                display: none !important;
            }
            .main-app > *:not(.app-layout) {
                display: none !important;
            }
            .app-layout > *:not(.main-content) {
                display: none !important;
            }
            .main-content > *:not(.page.active) {
                display: none !important;
            }
            .page.active > *:not(.printable-area) {
                display: none !important;
            }
            .printable-area {
                display: block !important;
            }
            body {
                background: white !important;
                color: black !important;
            }
            .card {
                background: white !important;
                border: 1px solid #ccc !important;
                box-shadow: none !important;
            }
            .table th,
            .table td {
                color: black !important;
                border: 1px solid #ccc !important;
            }
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .app-layout {
                flex-direction: column;
                gap: 10px;
                padding: 0 10px;
            }

            .sidebar {
                width: 100%;
                order: 2;
            }

            .main-content {
                order: 1;
                padding-right: 0;
            }

            .header {
                padding: 10px 15px;
                border-radius: 0;
                margin-bottom: 10px;
            }

            .sidebar-toggle {
                display: block;
            }

            .stats-grid {
                grid-template-columns: 1fr;
            }

            .wrapper {
                margin: 20px;
                padding: 30px 20px;
                width: calc(100% - 40px);
            }

            .map-container {
                height: 300px;
            }

            .card {
                padding: 15px;
            }

            .estimation-form-grid {
                grid-template-columns: 1fr;
            }

            .boq-form-grid {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 480px) {
            .header-left {
                gap: 10px;
            }

            .logo {
                font-size: 18px;
            }

            .map-container {
                height: 250px;
            }

            .wrapper {
                padding: 25px 15px;
            }

            .auth-logo {
                font-size: 1.8rem;
            }

            .card-header {
                flex-direction: column;
                gap: 15px;
                align-items: flex-start;
            }
        }

        /* Utility Classes */
        .text-center { text-align: center; }
        .text-right { text-align: right; }
        .mt-1 { margin-top: 0.25rem; }
        .mt-2 { margin-top: 0.5rem; }
        .mt-3 { margin-top: 1rem; }
        .mb-1 { margin-bottom: 0.25rem; }
        .mb-2 { margin-bottom: 0.5rem; }
        .mb-3 { margin-bottom: 1rem; }
        .p-1 { padding: 0.25rem; }
        .p-2 { padding: 0.5rem; }
        .p-3 { padding: 1rem; }
        .d-flex { display: flex; }
        .flex-column { flex-direction: column; }
        .align-center { align-items: center; }
        .justify-center { justify-content: center; }
        .gap-1 { gap: 0.25rem; }
        .gap-2 { gap: 0.5rem; }
        .gap-3 { gap: 1rem; }
        .w-100 { width: 100%; }
        .h-100 { height: 100%; }
    </style>
</head>
<body>
    <!-- Authentication Container -->
    <div id="auth-container" class="auth-container">
        <div class="wrapper">
            <div class="auth-logo">🏗️</div>
            <h2 id="auth-title">Welcome to Enhanced Engineering Platform</h2>
            <p id="auth-subtitle">Sign in to continue</p>

            <form id="auth-form" class="auth-form">
                <div class="input-field">
                    <input type="email" id="auth-email" required>
                    <label for="auth-email">Email</label>
                </div>
                <div class="input-field">
                    <input type="password" id="auth-password" required>
                    <label for="auth-password">Password</label>
                </div>
                <div class="input-field" id="name-field" style="display: none;">
                    <input type="text" id="auth-name">
                    <label for="auth-name">Full Name</label>
                </div>
                <button type="submit" id="auth-submit" class="auth-btn">Sign In</button>
                <div id="auth-toggle" class="auth-toggle">Don't have an account? Sign up</div>
            </form>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="main-app">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <button class="sidebar-toggle" onclick="toggleSidebar()">
                    <i class="fas fa-bars"></i>
                </button>
                <div class="logo">Enhanced Engineering Platform</div>
            </div>
            <div class="header-actions">
                <button class="theme-toggle" onclick="toggleTheme()">
                    <i class="fas fa-moon"></i>
                </button>
                <div class="user-menu">
                    <div class="user-avatar" onclick="toggleUserMenu()">
                        <span id="user-initial">U</span>
                    </div>
                    <div id="user-dropdown" class="user-dropdown">
                        <div class="user-dropdown-item" onclick="showProfile()">
                            <i class="fas fa-user"></i> Profile
                        </div>
                        <div class="user-dropdown-item" onclick="showSettings()">
                            <i class="fas fa-cog"></i> Settings
                        </div>
                        <div class="user-dropdown-item" onclick="logout()">
                            <i class="fas fa-sign-out-alt"></i> Logout
                        </div>
                    </div>
                </div>
            </div>
        </header>

        <div class="app-layout">
            <!-- Sidebar -->
            <nav id="sidebar" class="sidebar">
                <div class="nav-section">
                    <div class="nav-section-title">Main</div>
                    <div class="nav-item active" onclick="showPage('dashboard')">
                        <i class="fas fa-tachometer-alt"></i> Dashboard
                    </div>
                    <div class="nav-item" onclick="showPage('projects')">
                        <i class="fas fa-project-diagram"></i> Projects
                    </div>
                    <div class="nav-item" onclick="showPage('notifications')">
                        <i class="fas fa-bell"></i> Notifications
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Enhanced Tools</div>
                    <div class="nav-item" onclick="showPage('estimation-inspection')">
                        <i class="fas fa-calculator"></i> Enhanced Estimation & Inspection
                    </div>
                    <div class="nav-item" onclick="showPage('contracts')">
                        <i class="fas fa-file-contract"></i> Contracts & BOQ
                    </div>
                    <div class="nav-item" onclick="showPage('cost-estimation')">
                        <i class="fas fa-calculator"></i> Cost Estimation
                    </div>
                    <div class="nav-item" onclick="showPage('timeline')">
                        <i class="fas fa-timeline"></i> Project Timeline
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Engineering Tools</div>
                    <div class="nav-item" onclick="showPage('map')">
                        <i class="fas fa-map-marked-alt"></i> GIS Mapping
                    </div>
                    <div class="nav-item" onclick="showPage('drawing')">
                        <i class="fas fa-drafting-compass"></i> CAD Drawing
                    </div>
                    <div class="nav-item" onclick="showPage('ai-defect')">
                        <i class="fas fa-robot"></i> AI Defect Analysis
                    </div>
                    <div class="nav-item" onclick="showPage('inspection')">
                        <i class="fas fa-clipboard-check"></i> Inspection Reports
                    </div>
                </div>

                <div class="nav-section">
                    <div class="nav-section-title">Operations</div>
                    <div class="nav-item" onclick="showPage('vehicle-tracking')">
                        <i class="fas fa-truck"></i> Vehicle Tracking
                    </div>
                    <div class="nav-item" onclick="showPage('material-logistics')">
                        <i class="fas fa-boxes"></i> Material Logistics
                    </div>
                    <div class="nav-item" onclick="showPage('file-manager')">
                        <i class="fas fa-folder"></i> File Manager
                    </div>
                    <div class="nav-item" onclick="showPage('settings')">
                        <i class="fas fa-cog"></i> Settings
                    </div>
                </div>
            </nav>

            <!-- Main Content -->
            <main class="main-content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="card">
                        <h1>Enhanced Engineering Platform Dashboard</h1>
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-number" id="active-projects">12</div>
                                <div class="stat-label">Active Projects</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="pending-inspections">8</div>
                                <div class="stat-label">Pending Inspections</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="cost-estimations">25</div>
                                <div class="stat-label">Cost Estimations</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-number" id="ai-analyses">47</div>
                                <div class="stat-label">AI Analyses Today</div>
                            </div>
                        </div>

                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="showPage('estimation-inspection')">
                                <i class="fas fa-calculator"></i> Enhanced Estimation
                            </button>
                            <button class="btn btn-success" onclick="showPage('inspection')">
                                <i class="fas fa-clipboard-check"></i> New Inspection
                            </button>
                            <button class="btn btn-warning" onclick="showPage('ai-defect')">
                                <i class="fas fa-robot"></i> AI Analysis
                            </button>
                            <button class="btn btn-info" onclick="showPage('map')">
                                <i class="fas fa-map"></i> View Map
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Enhanced Estimation & Inspection Page -->
                <div id="estimation-inspection-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Enhanced Estimation & Inspection System</h1>
                            <div class="d-flex gap-2">
                                <button class="btn btn-primary" onclick="exportProject()">
                                    <i class="fas fa-save"></i> Export Project
                                </button>
                                <input type="file" id="project-import-input" accept=".json" style="display: none;" onchange="importProject(event)">
                                <button class="btn btn-success" onclick="document.getElementById('project-import-input').click()">
                                    <i class="fas fa-upload"></i> Import Project
                                </button>
                                <button class="btn btn-info" onclick="printReport()">
                                    <i class="fas fa-print"></i> Print Report
                                </button>
                            </div>
                        </div>

                        <!-- Tabs -->
                        <div class="tabs">
                            <button class="tab-button active" onclick="openTab(event, 'inspection-tab')">Inspection Report</button>
                            <button class="tab-button" onclick="openTab(event, 'cost-tab')">Cost Estimation</button>
                            <button class="tab-button" onclick="openTab(event, 'map-tab')">Project Map</button>
                        </div>

                        <!-- Inspection Tab -->
                        <div id="inspection-tab" class="tab-content active">
                            <div class="estimation-form-grid">
                                <div class="estimation-card">
                                    <h3>Asset Information</h3>
                                    <div class="form-group">
                                        <label class="form-label">Asset Description</label>
                                        <input type="text" id="asset-description" class="form-input" list="asset-options" placeholder="Enter asset description">
                                        <datalist id="asset-options">
                                            <option value="Bridge A-123">
                                            <option value="Highway Section B-456">
                                            <option value="Culvert C-789">
                                            <option value="Retaining Wall D-101">
                                            <option value="Pavement Section E-202">
                                        </datalist>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Status</label>
                                        <select id="asset-status" class="form-select">
                                            <option value="Good">Good</option>
                                            <option value="Fair">Fair</option>
                                            <option value="Poor">Poor</option>
                                            <option value="Critical">Critical</option>
                                        </select>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Recommendation</label>
                                        <textarea id="asset-recommendation" class="form-textarea" placeholder="Enter maintenance recommendations"></textarea>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Quantity</label>
                                        <input type="number" id="asset-quantity" class="form-input" placeholder="Enter quantity">
                                        <button class="btn btn-info mt-2" onclick="showQuantityCalculator()">
                                            <i class="fas fa-calculator"></i> Calculate Quantity
                                        </button>
                                    </div>
                                </div>

                                <div class="estimation-card">
                                    <h3>Photo Documentation</h3>
                                    <div class="drop-zone" onclick="document.getElementById('photo-input').click()">
                                        <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                        <p>Drag & Drop or Click to Add Photos</p>
                                        <div class="drop-zone-buttons">
                                            <button class="icon-button" onclick="event.stopPropagation(); document.getElementById('photo-input').click()" title="Choose from Gallery">
                                                <i class="fas fa-images"></i>
                                            </button>
                                            <button class="icon-button" onclick="event.stopPropagation(); openCamera()" title="Open Camera">
                                                <i class="fas fa-camera"></i>
                                            </button>
                                        </div>
                                    </div>
                                    <input type="file" id="photo-input" multiple accept="image/*" style="display: none;" onchange="handlePhotos(event)">
                                    <div id="photo-previews" class="photo-previews"></div>
                                </div>

                                <div class="estimation-card">
                                    <h3>GPS Location</h3>
                                    <div class="location-mode-switcher">
                                        <button id="auto-location" class="location-mode-btn active" onclick="switchLocationMode('auto')">Automatic</button>
                                        <button id="manual-location" class="location-mode-btn" onclick="switchLocationMode('manual')">Manual</button>
                                    </div>
                                    <div id="auto-location-panel">
                                        <button class="btn btn-success w-100 mb-2" onclick="getCurrentLocation()">
                                            <i class="fas fa-map-marker-alt"></i> Get Current GPS
                                        </button>
                                    </div>
                                    <div id="manual-location-panel" style="display: none;">
                                        <div class="form-group">
                                            <label class="form-label">Latitude</label>
                                            <input type="number" id="manual-lat" class="form-input" step="any" placeholder="25.2854">
                                        </div>
                                        <div class="form-group">
                                            <label class="form-label">Longitude</label>
                                            <input type="number" id="manual-lng" class="form-input" step="any" placeholder="51.5310">
                                        </div>
                                    </div>
                                    <div class="gps-info">
                                        <div class="gps-coordinate">
                                            <strong>Latitude:</strong> <span id="current-lat">N/A</span>
                                        </div>
                                        <div class="gps-coordinate">
                                            <strong>Longitude:</strong> <span id="current-lng">N/A</span>
                                        </div>
                                    </div>
                                    <div id="mini-map" class="map-container" style="height: 200px;"></div>
                                </div>
                            </div>

                            <button class="btn btn-primary" onclick="addInspectionRow()">
                                <i class="fas fa-plus"></i> Add to Inspection Report
                            </button>

                            <!-- Inspection Table -->
                            <div class="card mt-3">
                                <div class="card-header">
                                    <h3>Inspection Report</h3>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" onclick="exportInspectionCSV()">
                                            <i class="fas fa-file-csv"></i> Export CSV
                                        </button>
                                        <button class="btn btn-warning" onclick="exportInspectionKML()">
                                            <i class="fas fa-map"></i> Export KML
                                        </button>
                                        <button class="btn btn-info" onclick="printInspectionReport()">
                                            <i class="fas fa-print"></i> Print
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="table" id="inspection-table">
                                        <thead>
                                            <tr>
                                                <th>ID</th>
                                                <th>Asset</th>
                                                <th>Status</th>
                                                <th>Recommendation</th>
                                                <th>Quantity</th>
                                                <th>Photos</th>
                                                <th>Latitude</th>
                                                <th>Longitude</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inspection-tbody">
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Cost Estimation Tab -->
                        <div id="cost-tab" class="tab-content">
                            <div class="boq-entry-card">
                                <h3>BOQ Item Entry</h3>
                                <div class="boq-form-grid">
                                    <div class="form-group">
                                        <label class="form-label">BOQ Reference</label>
                                        <div class="boq-ref-group">
                                            <input type="search" id="boq-search" class="form-input" placeholder="Search BOQ..." onkeyup="filterBOQ()">
                                            <select id="boq-select" class="form-select" onchange="updateBOQDetails()">
                                                <option value="">Select BOQ Item</option>
                                                <option value="A1.1" data-desc="Excavation" data-unit="m³" data-rate="15.00">A1.1 - Excavation</option>
                                                <option value="A1.2" data-desc="Backfilling" data-unit="m³" data-rate="10.00">A1.2 - Backfilling</option>
                                                <option value="B2.1" data-desc="Concrete Paving" data-unit="m²" data-rate="75.00">B2.1 - Concrete Paving</option>
                                                <option value="B2.2" data-desc="Asphalt Layer" data-unit="m²" data-rate="50.00">B2.2 - Asphalt Layer</option>
                                                <option value="C3.1" data-desc="Kerb Installation" data-unit="m.l" data-rate="25.00">C3.1 - Kerb Installation</option>
                                                <option value="C3.2" data-desc="Interlock Paving" data-unit="m²" data-rate="40.00">C3.2 - Interlock Paving</option>
                                            </select>
                                        </div>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Description</label>
                                        <input type="text" id="boq-description" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Unit</label>
                                        <input type="text" id="boq-unit" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">NR</label>
                                        <input type="number" id="boq-nr" class="form-input" value="1" onchange="calculateBOQTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Length (m)</label>
                                        <input type="number" id="boq-length" class="form-input" onchange="calculateBOQTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Width (m)</label>
                                        <input type="number" id="boq-width" class="form-input" onchange="calculateBOQTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Height (m)</label>
                                        <input type="number" id="boq-height" class="form-input" onchange="calculateBOQTotal()">
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Total Quantity</label>
                                        <input type="text" id="boq-total-qty" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Rate</label>
                                        <input type="number" id="boq-rate" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Amount (QR)</label>
                                        <input type="text" id="boq-amount" class="form-input" readonly>
                                    </div>
                                    <div class="form-group">
                                        <label class="form-label">Remarks</label>
                                        <input type="text" id="boq-remarks" class="form-input">
                                    </div>
                                </div>

                                <div class="most-used-boq">
                                    <h4>Most Used BOQ References</h4>
                                    <ul class="most-used-boq-list" id="most-used-list">
                                        <li onclick="selectBOQ('A1.1')">A1.1 (5)</li>
                                        <li onclick="selectBOQ('B2.1')">B2.1 (3)</li>
                                        <li onclick="selectBOQ('C3.1')">C3.1 (2)</li>
                                    </ul>
                                </div>

                                <div class="d-flex gap-2 mt-3">
                                    <button class="btn btn-success" onclick="addBOQRow()">
                                        <i class="fas fa-plus"></i> Add Item
                                    </button>
                                    <button class="btn btn-warning" onclick="showQuantityCalculator('boq')">
                                        <i class="fas fa-calculator"></i> Calculate Quantity
                                    </button>
                                    <button class="btn btn-info" onclick="downloadBOQTemplate()">
                                        <i class="fas fa-download"></i> Download Template
                                    </button>
                                    <input type="file" id="boq-csv-input" accept=".csv" style="display: none;" onchange="importBOQCSV(event)">
                                    <button class="btn btn-primary" onclick="document.getElementById('boq-csv-input').click()">
                                        <i class="fas fa-upload"></i> Import CSV
                                    </button>
                                </div>
                            </div>

                            <!-- Cost Estimation Table -->
                            <div class="card">
                                <div class="card-header">
                                    <h3>Cost Estimation</h3>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-success" onclick="exportCostCSV()">
                                            <i class="fas fa-file-csv"></i> Export CSV
                                        </button>
                                        <button class="btn btn-info" onclick="printCostReport()">
                                            <i class="fas fa-print"></i> Print
                                        </button>
                                    </div>
                                </div>
                                <div class="table-container">
                                    <table class="table" id="cost-table">
                                        <thead>
                                            <tr>
                                                <th>BOQ Ref.</th>
                                                <th>Description</th>
                                                <th>Unit</th>
                                                <th>NR</th>
                                                <th>Length</th>
                                                <th>Width</th>
                                                <th>Height</th>
                                                <th>Total Qty</th>
                                                <th>Rate</th>
                                                <th>Amount</th>
                                                <th>Remarks</th>
                                                <th>Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody id="cost-tbody">
                                        </tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="9" style="text-align: right; font-weight: bold;">Total Amount:</td>
                                                <td id="total-amount" style="font-weight: bold;">QR 0.00</td>
                                                <td colspan="2"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>

                        <!-- Map Tab -->
                        <div id="map-tab" class="tab-content">
                            <div class="card">
                                <div class="card-header">
                                    <h3>Project Map</h3>
                                    <div class="d-flex gap-2">
                                        <button class="btn btn-primary" onclick="centerMapOnUser()">
                                            <i class="fas fa-map-marker-alt"></i> My Location
                                        </button>
                                        <button class="btn btn-success" onclick="fitMapToMarkers()">
                                            <i class="fas fa-expand-arrows-alt"></i> Fit All
                                        </button>
                                        <button class="btn btn-warning" onclick="clearMapMarkers()">
                                            <i class="fas fa-trash"></i> Clear Markers
                                        </button>
                                        <input type="file" id="map-import" accept=".kml,.csv" style="display: none;" onchange="importMapData(event)">
                                        <button class="btn btn-info" onclick="document.getElementById('map-import').click()">
                                            <i class="fas fa-upload"></i> Import KML/CSV
                                        </button>
                                    </div>
                                </div>
                                <div id="project-map" class="map-container" style="height: 500px;"></div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Placeholder pages for other sections -->
                <div id="projects-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Project Management</h1>
                        </div>
                        <p>Project management interface will be here.</p>
                    </div>
                </div>

                <div id="contracts-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Contracts & BOQ</h1>
                        </div>
                        <p>Contracts and BOQ management interface will be here.</p>
                    </div>
                </div>

                <div id="cost-estimation-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Cost Estimation</h1>
                        </div>
                        <p>Cost estimation interface will be here.</p>
                    </div>
                </div>

                <div id="timeline-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Project Timeline</h1>
                        </div>
                        <p>Project timeline interface will be here.</p>
                    </div>
                </div>

                <div id="map-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">GIS Mapping</h1>
                        </div>
                        <div id="main-map" class="map-container" style="height: 600px;"></div>
                    </div>
                </div>

                <div id="drawing-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">CAD Drawing</h1>
                        </div>
                        <p>CAD drawing interface will be here.</p>
                    </div>
                </div>

                <div id="ai-defect-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">AI Defect Analysis</h1>
                        </div>
                        <div class="drop-zone" onclick="document.getElementById('ai-image-input').click()">
                            <i class="fas fa-cloud-upload-alt fa-3x mb-3"></i>
                            <h3>Upload Images for AI Analysis</h3>
                            <p>Drag and drop images here or click to select</p>
                            <input type="file" id="ai-image-input" multiple accept="image/*" style="display: none;" onchange="analyzeDefects(event)">
                        </div>
                        <div id="ai-results" style="display: none;">
                            <h3>Analysis Results</h3>
                            <div id="ai-results-container"></div>
                        </div>
                    </div>
                </div>

                <div id="inspection-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Inspection Reports</h1>
                        </div>
                        <p>Standard inspection reports interface will be here.</p>
                    </div>
                </div>

                <div id="vehicle-tracking-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Vehicle Tracking</h1>
                        </div>
                        <p>Vehicle tracking interface will be here.</p>
                    </div>
                </div>

                <div id="material-logistics-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Material Logistics</h1>
                        </div>
                        <p>Material logistics interface will be here.</p>
                    </div>
                </div>

                <div id="file-manager-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">File Manager</h1>
                        </div>
                        <p>File management interface will be here.</p>
                    </div>
                </div>

                <div id="notifications-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Notifications</h1>
                        </div>
                        <p>Notifications interface will be here.</p>
                    </div>
                </div>

                <div id="settings-page" class="page">
                    <div class="card">
                        <div class="card-header">
                            <h1 class="card-title">Settings</h1>
                        </div>
                        <p>Settings interface will be here.</p>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Modals -->
    <div id="quantity-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="hideModal('quantity-modal')">&times;</button>
            <h2>Quantity Calculator</h2>
            <div class="form-group">
                <label class="form-label">Length (m)</label>
                <input type="number" id="calc-length" class="form-input" onchange="calculateQuantity()">
            </div>
            <div class="form-group">
                <label class="form-label">Width (m)</label>
                <input type="number" id="calc-width" class="form-input" onchange="calculateQuantity()">
            </div>
            <div class="form-group">
                <label class="form-label">Height (m)</label>
                <input type="number" id="calc-height" class="form-input" onchange="calculateQuantity()">
            </div>
            <div class="form-group">
                <label class="form-label">Repetitions</label>
                <input type="number" id="calc-repetitions" class="form-input" value="1" onchange="calculateQuantity()">
            </div>
            <div class="form-group">
                <label class="form-label">Calculated Quantity</label>
                <input type="text" id="calculated-quantity" class="form-input" readonly>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="setQuantity()">Set Quantity</button>
                <button class="btn btn-secondary" onclick="hideModal('quantity-modal')">Cancel</button>
            </div>
        </div>
    </div>

    <div id="camera-modal" class="modal">
        <div class="modal-content" style="background: black; padding: 0; max-width: 600px;">
            <button class="modal-close" onclick="closeCamera()" style="color: white; z-index: 1001;">&times;</button>
            <video id="camera-feed" autoplay playsinline style="width: 100%; height: 400px; object-fit: cover;"></video>
            <div style="position: absolute; bottom: 20px; left: 50%; transform: translateX(-50%);">
                <button class="btn btn-primary" onclick="capturePhoto()" style="border-radius: 50%; width: 60px; height: 60px;">
                    <i class="fas fa-camera"></i>
                </button>
            </div>
        </div>
    </div>

    <script>
        // Global Variables
        let currentUser = null;
        let currentPage = 'dashboard';
        let isAuthMode = 'signin';
        let inspectionData = [];
        let costEstimationData = [];
        let projectMap = null;
        let miniMap = null;
        let mainMap = null;
        let currentLocation = { lat: 25.2854, lng: 51.5310 };
        let mapMarkers = [];
        let photoFiles = [];
        let cameraStream = null;
        let quantityContext = 'inspection';
        let boqUsage = {};

        // Initialize app
        document.addEventListener('DOMContentLoaded', () => {
            initAuth();
            loadBOQUsage();
        });

        // Authentication Functions
        function initAuth() {
            document.getElementById('auth-container').style.display = 'flex';
            document.getElementById('main-app').style.display = 'none';
            
            document.getElementById('auth-form').addEventListener('submit', handleAuth);
            document.getElementById('auth-toggle').addEventListener('click', toggleAuthMode);
        }

        function toggleAuthMode() {
            const title = document.getElementById('auth-title');
            const subtitle = document.getElementById('auth-subtitle');
            const submitBtn = document.getElementById('auth-submit');
            const toggle = document.getElementById('auth-toggle');
            const nameField = document.getElementById('name-field');
            
            if (isAuthMode === 'signin') {
                isAuthMode = 'signup';
                title.textContent = 'Create Account';
                subtitle.textContent = 'Join the Enhanced Engineering Platform';
                submitBtn.textContent = 'Sign Up';
                toggle.textContent = 'Already have an account? Sign in';
                nameField.style.display = 'block';
            } else {
                isAuthMode = 'signin';
                title.textContent = 'Welcome Back';
                subtitle.textContent = 'Sign in to continue';
                submitBtn.textContent = 'Sign In';
                toggle.textContent = "Don't have an account? Sign up";
                nameField.style.display = 'none';
            }
        }

        function handleAuth(e) {
            e.preventDefault();
            
            const email = document.getElementById('auth-email').value;
            const password = document.getElementById('auth-password').value;
            const name = document.getElementById('auth-name').value;
            
            currentUser = {
                email: email,
                name: name || email.split('@')[0],
                id: Date.now()
            };
            
            showMainApp();
        }

        function showMainApp() {
            document.getElementById('auth-container').style.display = 'none';
            document.getElementById('main-app').style.display = 'block';
            
            const userInitial = document.getElementById('user-initial');
            userInitial.textContent = currentUser ? currentUser.name.charAt(0).toUpperCase() : 'U';
            
            initializeMaps();
        }

        // Page Navigation
        function showPage(pageId) {
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });

            const page = document.getElementById(`${pageId}-page`);
            if (page) {
                page.classList.add('active');
                currentPage = pageId;
            }

            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });

            const navItem = document.querySelector(`[onclick="showPage('${pageId}')"]`);
            if (navItem) {
                navItem.classList.add('active');
            }

            if (pageId === 'map' && !mainMap) {
                setTimeout(initializeMainMap, 100);
            }
        }

        function toggleSidebar() {
            document.getElementById('sidebar').classList.toggle('active');
        }

        function toggleUserMenu() {
            document.getElementById('user-dropdown').classList.toggle('active');
        }

        function toggleTheme() {
            const body = document.body;
            const themeToggle = document.querySelector('.theme-toggle i');

            if (body.getAttribute('data-theme') === 'dark') {
                body.removeAttribute('data-theme');
                themeToggle.className = 'fas fa-moon';
            } else {
                body.setAttribute('data-theme', 'dark');
                themeToggle.className = 'fas fa-sun';
            }
        }

        // Tab Management
        function openTab(event, tabName) {
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            document.querySelectorAll('.tab-button').forEach(btn => {
                btn.classList.remove('active');
            });

            document.getElementById(tabName).classList.add('active');
            event.currentTarget.classList.add('active');

            if (tabName === 'map-tab' && !projectMap) {
                setTimeout(initializeProjectMap, 100);
            }
        }

        // Map Functions
        function initializeMaps() {
            setTimeout(() => {
                initializeMiniMap();
                if (currentPage === 'estimation-inspection') {
                    initializeProjectMap();
                }
            }, 500);
        }

        function initializeMiniMap() {
            if (miniMap) return;
            
            const miniMapEl = document.getElementById('mini-map');
            if (!miniMapEl) return;

            miniMap = L.map('mini-map').setView([currentLocation.lat, currentLocation.lng], 13);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(miniMap);

            updateMiniMapLocation();
        }

        function initializeProjectMap() {
            if (projectMap) return;
            
            const projectMapEl = document.getElementById('project-map');
            if (!projectMapEl) return;

            projectMap = L.map('project-map').setView([currentLocation.lat, currentLocation.lng], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(projectMap);
        }

        function initializeMainMap() {
            if (mainMap) return;
            
            const mainMapEl = document.getElementById('main-map');
            if (!mainMapEl) return;

            mainMap = L.map('main-map').setView([currentLocation.lat, currentLocation.lng], 10);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(mainMap);
        }

        function updateMiniMapLocation() {
            if (!miniMap) return;

            miniMap.setView([currentLocation.lat, currentLocation.lng], 15);
            
            if (window.currentLocationMarker) {
                miniMap.removeLayer(window.currentLocationMarker);
            }
            
            window.currentLocationMarker = L.marker([currentLocation.lat, currentLocation.lng])
                .addTo(miniMap)
                .bindPopup('Current Location');
        }

        // GPS Functions
        function switchLocationMode(mode) {
            document.getElementById('auto-location').classList.toggle('active', mode === 'auto');
            document.getElementById('manual-location').classList.toggle('active', mode === 'manual');
            
            document.getElementById('auto-location-panel').style.display = mode === 'auto' ? 'block' : 'none';
            document.getElementById('manual-location-panel').style.display = mode === 'manual' ? 'block' : 'none';

            if (mode === 'auto') {
                getCurrentLocation();
            }
        }

        function getCurrentLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(
                    (position) => {
                        currentLocation.lat = position.coords.latitude;
                        currentLocation.lng = position.coords.longitude;
                        updateLocationDisplay();
                        updateMiniMapLocation();
                    },
                    (error) => {
                        console.error('Error getting location:', error);
                        alert('Could not get your location. Please check permissions.');
                    }
                );
            } else {
                alert('Geolocation is not supported by this browser.');
            }
        }

        function updateLocationDisplay() {
            document.getElementById('current-lat').textContent = currentLocation.lat.toFixed(6);
            document.getElementById('current-lng').textContent = currentLocation.lng.toFixed(6);
            
            // Update manual inputs if in manual mode
            const manualLat = document.getElementById('manual-lat');
            const manualLng = document.getElementById('manual-lng');
            if (manualLat && manualLng) {
                manualLat.value = currentLocation.lat.toFixed(6);
                manualLng.value = currentLocation.lng.toFixed(6);
            }
        }

        // Photo Functions
        function handlePhotos(event) {
            const files = Array.from(event.target.files);
            files.forEach(file => {
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => {
                        addPhotoPreview(e.target.result, file.name);
                    };
                    reader.readAsDataURL(file);
                }
            });
        }

        function addPhotoPreview(src, name) {
            const previewsContainer = document.getElementById('photo-previews');
            const photoDiv = document.createElement('div');
            photoDiv.className = 'photo-preview';
            photoDiv.innerHTML = `
                <img src="${src}" alt="${name}" onclick="showImagePreview('${src}')">
                <button onclick="removePhoto(this)" style="position: absolute; top: 5px; right: 5px; background: red; color: white; border: none; border-radius: 50%; width: 20px; height: 20px; font-size: 12px;">&times;</button>
            `;
            previewsContainer.appendChild(photoDiv);
            
            photoFiles.push({ src, name });
        }

        function removePhoto(button) {
            const photoDiv = button.parentElement;
            const img = photoDiv.querySelector('img');
            const src = img.src;
            
            photoFiles = photoFiles.filter(photo => photo.src !== src);
            photoDiv.remove();
        }

        function openCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-feed');
            
            navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment' } })
                .then(stream => {
                    cameraStream = stream;
                    video.srcObject = stream;
                    modal.classList.add('active');
                })
                .catch(err => {
                    console.error('Error accessing camera:', err);
                    alert('Could not access camera');
                });
        }

        function closeCamera() {
            const modal = document.getElementById('camera-modal');
            const video = document.getElementById('camera-feed');
            
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
                cameraStream = null;
            }
            
            video.srcObject = null;
            modal.classList.remove('active');
        }

        function capturePhoto() {
            const video = document.getElementById('camera-feed');
            const canvas = document.createElement('canvas');
            const context = canvas.getContext('2d');
            
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            context.drawImage(video, 0, 0);
            
            const dataUrl = canvas.toDataURL('image/jpeg');
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-');
            addPhotoPreview(dataUrl, `captured-${timestamp}.jpg`);
            
            closeCamera();
        }

        // Quantity Calculator
        function showQuantityCalculator(context = 'inspection') {
            quantityContext = context;
            document.getElementById('quantity-modal').classList.add('active');
            
            // Pre-fill values if context is BOQ
            if (context === 'boq') {
                document.getElementById('calc-length').value = document.getElementById('boq-length').value || '';
                document.getElementById('calc-width').value = document.getElementById('boq-width').value || '';
                document.getElementById('calc-height').value = document.getElementById('boq-height').value || '';
                document.getElementById('calc-repetitions').value = document.getElementById('boq-nr').value || 1;
            } else {
                // Clear for inspection context
                document.getElementById('calc-length').value = '';
                document.getElementById('calc-width').value = '';
                document.getElementById('calc-height').value = '';
                document.getElementById('calc-repetitions').value = 1;
            }
            
            calculateQuantity();
        }

        function calculateQuantity() {
            const length = parseFloat(document.getElementById('calc-length').value) || 0;
            const width = parseFloat(document.getElementById('calc-width').value) || 0;
            const height = parseFloat(document.getElementById('calc-height').value) || 0;
            const repetitions = parseFloat(document.getElementById('calc-repetitions').value) || 1;
            
            let quantity = 0;
            if (length > 0 && width > 0 && height > 0) {
                quantity = length * width * height * repetitions;
            } else if (length > 0 && width > 0) {
                quantity = length * width * repetitions;
            } else if (length > 0) {
                quantity = length * repetitions;
            } else {
                quantity = repetitions;
            }
            
            document.getElementById('calculated-quantity').value = quantity.toFixed(3);
        }

        function setQuantity() {
            const quantity = document.getElementById('calculated-quantity').value;
            
            if (quantityContext === 'boq') {
                document.getElementById('boq-nr').value = document.getElementById('calc-repetitions').value;
                document.getElementById('boq-length').value = document.getElementById('calc-length').value;
                document.getElementById('boq-width').value = document.getElementById('calc-width').value;
                document.getElementById('boq-height').value = document.getElementById('calc-height').value;
                calculateBOQTotal();
            } else {
                document.getElementById('asset-quantity').value = quantity;
            }
            
            hideModal('quantity-modal');
        }

        // BOQ Functions
        function updateBOQDetails() {
            const select = document.getElementById('boq-select');
            const selectedOption = select.options[select.selectedIndex];
            
            if (selectedOption && selectedOption.value) {
                document.getElementById('boq-description').value = selectedOption.getAttribute('data-desc') || '';
                document.getElementById('boq-unit').value = selectedOption.getAttribute('data-unit') || '';
                document.getElementById('boq-rate').value = selectedOption.getAttribute('data-rate') || '';
                calculateBOQTotal();
            }
        }

        function calculateBOQTotal() {
            const nr = parseFloat(document.getElementById('boq-nr').value) || 0;
            const length = parseFloat(document.getElementById('boq-length').value) || 0;
            const width = parseFloat(document.getElementById('boq-width').value) || 0;
            const height = parseFloat(document.getElementById('boq-height').value) || 0;
            const rate = parseFloat(document.getElementById('boq-rate').value) || 0;
            
            let totalQty = 0;
            if (nr > 0 && length > 0 && width > 0 && height > 0) {
                totalQty = nr * length * width * height;
            } else if (nr > 0 && length > 0 && width > 0) {
                totalQty = nr * length * width;
            } else if (nr > 0 && length > 0) {
                totalQty = nr * length;
            } else if (nr > 0) {
                totalQty = nr;
            }
            
            const amount = totalQty * rate;
            
            document.getElementById('boq-total-qty').value = totalQty.toFixed(3);
            document.getElementById('boq-amount').value = amount.toFixed(2);
        }

        function filterBOQ() {
            const searchTerm = document.getElementById('boq-search').value.toLowerCase();
            const select = document.getElementById('boq-select');
            const options = select.querySelectorAll('option');
            
            let hasVisibleOptions = false;
            options.forEach(option => {
                if (option.value === '') {
                    option.style.display = 'block';
                    return;
                }
                
                const text = option.textContent.toLowerCase();
                if (text.includes(searchTerm)) {
                    option.style.display = 'block';
                    hasVisibleOptions = true;
                } else {
                    option.style.display = 'none';
                }
            });
        }

        function selectBOQ(ref) {
            document.getElementById('boq-select').value = ref;
            updateBOQDetails();
        }

        function trackBOQUsage(ref) {
            boqUsage[ref] = (boqUsage[ref] || 0) + 1;
            saveBOQUsage();
            updateMostUsedList();
        }

        function loadBOQUsage() {
            const saved = localStorage.getItem('boqUsage');
            if (saved) {
                boqUsage = JSON.parse(saved);
                updateMostUsedList();
            }
        }

        function saveBOQUsage() {
            localStorage.setItem('boqUsage', JSON.stringify(boqUsage));
        }

        function updateMostUsedList() {
            const list = document.getElementById('most-used-list');
            if (!list) return;
            
            const sorted = Object.entries(boqUsage)
                .sort(([,a], [,b]) => b - a)
                .slice(0, 5);
            
            if (sorted.length === 0) {
                list.innerHTML = '<li>No BOQ items used yet</li>';
                return;
            }
            
            list.innerHTML = sorted
                .map(([ref, count]) => `<li onclick="selectBOQ('${ref}')">${ref} (${count})</li>`)
                .join('');
        }

        // Data Management Functions
        function addInspectionRow() {
            const asset = document.getElementById('asset-description').value;
            const status = document.getElementById('asset-status').value;
            const recommendation = document.getElementById('asset-recommendation').value;
            const quantity = document.getElementById('asset-quantity').value;
            
            if (!asset) {
                alert('Please enter asset description');
                return;
            }
            
            const row = {
                id: Date.now(),
                asset: asset,
                status: status,
                recommendation: recommendation,
                quantity: quantity,
                photos: [...photoFiles],
                latitude: currentLocation.lat.toFixed(6),
                longitude: currentLocation.lng.toFixed(6)
            };
            
            inspectionData.push(row);
            updateInspectionTable();
            clearInspectionForm();
            
            // Add marker to project map
            if (projectMap) {
                const marker = L.marker([currentLocation.lat, currentLocation.lng])
                    .addTo(projectMap)
                    .bindPopup(`<b>${asset}</b><br>Status: ${status}`);
                mapMarkers.push(marker);
            }
        }

        function addBOQRow() {
            const ref = document.getElementById('boq-select').value;
            const description = document.getElementById('boq-description').value;
            const unit = document.getElementById('boq-unit').value;
            const nr = document.getElementById('boq-nr').value;
            const length = document.getElementById('boq-length').value;
            const width = document.getElementById('boq-width').value;
            const height = document.getElementById('boq-height').value;
            const totalQty = document.getElementById('boq-total-qty').value;
            const rate = document.getElementById('boq-rate').value;
            const amount = document.getElementById('boq-amount').value;
            const remarks = document.getElementById('boq-remarks').value;
            
            if (!ref || !description) {
                alert('Please select a BOQ item');
                return;
            }
            
            const row = {
                id: Date.now(),
                ref: ref,
                description: description,
                unit: unit,
                nr: nr,
                length: length,
                width: width,
                height: height,
                totalQty: totalQty,
                rate: rate,
                amount: amount,
                remarks: remarks
            };
            
            costEstimationData.push(row);
            updateCostEstimationTable();
            clearBOQForm();
            trackBOQUsage(ref);
        }

        function updateInspectionTable() {
            const tbody = document.getElementById('inspection-tbody');
            tbody.innerHTML = '';
            
            inspectionData.forEach((row, index) => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${index + 1}</td>
                    <td>${row.asset}</td>
                    <td>${row.status}</td>
                    <td>${row.recommendation}</td>
                    <td>${row.quantity}</td>
                    <td>
                        <div class="photo-wrapper">
                            ${row.photos.map(photo => `<img src="${photo.src}" onclick="showImagePreview('${photo.src}')">`).join('')}
                        </div>
                    </td>
                    <td>${row.latitude}</td>
                    <td>${row.longitude}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteInspectionRow(${row.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
            });
        }

        function updateCostEstimationTable() {
            const tbody = document.getElementById('cost-tbody');
            tbody.innerHTML = '';
            
            let total = 0;
            costEstimationData.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${row.ref}</td>
                    <td>${row.description}</td>
                    <td>${row.unit}</td>
                    <td>${row.nr}</td>
                    <td>${row.length}</td>
                    <td>${row.width}</td>
                    <td>${row.height}</td>
                    <td>${row.totalQty}</td>
                    <td>${row.rate}</td>
                    <td>${row.amount}</td>
                    <td>${row.remarks}</td>
                    <td>
                        <button class="btn btn-danger" onclick="deleteCostRow(${row.id})">
                            <i class="fas fa-trash"></i>
                        </button>
                    </td>
                `;
                tbody.appendChild(tr);
                total += parseFloat(row.amount) || 0;
            });
            
            document.getElementById('total-amount').textContent = `QR ${total.toFixed(2)}`;
        }

        function deleteInspectionRow(id) {
            if (confirm('Are you sure you want to delete this row?')) {
                inspectionData = inspectionData.filter(row => row.id !== id);
                updateInspectionTable();
            }
        }

        function deleteCostRow(id) {
            if (confirm('Are you sure you want to delete this row?')) {
                costEstimationData = costEstimationData.filter(row => row.id !== id);
                updateCostEstimationTable();
            }
        }

        function clearInspectionForm() {
            document.getElementById('asset-description').value = '';
            document.getElementById('asset-status').value = 'Good';
            document.getElementById('asset-recommendation').value = '';
            document.getElementById('asset-quantity').value = '';
            document.getElementById('photo-previews').innerHTML = '';
            photoFiles = [];
        }

        function clearBOQForm() {
            document.getElementById('boq-select').value = '';
            document.getElementById('boq-description').value = '';
            document.getElementById('boq-unit').value = '';
            document.getElementById('boq-nr').value = '1';
            document.getElementById('boq-length').value = '';
            document.getElementById('boq-width').value = '';
            document.getElementById('boq-height').value = '';
            document.getElementById('boq-total-qty').value = '';
            document.getElementById('boq-rate').value = '';
            document.getElementById('boq-amount').value = '';
            document.getElementById('boq-remarks').value = '';
        }

        // Export Functions
        function exportProject() {
            const project = {
                name: `Project_${new Date().toISOString().split('T')[0]}`,
                date: new Date().toISOString(),
                inspectionData: inspectionData,
                costEstimationData: costEstimationData,
                location: currentLocation
            };
            
            const blob = new Blob([JSON.stringify(project, null, 2)], { type: 'application/json' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `${project.name}.json`;
            a.click();
            URL.revokeObjectURL(url);
        }

        function importProject(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const project = JSON.parse(e.target.result);
                    
                    if (project.inspectionData) {
                        inspectionData = project.inspectionData;
                        updateInspectionTable();
                    }
                    
                    if (project.costEstimationData) {
                        costEstimationData = project.costEstimationData;
                        updateCostEstimationTable();
                    }
                    
                    if (project.location) {
                        currentLocation = project.location;
                        updateLocationDisplay();
                        updateMiniMapLocation();
                    }
                    
                    alert('Project imported successfully!');
                } catch (error) {
                    alert('Error importing project: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        function exportInspectionCSV() {
            if (inspectionData.length === 0) {
                alert('No inspection data to export');
                return;
            }
            
            const headers = ['ID', 'Asset', 'Status', 'Recommendation', 'Quantity', 'Photos', 'Latitude', 'Longitude'];
            const csvContent = [
                headers.join(','),
                ...inspectionData.map((row, index) => [
                    index + 1,
                    `"${row.asset}"`,
                    `"${row.status}"`,
                    `"${row.recommendation}"`,
                    row.quantity,
                    row.photos.length,
                    row.latitude,
                    row.longitude
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'inspection_report.csv', 'text/csv');
        }

        function exportCostCSV() {
            if (costEstimationData.length === 0) {
                alert('No cost estimation data to export');
                return;
            }
            
            const headers = ['BOQ Ref', 'Description', 'Unit', 'NR', 'Length', 'Width', 'Height', 'Total Qty', 'Rate', 'Amount', 'Remarks'];
            const csvContent = [
                headers.join(','),
                ...costEstimationData.map(row => [
                    `"${row.ref}"`,
                    `"${row.description}"`,
                    `"${row.unit}"`,
                    row.nr,
                    row.length,
                    row.width,
                    row.height,
                    row.totalQty,
                    row.rate,
                    row.amount,
                    `"${row.remarks}"`
                ].join(','))
            ].join('\n');
            
            downloadFile(csvContent, 'cost_estimation.csv', 'text/csv');
        }

        function exportInspectionKML() {
            if (inspectionData.length === 0) {
                alert('No inspection data to export');
                return;
            }
            
            const placemarks = inspectionData.map(row => `
                <Placemark>
                    <name>${row.asset}</name>
                    <description>Status: ${row.status}\nRecommendation: ${row.recommendation}\nQuantity: ${row.quantity}</description>
                    <Point>
                        <coordinates>${row.longitude},${row.latitude},0</coordinates>
                    </Point>
                </Placemark>
            `).join('');
            
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
                <kml xmlns="http://www.opengis.net/kml/2.2">
                    <Document>
                        <name>Inspection Report</name>
                        ${placemarks}
                    </Document>
                </kml>`;
            
            downloadFile(kmlContent, 'inspection_locations.kml', 'application/vnd.google-earth.kml+xml');
        }

        function downloadBOQTemplate() {
            const headers = 'BOQ Ref,Description,Unit,NR,Length (m),Width (m),Height (m),Total Qty,Rate,Amount,Remarks';
            downloadFile(headers, 'boq_template.csv', 'text/csv');
        }

        function importBOQCSV(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            Papa.parse(file, {
                header: true,
                skipEmptyLines: true,
                complete: function(results) {
                    results.data.forEach(row => {
                        const boqRow = {
                            id: Date.now() + Math.random(),
                            ref: row['BOQ Ref'] || '',
                            description: row['Description'] || '',
                            unit: row['Unit'] || '',
                            nr: row['NR'] || '',
                            length: row['Length (m)'] || '',
                            width: row['Width (m)'] || '',
                            height: row['Height (m)'] || '',
                            totalQty: row['Total Qty'] || '',
                            rate: row['Rate'] || '',
                            amount: row['Amount'] || '',
                            remarks: row['Remarks'] || ''
                        };
                        costEstimationData.push(boqRow);
                    });
                    updateCostEstimationTable();
                    alert(`${results.data.length} BOQ items imported successfully!`);
                },
                error: function(error) {
                    alert('Error parsing CSV file: ' + error.message);
                }
            });
        }

        function downloadFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = fileName;
            a.click();
            URL.revokeObjectURL(url);
        }

        // Print Functions
        function printReport() {
            window.print();
        }

        function printInspectionReport() {
            const printWindow = window.open('', '_blank');
            const inspectionTable = document.getElementById('inspection-table').outerHTML;
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Inspection Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                        </style>
                    </head>
                    <body>
                        <h1>Inspection Report</h1>
                        ${inspectionTable}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        function printCostReport() {
            const printWindow = window.open('', '_blank');
            const costTable = document.getElementById('cost-table').outerHTML;
            printWindow.document.write(`
                <html>
                    <head>
                        <title>Cost Estimation Report</title>
                        <style>
                            body { font-family: Arial, sans-serif; }
                            table { width: 100%; border-collapse: collapse; }
                            th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
                            th { background-color: #f5f5f5; }
                        </style>
                    </head>
                    <body>
                        <h1>Cost Estimation Report</h1>
                        ${costTable}
                    </body>
                </html>
            `);
            printWindow.document.close();
            printWindow.print();
        }

        // Utility Functions
        function hideModal(modalId) {
            document.getElementById(modalId).classList.remove('active');
        }

        function showImagePreview(src) {
            const modal = document.createElement('div');
            modal.className = 'modal active';
            modal.style.zIndex = '3000';
            modal.innerHTML = `
                <div class="modal-content" style="max-width: 90%; max-height: 90%; padding: 0;">
                    <button class="modal-close" onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 10px; right: 15px; z-index: 1;">&times;</button>
                    <img src="${src}" style="width: 100%; height: auto; border-radius: 12px;">
                </div>
            `;
            document.body.appendChild(modal);
        }

        function centerMapOnUser() {
            getCurrentLocation();
            if (projectMap) {
                projectMap.setView([currentLocation.lat, currentLocation.lng], 15);
            }
        }

        function fitMapToMarkers() {
            if (projectMap && mapMarkers.length > 0) {
                const group = new L.featureGroup(mapMarkers);
                projectMap.fitBounds(group.getBounds());
            } else {
                alert('No markers to fit to');
            }
        }

        function clearMapMarkers() {
            if (projectMap) {
                mapMarkers.forEach(marker => projectMap.removeLayer(marker));
                mapMarkers = [];
            }
        }

        function importMapData(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    if (file.name.toLowerCase().endsWith('.csv')) {
                        Papa.parse(e.target.result, {
                            header: true,
                            skipEmptyLines: true,
                            complete: function(results) {
                                results.data.forEach(row => {
                                    const lat = parseFloat(row.latitude || row.Latitude || row.lat);
                                    const lng = parseFloat(row.longitude || row.Longitude || row.lng);
                                    const name = row.name || row.Name || row.asset || 'Marker';
                                    
                                    if (!isNaN(lat) && !isNaN(lng) && projectMap) {
                                        const marker = L.marker([lat, lng])
                                            .addTo(projectMap)
                                            .bindPopup(name);
                                        mapMarkers.push(marker);
                                    }
                                });
                                fitMapToMarkers();
                                alert(`${results.data.length} markers imported from CSV`);
                            }
                        });
                    } else if (file.name.toLowerCase().endsWith('.kml')) {
                        // Basic KML parsing (simplified)
                        const parser = new DOMParser();
                        const kmlDoc = parser.parseFromString(e.target.result, 'text/xml');
                        const placemarks = kmlDoc.querySelectorAll('Placemark');
                        
                        placemarks.forEach(placemark => {
                            const name = placemark.querySelector('name')?.textContent || 'Marker';
                            const coordinates = placemark.querySelector('coordinates')?.textContent;
                            
                            if (coordinates) {
                                const coords = coordinates.trim().split(',');
                                const lng = parseFloat(coords[0]);
                                const lat = parseFloat(coords[1]);
                                
                                if (!isNaN(lat) && !isNaN(lng) && projectMap) {
                                    const marker = L.marker([lat, lng])
                                        .addTo(projectMap)
                                        .bindPopup(name);
                                    mapMarkers.push(marker);
                                }
                            }
                        });
                        
                        fitMapToMarkers();
                        alert(`${placemarks.length} markers imported from KML`);
                    }
                } catch (error) {
                    alert('Error importing file: ' + error.message);
                }
            };
            reader.readAsText(file);
        }

        // AI Defect Analysis (placeholder)
        function analyzeDefects(event) {
            const files = Array.from(event.target.files);
            const resultsContainer = document.getElementById('ai-results-container');
            const resultsDiv = document.getElementById('ai-results');
            
            resultsContainer.innerHTML = '';
            resultsDiv.style.display = 'block';
            
            files.forEach((file, index) => {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const resultDiv = document.createElement('div');
                    resultDiv.className = 'card';
                    resultDiv.innerHTML = `
                        <h4>Analysis Result ${index + 1}</h4>
                        <img src="${e.target.result}" style="max-width: 200px; border-radius: 8px;">
                        <div style="margin-top: 10px;">
                            <p><strong>Detected Issues:</strong> Crack detection (simulated)</p>
                            <p><strong>Severity:</strong> Medium</p>
                            <p><strong>Recommendation:</strong> Monitor and schedule maintenance</p>
                        </div>
                    `;
                    resultsContainer.appendChild(resultDiv);
                };
                reader.readAsDataURL(file);
            });
        }

        // Placeholder functions for other features
        function showProfile() { alert('Profile page would open here'); }
        function showSettings() { alert('Settings page would open here'); }
        function logout() { 
            if (confirm('Are you sure you want to logout?')) {
                location.reload();
            }
        }
    </script>
</body>
</html>
