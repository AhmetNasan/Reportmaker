<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script defer src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script defer src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff; --background-color: #f0f4f8;
            --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(200, 210, 220, 0.5);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1); --text-color: #2c3e50; --border-radius: 12px;
        }

        /* Base & Bilingual Support */
        html[dir="rtl"] { font-family: 'Tahoma', sans-serif; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); margin: 0; color: var(--text-color); transition: background-color 0.3s; }
        
        /* Page Visibility */
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Layouts */
        .main-container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .centered-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }

        /* Glass Card Style */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); margin-bottom: 20px;
        }
        html[dir="rtl"] .glass-card { text-align: right; }

        /* Forms & Buttons */
        .form-card { max-width: 480px; width: 100%; }
        .form-card h1, .form-card p { text-align: center; }
        html[dir="rtl"] .form-card h1, html[dir="rtl"] .form-card p { text-align: center; }
        
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;
        }
        
        button {
            padding: 10px 20px; border-radius: 8px; border: none; background-color: var(--primary-color);
            color: white; font-size: 16px; cursor: pointer; transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        .btn-secondary { background-color: #6c757d; }
        .btn-secondary:hover { background-color: #5a6268; }
        .btn-danger { background-color: #dc3545; }
        .btn-danger:hover { background-color: #c82333; }
        .btn-success { background-color: #28a745; }
        .btn-success:hover { background-color: #218838; }

        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; }
        .header-actions { display: flex; gap: 10px; align-items: center; }
        .notification-bell { position: relative; cursor: pointer; }
        .notification-count { position: absolute; top: -5px; right: -8px; background: red; color: white; border-radius: 50%; width: 18px; height: 18px; font-size: 12px; display: flex; justify-content: center; align-items: center; }
        
        /* Contracts Page */
        .contracts-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(400px, 1fr)); gap: 20px; }
        .contract-item { display: flex; justify-content: space-between; align-items: center; padding: 15px; border-bottom: 1px solid #eee; }
        .contract-item:hover { background-color: #f8f9fa; }
        .contract-actions button { margin-inline-start: 8px; }

        /* Admin Panel */
        .admin-grid { display: grid; grid-template-columns: 1fr 2fr; gap: 20px; }
        .user-request-item { display: flex; justify-content: space-between; align-items: center; }

        /* Footer */
        .footer { text-align: center; margin-top: 30px; padding: 20px; }
        html[dir="rtl"] .footer { text-align: center; }

    </style>
</head>
<body>

    <div id="login-page" class="page centered-container">
        <div class="form-card glass-card">
            <h1 data-translate="welcome_title">Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è</h1>
            <p data-translate="welcome_subtitle">Smart tools for managing maps, data, inspections, and reports for engineers and managers.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_in">Sign In</button>
                <p class="error-message" id="login-error-message"></p>
                <a href="#" class="toggle-link" onclick="window.showPage('signup-page')" data-translate="need_account">Need an account? Sign Up</a>
            </form>
        </div>
    </div>

    <div id="signup-page" class="page centered-container">
        <div class="form-card glass-card">
            <h1 data-translate="create_account">Create Your Account</h1>
            <form id="signup-form">
                <input type="text" id="signup-name" placeholder="Full Name" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_up">Sign Up</button>
                <p id="signup-message" class="error-message"></p>
                <a href="#" class="toggle-link" onclick="window.showPage('login-page')" data-translate="have_account">Already have an account? Sign In</a>
            </form>
        </div>
    </div>
    
    <div id="pending-approval-page" class="page centered-container">
        <div class="form-card glass-card">
            <h1 data-translate="pending_title">Request Received</h1>
            <p data-translate="pending_message">Your access request has been sent to the administrator for approval. You will be notified via email once your account is activated.</p>
            <button onclick="window.signOutUser()" data-translate="sign_out">Sign Out</button>
        </div>
    </div>

    <div id="app-container" class="page main-container">
        <div class="header glass-card">
            <h1 id="app-main-title">Project Dashboard</h1>
            <div class="header-actions">
                <div id="notification-bell-container" class="notification-bell" style="display:none;" onclick="window.showPage('admin-page')">
                    <i class="fas fa-bell fa-lg"></i>
                    <span id="notification-count" class="notification-count" style="display:none;">0</span>
                </div>
                <select id="language-switcher" onchange="window.switchLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
                <button onclick="window.showPage('contracts-page')" data-translate="contracts_dashboard">Contracts</button>
                <button onclick="window.showPage('admin-page')" data-translate="admin_panel" id="admin-panel-button" style="display:none;">Admin Panel</button>
                <button class="btn-danger" onclick="window.signOutUser()" data-translate="sign_out">Sign Out</button>
            </div>
        </div>
        
        <div id="app-content"></div>
    </div>
    
    <div id="contracts-page-content" class="app-page-content" style="display: none;">
        <div class="contracts-grid">
            <div class="glass-card">
                <h2 data-translate="add_contract">Add New Contract</h2>
                <form id="add-contract-form">
                    <label data-translate="title">Title:</label><input type="text" id="contract-title" required>
                    <label data-translate="subtitles">Subtitles:</label><input type="text" id="contract-subtitles">
                    <label data-translate="contract_number">Contract Number:</label><input type="text" id="contract-number">
                    <label data-translate="start_date">Start Date:</label><input type="date" id="contract-start-date">
                    <label data-translate="end_date">End Date:</label><input type="date" id="contract-end-date">
                    <label data-translate="project_value">Project Value:</label><input type="number" id="project-value">
                    <label data-translate="company_logo">Company Logo:</label><input type="file" id="company-logo" accept="image/*">
                    <label data-translate="client_logo">Client Logo:</label><input type="file" id="client-logo" accept="image/*">
                    
                    <h4>BOQ Upload</h4>
                    <p data-translate="boq_note">Note: This BOQ will be used in the Cost Estimation page.</p>
                    <div style="display:flex; gap: 10px;">
                        <input type="file" id="boq-file-input" accept=".csv" required style="width: 100%;">
                        <button type="button" class="btn-secondary" onclick="window.downloadBoqTemplate()" data-translate="download_template">Template</button>
                    </div>
                    <button type="submit" data-translate="save_contract" style="margin-top: 20px;">Save Contract</button>
                </form>
            </div>
            <div class="glass-card">
                <h2 data-translate="saved_contracts">Saved Contracts</h2>
                <div id="contracts-list"><p data-translate="loading_contracts">Loading contracts...</p></div>
            </div>
        </div>
    </div>

    <div id="admin-page-content" class="app-page-content" style="display: none;">
        <div class="glass-card">
            <h2 data-translate="admin_panel">Admin Panel</h2>
            <div class="admin-grid">
                <div>
                    <h3 data-translate="user_requests">New User Requests</h3>
                    <div id="pending-requests-list"><p>Loading...</p></div>
                </div>
                <div>
                    <h3 data-translate="api_keys">API Key Manager</h3>
                    <p>Feature coming soon.</p>
                    <h3 data-translate="ai_prompt">Editable AI Prompt</h3>
                    <p>Feature coming soon.</p>
                </div>
            </div>
        </div>
    </div>
    
    <div class="footer">
        <p>Developed by Eng. Ahmet Nasan</p>
        <p>Civil Engineer & Software Developer</p>
        <em>‚ÄúBlending engineering precision with modern tech.‚Äù</em>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // --- Supabase Client Setup ---
        const supabaseUrl = 'https://cykjjrrexaqmsqwrgnzp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5a2pqcnJleGFxbXNxd3JnbnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MjUyMDksImV4cCI6MjA2NzIwMTIwOX0.Fx6f23TWCQQMCIkc5hcx8LqHyskVMm6WAhJl1UFZpMA';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- GLOBAL STATE & CONSTANTS ---
        const ADMIN_EMAIL = "ahmetnasan1993@gmail.com";
        let currentUser;

        // --- BILINGUAL & RTL DICTIONARY ---
        const translations = {
            en: {
                // Add all your keys here
                welcome_title: "Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è",
                sign_in: "Sign In",
                need_account: "Need an account? Sign Up",
                create_account: "Create Your Account",
                sign_up: "Sign Up",
                have_account: "Already have an account? Sign In",
                pending_title: "Request Received",
                pending_message: "Your access request has been sent to the administrator for approval. You will be notified via email once your account is activated.",
                sign_out: "Sign Out",
                contracts_dashboard: "Contracts",
                admin_panel: "Admin Panel",
                add_contract: "Add New Contract",
                title: "Title",
                subtitles: "Subtitles",
                contract_number: "Contract Number",
                start_date: "Start Date",
                end_date: "End Date",
                project_value: "Project Value",
                company_logo: "Company Logo",
                client_logo: "Client Logo",
                boq_note: "Note: This BOQ will be used in the Cost Estimation page.",
                download_template: "Template",
                save_contract: "Save Contract",
                saved_contracts: "Saved Contracts",
                loading_contracts: "Loading contracts...",
                user_requests: "New User Requests",
                api_keys: "API Key Manager",
                ai_prompt: "Editable AI Prompt"
            },
            ar: {
                // Add all your keys here
                welcome_title: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ ŸÅŸä ŸÖŸÜÿµÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸáŸÜÿØÿ≥Ÿäÿ© üë∑‚Äç‚ôÇÔ∏è",
                sign_in: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                need_account: "ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ≠ÿ≥ÿßÿ®ÿü ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                create_account: "ÿ£ŸÜÿ¥ÿ¶ ÿ≠ÿ≥ÿßÿ®ŸÉ",
                sign_up: "ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                have_account: "ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                pending_title: "ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®",
                pending_message: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸäŸá. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπŸÑÿßŸÖŸÉ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ± ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ®ŸÖÿ¨ÿ±ÿØ ÿ™ŸÅÿπŸäŸÑ ÿ≠ÿ≥ÿßÿ®ŸÉ.",
                sign_out: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                contracts_dashboard: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿπŸÇŸàÿØ",
                admin_panel: "ŸÑŸàÿ≠ÿ© ÿßŸÑÿ•ÿØÿßÿ±ÿ©",
                add_contract: "ÿ•ÿ∂ÿßŸÅÿ© ÿπŸÇÿØ ÿ¨ÿØŸäÿØ",
                title: "ÿßŸÑÿπŸÜŸàÿßŸÜ",
                subtitles: "ÿπŸÜÿßŸàŸäŸÜ ŸÅÿ±ÿπŸäÿ©",
                contract_number: "ÿ±ŸÇŸÖ ÿßŸÑÿπŸÇÿØ",
                start_date: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿ®ÿØÿ°",
                end_date: "ÿ™ÿßÿ±ŸäÿÆ ÿßŸÑÿßŸÜÿ™Ÿáÿßÿ°",
                project_value: "ŸÇŸäŸÖÿ© ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ",
                company_logo: "ÿ¥ÿπÿßÿ± ÿßŸÑÿ¥ÿ±ŸÉÿ©",
                client_logo: "ÿ¥ÿπÿßÿ± ÿßŸÑÿπŸÖŸäŸÑ",
                boq_note: "ŸÖŸÑÿßÿ≠ÿ∏ÿ©: ÿ≥Ÿäÿ™ŸÖ ÿßÿ≥ÿ™ÿÆÿØÿßŸÖ ÿ¨ÿØŸàŸÑ ÿßŸÑŸÉŸÖŸäÿßÿ™ Ÿáÿ∞ÿß ŸÅŸä ÿµŸÅÿ≠ÿ© ÿ™ŸÇÿØŸäÿ± ÿßŸÑÿ™ŸÉŸÑŸÅÿ©.",
                download_template: "ŸÜŸÖŸàÿ∞ÿ¨",
                save_contract: "ÿ≠ŸÅÿ∏ ÿßŸÑÿπŸÇÿØ",
                saved_contracts: "ÿßŸÑÿπŸÇŸàÿØ ÿßŸÑŸÖÿ≠ŸÅŸàÿ∏ÿ©",
                loading_contracts: "ÿ¨ÿßÿ±Ÿä ÿ™ÿ≠ŸÖŸäŸÑ ÿßŸÑÿπŸÇŸàÿØ...",
                user_requests: "ÿ∑ŸÑÿ®ÿßÿ™ ÿßŸÑŸÖÿ≥ÿ™ÿÆÿØŸÖŸäŸÜ ÿßŸÑÿ¨ÿØÿØ",
                api_keys: "ÿ•ÿØÿßÿ±ÿ© ŸÖŸÅÿßÿ™Ÿäÿ≠ API",
                ai_prompt: "ÿ™ÿπÿØŸäŸÑ ŸÖŸàÿ¨Ÿá ÿßŸÑÿ∞ŸÉÿßÿ° ÿßŸÑÿßÿµÿ∑ŸÜÿßÿπŸä"
            }
        };

        // --- GLOBAL FUNCTIONS ATTACHED TO WINDOW ---
        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId);
            if(page) page.classList.add('active');

            if (pageId.endsWith('-page-content')) {
                document.querySelectorAll('.app-page-content').forEach(p => p.style.display = 'none');
                document.getElementById(pageId).style.display = 'block';
                document.getElementById('app-container').classList.add('active');
            }
        };
        
        window.signOutUser = async () => {
            await supabase.auth.signOut();
            // The onAuthStateChange listener will handle the redirect
        };
        
        window.switchLanguage = (lang) => {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.innerText = translations[lang][key] || el.innerText;
            });
        };

        window.downloadBoqTemplate = () => {
            const csvContent = "data:text/csv;charset=utf-8," 
                + "BOQ Ref.,Asset,Description,Unit,Rate\n";
            const encodedUri = encodeURI(csvContent);
            const link = document.createElement("a");
            link.setAttribute("href", encodedUri);
            link.setAttribute("download", "BOQ_Template.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        };

        // --- AUTH STATE LOGIC ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                currentUser = null;
                showPage('login-page');
            } else if (session) {
                currentUser = session.user;
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('status, is_admin')
                    .eq('id', currentUser.id)
                    .single();

                if(error || !profile) {
                    // This case can happen for a brand new user
                     showPage('pending-approval-page');
                     return;
                }

                if (profile.is_admin) {
                    document.getElementById('admin-panel-button').style.display = 'block';
                    document.getElementById('notification-bell-container').style.display = 'block';
                    loadPendingRequests();
                } else {
                    document.getElementById('admin-panel-button').style.display = 'none';
                    document.getElementById('notification-bell-container').style.display = 'none';
                }

                if (profile.status === 'approved') {
                    showPage('contracts-page-content');
                    loadContracts();
                } else {
                    showPage('pending-approval-page');
                }
            }
        });

        // --- AUTH FORM HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('login-error-message').innerText = error.message;
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const messageEl = document.getElementById('signup-message');

            const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: name } } });
            
            if (error) {
                messageEl.innerText = error.message;
                messageEl.style.color = 'red';
            } else {
                messageEl.innerText = "Success! Please check your email to verify your account. After verification, an admin must approve your access.";
                messageEl.style.color = 'green';
            }
        });

        // --- ADMIN PANEL LOGIC ---
        async function loadPendingRequests() {
            const listContainer = document.getElementById('pending-requests-list');
            const notifCountEl = document.getElementById('notification-count');

            const { data: requests, error } = await supabase
                .from('profiles')
                .select('id, full_name, email')
                .eq('status', 'pending');

            if (error) return listContainer.innerHTML = `<p>Error loading requests.</p>`;
            
            if (requests.length > 0) {
                notifCountEl.innerText = requests.length;
                notifCountEl.style.display = 'flex';
            } else {
                notifCountEl.style.display = 'none';
            }

            if (requests.length === 0) return listContainer.innerHTML = '<p>No pending requests.</p>';

            listContainer.innerHTML = '';
            requests.forEach(req => {
                const item = document.createElement('div');
                item.className = 'user-request-item';
                item.innerHTML = `<span>${req.full_name} (${req.email})</span>
                                  <div>
                                    <button class="btn-success" onclick="window.handleRequest('${req.id}', 'approved')">Approve</button>
                                    <button class="btn-danger" onclick="window.handleRequest('${req.id}', 'rejected')">Reject</button>
                                  </div>`;
                listContainer.appendChild(item);
            });
        }
        
        window.handleRequest = async (profileId, newStatus) => {
            const { error } = await supabase
                .from('profiles')
                .update({ status: newStatus })
                .eq('id', profileId);
            
            if(error) {
                alert(`Error updating status: ${error.message}`);
            } else {
                alert(`User has been ${newStatus}.`);
                loadPendingRequests(); // Refresh list
            }
        };

        // --- CONTRACTS PAGE LOGIC ---
        async function loadContracts() {
            // Placeholder for loading contracts
        }

        // Initially check auth state to show the correct page on load
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                showPage('login-page');
            }
            // onAuthStateChange will handle the rest
        });

    </script>
</body>
</html>
