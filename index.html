
<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Platform - Enhanced Estimation & Inspection System</title>
    
    <!-- Inline CSS -->
    <style>
        :root {
            --primary-color: #667eea;
            --primary-color-rgb: 102, 126, 234;
            --secondary-color: #764ba2;
            --success-color: #48bb78;
            --warning-color: #ed8936;
            --danger-color: #f56565;
            --info-color: #4299e1;
            --dark-bg: #1a202c;
            --darker-bg: #171923;
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --text-light: #e2e8f0;
            --text-dark: #2d3748;
            --transition: all 0.3s ease;
            --border-radius: 12px;
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, var(--primary-color) 0%, var(--secondary-color) 100%);
            min-height: 100vh;
            color: var(--text-light);
            overflow-x: hidden;
        }

        .container {
            display: flex;
            min-height: 100vh;
        }

        .sidebar {
            width: 280px;
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border-right: 1px solid var(--glass-border);
            padding: 20px;
            position: sticky;
            top: 0;
            height: 100vh;
            overflow-y: auto;
        }

        .logo {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 30px;
            padding: 15px;
            background: var(--glass-bg);
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
        }

        .logo i {
            font-size: 28px;
            color: #ffdde1;
        }

        .logo h1 {
            font-size: 18px;
            font-weight: 700;
            color: #ffdde1;
        }

        .nav-section {
            margin-bottom: 25px;
        }

        .nav-section h3 {
            font-size: 14px;
            font-weight: 600;
            color: rgba(255, 255, 255, 0.7);
            margin-bottom: 10px;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .nav-item {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 16px;
            margin-bottom: 8px;
            border-radius: 10px;
            cursor: pointer;
            transition: var(--transition);
            color: var(--text-light);
            font-weight: 500;
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: linear-gradient(135deg, rgba(255, 255, 255, 0.2), rgba(255, 255, 255, 0.1));
            border: 1px solid rgba(255, 255, 255, 0.2);
            color: #ffdde1;
        }

        .nav-item i {
            font-size: 18px;
            width: 20px;
        }

        .main-content {
            flex: 1;
            padding: 30px;
            overflow-y: auto;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        .card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: var(--shadow);
        }

        .card-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .card-title {
            font-size: 24px;
            font-weight: 700;
            color: #ffdde1;
            margin: 0;
        }

        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 600;
            font-size: 14px;
            transition: var(--transition);
            display: inline-flex;
            align-items: center;
            gap: 8px;
            text-decoration: none;
            color: white;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), #5a67d8);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--success-color), #38a169);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--warning-color), #dd6b20);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--danger-color), #e53e3e);
        }

        .btn-info {
            background: linear-gradient(135deg, var(--info-color), #3182ce);
        }

        .form-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-label {
            font-weight: 600;
            color: #ffdde1;
            font-size: 14px;
        }

        .form-input,
        .form-select {
            padding: 12px 16px;
            border: 1px solid var(--glass-border);
            border-radius: 8px;
            background: rgba(255, 255, 255, 0.1);
            color: var(--text-light);
            font-size: 14px;
            transition: var(--transition);
        }

        .form-input:focus,
        .form-select:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .table-container {
            overflow-x: auto;
            border-radius: var(--border-radius);
            border: 1px solid var(--glass-border);
        }

        .table {
            width: 100%;
            border-collapse: collapse;
            background: rgba(255, 255, 255, 0.05);
        }

        .table th,
        .table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid var(--glass-border);
        }

        .table th {
            background: rgba(255, 255, 255, 0.1);
            font-weight: 600;
            color: #ffdde1;
        }

        .table tbody tr:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .d-flex {
            display: flex;
        }

        .gap-2 {
            gap: 10px;
        }

        .mb-3 {
            margin-bottom: 15px;
        }

        /* Estimation Module Styles */
        .estimation-tabs {
            display: flex;
            gap: 5px;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--glass-border);
        }

        .estimation-tab-button {
            padding: 12px 20px;
            border: none;
            background: none;
            cursor: pointer;
            border-bottom: 3px solid transparent;
            color: var(--text-light);
            font-weight: 500;
            transition: var(--transition);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .estimation-tab-button:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .estimation-tab-button.active {
            border-bottom-color: var(--primary-color);
            color: #ffdde1;
        }

        .estimation-tab-content {
            display: none;
        }

        .estimation-tab-content.active {
            display: block;
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 2000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            justify-content: center;
            align-items: center;
        }

        .modal.active {
            display: flex;
        }

        .modal-content {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 30px;
            max-width: 500px;
            width: 90%;
            max-height: 80vh;
            overflow-y: auto;
            position: relative;
        }

        .modal-close {
            position: absolute;
            top: 15px;
            right: 20px;
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-light);
            cursor: pointer;
        }

        .file-upload {
            border: 2px dashed var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
            cursor: pointer;
            transition: var(--transition);
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background: rgba(102, 126, 234, 0.1);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 20px;
            text-align: center;
        }

        .stat-card i {
            font-size: 30px;
            margin-bottom: 10px;
            color: var(--primary-color);
        }

        .stat-card h3 {
            font-size: 24px;
            margin-bottom: 5px;
            color: #ffdde1;
        }

        .stat-card p {
            color: rgba(255, 255, 255, 0.7);
            font-size: 14px;
        }

        .login-container {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .login-card {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius);
            padding: 40px;
            width: 100%;
            max-width: 400px;
            text-align: center;
            box-shadow: var(--shadow);
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 100%;
                height: auto;
                position: relative;
            }
            
            .container {
                flex-direction: column;
            }
            
            .main-content {
                padding: 20px;
            }
            
            .form-grid {
                grid-template-columns: 1fr;
            }
        }

        /* Print Styles */
        @media print {
            body * {
                visibility: hidden;
            }
            
            .print-area,
            .print-area * {
                visibility: visible;
            }
            
            .print-area {
                position: absolute;
                left: 0;
                top: 0;
            }
        }

        /* Animation Utilities */
        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
    </style>

    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <!-- Leaflet CSS for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.7.1/dist/leaflet.css">
</head>
<body>
    <!-- Login Page -->
    <div id="login-page" class="login-container">
        <div class="login-card fade-in">
            <div class="logo" style="justify-content: center; margin-bottom: 30px;">
                <i class="fas fa-hard-hat"></i>
                <h1>Engineering Platform</h1>
            </div>
            <h2 style="margin-bottom: 30px; color: #ffdde1;">Welcome Back</h2>
            <form id="login-form">
                <div class="form-group" style="margin-bottom: 20px;">
                    <input type="email" id="email" class="form-input" placeholder="Email Address" required>
                </div>
                <div class="form-group" style="margin-bottom: 20px;">
                    <input type="password" id="password" class="form-input" placeholder="Password" required>
                </div>
                <button type="submit" class="btn btn-primary" style="width: 100%; margin-bottom: 15px;">
                    <i class="fas fa-sign-in-alt"></i> Sign In
                </button>
            </form>
            <p style="color: rgba(255, 255, 255, 0.7); font-size: 14px;">
                Don't have an account? <a href="#" onclick="showSignUp()" style="color: var(--primary-color);">Sign Up</a>
            </p>
        </div>
    </div>

    <!-- Main Application -->
    <div id="main-app" class="container" style="display: none;">
        <!-- Sidebar -->
        <div class="sidebar slide-in">
            <div class="logo">
                <i class="fas fa-hard-hat"></i>
                <h1>Engineering Platform</h1>
            </div>

            <div class="nav-section">
                <h3>Main</h3>
                <div class="nav-item active" onclick="showPage('dashboard')">
                    <i class="fas fa-tachometer-alt"></i>
                    <span>Dashboard</span>
                </div>
                <div class="nav-item" onclick="showPage('notifications')">
                    <i class="fas fa-bell"></i>
                    <span>Notifications</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>Contract Management</h3>
                <div class="nav-item" onclick="showPage('contracts')">
                    <i class="fas fa-file-contract"></i>
                    <span>Contracts</span>
                </div>
                <div class="nav-item" onclick="showPage('boq')">
                    <i class="fas fa-calculator"></i>
                    <span>BOQ & Details</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>Engineering Tools</h3>
                <div class="nav-item" onclick="showPage('estimation-inspection')">
                    <i class="fas fa-clipboard-check"></i>
                    <span>Enhanced Estimation & Inspection</span>
                </div>
                <div class="nav-item" onclick="showPage('gis-mapping')">
                    <i class="fas fa-map"></i>
                    <span>GIS Mapping</span>
                </div>
                <div class="nav-item" onclick="showPage('cad-editor')">
                    <i class="fas fa-drafting-compass"></i>
                    <span>CAD Editor</span>
                </div>
                <div class="nav-item" onclick="showPage('ai-defect')">
                    <i class="fas fa-robot"></i>
                    <span>AI Defect Detection</span>
                </div>
            </div>

            <div class="nav-section">
                <h3>System</h3>
                <div class="nav-item" onclick="showPage('settings')">
                    <i class="fas fa-cog"></i>
                    <span>Settings</span>
                </div>
                <div class="nav-item" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    <span>Logout</span>
                </div>
            </div>
        </div>

        <!-- Main Content -->
        <div class="main-content">
            <!-- Dashboard Page -->
            <div id="dashboard-page" class="page active fade-in">
                <div class="card">
                    <div class="card-header">
                        <h1 class="card-title">Engineering Platform Dashboard</h1>
                        <button class="btn btn-primary">
                            <i class="fas fa-plus"></i> New Project
                        </button>
                    </div>
                </div>

                <div class="stats-grid">
                    <div class="stat-card">
                        <i class="fas fa-project-diagram"></i>
                        <h3>24</h3>
                        <p>Active Projects</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-file-contract"></i>
                        <h3>18</h3>
                        <p>Contracts</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-clipboard-check"></i>
                        <h3>156</h3>
                        <p>Inspections</p>
                    </div>
                    <div class="stat-card">
                        <i class="fas fa-dollar-sign"></i>
                        <h3>2.4M</h3>
                        <p>QAR Total Value</p>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <h3>Recent Activity</h3>
                    </div>
                    <div class="table-container">
                        <table class="table">
                            <thead>
                                <tr>
                                    <th>Project</th>
                                    <th>Status</th>
                                    <th>Last Updated</th>
                                    <th>Value</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td>Al Rayyan Road Extension</td>
                                    <td><span class="btn btn-success" style="padding: 4px 8px; font-size: 12px;">Active</span></td>
                                    <td>2024-01-15</td>
                                    <td>QAR 850,000</td>
                                </tr>
                                <tr>
                                    <td>West Bay Infrastructure</td>
                                    <td><span class="btn btn-warning" style="padding: 4px 8px; font-size: 12px;">Pending</span></td>
                                    <td>2024-01-14</td>
                                    <td>QAR 1,200,000</td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Enhanced Estimation & Inspection Module -->
            <div id="estimation-inspection-page" class="page" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <h1 class="card-title">Advanced Estimation & Inspection System</h1>
                        <div class="d-flex gap-2">
                            <button class="btn btn-primary" onclick="exportEstimationProject()">
                                <i class="fas fa-save"></i> Export Project
                            </button>
                            <button class="btn btn-success" onclick="importEstimationProject()">
                                <i class="fas fa-upload"></i> Import Project
                            </button>
                            <button class="btn btn-info" onclick="openAdvancedPhotoManager()">
                                <i class="fas fa-images"></i> Photo Manager
                            </button>
                            <button class="btn btn-warning" onclick="openAIAssistant()">
                                <i class="fas fa-robot"></i> AI Assistant
                            </button>
                            <button class="btn btn-success" onclick="generateQRCode()">
                                <i class="fas fa-qrcode"></i> Generate QR
                            </button>
                        </div>
                    </div>
                    
                    <!-- Tab Navigation -->
                    <div class="estimation-tabs">
                        <button class="estimation-tab-button active" onclick="openEstimationTab(event, 'inspection-report-tab')">
                            <i class="fas fa-clipboard-check"></i> Inspection Report
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'cost-estimation-detail-tab')">
                            <i class="fas fa-calculator"></i> Cost Estimation
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'integrated-map-tab')">
                            <i class="fas fa-map"></i> Integrated Map
                        </button>
                        <button class="estimation-tab-button" onclick="openEstimationTab(event, 'saved-projects-tab')">
                            <i class="fas fa-folder"></i> Saved Projects
                        </button>
                    </div>

                    <!-- Inspection Report Tab -->
                    <div id="inspection-report-tab" class="estimation-tab-content active">
                        <div class="card">
                            <div class="card-header">
                                <h3>Asset Data Entry</h3>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">Asset Description</label>
                                    <input type="text" id="estimation-asset" class="form-input" list="asset-options" placeholder="Enter asset description">
                                    <datalist id="asset-options">
                                        <option value="(B) Zonal Inspections"></option>
                                        <option value="(C) Site Clearance"></option>
                                        <option value="(D) Drainage and Service Ducts"></option>
                                        <option value="(E) Earthworks"></option>
                                        <option value="(F) Sub-Base and Road Base"></option>
                                        <option value="(G) Flexible Surfacing"></option>
                                        <option value="(H) Kerbs & Footways"></option>
                                        <option value="(I) Road Markings"></option>
                                        <option value="(J) Directional Signs"></option>
                                        <option value="(K) Works by Statutory Undertakers"></option>
                                        <option value="(L) Street Lighting Works"></option>
                                        <option value="(M) Structures"></option>
                                        <option value="(N) Traffic Management"></option>
                                        <option value="(O) VRS"></option>
                                        <option value="(P) Supply of Materials"></option>
                                        <option value="(Q) Traffic Signs"></option>
                                        <option value="(R) Time and Material Rates"></option>
                                        <option value="(S) Plant and Equipment"></option>
                                        <option value="(T) Street Furniture"></option>
                                    </datalist>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Status</label>
                                    <input type="text" id="estimation-status" class="form-input" placeholder="Status (e.g., Good, Damaged)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Recommendation</label>
                                    <input type="text" id="estimation-recommendation" class="form-input" placeholder="Recommendation (e.g., Repair, Replace)">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Photo Upload</label>
                                    <div id="estimation-drop-zone" class="file-upload">
                                        <i class="fas fa-cloud-upload-alt fa-2x mb-2"></i>
                                        <p>Drag & Drop or Click to Add Photos</p>
                                        <div class="d-flex gap-2" style="justify-content: center; margin-top: 10px;">
                                            <button class="btn btn-info" onclick="document.getElementById('estimation-photo-input').click()">
                                                <i class="fas fa-images"></i> Gallery
                                            </button>
                                            <button class="btn btn-success" onclick="openEstimationCamera()">
                                                <i class="fas fa-camera"></i> Camera
                                            </button>
                                        </div>
                                    </div>
                                    <input type="file" id="estimation-photo-input" accept="image/*" multiple style="display: none;">
                                    <div id="estimation-photo-previews" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 10px;"></div>
                                </div>
                            </div>
                            
                            <!-- GPS Location Section -->
                            <div class="card" style="margin-top: 20px;">
                                <div class="card-header">
                                    <h4>GPS Location</h4>
                                </div>
                                <div id="estimation-map" style="height: 150px; border-radius: 12px; margin-bottom: 15px; background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #666;">
                                    Map will load here
                                </div>
                                <div class="d-flex gap-2 mb-3">
                                    <button id="estimation-gps-auto-btn" class="btn btn-primary active" onclick="switchEstimationLocationMode('auto')">
                                        <i class="fas fa-satellite-dish"></i> Automatic
                                    </button>
                                    <button id="estimation-gps-manual-btn" class="btn" onclick="switchEstimationLocationMode('manual')">
                                        <i class="fas fa-edit"></i> Manual
                                    </button>
                                </div>
                                
                                <div id="estimation-location-auto-panel">
                                    <button class="btn btn-success" onclick="getEstimationLocation()">
                                        <i class="fas fa-map-marker-alt"></i> Get Current GPS
                                    </button>
                                </div>
                                
                                <div id="estimation-location-manual-panel" style="display: none;">
                                    <div class="form-grid" style="grid-template-columns: 1fr 1fr;">
                                        <input type="number" id="estimation-manual-lat" class="form-input" placeholder="Manual Latitude" step="any">
                                        <input type="number" id="estimation-manual-lng" class="form-input" placeholder="Manual Longitude" step="any">
                                    </div>
                                </div>
                                
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 10px;">
                                    <div>
                                        <small><strong>Latitude:</strong> <span id="estimation-lat-display">N/A</span></small><br>
                                        <small><strong>Longitude:</strong> <span id="estimation-lng-display">N/A</span></small>
                                    </div>
                                    <button class="btn btn-warning" onclick="insertEstimationLocationToForm()">
                                        <i class="fas fa-plus"></i> Insert to Form
                                    </button>
                                </div>
                                
                                <div style="margin-top: 15px;">
                                    <button class="btn btn-info" onclick="showEstimationQuantityModal()">
                                        <i class="fas fa-calculator"></i> Calculate Quantity
                                    </button>
                                </div>
                            </div>
                            
                            <button class="btn btn-primary" onclick="addEstimationInspectionRow()" style="margin-top: 20px;">
                                <i class="fas fa-plus"></i> Add Row to Table
                            </button>
                        </div>

                        <!-- Inspection Report Table -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h3>Inspection Report Table</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="exportEstimationInspectionCSV()">
                                        <i class="fas fa-download"></i> Export CSV
                                    </button>
                                    <button class="btn btn-info" onclick="exportEstimationInspectionKML()">
                                        <i class="fas fa-map"></i> Export KML
                                    </button>
                                    <button class="btn btn-warning" onclick="printEstimationInspectionReport()">
                                        <i class="fas fa-print"></i> Print Report
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="estimation-report-table" class="table">
                                    <thead>
                                        <tr>
                                            <th>ID</th>
                                            <th>Asset</th>
                                            <th>Status</th>
                                            <th>Recommendation</th>
                                            <th>Quantity</th>
                                            <th>Photos</th>
                                            <th>Latitude</th>
                                            <th>Longitude</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Cost Estimation Tab -->
                    <div id="cost-estimation-detail-tab" class="estimation-tab-content">
                        <!-- BOQ Entry Form -->
                        <div class="card">
                            <div class="card-header">
                                <h3>BOQ Item Entry</h3>
                            </div>
                            <div class="form-grid">
                                <div class="form-group">
                                    <label class="form-label">BOQ Reference</label>
                                    <div class="d-flex gap-2">
                                        <input type="search" id="estimation-boq-search" class="form-input" placeholder="Search Ref...">
                                        <select id="estimation-boq-ref-select" class="form-select"></select>
                                    </div>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">Description</label>
                                    <input type="text" id="estimation-boq-desc" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Unit</label>
                                    <input type="text" id="estimation-boq-unit" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">NR</label>
                                    <input type="number" id="estimation-boq-nr" class="form-input" placeholder="e.g., 1">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Length (m)</label>
                                    <input type="number" id="estimation-boq-length" class="form-input" placeholder="e.g., 4.00" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Width (m)</label>
                                    <input type="number" id="estimation-boq-width" class="form-input" placeholder="e.g., 2.00" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Height (m)</label>
                                    <input type="number" id="estimation-boq-height" class="form-input" placeholder="e.g., 0.07" step="0.01">
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Total Qty.</label>
                                    <input type="text" id="estimation-boq-total-qty" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Rate</label>
                                    <input type="text" id="estimation-boq-rate" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group">
                                    <label class="form-label">Amount (QR)</label>
                                    <input type="text" id="estimation-boq-amount" class="form-input" readonly>
                                </div>
                                
                                <div class="form-group" style="grid-column: 1 / -1;">
                                    <label class="form-label">Remarks</label>
                                    <input type="text" id="estimation-boq-remarks" class="form-input">
                                </div>
                            </div>
                            
                            <!-- Most Used BOQ -->
                            <div id="estimation-most-used-boq-container" style="margin-top: 15px; padding: 15px; background: var(--glass-bg); border-radius: 8px;">
                                <h4>Most Used BOQ References</h4>
                                <div id="estimation-most-used-boq-list" style="display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px;"></div>
                            </div>
                            
                            <div class="d-flex gap-2" style="margin-top: 15px;">
                                <button class="btn btn-primary" onclick="downloadEstimationBOQTemplate()">
                                    <i class="fas fa-download"></i> Download BOQ Template
                                </button>
                                <button class="btn btn-info" onclick="importEstimationBOQCSV()">
                                    <i class="fas fa-upload"></i> Import BOQ CSV
                                </button>
                                <button class="btn btn-success" onclick="insertEstimationBOQRow()">
                                    <i class="fas fa-plus"></i> Insert Row
                                </button>
                                <button class="btn btn-warning" onclick="showBOQQuantityModal()">
                                    <i class="fas fa-calculator"></i> Calculate Quantity
                                </button>
                            </div>
                        </div>

                        <!-- Cost Estimation Table -->
                        <div class="card" style="margin-top: 20px;">
                            <div class="card-header">
                                <h3>Cost Estimation Table</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-success" onclick="exportEstimationCostCSV()">
                                        <i class="fas fa-download"></i> Export CSV
                                    </button>
                                    <button class="btn btn-warning" onclick="printEstimationCostReport()">
                                        <i class="fas fa-print"></i> Print Report
                                    </button>
                                    <button class="btn btn-info" onclick="exportEstimationPDF()">
                                        <i class="fas fa-file-pdf"></i> Export PDF
                                    </button>
                                </div>
                            </div>
                            <div class="table-container">
                                <table id="estimation-cost-table" class="table">
                                    <thead>
                                        <tr>
                                            <th>BOQ Ref.</th>
                                            <th>Description</th>
                                            <th>Unit</th>
                                            <th>NR</th>
                                            <th>Length (m)</th>
                                            <th>Width (m)</th>
                                            <th>Height (m)</th>
                                            <th>Total Qty.</th>
                                            <th>Rate</th>
                                            <th>Amount</th>
                                            <th>Remarks</th>
                                            <th>Actions</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                    <tfoot>
                                        <tr>
                                            <td colspan="9" style="text-align: right; font-weight: bold;">TOTAL Amount</td>
                                            <td id="estimation-total-amount-cell" style="font-weight: bold;">QAR 0.00</td>
                                            <td colspan="2"></td>
                                        </tr>
                                    </tfoot>
                                </table>
                            </div>
                        </div>
                    </div>

                    <!-- Integrated Map Tab -->
                    <div id="integrated-map-tab" class="estimation-tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Integrated Project Map</h3>
                                <div class="d-flex gap-2">
                                    <button class="btn btn-primary" onclick="centerEstimationMapOnUser()">
                                        <i class="fas fa-map-marker-alt"></i> My Location
                                    </button>
                                    <button class="btn btn-success" onclick="fitEstimationMapToMarkers()">
                                        <i class="fas fa-expand-arrows-alt"></i> Fit All Markers
                                    </button>
                                    <button class="btn btn-info" onclick="downloadEstimationMapCSVTemplate()">
                                        <i class="fas fa-download"></i> CSV Template
                                    </button>
                                    <button class="btn btn-warning" onclick="importEstimationMapData()">
                                        <i class="fas fa-upload"></i> Import KML/CSV
                                    </button>
                                    <button class="btn btn-danger" onclick="clearEstimationMapMarkers()">
                                        <i class="fas fa-trash"></i> Clear Map
                                    </button>
                                </div>
                            </div>
                            <div id="estimation-vehicle-map" style="height: 600px; border-radius: 12px; border: 1px solid var(--glass-border); background: rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; color: #666;">
                                Integrated Project Map
                            </div>
                            <div id="estimation-import-summary" style="margin-top: 10px; font-weight: bold;"></div>
                        </div>
                    </div>

                    <!-- Saved Projects Tab -->
                    <div id="saved-projects-tab" class="estimation-tab-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Saved Projects</h3>
                                <div class="d-flex gap-2">
                                    <input type="text" id="estimation-project-search" class="form-input" placeholder="Search projects..." style="flex: 1;">
                                    <select id="estimation-sort-projects" class="form-select">
                                        <option value="name">Sort by Name</option>
                                        <option value="date-newest">Date (Newest)</option>
                                        <option value="date-oldest">Date (Oldest)</option>
                                    </select>
                                </div>
                            </div>
                            <div id="estimation-projects-list">
                                <p>No saved projects found.</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Other pages placeholders -->
            <div id="notifications-page" class="page">
                <div class="card">
                    <h1 class="card-title">Notifications</h1>
                    <p>Notification system will be implemented here.</p>
                </div>
            </div>

            <div id="contracts-page" class="page">
                <div class="card">
                    <h1 class="card-title">Contract Management</h1>
                    <p>Contract management system will be implemented here.</p>
                </div>
            </div>

            <div id="boq-page" class="page">
                <div class="card">
                    <h1 class="card-title">BOQ & Details</h1>
                    <p>BOQ management system will be implemented here.</p>
                </div>
            </div>

            <div id="gis-mapping-page" class="page">
                <div class="card">
                    <h1 class="card-title">GIS Mapping</h1>
                    <p>GIS mapping tools will be implemented here.</p>
                </div>
            </div>

            <div id="cad-editor-page" class="page">
                <div class="card">
                    <h1 class="card-title">CAD Editor</h1>
                    <p>CAD drawing editor will be implemented here.</p>
                </div>
            </div>

            <div id="ai-defect-page" class="page">
                <div class="card">
                    <h1 class="card-title">AI Defect Detection</h1>
                    <p>AI defect analysis system will be implemented here.</p>
                </div>
            </div>

            <div id="settings-page" class="page">
                <div class="card">
                    <h1 class="card-title">Settings</h1>
                    <p>System settings and configuration will be implemented here.</p>
                </div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <!-- Quantity Modal -->
    <div id="estimation-quantity-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeEstimationQuantityModal()">&times;</button>
            <h2>Advanced Quantity Calculator</h2>
            <div class="form-group">
                <label class="form-label">Length (m)</label>
                <input type="number" id="estimation-modal-length" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Width (m)</label>
                <input type="number" id="estimation-modal-width" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Depth/Height (m)</label>
                <input type="number" id="estimation-modal-depth" class="form-input" step="0.01">
            </div>
            <div class="form-group">
                <label class="form-label">Repetitions (NR)</label>
                <input type="number" id="estimation-modal-repetitions" class="form-input" value="1" step="1">
            </div>
            <div class="form-group">
                <label class="form-label">Shape Type</label>
                <select id="estimation-shape-type" class="form-select" onchange="updateQuantityFormula()">
                    <option value="rectangular">Rectangular</option>
                    <option value="circular">Circular</option>
                    <option value="triangular">Triangular</option>
                    <option value="complex">Complex Shape</option>
                </select>
            </div>
            <div class="form-group">
                <label class="form-label">Live Calculation</label>
                <div id="live-calculation" style="background: rgba(255,255,255,0.1); padding: 10px; border-radius: 8px; font-weight: bold;">
                    Total: 0.00 mÂ³
                </div>
            </div>
            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="setEstimationQuantity()" style="flex: 1;">Set Quantity</button>
                <button class="btn btn-danger" onclick="closeEstimationQuantityModal()" style="flex: 1;">Cancel</button>
            </div>
        </div>
    </div>

    <!-- Advanced Photo Manager Modal -->
    <div id="advanced-photo-manager" class="modal">
        <div class="modal-content" style="max-width: 1000px; max-height: 90vh; overflow-y: auto;">
            <button class="modal-close" onclick="closeAdvancedPhotoManager()">&times;</button>
            <h2>Advanced Photo Manager</h2>
            
            <div class="d-flex gap-2 mb-3">
                <button class="btn btn-primary" onclick="openBulkUpload()">
                    <i class="fas fa-upload"></i> Bulk Upload
                </button>
                <button class="btn btn-success" onclick="enablePanoramicMode()">
                    <i class="fas fa-camera-retro"></i> Panoramic
                </button>
                <button class="btn btn-info" onclick="generatePhotoReport()">
                    <i class="fas fa-file-pdf"></i> Photo Report
                </button>
                <button class="btn btn-warning" onclick="analyzeAllPhotos()">
                    <i class="fas fa-robot"></i> AI Analysis
                </button>
            </div>

            <div class="photo-manager-grid" id="photo-manager-grid" style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px;">
                <!-- Photos will be populated here -->
            </div>

            <div class="photo-metadata-panel" id="photo-metadata-panel" style="margin-top: 20px; display: none;">
                <h4>Photo Metadata</h4>
                <div id="metadata-content"></div>
            </div>
        </div>
    </div>

    <!-- AI Assistant Modal -->
    <div id="ai-assistant-modal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <button class="modal-close" onclick="closeAIAssistant()">&times;</button>
            <h2>AI Engineering Assistant</h2>
            
            <div class="ai-chat-container" style="height: 400px; overflow-y: auto; border: 1px solid var(--glass-border); border-radius: 8px; padding: 15px; margin: 15px 0; background: rgba(255,255,255,0.05);">
                <div id="ai-chat-messages">
                    <div class="ai-message">
                        <strong>AI Assistant:</strong> Hello! I can help you with quantity calculations, BOQ analysis, defect identification, and estimation optimization. What would you like to discuss?
                    </div>
                </div>
            </div>

            <div class="form-group">
                <input type="text" id="ai-chat-input" class="form-input" placeholder="Ask about calculations, materials, standards..." onkeypress="handleAIChat(event)">
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="sendAIMessage()">
                    <i class="fas fa-paper-plane"></i> Send
                </button>
                <button class="btn btn-info" onclick="loadAITemplates()">
                    <i class="fas fa-templates"></i> Templates
                </button>
            </div>
        </div>
    </div>

    <!-- QR Code Generator Modal -->
    <div id="qr-code-modal" class="modal">
        <div class="modal-content">
            <button class="modal-close" onclick="closeQRCodeModal()">&times;</button>
            <h2>QR Code Generator</h2>
            
            <div class="form-group">
                <label class="form-label">QR Code Type</label>
                <select id="qr-code-type" class="form-select">
                    <option value="inspection">Inspection Data</option>
                    <option value="estimation">Cost Estimation</option>
                    <option value="location">GPS Location</option>
                    <option value="project">Project Summary</option>
                </select>
            </div>

            <div id="qr-code-display" style="text-align: center; margin: 20px 0;">
                <!-- QR Code will be generated here -->
            </div>

            <div class="d-flex gap-2">
                <button class="btn btn-primary" onclick="generateQRCodeContent()">
                    <i class="fas fa-qrcode"></i> Generate QR
                </button>
                <button class="btn btn-success" onclick="downloadQRCode()">
                    <i class="fas fa-download"></i> Download
                </button>
            </div>
        </div>
    </div>

    <!-- Camera Modal -->
    <div id="estimation-camera-modal" class="modal">
        <div id="estimation-camera-modal-content" style="background-color: black; padding: 0; width: 90vw; height: 90vh; max-width: 600px; max-height: 800px; display: flex; flex-direction: column; justify-content: center; align-items: center; position: relative; overflow: hidden;">
            <video id="estimation-camera-feed" autoplay playsinline style="width: 100%; height: 100%; object-fit: contain; transform: scaleX(-1);"></video>
            <button id="estimation-capture-btn" onclick="captureEstimationPhoto()" style="position: absolute; bottom: 20px; width: 60px; height: 60px; background-color: white; border: 5px solid var(--primary-color); border-radius: 50%; cursor: pointer; z-index: 2010; display: flex; justify-content: center; align-items: center; font-size: 30px; color: var(--primary-color);">ð¸</button>
            <button id="estimation-close-camera-btn" onclick="closeEstimationCamera()" style="position: absolute; top: 10px; right: 10px; background: rgba(255, 255, 255, 0.5); border: none; border-radius: 50%; width: 30px; height: 30px; font-size: 18px; cursor: pointer; z-index: 2010;">Ã</button>
        </div>
    </div>

    <!-- Hidden Elements -->
    <canvas id="estimation-photo-canvas" style="display:none;"></canvas>
    <input type="file" id="estimation-project-import-input" accept=".json" style="display:none;">
    <input type="file" id="estimation-boq-csv-input" accept=".csv" style="display:none;">
    <input type="file" id="estimation-map-import-input" accept=".csv,.kml" style="display:none;">

    <!-- External Libraries -->
    <script src="https://unpkg.com/leaflet@1.7.1/dist/leaflet.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <!-- JavaScript -->
    <script>
        // Global Variables
        let currentUser = null;
        let reportTable;
        let costEstimationTable;
        let leafletMap;
        let currentMarker;
        let projectMarkers = [];
        let editingRow = null;
        let projects = [];
        let currentProjectName = "Unnamed Project";
        let clientLogoInspection = null;
        let companyLogoInspection = null;
        let clientLogoEstimation = null;
        let companyLogoEstimation = null;
        let quantityContext = 'inspection';
        let vehicleMap;
        let vehicleMarkers = [];
        let cameraStream;

        // BOQ data for cost estimation
        const boqData = [
            { ref: "A1.1", description: "Excavation", unit: "mÂ³", rate: 15.00 },
            { ref: "A1.2", description: "Backfilling", unit: "mÂ³", rate: 10.00 },
            { ref: "B2.1", description: "Concrete Paving", unit: "mÂ²", rate: 75.00 },
            { ref: "B2.2", description: "Asphalt Layer", unit: "mÂ²", rate: 50.00 },
            { ref: "C3.1", description: "Kerb Installation", unit: "m.l", rate: 25.00 },
            { ref: "C3.2", description: "Interlock Paving", unit: "mÂ²", rate: 40.00 },
            { ref: "D4.1", description: "Road Marking (White)", unit: "mÂ²", rate: 12.00 },
            { ref: "D4.2", description: "Road Marking (Yellow)", unit: "mÂ²", rate: 12.00 },
        ];

        // Authentication Functions
        function showSignUp() {
            alert('Sign up functionality would be implemented here');
        }

        function login(email, password) {
            // Simulate login
            currentUser = { email: email, name: "Engineer User" };
            document.getElementById('login-page').style.display = 'none';
            document.getElementById('main-app').style.display = 'flex';
            initializeEstimationComponents();
        }

        function logout() {
            currentUser = null;
            document.getElementById('main-app').style.display = 'none';
            document.getElementById('login-page').style.display = 'flex';
        }

        // Login form handler
        document.addEventListener('DOMContentLoaded', function() {
            const loginForm = document.getElementById('login-form');
            if (loginForm) {
                loginForm.addEventListener('submit', function(e) {
                    e.preventDefault();
                    const email = document.getElementById('email').value;
                    const password = document.getElementById('password').value;
                    
                    if (email && password) {
                        login(email, password);
                    } else {
                        alert('Please enter email and password');
                    }
                });
            }
        });

        // Page Navigation
        function showPage(pageId) {
            // Hide all pages
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
                page.style.display = 'none';
            });
            
            // Show selected page
            const targetPage = document.getElementById(pageId + '-page');
            if (targetPage) {
                targetPage.style.display = 'block';
                targetPage.classList.add('active');
            }
            
            // Update navigation
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            event.target.classList.add('active');
            
            console.log('Switched to page:', pageId);
        }

        // Enhanced Estimation & Inspection Module Functions
        function initializeEstimationComponents() {
            // Initialize tables
            reportTable = document.getElementById('estimation-report-table');
            costEstimationTable = document.getElementById('estimation-cost-table');
            
            // Initialize BOQ select
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            if (boqSelect) {
                boqData.forEach(item => {
                    const option = document.createElement('option');
                    option.value = item.ref;
                    option.textContent = `${item.ref} - ${item.description}`;
                    boqSelect.appendChild(option);
                });
            }
            
            // Set up event listeners
            if (document.getElementById('estimation-boq-ref-select')) {
                document.getElementById('estimation-boq-ref-select').addEventListener('change', updateEstimationBOQDetails);
            }
            if (document.getElementById('estimation-boq-search')) {
                document.getElementById('estimation-boq-search').addEventListener('input', filterEstimationBOQOptions);
            }
            if (document.getElementById('estimation-photo-input')) {
                document.getElementById('estimation-photo-input').addEventListener('change', handleEstimationPhotoUpload);
            }
            if (document.getElementById('estimation-manual-lat')) {
                document.getElementById('estimation-manual-lat').addEventListener('input', updateEstimationLocationFromManual);
            }
            if (document.getElementById('estimation-manual-lng')) {
                document.getElementById('estimation-manual-lng').addEventListener('input', updateEstimationLocationFromManual);
            }
            
            // Initialize drop zone
            const dropZone = document.getElementById('estimation-drop-zone');
            if (dropZone) {
                dropZone.addEventListener('dragover', handleEstimationDragOver);
                dropZone.addEventListener('dragleave', handleEstimationDragLeave);
                dropZone.addEventListener('drop', handleEstimationDrop);
                dropZone.addEventListener('click', () => document.getElementById('estimation-photo-input').click());
            }
            
            // Initialize BOQ form calculations
            ['estimation-boq-nr', 'estimation-boq-length', 'estimation-boq-width', 'estimation-boq-height'].forEach(id => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', calculateEstimationBOQTotalQuantity);
                }
            });
            
            // Load existing data
            updateEstimationBOQDetails();
            updateEstimationMostUsedBOQ();
            loadEstimationProjects();
        }

        // Tab Management Functions
        function openEstimationTab(evt, tabName) {
            const tabContents = document.getElementsByClassName("estimation-tab-content");
            for (let i = 0; i < tabContents.length; i++) {
                tabContents[i].classList.remove("active");
                tabContents[i].style.display = "none";
            }
            
            const tabButtons = document.getElementsByClassName("estimation-tab-button");
            for (let i = 0; i < tabButtons.length; i++) {
                tabButtons[i].classList.remove("active");
            }
            
            document.getElementById(tabName).style.display = "block";
            document.getElementById(tabName).classList.add("active");
            evt.currentTarget.classList.add("active");
        }

        // BOQ Management Functions
        function updateEstimationBOQDetails(boqRef = null) {
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            if (!boqSelect) return;
            
            const selectedRef = boqRef || boqSelect.value;
            
            if (boqRef) {
                boqSelect.value = boqRef;
            }
            
            const selectedItem = boqData.find(item => item.ref === selectedRef);
            if (selectedItem) {
                const descField = document.getElementById('estimation-boq-desc');
                const unitField = document.getElementById('estimation-boq-unit');
                const rateField = document.getElementById('estimation-boq-rate');
                
                if (descField) descField.value = selectedItem.description;
                if (unitField) unitField.value = selectedItem.unit;
                if (rateField) rateField.value = selectedItem.rate.toFixed(2);
                
                calculateEstimationBOQTotalQuantity();
            }
        }

        function filterEstimationBOQOptions() {
            const searchTerm = document.getElementById('estimation-boq-search').value.toLowerCase();
            const boqSelect = document.getElementById('estimation-boq-ref-select');
            if (!boqSelect) return;
            
            boqSelect.innerHTML = '';
            
            const filteredData = boqData.filter(item =>
                item.ref.toLowerCase().includes(searchTerm) ||
                item.description.toLowerCase().includes(searchTerm)
            );
            
            filteredData.forEach(item => {
                const option = document.createElement('option');
                option.value = item.ref;
                option.textContent = `${item.ref} - ${item.description}`;
                boqSelect.appendChild(option);
            });
            
            updateEstimationBOQDetails();
        }

        function calculateEstimationBOQTotalQuantity() {
            const nr = parseFloat(document.getElementById('estimation-boq-nr')?.value) || 0;
            const length = parseFloat(document.getElementById('estimation-boq-length')?.value) || 0;
            const width = parseFloat(document.getElementById('estimation-boq-width')?.value) || 0;
            const height = parseFloat(document.getElementById('estimation-boq-height')?.value) || 0;
            const rate = parseFloat(document.getElementById('estimation-boq-rate')?.value) || 0;
            
            let totalQty = 0;
            if (nr > 0 && length > 0 && width > 0 && height > 0) {
                totalQty = nr * length * width * height;
            } else if (nr > 0 && length > 0 && width > 0) {
                totalQty = nr * length * width;
            } else if (nr > 0 && length > 0) {
                totalQty = nr * length;
            } else if (nr > 0) {
                totalQty = nr;
            }
            
            const amount = totalQty * rate;
            
            const totalQtyField = document.getElementById('estimation-boq-total-qty');
            const amountField = document.getElementById('estimation-boq-amount');
            
            if (totalQtyField) totalQtyField.value = totalQty.toFixed(3);
            if (amountField) amountField.value = amount.toFixed(2);
        }

        function updateEstimationMostUsedBOQ() {
            const usage = JSON.parse(localStorage.getItem('estimationBOQUsage')) || {};
            const list = document.getElementById('estimation-most-used-boq-list');
            if (!list) return;
            
            list.innerHTML = '';
            
            const sortedUsage = Object.entries(usage)
                .sort(([,a],[,b]) => b - a)
                .slice(0, 10);
            
            if (sortedUsage.length === 0) {
                list.innerHTML = '<span style="color: #666;">Start adding items to see your most used here.</span>';
                return;
            }
            
            sortedUsage.forEach(([ref, count]) => {
                const item = document.createElement('span');
                item.style.cssText = 'padding: 5px 10px; background-color: rgba(var(--primary-color-rgb), 0.1); border-radius: 15px; font-size: 13px; cursor: pointer; transition: background-color 0.2s;';
                item.textContent = `${ref} (${count})`;
                item.title = `Used ${count} times`;
                item.onclick = () => updateEstimationBOQDetails(ref);
                item.onmouseenter = () => item.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.2)';
                item.onmouseleave = () => item.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.1)';
                list.appendChild(item);
            });
        }

        function trackEstimationBOQUsage(boqRef) {
            let usage = JSON.parse(localStorage.getItem('estimationBOQUsage')) || {};
            usage[boqRef] = (usage[boqRef] || 0) + 1;
            localStorage.setItem('estimationBOQUsage', JSON.stringify(usage));
            updateEstimationMostUsedBOQ();
        }

        // Photo Management Functions
        function handleEstimationPhotoUpload(event) {
            const files = event.target.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => addEstimationPhotoToPreview(e.target.result);
                    reader.readAsDataURL(file);
                }
            }
        }

        function handleEstimationDragOver(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.2)';
        }

        function handleEstimationDragLeave(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.05)';
        }

        function handleEstimationDrop(event) {
            event.preventDefault();
            event.currentTarget.style.backgroundColor = 'rgba(var(--primary-color-rgb), 0.05)';
            
            const files = event.dataTransfer.files;
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                if (file.type.startsWith('image/')) {
                    const reader = new FileReader();
                    reader.onload = (e) => addEstimationPhotoToPreview(e.target.result);
                    reader.readAsDataURL(file);
                }
            }
        }

        function addEstimationPhotoToPreview(dataUrl) {
            const photoPreviews = document.getElementById('estimation-photo-previews');
            if (!photoPreviews) return;
            
            const img = document.createElement('img');
            img.src = dataUrl;
            img.style.cssText = 'max-height: 70px; border-radius: 8px; cursor: pointer; object-fit: cover;';
            img.onclick = () => showEstimationImagePreview(dataUrl);
            photoPreviews.appendChild(img);
        }

        function showEstimationImagePreview(src) {
            // Create overlay
            const overlay = document.createElement('div');
            overlay.style.cssText = 'position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background: rgba(0,0,0,0.8); z-index: 3000; display: flex; justify-content: center; align-items: center;';
            
            const img = document.createElement('img');
            img.src = src;
            img.style.cssText = 'max-width: 90%; max-height: 90%; object-fit: contain;';
            
            const closeBtn = document.createElement('button');
            closeBtn.textContent = 'Ã';
            closeBtn.style.cssText = 'position: absolute; top: 20px; right: 20px; background: white; border: none; border-radius: 50%; width: 40px; height: 40px; font-size: 24px; cursor: pointer;';
            closeBtn.onclick = () => document.body.removeChild(overlay);
            
            overlay.appendChild(img);
            overlay.appendChild(closeBtn);
            overlay.onclick = (e) => { if (e.target === overlay) document.body.removeChild(overlay); };
            
            document.body.appendChild(overlay);
        }

        // Camera Functions
        async function openEstimationCamera() {
            const cameraModal = document.getElementById('estimation-camera-modal');
            const cameraFeed = document.getElementById('estimation-camera-feed');
            
            try {
                cameraStream = await navigator.mediaDevices.getUserMedia({ 
                    video: { facingMode: 'environment' } 
                });
                cameraFeed.srcObject = cameraStream;
                cameraModal.style.display = 'flex';
            } catch (err) {
                console.error("Error accessing camera: ", err);
                alert("Could not access camera. Please ensure it's allowed and try again.");
            }
        }

        function closeEstimationCamera() {
            const cameraModal = document.getElementById('estimation-camera-modal');
            cameraModal.style.display = 'none';
            if (cameraStream) {
                cameraStream.getTracks().forEach(track => track.stop());
            }
        }

        function captureEstimationPhoto() {
            const cameraFeed = document.getElementById('estimation-camera-feed');
            const canvas = document.getElementById('estimation-photo-canvas');
            canvas.width = cameraFeed.videoWidth;
            canvas.height = cameraFeed.videoHeight;
            
            const context = canvas.getContext('2d');
            context.save();
            context.scale(-1, 1);
            context.drawImage(cameraFeed, -canvas.width, 0, canvas.width, canvas.height);
            context.restore();
            
            const dataUrl = canvas.toDataURL('image/jpeg', 0.9);
            addEstimationPhotoToPreview(dataUrl);
            closeEstimationCamera();
        }

        // GPS and Location Functions
        function switchEstimationLocationMode(mode) {
            const autoPanel = document.getElementById('estimation-location-auto-panel');
            const manualPanel = document.getElementById('estimation-location-manual-panel');
            const autoBtn = document.getElementById('estimation-gps-auto-btn');
            const manualBtn = document.getElementById('estimation-gps-manual-btn');
            
            if (autoPanel) autoPanel.style.display = 'none';
            if (manualPanel) manualPanel.style.display = 'none';
            
            if (autoBtn) autoBtn.classList.remove('active');
            if (manualBtn) manualBtn.classList.remove('active');
            
            if (mode === 'auto') {
                if (autoPanel) autoPanel.style.display = 'block';
                if (autoBtn) autoBtn.classList.add('active');
                getEstimationLocation();
            } else if (mode === 'manual') {
                if (manualPanel) manualPanel.style.display = 'block';
                if (manualBtn) manualBtn.classList.add('active');
            }
        }

        function getEstimationLocation() {
            if (navigator.geolocation) {
                navigator.geolocation.getCurrentPosition(showEstimationPosition, showEstimationError);
            } else {
                alert("Geolocation is not supported by this browser.");
            }
        }

        function showEstimationPosition(position) {
            const lat = position.coords.latitude;
            const lng = position.coords.longitude;
            const latDisplay = document.getElementById('estimation-lat-display');
            const lngDisplay = document.getElementById('estimation-lng-display');
            
            if (latDisplay) latDisplay.textContent = lat.toFixed(6);
            if (lngDisplay) lngDisplay.textContent = lng.toFixed(6);
        }

        function showEstimationError(error) {
            let message = "Unknown error occurred";
            switch (error.code) {
                case error.PERMISSION_DENIED:
                    message = "User denied the request for Geolocation.";
                    break;
                case error.POSITION_UNAVAILABLE:
                    message = "Location information is unavailable.";
                    break;
                case error.TIMEOUT:
                    message = "The request to get user location timed out.";
                    break;
            }
            alert(message);
            const latDisplay = document.getElementById('estimation-lat-display');
            const lngDisplay = document.getElementById('estimation-lng-display');
            if (latDisplay) latDisplay.textContent = "N/A";
            if (lngDisplay) lngDisplay.textContent = "N/A";
        }

        function updateEstimationLocationFromManual() {
            const lat = parseFloat(document.getElementById('estimation-manual-lat').value);
            const lng = parseFloat(document.getElementById('estimation-manual-lng').value);
            
            if (!isNaN(lat) && !isNaN(lng)) {
                const latDisplay = document.getElementById('estimation-lat-display');
                const lngDisplay = document.getElementById('estimation-lng-display');
                
                if (latDisplay) latDisplay.textContent = lat.toFixed(6);
                if (lngDisplay) lngDisplay.textContent = lng.toFixed(6);
            } else {
                const latDisplay = document.getElementById('estimation-lat-display');
                const lngDisplay = document.getElementById('estimation-lng-display');
                if (latDisplay) latDisplay.textContent = "N/A";
                if (lngDisplay) lngDisplay.textContent = "N/A";
            }
        }

        function insertEstimationLocationToForm() {
            const lat = document.getElementById('estimation-lat-display').textContent;
            const lng = document.getElementById('estimation-lng-display').textContent;
            
            if (lat !== "N/A" && lng !== "N/A") {
                if (editingRow) {
                    editingRow.cells[6].textContent = lat;
                    editingRow.cells[7].textContent = lng;
                } else {
                    alert("Location ready to be inserted when you add a new row or edit an existing one.");
                }
            } else {
                alert("No valid GPS location to insert.");
            }
        }

        // Quantity Modal Functions
        function showEstimationQuantityModal() {
            quantityContext = 'inspection';
            document.getElementById('estimation-quantity-modal').style.display = 'flex';
        }

        function showBOQQuantityModal() {
            quantityContext = 'boq';
            // Pre-fill with current BOQ form values
            const lengthField = document.getElementById('estimation-boq-length');
            const widthField = document.getElementById('estimation-boq-width');
            const heightField = document.getElementById('estimation-boq-height');
            const nrField = document.getElementById('estimation-boq-nr');
            
            if (lengthField) document.getElementById('estimation-modal-length').value = lengthField.value;
            if (widthField) document.getElementById('estimation-modal-width').value = widthField.value;
            if (heightField) document.getElementById('estimation-modal-depth').value = heightField.value;
            if (nrField) document.getElementById('estimation-modal-repetitions').value = nrField.value;
            
            document.getElementById('estimation-quantity-modal').style.display = 'flex';
        }

        function closeEstimationQuantityModal() {
            document.getElementById('estimation-quantity-modal').style.display = 'none';
        }

        function setEstimationQuantity() {
            const length = parseFloat(document.getElementById('estimation-modal-length').value) || 0;
            const width = parseFloat(document.getElementById('estimation-modal-width').value) || 0;
            const depth = parseFloat(document.getElementById('estimation-modal-depth').value) || 0;
            const repetitions = parseFloat(document.getElementById('estimation-modal-repetitions').value) || 1;
            
            if (quantityContext === 'boq') {
                // Update BOQ form
                const nrField = document.getElementById('estimation-boq-nr');
                const lengthField = document.getElementById('estimation-boq-length');
                const widthField = document.getElementById('estimation-boq-width');
                const heightField = document.getElementById('estimation-boq-height');
                
                if (nrField) nrField.value = repetitions;
                if (lengthField) lengthField.value = length;
                if (widthField) widthField.value = width;
                if (heightField) heightField.value = depth;
                
                calculateEstimationBOQTotalQuantity();
            } else {
                // Calculate quantity for inspection
                let quantity = 0;
                if (length > 0 && width > 0 && depth > 0) {
                    quantity = length * width * depth * repetitions;
                } else if (length > 0 && width > 0) {
                    quantity = length * width * repetitions;
                } else if (length > 0) {
                    quantity = length * repetitions;
                } else {
                    quantity = repetitions;
                }
                
                if (editingRow) {
                    editingRow.cells[4].textContent = quantity.toFixed(2);
                } else {
                    // Store for next row addition
                    window.calculatedQuantity = quantity.toFixed(2);
                }
            }
            
            closeEstimationQuantityModal();
        }

        // Table Management Functions
        function addEstimationInspectionRow() {
            if (!reportTable) return;
            
            const tbody = reportTable.tBodies[0];
            const newRow = tbody.insertRow();
            newRow.dataset.id = generateEstimationId();
            
            // Get current form values
            const asset = document.getElementById('estimation-asset')?.value || '';
            const status = document.getElementById('estimation-status')?.value || '';
            const recommendation = document.getElementById('estimation-recommendation')?.value || '';
            const lat = document.getElementById('estimation-lat-display')?.textContent || 'N/A';
            const lng = document.getElementById('estimation-lng-display')?.textContent || 'N/A';
            
            // Get photos
            const photoSrcs = Array.from(document.querySelectorAll('#estimation-photo-previews img')).map(img => img.src);
            
            // Create cells
            const cells = [];
            for (let i = 0; i < 9; i++) {
                cells.push(newRow.insertCell(i));
            }
            
            // Populate cells
            cells[0].textContent = tbody.rows.length; // Row number
            cells[1].textContent = asset;
            cells[1].style.textAlign = 'left';
            cells[2].textContent = status;
            cells[3].textContent = recommendation;
            cells[4].textContent = window.calculatedQuantity || '';
            
            // Photos cell
            const photoWrapper = document.createElement('div');
            photoWrapper.style.cssText = 'display: flex; flex-wrap: wrap; gap: 5px; justify-content: center;';
            photoSrcs.forEach(src => {
                const img = document.createElement('img');
                img.src = src;
                img.style.cssText = 'max-height: 50px; max-width: 80px; border-radius: 5px; cursor: pointer; object-fit: cover;';
                img.onclick = () => showEstimationImagePreview(src);
                photoWrapper.appendChild(img);
            });
            cells[5].appendChild(photoWrapper);
            
            cells[6].textContent = lat;
            cells[7].textContent = lng;
            
            // Actions cell
            const actionsDiv = document.createElement('div');
            actionsDiv.style.cssText = 'display: flex; gap: 5px; justify-content: center;';
            
            const editBtn = document.createElement('button');
            editBtn.textContent = 'âï¸';
            editBtn.className = 'btn btn-info';
            editBtn.style.padding = '2px 6px';
            editBtn.onclick = () => editEstimationRow(newRow);
            
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ðï¸';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.onclick = () => removeEstimationRow(newRow);
            
            actionsDiv.appendChild(editBtn);
            actionsDiv.appendChild(deleteBtn);
            cells[8].appendChild(actionsDiv);
            
            // Clear form
            const assetField = document.getElementById('estimation-asset');
            const statusField = document.getElementById('estimation-status');
            const recommendationField = document.getElementById('estimation-recommendation');
            const photoPreviewsField = document.getElementById('estimation-photo-previews');
            
            if (assetField) assetField.value = '';
            if (statusField) statusField.value = '';
            if (recommendationField) recommendationField.value = '';
            if (photoPreviewsField) photoPreviewsField.innerHTML = '';
            
            window.calculatedQuantity = null;
            updateEstimationRowNumbers();
        }

        function editEstimationRow(row) {
            editingRow = row;
            
            // Populate form with row data
            const assetField = document.getElementById('estimation-asset');
            const statusField = document.getElementById('estimation-status');
            const recommendationField = document.getElementById('estimation-recommendation');
            
            if (assetField) assetField.value = row.cells[1].textContent;
            if (statusField) statusField.value = row.cells[2].textContent;
            if (recommendationField) recommendationField.value = row.cells[3].textContent;
            
            // Populate photos
            const photoPreviews = document.getElementById('estimation-photo-previews');
            if (photoPreviews) {
                photoPreviews.innerHTML = '';
                Array.from(row.cells[5].querySelectorAll('img')).forEach(img => {
                    addEstimationPhotoToPreview(img.src);
                });
            }
            
            // Update GPS display
            const latDisplay = document.getElementById('estimation-lat-display');
            const lngDisplay = document.getElementById('estimation-lng-display');
            if (latDisplay) latDisplay.textContent = row.cells[6].textContent;
            if (lngDisplay) lngDisplay.textContent = row.cells[7].textContent;
            
            alert("Row is now being edited. Modify the form above and the changes will apply to this row when you add it again.");
        }

        function removeEstimationRow(row) {
            if (confirm("Are you sure you want to delete this row?")) {
                row.remove();
                updateEstimationRowNumbers();
            }
        }

        function updateEstimationRowNumbers() {
            if (!reportTable) return;
            const rows = reportTable.tBodies[0].rows;
            for (let i = 0; i < rows.length; i++) {
                rows[i].cells[0].textContent = i + 1;
            }
        }

        function insertEstimationBOQRow() {
            if (!costEstimationTable) return;
            
            const tbody = costEstimationTable.tBodies[0];
            const newRow = tbody.insertRow();
            newRow.dataset.id = generateEstimationId();
            
            const boqRefSelect = document.getElementById('estimation-boq-ref-select');
            const boqRef = boqRefSelect ? boqRefSelect.value : '';
            
            // Track usage
            if (boqRef) trackEstimationBOQUsage(boqRef);
            
            // Create cells
            const cells = [];
            for (let i = 0; i < 12; i++) {
                cells.push(newRow.insertCell(i));
            }
            
            // Populate cells
            cells[0].textContent = boqRef;
            cells[1].textContent = document.getElementById('estimation-boq-desc')?.value || '';
            cells[1].style.textAlign = 'left';
            cells[2].textContent = document.getElementById('estimation-boq-unit')?.value || '';
            cells[3].textContent = document.getElementById('estimation-boq-nr')?.value || '';
            cells[4].textContent = document.getElementById('estimation-boq-length')?.value || '';
            cells[5].textContent = document.getElementById('estimation-boq-width')?.value || '';
            cells[6].textContent = document.getElementById('estimation-boq-height')?.value || '';
            cells[7].textContent = document.getElementById('estimation-boq-total-qty')?.value || '';
            cells[8].textContent = document.getElementById('estimation-boq-rate')?.value || '';
            cells[9].textContent = document.getElementById('estimation-boq-amount')?.value || '';
            cells[10].textContent = document.getElementById('estimation-boq-remarks')?.value || '';
            
            // Actions cell
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = 'ðï¸';
            deleteBtn.className = 'btn btn-danger';
            deleteBtn.style.padding = '2px 6px';
            deleteBtn.onclick = () => removeEstimationBOQRow(newRow);
            cells[11].appendChild(deleteBtn);
            
            // Clear form
            ['estimation-boq-nr', 'estimation-boq-length', 'estimation-boq-width', 'estimation-boq-height', 
             'estimation-boq-total-qty', 'estimation-boq-amount', 'estimation-boq-remarks'].forEach(id => {
                const field = document.getElementById(id);
                if (field) field.value = '';
            });
            
            calculateEstimationCostTotal();
        }

        function removeEstimationBOQRow(row) {
            if (confirm("Are you sure you want to delete this BOQ row?")) {
                row.remove();
                calculateEstimationCostTotal();
            }
        }

        function calculateEstimationCostTotal() {
            if (!costEstimationTable) return;
            
            let totalAmount = 0;
            const rows = costEstimationTable.tBodies[0].rows;
            
            Array.from(rows).forEach(row => {
                const amount = parseFloat(row.cells[9].textContent) || 0;
                totalAmount += amount;
            });
            
            const totalCell = document.getElementById('estimation-total-amount-cell');
            if (totalCell) {
                totalCell.textContent = `QAR ${totalAmount.toFixed(2)}`;
            }
        }

        // Export Functions
        function exportEstimationInspectionCSV() {
            if (!reportTable) return;
            
            let csv = [];
            
            // Headers (excluding actions)
            const headers = Array.from(reportTable.tHead.rows[0].cells).slice(0, -1).map(th => `"${th.textContent}"`).join(',');
            csv.push(headers);
            
            // Data rows
            Array.from(reportTable.tBodies[0].rows).forEach(row => {
                const rowData = Array.from(row.cells).slice(0, -1).map((cell, index) => {
                    if (index === 5) { // Photos column
                        return `"${cell.querySelectorAll('img').length} photo(s)"`;
                    }
                    return `"${cell.textContent.replace(/"/g, '""')}"`;
                }).join(',');
                csv.push(rowData);
            });
            
            downloadEstimationFile(csv.join('\n'), 'estimation_inspection_report.csv', 'text/csv;charset=utf-8;');
        }

        function exportEstimationCostCSV() {
            if (!costEstimationTable) return;
            
            let csv = [];
            
            // Headers (excluding actions)
            const headers = Array.from(costEstimationTable.tHead.rows[0].cells).slice(0, -1).map(th => `"${th.textContent}"`).join(',');
            csv.push(headers);
            
            // Data rows
            Array.from(costEstimationTable.tBodies[0].rows).forEach(row => {
                const rowData = Array.from(row.cells).slice(0, -1).map(cell => `"${cell.textContent.replace(/"/g, '""')}"`).join(',');
                csv.push(rowData);
            });
            
            downloadEstimationFile(csv.join('\n'), 'estimation_cost_estimation.csv', 'text/csv;charset=utf-8;');
        }

        function exportEstimationInspectionKML() {
            if (!reportTable) return;
            
            let kmlPlacemarks = [];
            
            Array.from(reportTable.tBodies[0].rows).forEach(row => {
                const lat = parseFloat(row.cells[6].textContent);
                const lng = parseFloat(row.cells[7].textContent);
                
                if (!isNaN(lat) && !isNaN(lng)) {
                    const name = row.cells[1].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const status = row.cells[2].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const recommendation = row.cells[3].textContent.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;');
                    const quantity = row.cells[4].textContent;
                    
                    const description = `Status: ${status}\\nRecommendation: ${recommendation}\\nQuantity: ${quantity}`;
                    
                    kmlPlacemarks.push(`
                        <Placemark>
                            <name>${name}</name>
                            <description>${description}</description>
                            <Point>
                                <coordinates>${lng},${lat},0</coordinates>
                            </Point>
                        </Placemark>
                    `);
                }
            });
            
            if (kmlPlacemarks.length === 0) {
                alert("No rows with valid GPS coordinates to export.");
                return;
            }
            
            const kmlContent = `<?xml version="1.0" encoding="UTF-8"?>
        <kml xmlns="http://www.opengis.net/kml/2.2">
            <Document>
                <name>Estimation Inspection Report</name>
                ${kmlPlacemarks.join('')}
            </Document>
        </kml>`;
            
            downloadEstimationFile(kmlContent, 'estimation_inspection_locations.kml', 'application/vnd.google-earth.kml+xml');
        }

        function downloadEstimationFile(content, fileName, mimeType) {
            const blob = new Blob([content], { type: mimeType });
            const link = document.createElement('a');
            link.href = URL.createObjectURL(blob);
            link.download = fileName;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

        // Print Functions
        function printEstimationInspectionReport() {
            if (!reportTable) return;
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Estimation Inspection Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Enhanced Asset Inspection Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        ${reportTable.outerHTML}
                    </table>
                    <div class="footer">
                        <p>Generated from Engineering Platform - Enhanced Estimation & Inspection Module</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        function printEstimationCostReport() {
            if (!costEstimationTable) return;
            
            const printWindow = window.open('', '_blank');
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Cost Estimation Report</title>
                    <style>
                        body { font-family: Arial, sans-serif; margin: 20px; }
                        .header { text-align: center; border-bottom: 2px solid #333; padding-bottom: 10px; margin-bottom: 20px; }
                        table { width: 100%; border-collapse: collapse; }
                        th, td { border: 1px solid #333; padding: 8px; text-align: left; }
                        th { background-color: #f0f0f0; }
                        .footer { margin-top: 20px; text-align: center; font-size: 12px; }
                    </style>
                </head>
                <body>
                    <div class="header">
                        <h1>Enhanced Cost Estimation Report</h1>
                        <p>Generated on: ${new Date().toLocaleString()}</p>
                    </div>
                    <table>
                        ${costEstimationTable.outerHTML}
                    </table>
                    <div class="footer">
                        <p>Generated from Engineering Platform - Enhanced Estimation & Inspection Module</p>
                    </div>
                </body>
                </html>
            `);
            
            printWindow.document.close();
            printWindow.print();
        }

        // PDF Export Function
        async function exportEstimationPDF() {
            alert('PDF export functionality is available. In production, this would generate a comprehensive PDF report.');
        }

        // BOQ Template and Import Functions
        function downloadEstimationBOQTemplate() {
            const headers = "BOQ Ref.,Description,Unit,NR,Length (m),Width (m),Height (m),Total Qty.,Rate,Amount,Remarks";
            downloadEstimationFile(headers, 'boq_template.csv', 'text/csv;charset=utf-8;');
        }

        function importEstimationBOQCSV() {
            alert('BOQ CSV import functionality is available. In production, this would allow importing BOQ data from CSV files.');
        }

        // Project Management Functions
        function exportEstimationProject() {
            const projectData = {
                name: `Estimation Project ${new Date().toISOString().split('T')[0]}`,
                date: new Date().toISOString(),
                inspectionData: [],
                costData: [],
                mapMarkers: []
            };
            
            // Capture inspection data
            if (reportTable) {
                Array.from(reportTable.tBodies[0].rows).forEach(row => {
                    projectData.inspectionData.push({
                        asset: row.cells[1].textContent,
                        status: row.cells[2].textContent,
                        recommendation: row.cells[3].textContent,
                        quantity: row.cells[4].textContent,
                        photos: Array.from(row.cells[5].querySelectorAll('img')).map(img => img.src),
                        latitude: row.cells[6].textContent,
                        longitude: row.cells[7].textContent
                    });
                });
            }
            
            // Capture cost data
            if (costEstimationTable) {
                Array.from(costEstimationTable.tBodies[0].rows).forEach(row => {
                    projectData.costData.push({
                        boqRef: row.cells[0].textContent,
                        description: row.cells[1].textContent,
                        unit: row.cells[2].textContent,
                        nr: row.cells[3].textContent,
                        length: row.cells[4].textContent,
                        width: row.cells[5].textContent,
                        height: row.cells[6].textContent,
                        totalQty: row.cells[7].textContent,
                        rate: row.cells[8].textContent,
                        amount: row.cells[9].textContent,
                        remarks: row.cells[10].textContent
                    });
                });
            }
            
            const fileName = `${projectData.name.replace(/ /g, '_')}.json`;
            downloadEstimationFile(JSON.stringify(projectData, null, 2), fileName, 'application/json');
        }

        function importEstimationProject() {
            alert('Project import functionality is available. In production, this would allow importing saved projects.');
        }

        function loadEstimationProjects() {
            // Load saved projects from localStorage
            const savedProjects = JSON.parse(localStorage.getItem('estimationProjects')) || [];
            const projectsList = document.getElementById('estimation-projects-list');
            
            if (!projectsList) return;
            
            if (savedProjects.length === 0) {
                projectsList.innerHTML = '<p>No saved projects found.</p>';
                return;
            }
            
            projectsList.innerHTML = savedProjects.map(project => `
                <div class="card" style="margin-bottom: 10px;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <div>
                            <h4 style="margin: 0;">${project.name}</h4>
                            <small>Saved: ${new Date(project.date).toLocaleString()}</small>
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button class="btn btn-info" onclick="loadEstimationProject('${project.name}')">Load</button>
                            <button class="btn btn-danger" onclick="deleteEstimationProject('${project.name}')">Delete</button>
                        </div>
                    </div>
                </div>
            `).join('');
        }

        // Map Functions
        function centerEstimationMapOnUser() {
            alert('Map centering functionality is available. In production, this would center the map on user location.');
        }

        function fitEstimationMapToMarkers() {
            alert('Map fitting functionality is available. In production, this would fit all markers in view.');
        }

        function downloadEstimationMapCSVTemplate() {
            const headers = "Asset,Latitude,Longitude,Status";
            downloadEstimationFile(headers, 'map_import_template.csv', 'text/csv;charset=utf-8;');
        }

        function importEstimationMapData() {
            alert('Map data import functionality is available. In production, this would import KML/CSV location data.');
        }

        function clearEstimationMapMarkers() {
            alert('Map marker clearing functionality is available. In production, this would clear all map markers.');
        }

        // Advanced Photo Manager Functions
        function openAdvancedPhotoManager() {
            document.getElementById('advanced-photo-manager').style.display = 'flex';
            loadPhotoManagerGrid();
        }

        function closeAdvancedPhotoManager() {
            document.getElementById('advanced-photo-manager').style.display = 'none';
        }

        function loadPhotoManagerGrid() {
            const grid = document.getElementById('photo-manager-grid');
            const photos = document.querySelectorAll('#estimation-photo-previews img');
            
            if (!grid) return;
            
            grid.innerHTML = '';
            
            Array.from(photos).forEach((photo, index) => {
                const photoCard = document.createElement('div');
                photoCard.className = 'photo-card';
                photoCard.style.cssText = 'background: rgba(255,255,255,0.1); border-radius: 12px; padding: 15px; cursor: pointer; transition: transform 0.3s;';
                
                photoCard.innerHTML = `
                    <img src="${photo.src}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px;" onclick="showPhotoMetadata(${index})">
                    <div style="margin-top: 10px;">
                        <small>Photo ${index + 1}</small>
                        <div class="photo-actions" style="margin-top: 8px;">
                            <button class="btn btn-info" onclick="enhancePhoto(${index})" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-magic"></i> Enhance
                            </button>
                            <button class="btn btn-warning" onclick="analyzePhotoAI(${index})" style="padding: 4px 8px; font-size: 12px;">
                                <i class="fas fa-robot"></i> AI
                            </button>
                        </div>
                    </div>
                `;
                
                grid.appendChild(photoCard);
            });
        }

        function showPhotoMetadata(index) {
            const panel = document.getElementById('photo-metadata-panel');
            const content = document.getElementById('metadata-content');
            
            if (!panel || !content) return;
            
            // Simulate metadata extraction
            const metadata = {
                size: '2.4 MB',
                dimensions: '1920x1080',
                timestamp: new Date().toLocaleString(),
                gps: document.getElementById('estimation-lat-display').textContent + ', ' + document.getElementById('estimation-lng-display').textContent,
                device: 'Engineering Camera',
                defectsDetected: Math.floor(Math.random() * 3) + 1
            };
            
            content.innerHTML = `
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                    <div><strong>Size:</strong> ${metadata.size}</div>
                    <div><strong>Dimensions:</strong> ${metadata.dimensions}</div>
                    <div><strong>Timestamp:</strong> ${metadata.timestamp}</div>
                    <div><strong>GPS:</strong> ${metadata.gps}</div>
                    <div><strong>Device:</strong> ${metadata.device}</div>
                    <div><strong>AI Defects:</strong> ${metadata.defectsDetected} detected</div>
                </div>
            `;
            
            panel.style.display = 'block';
        }

        function analyzeAllPhotos() {
            const photos = document.querySelectorAll('#estimation-photo-previews img');
            if (photos.length === 0) {
                alert('No photos to analyze');
                return;
            }
            
            // Simulate AI analysis
            let analysisResult = `AI Analysis Complete!\n\n`;
            Array.from(photos).forEach((photo, index) => {
                const defects = ['Crack', 'Corrosion', 'Wear', 'Deformation'][Math.floor(Math.random() * 4)];
                const confidence = (85 + Math.random() * 10).toFixed(1);
                analysisResult += `Photo ${index + 1}: ${defects} detected (${confidence}% confidence)\n`;
            });
            
            alert(analysisResult);
        }

        // AI Assistant Functions
        function openAIAssistant() {
            document.getElementById('ai-assistant-modal').style.display = 'flex';
        }

        function closeAIAssistant() {
            document.getElementById('ai-assistant-modal').style.display = 'none';
        }

        function handleAIChat(event) {
            if (event.key === 'Enter') {
                sendAIMessage();
            }
        }

        function sendAIMessage() {
            const input = document.getElementById('ai-chat-input');
            const messages = document.getElementById('ai-chat-messages');
            const userMessage = input.value.trim();
            
            if (!userMessage || !input || !messages) return;
            
            // Add user message
            const userDiv = document.createElement('div');
            userDiv.className = 'user-message';
            userDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: rgba(102,126,234,0.2); border-radius: 8px; text-align: right;';
            userDiv.innerHTML = `<strong>You:</strong> ${userMessage}`;
            messages.appendChild(userDiv);
            
            // Simulate AI response
            setTimeout(() => {
                const aiDiv = document.createElement('div');
                aiDiv.className = 'ai-message';
                aiDiv.style.cssText = 'margin: 10px 0; padding: 10px; background: rgba(255,255,255,0.1); border-radius: 8px;';
                
                let response = '';
                if (userMessage.toLowerCase().includes('calculation') || userMessage.toLowerCase().includes('quantity')) {
                    response = 'For accurate quantity calculations, consider the shape type, material waste factor (typically 5-10%), and local standards. I can help you calculate volumes, areas, and material requirements based on your specifications.';
                } else if (userMessage.toLowerCase().includes('boq') || userMessage.toLowerCase().includes('estimate')) {
                    response = 'BOQ optimization tips: 1) Use standardized item codes, 2) Include material waste factors, 3) Consider local labor rates, 4) Add contingency allowances (10-15%). Would you like me to analyze your current BOQ structure?';
                } else if (userMessage.toLowerCase().includes('defect') || userMessage.toLowerCase().includes('inspection')) {
                    response = 'Common inspection defects include: Surface cracks (check width/depth), Corrosion (assess percentage coverage), Material wear (measure thickness loss), Structural deformation (check alignment). I can analyze your photos for these issues.';
                } else {
                    response = 'I can assist with: Quantity calculations, BOQ analysis, Material estimations, Defect identification, Cost optimization, and Engineering standards compliance. What specific area would you like help with?';
                }
                
                aiDiv.innerHTML = `<strong>AI Assistant:</strong> ${response}`;
                messages.appendChild(aiDiv);
                
                // Scroll to bottom
                messages.scrollTop = messages.scrollHeight;
            }, 1000);
            
            input.value = '';
            messages.scrollTop = messages.scrollHeight;
        }

        function loadAITemplates() {
            const templates = [
                'Calculate concrete volume for foundation',
                'Estimate steel reinforcement requirements',
                'Analyze pavement condition assessment',
                'BOQ optimization recommendations',
                'Material waste factor calculations'
            ];
            
            alert('AI Templates:\n' + templates.join('\n'));
        }

        // QR Code Functions
        function generateQRCode() {
            document.getElementById('qr-code-modal').style.display = 'flex';
        }

        function closeQRCodeModal() {
            document.getElementById('qr-code-modal').style.display = 'none';
        }

        function generateQRCodeContent() {
            const type = document.getElementById('qr-code-type').value;
            const display = document.getElementById('qr-code-display');
            
            if (!display) return;
            
            let qrData = '';
            switch(type) {
                case 'inspection':
                    qrData = `Inspection Data - Asset: ${document.getElementById('estimation-asset')?.value || 'N/A'}, Status: ${document.getElementById('estimation-status')?.value || 'N/A'}, GPS: ${document.getElementById('estimation-lat-display')?.textContent}, ${document.getElementById('estimation-lng-display')?.textContent}`;
                    break;
                case 'estimation':
                    const total = costEstimationTable ? Array.from(costEstimationTable.tBodies[0].rows).reduce((sum, row) => sum + parseFloat(row.cells[9].textContent || 0), 0) : 0;
                    qrData = `Cost Estimation - Total: QAR ${total.toFixed(2)}, Items: ${costEstimationTable ? costEstimationTable.tBodies[0].rows.length : 0}`;
                    break;
                case 'location':
                    qrData = `GPS Location - Lat: ${document.getElementById('estimation-lat-display')?.textContent}, Lng: ${document.getElementById('estimation-lng-display')?.textContent}`;
                    break;
                case 'project':
                    qrData = `Project: ${currentProjectName}, Date: ${new Date().toLocaleDateString()}`;
                    break;
            }
            
            // Generate QR code (simplified representation)
            display.innerHTML = `
                <div style="width: 200px; height: 200px; background: white; margin: 0 auto; display: flex; align-items: center; justify-content: center; border: 2px solid #000;">
                    <div style="width: 180px; height: 180px; background: repeating-linear-gradient(0deg, #000 0px, #000 10px, #fff 10px, #fff 20px), repeating-linear-gradient(90deg, #000 0px, #000 10px, #fff 10px, #fff 20px);"></div>
                </div>
                <p style="margin-top: 10px; font-size: 12px; word-break: break-all;">${qrData}</p>
            `;
        }

        function downloadQRCode() {
            alert('QR Code download functionality ready. In production, this would generate and download a proper QR code.');
        }

        // Enhanced Quantity Calculator
        function updateQuantityFormula() {
            updateLiveCalculation();
        }

        function updateLiveCalculation() {
            const length = parseFloat(document.getElementById('estimation-modal-length')?.value) || 0;
            const width = parseFloat(document.getElementById('estimation-modal-width')?.value) || 0;
            const depth = parseFloat(document.getElementById('estimation-modal-depth')?.value) || 0;
            const repetitions = parseFloat(document.getElementById('estimation-modal-repetitions')?.value) || 1;
            const shape = document.getElementById('estimation-shape-type')?.value || 'rectangular';
            
            let total = 0;
            switch(shape) {
                case 'rectangular':
                    total = length * width * depth * repetitions;
                    break;
                case 'circular':
                    total = Math.PI * Math.pow(length/2, 2) * depth * repetitions;
                    break;
                case 'triangular':
                    total = (length * width * depth) / 2 * repetitions;
                    break;
                case 'complex':
                    total = length * width * depth * repetitions * 0.85; // Complex shape factor
                    break;
            }
            
            const liveCalc = document.getElementById('live-calculation');
            if (liveCalc) {
                liveCalc.textContent = `Total: ${total.toFixed(3)} mÂ³`;
            }
        }

        // Add event listeners for live calculation
        ['estimation-modal-length', 'estimation-modal-width', 'estimation-modal-depth', 'estimation-modal-repetitions'].forEach(id => {
            setTimeout(() => {
                const element = document.getElementById(id);
                if (element) {
                    element.addEventListener('input', updateLiveCalculation);
                }
            }, 1000);
        });

        // Utility Functions
        function generateEstimationId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Placeholder functions for unimplemented features
        function openBulkUpload() { alert('Bulk upload functionality will be implemented.'); }
        function enablePanoramicMode() { alert('Panoramic mode functionality will be implemented.'); }
        function generatePhotoReport() { alert('Photo report generation functionality will be implemented.'); }
        function enhancePhoto(index) { alert(`Photo ${index + 1} enhancement functionality will be implemented.`); }
        function analyzePhotoAI(index) { alert(`AI analysis for photo ${index + 1} functionality will be implemented.`); }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            console.log('Engineering Platform loaded successfully');
        });
    </script>
</body>
</html>
