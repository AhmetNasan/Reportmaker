<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/marzipano@6.1.1/dist/marzipano.css">


    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.8.2/jspdf.autotable.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/exif-js"></script>
    <script src="https://cdn.jsdelivr.net/npm/marzipano@6.1.1/dist/marzipano.min.js"></script>


    <style>
        :root {
            --primary-color: #2c3e50;
            --secondary-color: #3498db;
            --background-color: #ecf0f1;
            --card-bg: #ffffff;
            --text-color: #34495e;
            --shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            --border-radius: 8px;
            --success-color: #27ae60;
            --danger-color: #c0392b;
            --warning-color: #f39c12;

            /* From extra pages code */
            --primary-color-new: #007bff; /* Renamed to avoid clash if needed, but original primary is fine */
            --primary-color-rgb: 0, 123, 255;
            --background-color-new: #f0f4f8; /* Renamed */
            --glass-bg: rgba(255, 255, 255, 0.85);
            --glass-border: rgba(200, 210, 220, 0.7);
            --shadow-new: 0 4px 20px rgba(0, 0, 0, 0.12); /* Renamed */
            --text-color-new: #2c3e50; /* Renamed */
            --border-radius-new: 12px; /* Renamed */
        }

        /* Base */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: var(--background-color);
            margin: 0;
            color: var(--text-color);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        /* Page Visibility */
        .page {
            display: none;
            animation: fadeIn 0.4s ease-in-out;
            flex-grow: 1;
        }
        .page.active {
            display: flex;
            flex-direction: column;
        }
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(15px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Layouts */
        .main-container {
            width: 100%;
            max-width: 1800px;
            margin: 0 auto;
            padding: 20px;
            box-sizing: border-box;
        }
        .centered-container {
            justify-content: center;
            align-items: center;
            min-height: 100vh;
        }
        .app-grid {
            display: grid;
            grid-template-columns: 240px 1fr;
            gap: 20px;
            height: calc(100vh - 80px); /* Adjusted height as header is smaller */
        }

        /* Card Style */
        .card {
            background: var(--card-bg);
            padding: 25px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 20px;
        }

        /* Forms & Buttons */
        .form-card { max-width: 450px; width: 100%; }
        h1, h2, h3 { color: var(--primary-color); }
        input, select, textarea {
            width: 100%;
            padding: 12px;
            margin-bottom: 15px;
            border: 1px solid #bdc3c7;
            border-radius: var(--border-radius);
            box-sizing: border-box;
            font-size: 16px;
        }
        textarea { min-height: 120px; resize: vertical; }

        button, .btn {
            padding: 12px 20px;
            border-radius: var(--border-radius);
            border: none;
            background-color: var(--secondary-color);
            color: white;
            font-size: 16px;
            cursor: pointer;
            transition: all 0.3s;
            font-weight: 500;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }
        button:hover, .btn:hover { background-color: #2980b9; }
        .btn-primary { background-color: var(--primary-color); }
        .btn-primary:hover { background-color: #1a252f; }
        .btn-success { background-color: var(--success-color); }
        .btn-success:hover { background-color: #229954; }
        .btn-danger { background-color: var(--danger-color); }
        .btn-danger:hover { background-color: #a93226; }

        /* Header */
        .header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 15px 30px;
            background: var(--card-bg);
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 1.5em; }
        .header-actions { display: flex; gap: 15px; align-items: center; }

        /* Sidebar Navigation */
        .sidebar { padding: 20px; background: var(--card-bg); border-radius: var(--border-radius); }
        .sidebar .nav-btn {
            display: block; width: 100%; text-align: left;
            margin-bottom: 10px; background: none; color: var(--text-color);
            font-weight: 500; padding: 15px;
        }
        .sidebar .nav-btn.active, .sidebar .nav-btn:hover { background-color: #ecf0f1; color: var(--primary-color); }

        /* Map Container */
        #map-container { height: 100%; width: 100%; border-radius: var(--border-radius); }
        .leaflet-popup-content-wrapper { padding: 10px; }

        /* Tables */
        .table-container { overflow-x: auto; margin-top: 20px; }
        table { width: 100%; border-collapse: collapse; background: white; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #ecf0f1; }
        th { background-color: var(--primary-color); color: white; font-weight: 600; }
        tr:hover { background-color: #f8f9fa; }
        td[contenteditable="true"] { background-color: #fdfde2; }

        /* Popups / Modals */
        .modal-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; justify-content: center; align-items: center; z-index: 1000;
        }
        .modal-overlay.active { display: flex; }
        .modal-content {
            background: white; padding: 30px; border-radius: var(--border-radius);
            width: 90%; max-width: 600px; position: relative;
        }
        .modal-close-btn {
            position: absolute; top: 15px; right: 20px;
            font-size: 30px; cursor: pointer; border: none; background: none; color: #7f8c8d;
        }

        /* Specific Component Styles */
        #contract-selection-list, #saved-contracts-list {
            display: grid; grid-template-columns: repeat(auto-fill, minmax(350px, 1fr)); gap: 25px;
        }
        
        .message {
            padding: 15px; border-radius: var(--border-radius); margin-top: 15px;
            text-align: center;
        }
        .message.error { background-color: #fbeae5; color: var(--danger-color); }
        .message.success { background-color: #eaf7eb; color: var(--success-color); }
        .message.pending { background-color: #fef9e7; color: var(--warning-color); }

        .toggle-link {
            display: block; text-align: center; margin-top: 20px;
            color: var(--secondary-color); text-decoration: none;
        }

        /* --- New Styles from Extra Pages Code --- */
        .main-container-report { /* Renamed to avoid conflict */
            width: 100%;
            max-width: 1200px;
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .glass-card {
            background-color: var(--glass-bg);
            border: 1px solid var(--glass-border);
            border-radius: var(--border-radius-new);
            box-shadow: var(--shadow-new);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            padding: 15px;
        }

        /* Header & Tabs */
        .main-header-report { /* Renamed to avoid conflict */
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: relative;
            z-index: 110;
        }
        .main-title-report { font-size: clamp(18px, 5vw, 24px); font-weight: bold; color: var(--text-color-new); }
        .menu-button { background: none; border: none; font-size: 28px; cursor: pointer; position: relative; }
        .dropdown-menu {
            display: none;
            position: absolute;
            top: 40px;
            background-color: var(--glass-bg);
            backdrop-filter: blur(15px); -webkit-backdrop-filter: blur(15px);
            border-radius: var(--border-radius-new); box-shadow: var(--shadow-new);
            z-index: 2500;
            width: 260px; overflow: hidden;
            border: 1px solid var(--glass-border);
        }
        html[dir="ltr"] .dropdown-menu { right: 0; }
        html[dir="rtl"] .dropdown-menu { left: 0; }
        .dropdown-menu button {
            display: flex; align-items: center; gap: 12px;
            width: 100%; padding: 10px 15px;
            background: none; border: none; font-size: 15px; cursor: pointer; color: var(--text-color-new);
        }
        html[dir="ltr"] .dropdown-menu button { text-align: left; }
        html[dir="rtl"] .dropdown-menu button { text-align: right; }
        .dropdown-menu button:hover { background-color: rgba(var(--primary-color-rgb), 0.1); }
        .menu-button:focus-within .dropdown-menu { display: block; }
        hr { border: none; border-top: 1px solid var(--glass-border); margin: 5px 0; }
        
        #projects-list { list-style: none; padding: 0; }
        #projects-list li {
            display: flex; justify-content: space-between; align-items: center;
            padding: 8px; border-bottom: 1px solid var(--glass-border);
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 10px;
            box-shadow: var(--shadow);
        }
        #projects-list .project-name { cursor: pointer; font-weight: bold; }
        #projects-list .project-name:hover { color: var(--primary-color-new); }
        #projects-list button { background-color: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; padding: 4px 8px; }

        /* Forms & Inputs */
        .info-card { display: flex; justify-content: space-between; align-items: center; }
        
        #display-date {
            background: transparent;
            border: none;
            color: var(--text-color-new);
            font-family: inherit;
            font-size: inherit;
            padding: 0;
            margin: 0 5px;
            cursor: pointer;
        }
        #display-date::-webkit-calendar-picker-indicator {
            background: none;
        }

        #uploaded-logo { max-height: 60px; max-width: 120px; object-fit: contain; border-radius: 8px; cursor: pointer; }
        .form-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 15px; }
        .card h3 {
            margin: 0 0 10px 0; color: var(--primary-color-new);
            border-bottom: 1px solid rgba(var(--primary-color-rgb), 0.2); padding-bottom: 8px; font-size: 18px;
        }
        .form-group { display: flex; flex-direction: column; gap: 10px; }
        .form-row { display: flex; gap: 10px; align-items: center; }
        .form-row input { flex: 1; }
        input[type="text"], input[type="number"], input[type="url"], .form-button, select {
            width: 100%; padding: 10px; border-radius: 8px;
            border: 1px solid var(--glass-border); background-color: rgba(255, 255, 255, 0.9);
            box-sizing: border-box; font-size: 14px;
            color: var(--text-color-new);
        }
        input::placeholder { color: #889; }
        .primary-button {
            border: none; background-color: var(--primary-color-new);
            color: white; font-weight: bold; cursor: pointer; transition: background-color 0.3s; padding: 12px; border-radius: 8px; font-size: 15px;
        }
        
        #drop-zone {
            border: 2px dashed rgba(var(--primary-color-rgb), 0.5);
            border-radius: var(--border-radius-new);
            padding: 20px 15px;
            text-align: center;
            color: var(--primary-color-new);
            font-weight: 500;
            transition: all 0.3s;
            cursor: pointer;
            background-color: rgba(var(--primary-color-rgb), 0.05);
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            gap: 15px;
        }
        #drop-zone:hover { background-color: rgba(var(--primary-color-rgb), 0.1); }
        #drop-zone p { margin: 0; }
        .drop-zone-buttons { display: flex; gap: 20px; }
        .icon-button {
            width: 50px;
            height: 50px;
            border-radius: 50%;
            border: 2px solid var(--primary-color-new);
            background-color: #fff;
            color: var(--primary-color-new);
            font-size: 24px;
            cursor: pointer;
            display: flex;
            justify-content: center;
            align-items: center;
            transition: all 0.2s ease-in-out;
        }
        .icon-button:hover {
            background-color: var(--primary-color-new);
            color: #fff;
            transform: scale(1.1);
        }
        #photo-previews img { max-height: 70px; border-radius: 8px; }

        /* GPS Section & Map */
        #report-map { width: 100%; height: 120px; border-radius: 12px; background-color: #e9ecef; border: 1px solid var(--glass-border); overflow: hidden; margin-bottom: 10px; } /* Renamed */
        .location-mode-switcher {
            display: flex;
            width: 100%;
            border-radius: 8px;
            overflow: hidden;
            border: 1px solid var(--glass-border);
            margin-bottom: 10px;
        }
        .location-mode-btn {
            flex: 1;
            padding: 8px;
            border: none;
            background-color: rgba(255,255,255,0.5);
            cursor: pointer;
            transition: background-color 0.3s;
            font-size: 14px;
            font-weight: 500;
        }
        .location-mode-btn:not(:last-child) {
            border-right: 1px solid var(--glass-border);
        }
        .location-mode-btn.active {
            background-color: var(--primary-color-new);
            color: white;
            font-weight: bold;
        }
        .location-panel {
            display: flex;
            flex-direction: column;
            gap: 10px;
            margin-bottom: 10px;
        }
        .location-display-wrapper {
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }
        #insert-location-btn {
            padding: 6px 10px;
            font-size: 12px;
            border-radius: 6px;
            background-color: #28a745;
        }

        /* Table */
        .table-controls { display: flex; justify-content: space-between; gap: 8px; margin-bottom: 10px; align-items: center; }
        .table-controls button {
            background-color: rgba(255,255,255,0.5); border: 1px solid var(--glass-border);
            border-radius: 8px; padding: 6px 10px; font-size: 16px; cursor: pointer;
        }
        .table-controls button:hover { background-color: rgba(255,255,255,0.8); }
        table { width: 100%; border-collapse: collapse; }
        th { background-color: rgba(var(--primary-color-rgb), 0.1); padding: 10px; text-align: center; }
        td { border-top: 1px solid var(--glass-border); padding: 8px; text-align: center; vertical-align: middle; }
        tbody tr:nth-child(even) { background-color: rgba(0,0,0,0.02); }
        .photo-wrapper {
            display: flex;
            flex-wrap: wrap;
            gap: 5px;
            justify-content: center;
            align-items: center;
        }
        .photo-wrapper img {
            max-height: 100px;
            border-radius: 5px;
            cursor: pointer;
            object-fit: cover;
        }

        /* Table Drag & Drop */
        .draggable-row {
            cursor: grab;
        }
        .draggable-row.dragging {
            opacity: 0.5;
            border: 2px dashed var(--primary-color-new);
        }


        /* --- Cost Estimation Tab Styles --- */
        .estimation-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .estimation-header #client-logo-est, .estimation-header #company-logo-est {
            max-height: 60px;
            max-width: 150px;
            object-fit: contain;
            cursor: pointer;
        }
        .estimation-header .estimation-title {
            text-align: center;
            flex-grow: 1;
        }
        .estimation-title h2, .estimation-title h3 {
            margin: 0;
            padding: 2px 5px;
        }
        .estimation-title h2:hover, .estimation-title h3:hover {
            background-color: rgba(var(--primary-color-rgb), 0.1);
        }
        .estimation-details {
            display: flex;
            flex-direction: column;
            gap: 5px;
            margin: 10px 0;
        }
        .estimation-details .form-row {
            gap: 15px;
        }
        .estimation-details label {
            font-weight: bold;
            flex-basis: 150px;
        }
        .estimation-details input {
            flex-grow: 1;
        }
        .boq-entry-card .form-grid-est {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 10px;
            align-items: end;
        }
        .boq-ref-group {
            display: flex;
            gap: 5px;
            align-items: end;
        }
        .boq-ref-group select {
            flex-grow: 1;
        }
        .boq-entry-card .form-group-est {
             display: flex; flex-direction: column;
        }
        .boq-entry-card label {
            margin-bottom: 4px;
            font-size: 13px;
            font-weight: 500;
        }
        .boq-entry-card .description-group {
             grid-column: 1 / -1;
        }
        #cost-estimation-table {
            border: 1px solid black;
        }
        #cost-estimation-table th {
            background-color: transparent;
            color: black;
            font-weight: bold;
            border: 1px solid black;
        }
        #cost-estimation-table td {
            border: 1px solid black;
            text-align: right;
            padding: 4px 8px;
        }
        #cost-estimation-table td.description-cell {
            text-align: left;
        }
        #cost-estimation-table tfoot td {
            font-weight: bold;
        }
        
        /* Vehicle Tracking / Integrated Map Tab */
        .integrated-map-container {
             height: 80vh; display: flex; flex-direction: column;
        }
        #vehicle-map {
            flex-grow: 1;
            width: 100%;
            border-radius: var(--border-radius-new);
            border: 1px solid var(--glass-border);
        }
        #vehicle-map-controls { 
            display: flex; flex-wrap: wrap; gap: 10px; margin-bottom: 10px; align-items: center;
        }
        #vehicle-map-controls button { 
             padding: 8px 12px; font-size: 14px; 
        }
        .vehicle-popup-actions a {
            margin-right: 10px;
            text-decoration: none;
            color: var(--primary-color-new);
            font-weight: bold;
        }


        /* Modals */
        .modal {
            display: none; position: fixed; z-index: 2000;
            left: 0; top: 0; width: 100%; height: 100%;
            overflow: auto; background-color: rgba(0,0,0,0.5);
            align-items: center; justify-content: center;
        }
        .modal-content-report { /* Renamed to avoid conflict */
            padding: 20px; width: 90%; max-width: 450px; display: flex; flex-direction: column; gap: 10px;
            background: white; border-radius: var(--border-radius-new); box-shadow: var(--shadow-new);
        }
        
        /* FAB */
        .fab-container { position: fixed; display: flex; flex-direction: column; gap: 12px; z-index: 100; }
        html[dir="ltr"] .fab-container { bottom: 20px; right: 20px; }
        html[dir="rtl"] .fab-container { bottom: 20px; left: 20px; }
        .fab {
            width: 50px; height: 50px; border-radius: 50%;
            color: white; border: none; box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-size: 22px; cursor: pointer; display: flex; justify-content: center; align-items: center;
            transition: transform 0.2s;
        }
        .fab:hover { transform: scale(1.1); }
        #camera-fab { background-color: #28a745; }
        #add-fab { background-color: var(--primary-color-new); }
        
        /* Other minor fixes for clarity */
        .footer { padding: 10px; margin-top: 10px; text-align:center; font-size: 12px; }

        /* Camera Modal Specific Styles */
        #camera-modal-content {
            background-color: black;
            padding: 0;
            width: 90vw;
            height: 90vh;
            max-width: 600px; /* Limit camera feed size */
            max-height: 800px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
        }

        #camera-feed {
            width: 100%;
            height: 100%;
            object-fit: contain; /* or 'cover' depending on preference */
            transform: scaleX(-1); /* Mirror camera for selfie view */
        }

        #capture-btn {
            position: absolute;
            bottom: 20px;
            width: 60px;
            height: 60px;
            background-color: white;
            border: 5px solid var(--primary-color-new);
            border-radius: 50%;
            cursor: pointer;
            z-index: 2010;
            display: flex; /* Make it a flex container to center content */
            justify-content: center; /* Center horizontally */
            align-items: center; /* Center vertically */
            font-size: 30px; /* Size for the icon */
            color: var(--primary-color-new); /* Color for the icon */
        }

        #close-camera-btn {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(255, 255, 255, 0.5);
            border: none;
            border-radius: 50%;
            width: 30px;
            height: 30px;
            font-size: 18px;
            cursor: pointer;
            z-index: 2010;
        }
        #preview-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.7);
            z-index: 3000;
            justify-content: center;
            align-items: center;
        }
        #preview-content {
            background-color: white;
            width: 90%;
            height: 90%;
            overflow: auto;
            padding: 20px;
            position: relative;
            border-radius: var(--border-radius-new);
        }
        #preview-content img {
            max-width: 100%;
            height: auto;
            display: block;
            margin-bottom: 10px;
        }

        /* Hide print-specific elements by default */
        .print-header-replacement, .print-date-footer {
            display: none;
        }
    
        /* CSS for printing */
        @media print {
            /* --- General Hiding Rules --- */
            body > *:not(.main-container) {
                display: none !important;
            }
            .main-container > *:not(.printable-area) {
                 display: none !important;
            }
            .printable-area {
                display: flex !important;
                flex-direction: column;
                gap: 15px;
            }
            .main-container {
                display: block !important;
            }

            .printable-area .menu-button,
            .printable-area .boq-entry-card,
            .printable-area .table-controls,
            .printable-area .form-grid,
            .printable-area #main-report > .primary-button,
            .tabs-report, /* Renamed */
            /* Hide all buttons during print preview or printing */
            button, .fab-container {
                 display: none !important;
            }
            /* Specific buttons to hide for vehicle-tracking-tab print */
            #vehicle-map-controls button {
                display: none !important;
            }
            
            /* --- Page Setup --- */
            @page {
                size: A4 landscape;
                margin: 15mm;
            }

            /* --- General Styling Resets for Print --- */
            body {
                background: #fff !important;
                color: #000 !important;
                margin: 0;
                padding: 0;
            }

            .glass-card, .main-header-report, .estimation-header { /* Renamed */
                background: transparent !important;
                border: none !important;
                box-shadow: none !important;
                backdrop-filter: none !important;
                -webkit-backdrop-filter: none !important;
                padding: 0;
                color: #000;
            }
            
            .main-container-report, .printable-area { /* Renamed */
                width: 100% !important;
                max-width: 100% !important;
                box-shadow: none !important;
            }
            
            .main-title-report { /* Renamed */
                color: #000;
            }

            /* --- NEW PRINT HEADER STYLES --- */
            .info-card, .estimation-header {
               position: relative;
               border-bottom: 2px solid #000;
               padding-bottom: 25px; /* Make space for the date below */
               page-break-after: avoid;
               display: block !important;
            }
            /* Hide all original direct children in print */
            .info-card > *:not(.print-header-replacement):not(.print-date-footer),
            .estimation-header > *:not(.print-header-replacement):not(.print-date-footer) {
                display: none !important;
            }

            /* Show and style the replacement header */
            .print-header-replacement {
                display: flex !important;
                justify-content: space-between;
                align-items: center;
                width: 100%;
            }

            .print-header-replacement .print-logo {
                display: block !important;
                max-height: 60px;
                max-width: 120px;
                object-fit: contain;
            }

            .print-header-replacement .print-title-container {
                display: flex !important;
                flex-direction: column;
                justify-content: center;
                align-items: center;
                text-align: center;
                font-size: 14pt;
                flex-grow: 1;
                padding: 0 10px;
            }
            .print-header-replacement .print-title-container b {
                line-height: 1.2;
            }

            .print-date-footer {
                display: block !important;
                position: absolute;
                bottom: 5px;
                left: 0;
                font-size: 8pt;
            }
            .print-date-footer .date-subtitle {
                font-weight: bold;
            }

            /* --- Table Styling --- */
            .table-container {
                max-height: none !important;
                overflow: visible !important;
            }
            
            table {
                width: 100%;
                border-collapse: collapse;
                font-size: 9pt;
                page-break-inside: auto;
            }

            thead {
                display: table-header-group; 
            }

            tbody tr {
               page-break-inside: avoid !important;
               page-break-after: auto;
            }

            td, th {
                border: 1px solid #999 !important;
                padding: 5px;
                text-align: center;
                vertical-align: middle;
            }
            
            #report-table td:nth-child(2),
            #report-table th:nth-child(2),
            #cost-estimation-table td:nth-child(2),
            #cost-estimation-table th:nth-child(2) {
                text-align: left !important;
                vertical-align: middle !important;
            }

            #cost-estimation-table th, #cost-estimation-table td {
                 border: 1px solid black !important;
            }

            th {
                background-color: #e0e0e0 !important;
                color: #000 !important;
                -webkit-print-color-adjust: exact;
                color-adjust: exact;
            }
             #cost-estimation-table th {
                background-color: transparent !important;
             }
            
            /* --- Image/QR Styling in Table --- */
            .photo-wrapper {
                display: block !important;
                width: 100%;
                padding: 0;
                margin: 0;
                line-height: 0;
            }
            .photo-wrapper img {
                display: block !important;
                width: 100% !important;
                height: auto !important;
                object-fit: contain !important;
                border: none !important;
                margin: 0;
                padding: 0;
            }
            .photo-wrapper img:last-child {
                margin-bottom: 0;
            }
        }

        /* Marzipano Viewer */
        .marzipano-viewer {
            width: 100%;
            height: 500px; /* Adjust as needed */
            background-color: #000;
            border-radius: var(--border-radius-new);
            overflow: hidden;
        }

        /* Notebook Styles */
        #notebook-content {
            display: flex;
            flex-direction: column;
            gap: 20px;
        }
        .note-entry {
            background-color: var(--card-bg);
            padding: 15px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 15px;
        }
        .note-entry h3 {
            margin-top: 0;
            margin-bottom: 10px;
            color: var(--primary-color);
        }
        .note-meta {
            font-size: 0.8em;
            color: #777;
            margin-bottom: 10px;
        }
        .note-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        #note-tags-input {
            width: calc(100% - 20px);
            padding: 8px;
            margin-top: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
        }
        .tag-pill {
            display: inline-block;
            background-color: var(--secondary-color);
            color: white;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8em;
            margin-right: 5px;
            margin-bottom: 5px;
        }

        /* Drawing Canvas Styles */
        #drawing-canvas-container {
            position: relative;
            width: 100%;
            background-color: #f0f0f0;
            border: 1px solid #ccc;
            border-radius: var(--border-radius);
            overflow: hidden;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        #drawing-canvas {
            background-color: white;
            cursor: crosshair;
            display: block; /* Ensures no extra space below canvas */
        }
        #drawing-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 10px;
            padding: 10px;
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            margin-bottom: 15px;
            box-shadow: var(--shadow);
        }
        #drawing-toolbar button, #drawing-toolbar input[type="color"], #drawing-toolbar input[type="number"] {
            padding: 8px 12px;
            border-radius: 5px;
            border: 1px solid #ccc;
            background-color: #f0f0f0;
            cursor: pointer;
        }
        #drawing-toolbar button.active {
            background-color: var(--secondary-color);
            color: white;
        }
        #drawing-image-upload {
            display: none;
        }
        
        /* Professional Contract Management Styles */
        .contract-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            padding: 30px;
            margin-bottom: 30px;
            color: white;
            box-shadow: 0 15px 35px rgba(102, 126, 234, 0.3);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: flex-start;
            margin-bottom: 30px;
        }

        .header-info h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin: 0 0 10px 0;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-info h1 i {
            font-size: 2.2rem;
        }

        .header-subtitle {
            font-size: 1.1rem;
            opacity: 0.9;
            margin: 0;
        }

        .header-actions {
            display: flex;
            gap: 15px;
            align-items: center;
        }

        .professional-btn {
            padding: 12px 20px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            font-size: 14px;
            white-space: nowrap;
        }

        .professional-btn.primary {
            background: white;
            color: #667eea;
            box-shadow: 0 4px 15px rgba(255,255,255,0.3);
        }

        .professional-btn.primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(255,255,255,0.4);
        }

        .professional-btn.secondary {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
        }

        .professional-btn.secondary:hover {
            background: rgba(255,255,255,0.3);
            transform: translateY(-2px);
        }
        
        .professional-btn.info {
            background: rgba(0,123,255,0.2);
            color: white;
            border: 1px solid rgba(0,123,255,0.3);
        }

        .professional-btn.info:hover {
            background: rgba(0,123,255,0.3);
            transform: translateY(-2px);
        }

        .contract-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
        }

        .stat-card {
            background: rgba(255,255,255,0.15);
            backdrop-filter: blur(10px);
            border-radius: 16px;
            padding: 25px;
            display: flex;
            align-items: center;
            gap: 20px;
            border: 1px solid rgba(255,255,255,0.2);
            transition: all 0.3s ease;
        }

        .stat-card:hover {
            background: rgba(255,255,255,0.2);
            transform: translateY(-3px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            background: rgba(255,255,255,0.2);
            border-radius: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stat-info {
            flex: 1;
        }

        .stat-number {
            display: block;
            font-size: 2rem;
            font-weight: 700;
            line-height: 1;
        }

        .stat-label {
            font-size: 0.9rem;
            opacity: 0.8;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contract-controls {
            background: white;
            border-radius: 16px;
            padding: 25px;
            margin-bottom: 30px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 30px;
        }
        
        .search-section {
            display: flex;
            align-items: center;
            gap: 20px;
            flex: 1;
        }
        
        .search-box-advanced {
            position: relative;
            flex: 1;
            max-width: 500px;
        }
        
        .search-box-advanced i {
            position: absolute;
            left: 15px;
            top: 50%;
            transform: translateY(-50%);
            color: #667eea;
            font-size: 1.1rem;
        }

        .search-box-advanced input {
            width: 100%;
            padding: 15px 20px 15px 45px;
            border: 2px solid #e8ecf4;
            border-radius: 12px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .search-box-advanced input:focus {
            outline: none;
            border-color: #667eea;
            background: white;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .filter-controls {
            display: flex;
            gap: 15px;
        }

        .filter-controls select {
            padding: 12px 15px;
            border: 2px solid #e8ecf4;
            border-radius: 10px;
            background: white;
            font-size: 14px;
            color: #333;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .filter-controls select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .view-toggle {
            display: flex;
            background: #f1f5f9;
            border-radius: 10px;
            padding: 4px;
        }

        .view-btn {
            padding: 10px 15px;
            border: none;
            background: transparent;
            color: #64748b;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1.1rem;
        }

        .view-btn.active {
            background: white;
            color: #667eea;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
        }
        
        .contract-card {
            background: white;
            border-radius: 16px;
            padding: 25px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.08);
            border: 1px solid #e8ecf4;
            transition: all 0.3s ease;
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .contract-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }

        .contract-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 20px 40px rgba(0,0,0,0.15);
        }

        .contract-card h3 {
            margin: 0 0 15px 0;
            font-size: 1.3rem;
            font-weight: 700;
            color: #1e293b;
            line-height: 1.4;
        }

        .contract-info {
            display: grid;
            gap: 12px;
            margin-bottom: 20px;
        }

        .contract-info-item {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 0.9rem;
        }

        .contract-info-item i {
            width: 20px;
            color: #667eea;
            font-size: 0.9rem;
        }

        .contract-info-item strong {
            color: #475569;
            min-width: 80px;
        }

        .contract-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.8rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .contract-status.active {
            background: #dcfce7;
            color: #166534;
        }

        .contract-status.pending {
            background: #fef3c7;
            color: #92400e;
        }

        .contract-status.completed {
            background: #e0e7ff;
            color: #3730a3;
        }

        .contract-status.expired {
            background: #fee2e2;
            color: #991b1b;
        }

        .contract-actions {
            display: flex;
            gap: 10px;
            margin-top: 20px;
            padding-top: 20px;
            border-top: 1px solid #e8ecf4;
        }

        .contract-actions .professional-btn {
            flex: 1;
            justify-content: center;
            padding: 10px 15px;
            font-size: 0.85rem;
        }
        
        .empty-state {
            text-align: center;
            padding: 80px 20px;
            color: #64748b;
        }

        .empty-icon {
            font-size: 4rem;
            color: #cbd5e1;
            margin-bottom: 20px;
        }

        .empty-state h3 {
            font-size: 1.5rem;
            font-weight: 600;
            margin: 0 0 10px 0;
            color: #475569;
        }

        .empty-state p {
            font-size: 1rem;
            margin: 0 0 30px 0;
            color: #64748b;
        }
        
        .modal-content.professional {
            max-width: 900px;
            max-height: 90vh;
            padding: 0;
            border-radius: 20px;
            overflow: hidden;
        }

        .modal-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 25px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-title {
            display: flex;
            align-items: center;
            gap: 15px;
            font-size: 1.5rem;
            font-weight: 700;
        }

        .modal-title i {
            font-size: 1.4rem;
        }

        .modal-close {
            background: rgba(255,255,255,0.2);
            border: none;
            color: white;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .modal-close:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.1);
        }

        .modal-body {
            padding: 30px;
            max-height: 60vh;
            overflow-y: auto;
        }

        .modal-footer {
            padding: 20px 30px;
            background: #f8fafc;
            border-top: 1px solid #e8ecf4;
            display: flex;
            justify-content: flex-end;
            gap: 15px;
        }
        
        .professional-form {
            display: flex;
            flex-direction: column;
            gap: 30px;
        }

        .form-section {
            background: #f8fafc;
            border-radius: 15px;
            padding: 25px;
            border: 1px solid #e8ecf4;
        }

        .section-title {
            display: flex;
            align-items: center;
            gap: 12px;
            font-size: 1.2rem;
            font-weight: 600;
            color: #1e293b;
            margin: 0 0 20px 0;
            padding-bottom: 15px;
            border-bottom: 2px solid #e8ecf4;
        }

        .section-title i {
            color: #667eea;
            font-size: 1.1rem;
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        .form-row:last-child {
            margin-bottom: 0;
        }

        .form-group {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .form-group.full-width {
            grid-column: 1 / -1;
        }

        .form-group label {
            font-weight: 600;
            color: #374151;
            font-size: 0.9rem;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            padding: 12px 15px;
            border: 2px solid #e8ecf4;
            border-radius: 10px;
            font-size: 14px;
            transition: all 0.3s ease;
            background: white;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .field-helper {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 4px;
        }

        .input-with-addon {
            position: relative;
            display: flex;
            align-items: center;
        }

        .input-addon {
            position: absolute;
            left: 15px;
            color: #667eea;
            font-weight: 600;
            z-index: 1;
        }

        .input-with-addon input {
            padding-left: 35px;
        }
        
        .file-upload-area {
            border: 2px dashed #cbd5e1;
            border-radius: 12px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
            background: #f8fafc;
        }

        .file-upload-area:hover {
            border-color: #667eea;
            background: #f1f5f9;
        }

        .file-upload-area i {
            font-size: 2rem;
            color: #667eea;
            margin-bottom: 15px;
            display: block;
        }

        .upload-text {
            display: block;
            font-weight: 600;
            color: #374151;
            margin-bottom: 5px;
        }

        .upload-helper {
            font-size: 0.85rem;
            color: #6b7280;
        }

        .file-preview {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 15px;
            background: #f0f9ff;
            border: 1px solid #bae6fd;
            border-radius: 10px;
            margin-top: 15px;
        }

        .file-preview i {
            color: #0369a1;
            font-size: 1.2rem;
        }

        .file-name {
            flex: 1;
            color: #0369a1;
            font-weight: 500;
        }

        .remove-file {
            background: #ef4444;
            color: white;
            border: none;
            width: 30px;
            height: 30px;
            border-radius: 6px;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
        }

        .remove-file:hover {
            background: #dc2626;
            transform: scale(1.1);
        }
        
        .template-actions {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .template-btn {
            padding: 12px 20px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            font-weight: 600;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: all 0.3s ease;
        }

        .template-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }
    </style>
</head>
<body>

    <div id="app-container" class="page active">
        <header class="header">
            <h1 id="app-main-title">Project Dashboard</h1>
            <div class="header-actions">
                <select id="language-switcher" onchange="switchLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ar"></option>
                </select>
            </div>
        </header>

        <div class="main-container app-grid">
            <aside class="sidebar">
                <button id="nav-contracts" class="nav-btn active" onclick="showAppPage('contracts-page')"><i class="fa-solid fa-file-contract"></i> Contracts</button>
                <button id="nav-map" class="nav-btn" onclick="showAppPage('map-page')"><i class="fa-solid fa-map-location-dot"></i> GIS Map</button>
                <button id="nav-inspection-report" class="nav-btn" onclick="showAppPage('inspection-report-page')"><i class="fa-solid fa-file-lines"></i> Inspection Report</button>
                <button id="nav-cost-estimation" class="nav-btn" onclick="showAppPage('cost-estimation-page')"><i class="fa-solid fa-calculator"></i> Cost Estimation</button>
                <button id="nav-ai" class="nav-btn" onclick="showAppPage('ai-page')"><i class="fa-solid fa-robot"></i> AI Analysis</button>
                <button id="nav-saved-projects" class="nav-btn" onclick="showAppPage('saved-projects-page')"><i class="fa-solid fa-folder-open"></i> Saved Projects</button>
                <button id="nav-notebook" class="nav-btn" onclick="showAppPage('notebook-page')"><i class="fa-solid fa-book"></i> Notebook</button>
                <button id="nav-drawing" class="nav-btn" onclick="showAppPage('drawing-page')"><i class="fa-solid fa-pencil-ruler"></i> Drawing</button>
                <button id="nav-notifications" class="nav-btn" onclick="showAppPage('notifications-page')"><i class="fa-solid fa-bell"></i> Notifications</button>
            </aside>

            <main id="app-content-area">
                <div id="contracts-page" class="app-content active">
                    <!-- Professional Contract Management Header -->
                    <div class="contract-header">
                        <div class="header-content">
                            <div class="header-info">
                                <h1><i class="fas fa-file-contract"></i> Contract Management</h1>
                                <p class="header-subtitle">Manage your engineering contracts and project agreements</p>
                            </div>
                            <div class="header-actions">
                                <button class="professional-btn primary" onclick="showModal('contract-form-modal')">
                                    <i class="fas fa-plus"></i> New Contract
                                </button>
                                <button class="professional-btn secondary" onclick="exportAllContracts()">
                                    <i class="fas fa-download"></i> Export All
                                </button>
                                <button class="professional-btn info" onclick="importContracts()">
                                    <i class="fas fa-upload"></i> Import
                                </button>
                            </div>
                        </div>
                        <div class="contract-stats">
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-file-contract"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="total-contracts">0</span>
                                    <span class="stat-label">Total Contracts</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-clock"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="active-contracts">0</span>
                                    <span class="stat-label">Active</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-dollar-sign"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="total-value">$0</span>
                                    <span class="stat-label">Total Value</span>
                                </div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-icon">
                                    <i class="fas fa-calendar-check"></i>
                                </div>
                                <div class="stat-info">
                                    <span class="stat-number" id="upcoming-deadlines">0</span>
                                    <span class="stat-label">Due Soon</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Advanced Contract Search & Filter -->
                    <div class="contract-controls">
                        <div class="search-section">
                            <div class="search-box-advanced">
                                <i class="fas fa-search"></i>
                                <input type="text" id="contract-search" placeholder="Search contracts by title, number, or company..." onkeyup="filterContracts()">
                            </div>
                            <div class="filter-controls">
                                <select id="status-filter" onchange="filterContracts()">
                                    <option value="">All Status</option>
                                    <option value="active">Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="pending">Pending</option>
                                    <option value="expired">Expired</option>
                                </select>
                                <select id="sort-contracts" onchange="sortContracts()">
                                    <option value="date-desc">Newest First</option>
                                    <option value="date-asc">Oldest First</option>
                                    <option value="value-desc">Highest Value</option>
                                    <option value="value-asc">Lowest Value</option>
                                    <option value="title-asc">Title A-Z</option>
                                </select>
                            </div>
                        </div>
                        <div class="view-toggle">
                            <button class="view-btn active" onclick="switchView('grid')" data-view="grid">
                                <i class="fas fa-th-large"></i>
                            </button>
                            <button class="view-btn" onclick="switchView('list')" data-view="list">
                                <i class="fas fa-list"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Professional Contracts Grid -->
                    <div class="contracts-container">
                        <div id="saved-contracts-list" class="contracts-grid">
                            <!-- Contracts will be loaded here -->
                        </div>
                        
                        <!-- Empty State -->
                        <div id="contracts-empty-state" class="empty-state">
                            <div class="empty-icon">
                                <i class="fas fa-file-contract"></i>
                            </div>
                            <h3>No Contracts Found</h3>
                            <p>Get started by creating your first engineering contract</p>
                            <button class="professional-btn primary" onclick="showModal('contract-form-modal')">
                                <i class="fas fa-plus"></i> Create First Contract
                            </button>
                        </div>
                    </div>
                </div>
                <div id="map-page" class="app-content" style="display:none; height:100%;">
                    <div id="map-container"></div>
                    <div class="card" style="margin-top: 20px;">
                        <h3>GIS Map Data</h3>
                        <button class="btn" onclick="exportMapJson()">Export Map JSON</button>
                        <input type="file" id="import-map-json" style="display:none;" onchange="importMapJson(event)">
                        <button class="btn" onclick="document.getElementById('import-map-json').click()">Import Map JSON</button>
                        <button class="btn" onclick="exportMapPdf()">Export Map PDF</button>
                        <div id="map-overlays-section" style="margin-top: 20px;">
                            <h4>Map Overlays (Simulated)</h4>
                            <p>Real-time traffic, weather, and risk zone data would be integrated here from a backend service.</p>
                            <button class="btn" onclick="addNotification('GIS', 'Simulated: Traffic congestion detected near project site.', 'warning')">Simulate Traffic Alert</button>
                            <button class="btn" onclick="addNotification('GIS', 'Simulated: Severe weather warning for the region.', 'danger')">Simulate Weather Alert</button>
                        </div>
                    </div>
                </div>
                <div id="tables-page" class="app-content" style="display:none;">
                     <div class="card">
                        <h2><i class="fa-solid fa-table"></i> Bill of Quantities (BOQ)</h2>
                        <div style="display:flex; gap: 10px; margin-bottom: 20px;">
                             <button class="btn-success" onclick="addBoqRow()"><i class="fa-solid fa-plus"></i> Add Row</button>
                             <button class="btn" onclick="exportTableToCsv('boq-table.csv')"><i class="fa-solid fa-file-csv"></i> Export to CSV</button>
                             <button class="btn" onclick="exportTableToPdf()"><i class="fa-solid fa-file-pdf"></i> Export to PDF</button>
                             <button class="btn" onclick="alert('This feature requires a backend API for PDF to Excel conversion.')"><i class="fa-solid fa-file-excel"></i> PDF to Excel (Backend)</button>
                        </div>
                        <div class="table-container" id="boq-table-container">
                             <table id="boq-table">
                                <thead>
                                    <tr>
                                        <th>BOQ Ref.</th>
                                        <th>Asset</th>
                                        <th>Description</th>
                                        <th>Dimensions (L x W x H)</th>
                                        <th>Unit</th>
                                        <th>Rate</th>
                                        <th>Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="boq-table-body">
                                    </tbody>
                            </table>
                        </div>
                    </div>
                </div>
                <div id="ai-page" class="app-content" style="display:none;">
                    <div class="card">
                         <h2><i class="fa-solid fa-robot"></i> AI Road Defect Analysis</h2>
                         <p>Upload a road surface image to analyze for defects.</p>
                         <input type="file" id="ai-image-upload" accept="image/*">
                         <button class="btn-primary" onclick="handleAIAnalysis()"><i class="fa-solid fa-magnifying-glass"></i> Analyze with AI</button>
                    </div>
                    <div class="card" id="ai-results-card" style="display:none;">
                        <h3>Analysis Result</h3>
                        <div id="ai-spinner" style="display:none; text-align:center; padding:20px;"><i class="fa-solid fa-spinner fa-spin fa-2x"></i><p>Analyzing...</p></div>
                        <div id="ai-results-table" class="table-container"></div>
                        <div style="display:flex; gap: 10px; margin-top: 20px;">
                            <button class="btn" onclick="exportAiResultsToCsv()"><i class="fa-solid fa-file-csv"></i> Export to CSV</button>
                            <button class="btn" onclick="exportAiResultsToPdf()"><i class="fa-solid fa-file-pdf"></i> Export to PDF</button>
                        </div>
                    </div>
                </div>
                <div id="notifications-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-bell"></i> Notifications</h2>
                        <div class="table-container">
                            <table id="notifications-table">
                                <thead><tr><th>Date</th><th>Type</th><th>Message</th></tr></thead>
                                <tbody id="notifications-table-body"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Inspection Report Page Content (formerly main-report) -->
                <div id="inspection-report-page" class="app-content" style="display:none;">
                    <div class="main-container-report" id="main-content-wrapper-report">
                        <header class="main-header-report glass-card">
                            <h1 class="main-title-report" contenteditable="true"></h1>
                            <div class="menu-button" tabindex="0">
                                <span></span>
                                <div class="dropdown-menu" id="inspection-report-menu">
                                    <button onclick="saveProjectAs()"><i class="fa-solid fa-save"></i> Save As New Project</button>
                                    <button onclick="createNewProject()"><i class="fa-solid fa-plus-circle"></i> New Project</button>
                                </div>
                            </div>
                        </header>
                        
                        <div id="main-report-content">
                            <div class="info-card glass-card">
                                <div>
                                    <input type="file" accept="image/*" onchange="loadClientLogoReport('inspection')" style="display:none;" id="client-logo-inspection-input">
                                    <img id="client-logo-inspection" src="" alt="Client Logo" onclick="document.getElementById('client-logo-inspection-input').click();" style="max-height: 60px; max-width: 120px; object-fit: contain; border-radius: 8px; cursor: pointer;">
                                </div>
                                <div>
                                    <label for="display-date">
                                        <strong><span data-lang-key="date"></span>:</strong>
                                        <input type="date" id="display-date" onchange="saveActiveProjectDataIntoForms()">
                                    </label>
                                    <div contenteditable="true" oninput="saveActiveProjectDataIntoForms()"></div>
                                </div>
                                <input type="file" accept="image/*" onchange="loadCompanyLogoReport('inspection')" style="display:none;" id="company-logo-inspection-input">
                                <img id="company-logo-inspection" src="" alt="Company Logo" onclick="document.getElementById('company-logo-inspection-input').click();" style="max-height: 60px; max-width: 120px; object-fit: contain; border-radius: 8px; cursor: pointer;">
                                
                                <!-- START: ADDED FOR PRINTING -->
                                <div class="print-header-replacement">
                                    <img id="client-logo-print-src" src="" alt="Client Logo" class="print-logo">
                                    <div class="print-title-container">
                                        <b>Maintenance of Strategic Highways</b>
                                        <b>Qatar North ZF_093</b>
                                        <b>Inspection Report</b>
                                    </div>
                                    <img id="company-logo-print-src" src="" alt="Company Logo" class="print-logo">
                                </div>
                                <div class="print-date-footer">
                                    <span class="date-subtitle">Report Date:</span>
                                    <span id="inspection-print-date"></span>
                                </div>
                                <!-- END: ADDED FOR PRINTING -->
                            </div>

                            <div class="form-grid">
                                <div class="card glass-card">
                                    <h3 data-lang-key="add_new_asset"></h3>
                                    <div class="form-group">
                                        <input type="text" id="asset" list="asset-options" data-lang-placeholder="asset_description_placeholder">
                                        <datalist id="asset-options">
                                            <option value="(B) Zonal Inspections"></option>
                                            <option value="(C) Site Clearance"></option>
                                            <option value="(D) Drainage and Service Ducts"></option>
                                            <option value="(E) Earthworks"></option>
                                            <option value="(F) Sub-Base and Road Base"></option>
                                            <option value="(G) Flexible Surfacing"></option>
                                            <option value="(H) Kerbs & Footways"></option>
                                            <option value="(I) Road Markings"></option>
                                            <option value="(J) Directional Signs"></option>
                                            <option value="(K) Works by Statutory Undertakers"></option>
                                            <option value="(L) Street Lighting Works"></option>
                                            <option value="(M) Structures"></option>
                                            <option value="(N) Traffic Management"></option>
                                            <option value="(O) VRS"></option>
                                            <option value="(P) Supply of Materials"></option>
                                            <option value="(Q) Traffic Signs"></option>
                                            <option value="(R) Time and Material Rates"></option>
                                            <option value="(S) Plant and Equipment"></option>
                                            <option value="(T) Street Furniture"></option>
                                        </datalist>

                                        <div id="drop-zone">
                                            <p data-lang-key="drop_or_click_photos"></p>
                                            <div class="drop-zone-buttons">
                                                <button class="icon-button" onclick="event.stopPropagation(); document.querySelector('.photo-input').click()" title="Choose from Gallery"></button>
                                                <button class="icon-button" onclick="event.stopPropagation(); openCameraReport()" title="Open Camera"></button>
                                                <button class="icon-button" onclick="event.stopPropagation(); openMarzipanoViewerModal()" title="Open 360 Viewer"></button>
                                            </div>
                                        </div>
                                        <input type="file" class="photo-input" accept="image/*" multiple style="display: none;">
                                        <div id="photo-previews" style="display: flex; gap: 8px; flex-wrap: wrap; margin-top: 5px;"></div>
                                    </div>
                                </div>
                                <div class="card glass-card">
                                    <h3 data-lang-key="details_and_recommendations"></h3>
                                    <div class="form-group">
                                        <input type="text" id="status" data-lang-placeholder="status_placeholder">
                                        <input type="text" id="recommendation" data-lang-placeholder="recommendation_placeholder">
                                        <button class="form-button" onclick="showQuantityModal()" data-lang-key="calculate_quantity"></button>
                                    </div>
                                </div>
                                <div class="card glass-card">
                                    <h3 data-lang-key="gps_location"></h3>
                                    <div id="report-map" style="display:none;"></div>
                                    <div class="location-mode-switcher">
                                        <button id="gps-auto-btn" class="location-mode-btn active" onclick="switchLocationModeReport('auto')" data-lang-key="location_mode_auto"></button>
                                        <button id="gps-manual-btn" class="location-mode-btn" onclick="switchLocationModeReport('manual')" data-lang-key="location_mode_manual"></button>
                                        </div>

                                    <div id="location-auto-panel" class="location-panel">
                                        <button class="primary-button" onclick="getLocationReport()" style="font-size: 14px;" data-lang-key="get_current_gps"></button>
                                    </div>
                                    <div id="location-manual-panel" class="location-panel" style="display: none;">
                                        <input type="number" id="manual-lat" data-lang-placeholder="manual_lat_placeholder" step="any" oninput="updateLocationFromManualReport()">
                                        <input type="number" id="manual-lng" data-lang-placeholder="manual_lng_placeholder" step="any" oninput="updateLocationFromManualReport()">
                                    </div>
                                    <div class="location-display-wrapper">
                                        <div class="form-group">
                                            <div><small><strong><span data-lang-key="latitude"></span>:</strong> <span id="lat-display">N/A</span></small></div>
                                            <div><small><strong><span data-lang-key="longitude"></span>:</strong> <span id="lng-display">N/A</span></small></div>
                                        </div>
                                        <button id="insert-location-btn" class="primary-button" onclick="insertLocationToFormReport()" data-lang-key="insert_location_to_form"></button>
                                    </div>
                                </div>
                            </div>

                            <button onclick="addRowReport()" class="primary-button"><span data-lang-key="add_row_to_table"></span></button>

                            <div class="glass-card">
                                <div class="table-controls">
                                    <button onclick="addColumnReport()" title="Add Column"></button>
                                    <button onclick="removeColumnReport()" title="Remove Column"></button>
                                    <button onclick="removeSelectedRowReport()" title="Remove Row"></button>
                                    <button onclick="printReportContent()" data-lang-key="print_report"></button>
                                    <button onclick="exportToPdfReport('inspection')" data-lang-key="export_pdf_report">Export PDF</button>
                                </div>
                                <div class="table-container" style="max-height: 50vh; overflow-y: auto;">
                                    <table id="report-table"></table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Cost Estimation Page Content (formerly cost-estimation-tab) -->
                <div id="cost-estimation-page" class="app-content" style="display:none;">
                    <div class="main-container-report">
                        <header class="main-header-report glass-card">
                            <h1 class="main-title-report" contenteditable="true"></h1>
                            <div class="menu-button" tabindex="0">
                                <span></span>
                                <div class="dropdown-menu" id="cost-estimation-menu">
                                    <button onclick="saveProjectAs()"><i class="fa-solid fa-save"></i> Save As New Project</button>
                                    <button onclick="createNewProject()"><i class="fa-solid fa-plus-circle"></i> New Project</button>
                                </div>
                            </div>
                        </header>
                        <div id="cost-estimation-content">
                            <div class="glass-card estimation-header">
                                <input type="file" accept="image/*" onchange="loadClientLogoReport('estimation')" style="display:none;" id="client-logo-estimation-input">
                                <img id="client-logo-estimation" src="" alt="Client Logo" title="Click to upload Client Logo" onclick="document.getElementById('client-logo-estimation-input').click()" style="max-height: 60px; max-width: 150px; object-fit: contain; cursor: pointer;">
                                <div class="estimation-title">
                                    <h2 id="estimation-project-title" contenteditable="true">Maintenance of Strategic Highways Qatar North ZF_093</h2>
                                    <h3 id="estimation-subtitle" contenteditable="true">Estimation</h3>
                                </div>
                                <input type="file" accept="image/*" onchange="loadCompanyLogoReport('estimation')" style="display:none;" id="company-logo-estimation-input">
                                <img id="company-logo-estimation" src="" alt="Company Logo" title="Click to upload Company Logo" onclick="document.getElementById('company-logo-estimation-input').click()" style="max-height: 60px; max-width: 150px; object-fit: contain; cursor: pointer;">

                                <!-- START: ADDED FOR PRINTING -->
                                <div class="print-header-replacement">
                                    <img id="est-client-logo-print-src" src="" alt="Client Logo" class="print-logo">
                                    <div class="print-title-container">
                                        <b>Maintenance of Strategic Highways</b>
                                        <b>Qatar North ZF_093</b>
                                        <b>Cost Estimation</b>
                                    </div>
                                    <img id="est-company-logo-print-src" src="" alt="Company Logo" class="print-logo">
                                </div>
                                <div class="print-date-footer">
                                    <span class="date-subtitle">Report Date:</span>
                                    <span id="estimation-print-date"></span>
                                </div>
                                <!-- END: ADDED FOR PRINTING -->
                            </div>
                            <div class="glass-card estimation-details">
                                <div class="form-row"><label for="work-order-no">Work Order No.</label><input type="text" id="work-order-no"></div>
                                <div class="form-row"><label for="tpc-no">TPC No.</label><input type="text" id="tpc-no"></div>
                                <div class="form-row"><label for="work-desc">Description of Work</label><input type="text" id="work-desc"></div>
                            </div>
                            <div class="card glass-card boq-entry-card">
                                <div style="display: flex; justify-content: space-between; align-items: center;">
                                    <h3>BOQ Item Entry</h3>
                                    <div class="menu-button" tabindex="0">
                                        <span></span>
                                        <div class="dropdown-menu" id="estimation-form-menu"></div>
                                    </div>
                                </div>
                                <div class="form-grid-est">
                                    <div class="form-group-est">
                                        <label for="boq-ref-select">BOQ Ref.</label>
                                        <div class="boq-ref-group">
                                            <input type="search" id="boq-search" placeholder="Search Ref...">
                                            <select id="boq-ref-select"></select>
                                        </div>
                                    </div>
                                    <div class="form-group-est description-group">
                                        <label for="boq-desc">Description</label>
                                        <input type="text" id="boq-desc" readonly>
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-unit">Unit</label>
                                        <input type="text" id="boq-unit" readonly>
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-nr">NR</label>
                                        <input type="number" id="boq-nr" placeholder="e.g., 1">
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-length">Length (m)</label>
                                        <input type="number" id="boq-length" placeholder="e.g., 4.00">
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-width">Width (m)</label>
                                        <input type="number" id="boq-width" placeholder="e.g., 2.00">
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-height">Height (m)</label>
                                        <input type="number" id="boq-height" placeholder="e.g., 0.07">
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-total-qty">Total Qty.</label>
                                        <input type="text" id="boq-total-qty" readonly>
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-rate">Rate</label>
                                        <input type="text" id="boq-rate" readonly>
                                    </div>
                                    <div class="form-group-est">
                                        <label for="boq-amount">Amount (QR)</label>
                                        <input type="text" id="boq-amount" readonly>
                                    </div>
                                    <div class="form-group-est description-group">
                                        <label for="boq-remarks">Remarks</label>
                                        <input type="text" id="boq-remarks">
                                    </div>
                                </div>
                                <div style="display: flex; flex-wrap: wrap; gap: 10px; margin-top: 15px;">
                                    <button onclick="downloadBOQTemplate()" class="primary-button" style="flex: 1;">Download BOQ Template</button>
                                    <button id="import-boq-csv-btn" class="primary-button" style="flex: 1;">Import BOQ from CSV</button>
                                    <input type="file" id="boq-csv-input" style="display:none;" accept=".csv">
                                    <button id="insert-boq-row-btn" class="primary-button" style="flex: 1; background-color:#28a745;">Insert Row</button>
                                </div>
                            </div>
                            <div class="glass-card">
                                <div class="table-controls">
                                    <h3>Cost Estimation</h3>
                                    <div class="menu-button" tabindex="0">
                                        <span></span>
                                        <div class="dropdown-menu" id="estimation-table-menu"></div>
                                    </div>
                                    <button onclick="printCostEstimationReport()" data-lang-key="print_estimation">Print Estimation</button>
                                    <button onclick="exportToPdfReport('estimation')" data-lang-key="export_pdf_estimation">Export PDF</button>
                                </div>
                                <div class="table-container">
                                    <table id="cost-estimation-table">
                                        <thead>
                                            <tr>
                                                <th>BOQ Ref.</th>
                                                <th>Description</th>
                                                <th>Unit</th>
                                                <th>NR</th>
                                                <th>Length (m)</th>
                                                <th>Width (m)</th>
                                                <th>Height (m)</th>
                                                <th>Total Qty.</th>
                                                <th>Rate</th>
                                                <th>Amount</th>
                                                <th>Remarks</th>
                                                <th>Action</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                        <tfoot>
                                            <tr>
                                                <td colspan="9" style="text-align: right; font-weight: bold; border: 1px solid black;">TOTAL Amount</td>
                                                <td id="total-amount-cell" style="font-weight: bold; border: 1px solid black;">QAR 0.00</td>
                                                <td style="border: 1px solid black;"></td>
                                            </tr>
                                        </tfoot>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Saved Projects Page Content -->
                <div id="saved-projects-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-folder-open"></i> Saved Projects</h2>
                        <p>Select a project to load or manage existing ones.</p>
                        <button class="btn-success" onclick="createNewProject()"><i class="fa-solid fa-plus"></i> Create New Project</button>
                        <input type="file" id="import-all-projects-json" accept=".json" style="display:none;" onchange="importAllProjects(event)">
                        <button class="btn" onclick="document.getElementById('import-all-projects-json').click()">Import All Projects</button>
                        <button class="btn" onclick="exportAllProjects()">Export All Projects</button>
                    </div>
                    <div class="card">
                        <h3>Your Projects</h3>
                        <ul id="projects-list">
                            <p>No projects saved yet. Create a new one or save your current work.</p>
                        </ul>
                    </div>
                </div>

                <!-- New Notebook Page Content -->
                <div id="notebook-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-book"></i> Notebook</h2>
                        <div style="display:flex; gap: 10px; margin-bottom: 20px;">
                            <button class="btn-success" onclick="showModal('note-modal')"><i class="fa-solid fa-plus"></i> Add New Note</button>
                            <input type="text" id="note-filter-tags" placeholder="Filter by tags (comma-separated)" style="flex-grow: 1;">
                            <button class="btn" onclick="filterNotes()">Apply Filter</button>
                            <button class="btn" onclick="loadNotes()">Clear Filter</button>
                        </div>
                        <div id="notes-list">
                            <p>No notes yet. Add one to get started.</p>
                        </div>
                    </div>
                </div>

                <!-- New Drawing Page Content -->
                <div id="drawing-page" class="app-content" style="display:none;">
                    <div class="card">
                        <h2><i class="fa-solid fa-pencil-ruler"></i> Drawing & Annotation Tool</h2>
                        <div id="drawing-toolbar">
                            <button id="tool-pen" class="active" onclick="setDrawingTool('pen')"> Pen</button>
                            <button id="tool-rect" onclick="setDrawingTool('rect')"> Rectangle</button>
                            <button id="tool-circle" onclick="setDrawingTool('circle')"> Circle</button>
                            <button id="tool-arrow" onclick="setDrawingTool('arrow')"> Arrow</button>
                            <button id="tool-text" onclick="setDrawingTool('text')"> Text</button>
                            <button id="tool-eraser" onclick="setDrawingTool('eraser')"> Eraser</button>
                            <label for="stroke-color">Color:</label>
                            <input type="color" id="stroke-color" value="#000000" onchange="setDrawingColor(this.value)">
                            <label for="stroke-width">Width:</label>
                            <input type="number" id="stroke-width" value="2" min="1" max="20" onchange="setDrawingWidth(this.value)">
                            <button onclick="clearDrawingCanvas()">Clear Canvas</button>
                            <input type="file" id="drawing-image-upload" accept="image/*" onchange="loadDrawingImage(event)">
                            <button onclick="document.getElementById('drawing-image-upload').click()">Load Image</button>
                            <button onclick="saveDrawing()">Save Drawing</button>
                            <button onclick="loadDrawing()">Load Drawing</button>
                            <button onclick="exportDrawing('png')">Export PNG</button>
                            <button onclick="exportDrawing('json')">Export JSON</button>
                        </div>
                        <div id="drawing-canvas-container">
                            <canvas id="drawing-canvas"></canvas>
                        </div>
                        <div id="saved-drawings-list" style="margin-top: 20px;">
                            <h3>Saved Drawings</h3>
                            <ul id="drawings-list"></ul>
                        </div>
                    </div>
                </div>

            </main>
        </div>
    </div>

    <!-- Enhanced Contract Form Modal -->
    <div id="contract-form-modal" class="modal-overlay">
        <div class="modal-content professional">
            <div class="modal-header">
                <div class="modal-title">
                    <i class="fas fa-file-contract"></i>
                    <span id="modal-title-text">Create New Contract</span>
                </div>
                <button class="modal-close" onclick="hideModal('contract-form-modal')">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="modal-body">
                <form id="contract-form" class="professional-form">
                    <!-- Basic Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-info-circle"></i>
                            Basic Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contract-title">Contract Title *</label>
                                <input type="text" id="contract-title" placeholder="Enter contract title" required>
                                <span class="field-helper">Descriptive name for the contract</span>
                            </div>
                            <div class="form-group">
                                <label for="contract-number">Contract Number *</label>
                                <input type="text" id="contract-number" placeholder="e.g., ENG-2024-001" required>
                                <span class="field-helper">Unique contract identifier</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="company-name">Company Name *</label>
                                <input type="text" id="company-name" placeholder="Enter company name" required>
                                <span class="field-helper">Contracting company</span>
                            </div>
                            <div class="form-group">
                                <label for="client-name">Client Name *</label>
                                <input type="text" id="client-name" placeholder="Enter client name" required>
                                <span class="field-helper">Project client contact</span>
                            </div>
                        </div>
                    </div>

                    <!-- Project Details Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-calendar-alt"></i>
                            Project Timeline & Value
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contract-start">Start Date *</label>
                                <input type="date" id="contract-start" required>
                                <span class="field-helper">Project commencement date</span>
                            </div>
                            <div class="form-group">
                                <label for="contract-end">End Date *</label>
                                <input type="date" id="contract-end" required>
                                <span class="field-helper">Project completion deadline</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contract-value">Project Value *</label>
                                <div class="input-with-addon">
                                    <span class="input-addon">$</span>
                                    <input type="number" id="contract-value" placeholder="0.00" step="0.01" required>
                                </div>
                                <span class="field-helper">Total contract value in USD</span>
                            </div>
                            <div class="form-group">
                                <label for="contract-status">Status</label>
                                <select id="contract-status">
                                    <option value="pending">Pending</option>
                                    <option value="active" selected>Active</option>
                                    <option value="completed">Completed</option>
                                    <option value="on-hold">On Hold</option>
                                </select>
                                <span class="field-helper">Current contract status</span>
                            </div>
                        </div>
                    </div>

                    <!-- Documentation Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-file-upload"></i>
                            Documentation & BOQ
                        </h3>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="contract-description">Project Description</label>
                                <textarea id="contract-description" rows="3" placeholder="Enter project description..."></textarea>
                                <span class="field-helper">Brief description of the project scope</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="contract-boq">BOQ Upload (CSV/Excel)</label>
                                <div class="file-upload-area" onclick="document.getElementById('contract-boq').click()">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <span class="upload-text">Click to upload BOQ file</span>
                                    <span class="upload-helper">Supports CSV, XLS, XLSX files</span>
                                    <input type="file" id="contract-boq" accept=".csv,.xls,.xlsx" style="display: none;" onchange="handleFileUpload(this)" required>
                                </div>
                                <div id="file-preview" class="file-preview" style="display: none;">
                                    <i class="fas fa-file-excel"></i>
                                    <span class="file-name"></span>
                                    <button type="button" class="remove-file" onclick="removeFile()">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            <div class="form-group">
                                <label>BOQ Template</label>
                                <div class="template-actions">
                                    <button type="button" class="template-btn" onclick="downloadBoqTemplate()">
                                        <i class="fas fa-download"></i>
                                        Download Template
                                    </button>
                                    <span class="field-helper">Download our standardized BOQ template</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Additional Information Section -->
                    <div class="form-section">
                        <h3 class="section-title">
                            <i class="fas fa-cog"></i>
                            Additional Information
                        </h3>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="project-manager">Project Manager</label>
                                <input type="text" id="project-manager" placeholder="Enter project manager name">
                                <span class="field-helper">Assigned project manager</span>
                            </div>
                            <div class="form-group">
                                <label for="contract-category">Category</label>
                                <select id="contract-category">
                                    <option value="">Select category</option>
                                    <option value="construction">Construction</option>
                                    <option value="design">Design</option>
                                    <option value="consulting">Consulting</option>
                                    <option value="maintenance">Maintenance</option>
                                    <option value="other">Other</option>
                                </select>
                                <span class="field-helper">Project category type</span>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group full-width">
                                <label for="contract-notes">Notes</label>
                                <textarea id="contract-notes" rows="2" placeholder="Additional notes or comments..."></textarea>
                                <span class="field-helper">Any additional information or special requirements</span>
                            </div>
                        </div>
                    </div>
                </form>
                <div id="contract-form-modal-message" class="message" style="display: none;"></div>
            </div>
            <div class="modal-footer">
                <button type="button" class="professional-btn secondary" onclick="hideModal('contract-form-modal')">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="button" class="professional-btn primary" onclick="saveContract()">
                    <i class="fas fa-save"></i> <span id="save-btn-text">Save Contract</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Modals from extra pages code -->
    <div id="quantityModal" class="modal"><div class="modal-content-report glass-card"><h3 data-lang-key="enter_quantity_details"></h3><input type="number" id="length" data-lang-placeholder="length_m"><input type="number" id="width" data-lang-placeholder="width_m"><input type="number" id="depth" data-lang-placeholder="depth_m"><input type="number" id="repetitions" data-lang-placeholder="repetitions_nr"><div class="modal-buttons" style="display:flex; gap: 10px;"><button onclick="setQuantity()" class="primary-button" data-lang-key="set_quantity" style="flex: 1;"></button><button onclick="closeQuantityModal()" style="background-color: #dc3545; color:white; border:none; flex: 1; padding: 12px; border-radius: 8px; font-size: 15px;" data-lang-key="cancel"></button></div></div></div>

    <div id="camera-modal" class="modal"><div id="camera-modal-content" class="glass-card"><video id="camera-feed" autoplay playsinline></video><button id="capture-btn" onclick="capturePhotoReport()"></button><button id="close-camera-btn" onclick="closeCameraReport()">X</button></div></div>
    <canvas id="photo-canvas" style="display:none;"></canvas>

    <div id="preview-overlay" style="display: none; position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: rgba(0,0,0,0.7); z-index: 3000; justify-content: center; align-items: center;"><div id="preview-content" style="background-color: white; width: 90%; height: 90%; overflow: auto; padding: 20px; position: relative;"><button id="close-preview" onclick="hidePreviewReport()" style="position: absolute; top: 10px; right: 10px; font-size: 24px; background: none; border: none; cursor: pointer;"></button></div></div>

    <!-- New Save Project Modal -->
    <div id="save-project-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideModal('save-project-modal')">&times;</button>
            <h2>Save Project</h2>
            <form id="save-project-form">
                <label for="project-name-input">Project Name:</label>
                <input type="text" id="project-name-input" placeholder="Enter project name" required>
                <button type="submit" class="btn-success">Save</button>
            </form>
        </div>
    </div>

    <!-- New Note Modal -->
    <div id="note-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="modal-close-btn" onclick="hideModal('note-modal')">&times;</button>
            <h2><span id="note-modal-title">Add New Note</span></h2>
            <form id="note-form">
                <label for="note-title">Title:</label>
                <input type="text" id="note-title" placeholder="Note Title" required>
                <label for="note-content">Content (Markdown/HTML):</label>
                <textarea id="note-content" placeholder="Write your note here..."></textarea>
                <label for="note-tags">Tags (comma-separated):</label>
                <input type="text" id="note-tags" placeholder="e.g., road, inspection, defect">
                <button type="submit" class="btn-success">Save Note</button>
            </form>
        </div>
    </div>

    <!-- Marzipano Viewer Modal -->
    <div id="marzipano-viewer-modal" class="modal-overlay">
        <div class="modal-content" style="max-width: 90vw; max-height: 90vh; padding: 0;">
            <button class="modal-close-btn" onclick="hideModal('marzipano-viewer-modal')">&times;</button>
            <div id="marzipano-viewer" class="marzipano-viewer"></div>
        </div>
    </div>


    <footer class="glass-card footer">
        <p style="margin: 0;">All rights reserved  <span id="current-year"></span></p>
        <p style="margin: 0;">Developed by Eng. Ahmet Nasan</p>
        <p style="margin: 0;">Civil Engineer & Software Developer</p>
        <p style="margin: 0;">Blending engineering precision with modern tech.</p>
    </footer>

    <div class="fab-container">
        <button id="camera-fab" class="fab" onclick="openCameraReport()"></button>
        <button id="add-fab" class="fab" onclick="document.querySelector('#asset').focus()"></button>
    </div>


<script>
// ======== SCRIPT START ========

// ======== 0. UTILS & HELPERS ========
const getEl = (id) => document.getElementById(id);
const show = (id) => getEl(id).style.display = 'flex';
const hide = (id) => getEl(id).style.display = 'none';

const showModal = (id) => getEl(id).classList.add('active');
const hideModal = (id) => getEl(id).classList.remove('active');

const showAppPage = (pageId) => {
    document.querySelectorAll('.app-content').forEach(p => p.style.display = 'none');
    getEl(pageId).style.display = 'block';

    document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
    const navButtonId = pageId.replace('-page', '');
    getEl(`nav-${navButtonId}`).classList.add('active');

    // Special handler for main GIS map initialization
    if (pageId === 'map-page' && !window.mapInitialized) {
        initializeMap();
    }
    // Special handler for Inspection Report page initialization
    if (pageId === 'inspection-report-page') {
        initializeReportMap(); // Ensure report map is initialized
        loadActiveProjectDataIntoForms(); // Load data for the active project
    }
    // Special handler for Cost Estimation page initialization
    if (pageId === 'cost-estimation-page') {
        loadActiveProjectDataIntoForms(); // Load data for the active project
    }
    // Special handler for Saved Projects page
    if (pageId === 'saved-projects-page') {
        loadProjectsList();
    }
    // Special handler for Notebook page
    if (pageId === 'notebook-page') {
        loadNotes();
    }
    // Special handler for Drawing page
    if (pageId === 'drawing-page') {
        initializeDrawingCanvas();
        loadDrawingsList();
    }
};

const displayMessage = (elementId, text, type) => {
    // Check if the element exists before trying to access its properties
    const el = getEl(elementId);
    if (el) {
        el.textContent = text;
        el.className = `message ${type}`;
        el.style.display = 'block';
        setTimeout(() => el.style.display = 'none', 5000);
    } else {
        console.warn(`Attempted to display message on non-existent element: ${elementId}`);
        // Fallback to console log if element not found
        console.log(`Message (${type}): ${text}`);
    }
};

const addNotification = (type, message, severity = 'info', location = null, linkedImage = null) => {
    const notifications = JSON.parse(localStorage.getItem('notifications') || '[]');
    const newNotification = {
        id: generateId(),
        date: new Date().toLocaleString(),
        type,
        message,
        severity,
        location,
        projectId: currentProjectId,
        linkedImage
    };
    notifications.unshift(newNotification);
    localStorage.setItem('notifications', JSON.stringify(notifications));
    loadNotifications();
};

// --- DICTIONARY (for Report & Estimation Page) ---
const langDict = {
    en: {
        report_title: "Asset Inspection Report",
        tab_inspection_report: "Inspection Report",
        tab_cost_estimation: "Cost Estimation",
        date: "Date",
        add_new_asset: "Add New Asset",
        asset_description_placeholder: "Asset Description",
        drop_or_click_photos: "Drag & Drop or Click to Add Photos",
        details_and_recommendations: "Details & Recommendations",
        status_placeholder: "Status (e.g., Good, Damaged)",
        recommendation_placeholder: "Recommendation (e.g., Repair, Replace)",
        calculate_quantity: "Calculate Quantity",
        gps_location: "GPS Location",
        location_mode_auto: "Automatic",
        location_mode_manual: "Manual",
        get_current_gps: "Get Current GPS",
        manual_lat_placeholder: "Manual Latitude",
        manual_lng_placeholder: "Manual Longitude",
        latitude: "Latitude",
        longitude: "Longitude",
        insert_location_to_form: "Insert to Form",
        add_row_to_table: "Add Row to Table",
        print_report: "Print Report",
        export_pdf_report: "Export PDF",
        print_estimation: "Print Estimation",
        export_pdf_estimation: "Export PDF",
        enter_quantity_details: "Enter Quantity Details",
        length_m: "Length (m)",
        width_m: "Width (m)",
        depth_m: "Depth (m)",
        repetitions_nr: "Repetitions (NR)",
        set_quantity: "Set Quantity",
        cancel: "Cancel",
        print_date: "Report Date" // Added for print footer
    },
    ar: {
        report_title: "  ",
        tab_inspection_report: " ",
        tab_cost_estimation: " ",
        date: "",
        add_new_asset: "  ",
        asset_description_placeholder: " ",
        drop_or_click_photos: "     ",
        details_and_recommendations: " ",
        status_placeholder: " (:  )",
        recommendation_placeholder: " (:  )",
        calculate_quantity: " ",
        gps_location: " GPS",
        location_mode_auto: "",
        location_mode_manual: "",
        get_current_gps: "  GPS ",
        manual_lat_placeholder: "  ",
        manual_lng_placeholder: "  ",
        latitude: " ",
        longitude: " ",
        insert_location_to_form: "  ",
        add_row_to_table: "   ",
        print_report: " ",
        export_pdf_report: " PDF",
        print_estimation: " ",
        export_pdf_estimation: " PDF",
        enter_quantity_details: "  ",
        length_m: " ()",
        width_m: " ()",
        depth_m: " ()",
        repetitions_nr: " ()",
        set_quantity: " ",
        cancel: "",
        print_date: " " // Added for print footer
    }
};

let currentLang = 'en'; // Default language for the entire application

function switchLanguage(lang) {
    currentLang = lang;
    document.documentElement.dir = (lang === 'ar') ? 'rtl' : 'ltr';

    // Update main app titles/placeholders if any
    // For now, only the report page has dynamic text based on langDict
    setReportPageLanguage(lang);
}

function setReportPageLanguage(lang) {
    document.querySelectorAll('#inspection-report-page [data-lang-key], #cost-estimation-page [data-lang-key]').forEach(element => {
        const key = element.getAttribute('data-lang-key');
        if (langDict[currentLang] && langDict[currentLang][key]) {
            element.textContent = langDict[currentLang][key];
        }
    });
    document.querySelectorAll('#inspection-report-page [data-lang-placeholder], #cost-estimation-page [data-lang-placeholder]').forEach(element => {
        const key = element.getAttribute('data-lang-placeholder');
        if (langDict[currentLang] && langDict[currentLang][key]) {
            element.placeholder = langDict[currentLang][key];
        }
    });
}


// ======== 1. DATABASE SIMULATION (localStorage) ========
const DB = {
    get: (key) => JSON.parse(localStorage.getItem(key) || '[]'),
    set: (key, value) => localStorage.setItem(key, JSON.stringify(value)),
    init: () => {
        if (!localStorage.getItem('contracts')) DB.set('contracts', []);
        if (!localStorage.getItem('notifications')) DB.set('notifications', []);
        if (!localStorage.getItem('ai_prompt')) {
             localStorage.setItem('ai_prompt', `You are a civil engineering expert trained to analyze road surface images for pavement condition assessment. Examine the input image and identify all visible road surface defects. Use precise civil engineering terminology for each defect type. For every defect detected, provide the following details in tabular format:
1. Defect Type
2. Severity Level (Low/Med/High)
3. Location in image
4. Technical Description
5. Recommended Action
If no defects are found, return 'No visible defects detected'. Present result in structured table.`);
        }
        // Initialize projects array if it doesn't exist
        if (!localStorage.getItem('projects')) DB.set('projects', []);
        // Initialize active project ID
        if (!localStorage.getItem('currentProjectId')) localStorage.setItem('currentProjectId', 'default-project');
        // Initialize notes
        if (!localStorage.getItem('notes')) DB.set('notes', []);
        // Initialize drawings
        if (!localStorage.getItem('drawings')) DB.set('drawings', []);
        // Initialize map data
        if (!localStorage.getItem('mapData')) DB.set('mapData', { layers: [] });
    }
};

// ======== 2. APP INITIALIZATION ========
let currentProjectId = localStorage.getItem('currentProjectId');

const initializeApp = () => {
    DB.init(); // Initialize database
    loadContracts();
    updateContractStats(); // Update contract statistics on startup
    loadNotifications();
    loadAIPrompt();
    loadProjectsList(); // Load projects for the new page

    // Initialize Report & Estimation page components
    const today = new Date().toISOString().split('T')[0];
    const displayDateEl = getEl('display-date');
    if (displayDateEl) displayDateEl.value = today;
    const currentYearEl = getEl('current-year');
    if (currentYearEl) currentYearEl.textContent = new Date().getFullYear();

    reportTable = getEl('report-table');
    costEstimationTable = getEl('cost-estimation-table');

    if (reportTable && !reportTable.tHead) {
        reportTable.createTHead();
        const headerRow = reportTable.tHead.insertRow();
        const headers = ["ID", "Asset", "Status", "Recommendation", "Quantity", "Photos", "Latitude", "Longitude", "Action"];
        headers.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        reportTable.createTBody();
    }

    if (costEstimationTable && !costEstimationTable.tHead) {
        costEstimationTable.createTHead();
        const headerRow = costEstimationTable.tHead.insertRow();
        const headers = ["BOQ Ref.", "Description", "Unit", "NR", "Length (m)", "Width (m)", "Height (m)", "Total Qty.", "Rate", "Amount", "Remarks", "Action"];
        headers.forEach(text => {
            const th = document.createElement('th');
            th.textContent = text;
            headerRow.appendChild(th);
        });
        costEstimationTable.createTBody();
    }

    // Setup BOQ Select for Cost Estimation
    const boqSelect = getEl('boq-ref-select');
    if (boqSelect) {
        boqData.forEach(item => {
            const option = document.createElement('option');
            option.value = item.ref;
            option.textContent = item.ref + " - " + item.description;
            boqSelect.appendChild(option);
        });
        boqSelect.addEventListener('change', updateBOQDetails);
    }
    const boqSearchEl = getEl('boq-search');
    if (boqSearchEl) boqSearchEl.addEventListener('input', filterBOQOptions);
    if (boqSelect) updateBOQDetails(); // Initialize details with first item

    // Make tables editable
    if (reportTable) makeTableEditableReport('report-table');
    if (costEstimationTable) makeTableEditableReport('cost-estimation-table');

    // Attach print/PDF export to main buttons for Report & Estimation
    const printReportBtn = document.querySelector('#inspection-report-page .table-controls button[data-lang-key="print_report"]');
    if (printReportBtn) printReportBtn.onclick = printReportContent;
    const exportPdfReportBtn = document.querySelector('#inspection-report-page .table-controls button[data-lang-key="export_pdf_report"]');
    if (exportPdfReportBtn) exportPdfReportBtn.onclick = () => exportToPdfReport('inspection');
    const printEstimationBtn = document.querySelector('#cost-estimation-page .table-controls button[data-lang-key="print_estimation"]');
    if (printEstimationBtn) printEstimationBtn.onclick = printCostEstimationReport;
    const exportPdfEstimationBtn = document.querySelector('#cost-estimation-page .table-controls button[data-lang-key="export_pdf_estimation"]');
    if (exportPdfEstimationBtn) exportPdfEstimationBtn.onclick = () => exportToPdfReport('estimation');

    // Set default language for the report page
    switchLanguage(getEl('language-switcher').value); // Set initial language for the whole app

    // Load the active project when the app initializes
    loadProject(currentProjectId);

    // Event listener for saving project form
    const saveProjectForm = getEl('save-project-form');
    if (saveProjectForm) {
        saveProjectForm.addEventListener('submit', (e) => {
            e.preventDefault();
            const projectName = getEl('project-name-input').value;
            if (projectName) {
                saveProject(projectName);
                hideModal('save-project-modal');
                getEl('project-name-input').value = ''; // Clear input
            } else {
                displayMessage('save-project-modal-message', 'Project name cannot be empty.', 'error');
            }
        });
    }

    // Event listener for note form
    const noteForm = getEl('note-form');
    if (noteForm) {
        noteForm.addEventListener('submit', (e) => {
            e.preventDefault();
            saveNote();
        });
    }

    // Initialize drag-and-drop for report table
    if (reportTable) {
        let dragSrcRow = null;
        reportTable.tBodies[0].addEventListener('dragstart', (e) => {
            if (e.target.tagName === 'TR') {
                dragSrcRow = e.target;
                e.dataTransfer.effectAllowed = 'move';
                e.dataTransfer.setData('text/html', e.target.outerHTML);
                e.target.classList.add('dragging');
            }
        });

        reportTable.tBodies[0].addEventListener('dragover', (e) => {
            e.preventDefault();
            e.dataTransfer.dropEffect = 'move';
            const target = e.target.closest('tr');
            if (target && target !== dragSrcRow) {
                const rect = target.getBoundingClientRect();
                const offsetY = e.clientY - rect.top;
                if (offsetY < rect.height / 2) {
                    reportTable.tBodies[0].insertBefore(dragSrcRow, target);
                } else {
                    reportTable.tBodies[0].insertBefore(dragSrcRow, target.nextSibling);
                }
            }
        });

        reportTable.tBodies[0].addEventListener('dragend', (e) => {
            e.target.classList.remove('dragging');
            dragSrcRow = null;
            updateRowNumbersReport(); // Re-number rows after sorting
            saveActiveProjectDataIntoForms(); // Save new order
        });
    }
};

// ======== 3. CONTRACTS ========
// Professional contract save function
const saveContract = () => {
    const title = getEl('contract-title').value;
    const number = getEl('contract-number').value;
    const start = getEl('contract-start').value;
    const end = getEl('contract-end').value;
    const value = getEl('contract-value').value;
    const company = getEl('company-name').value;
    const client = getEl('client-name').value;
    const status = getEl('contract-status').value;
    const description = getEl('contract-description').value;
    const projectManager = getEl('project-manager').value;
    const category = getEl('contract-category').value;
    const notes = getEl('contract-notes').value;
    const boqFile = getEl('contract-boq').files[0];

    if (!title || !number || !start || !end || !value || !company || !client) {
        displayMessage('contract-form-modal-message', 'Please fill all required fields.', 'error');
        return;
    }

    const saveContractData = (boqData = null) => {
        const contracts = DB.get('contracts');
        const newContract = {
            id: `C${Date.now()}`,
            title,
            number,
            start,
            end,
            value: parseFloat(value),
            company,
            client,
            status,
            description,
            projectManager,
            category,
            notes,
            boq: boqData,
            createdDate: new Date().toISOString().split('T')[0],
            lastModified: new Date().toISOString()
        };
        contracts.push(newContract);
        DB.set('contracts', contracts);
        hideModal('contract-form-modal');
        loadContracts();
        updateContractStats();
        showNotification('success', `Contract "${title}" created successfully!`);
        clearContractForm();
    };

    if (boqFile) {
        Papa.parse(boqFile, {
            header: true,
            complete: (results) => {
                saveContractData(results.data);
            },
            error: (err) => {
                displayMessage('contract-form-modal-message', `Error parsing file: ${err.message}`, 'error');
            }
        });
    } else {
        saveContractData();
    }
};

// Professional contract loading with enhanced UI
const loadContracts = () => {
    const contracts = DB.get('contracts');
    const container = getEl('saved-contracts-list');
    const emptyState = getEl('contracts-empty-state');
    
    container.innerHTML = '';
    
    if (contracts.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    container.style.display = 'grid';
    emptyState.style.display = 'none';
    
    contracts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'contract-card';
        
        // Calculate status and progress
        const startDate = new Date(c.start);
        const endDate = new Date(c.end);
        const currentDate = new Date();
        const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
        
        card.innerHTML = `
            <h3>${c.title}</h3>
            <div class="contract-info">
                <div class="contract-info-item">
                    <i class="fas fa-hashtag"></i>
                    <strong>Number:</strong> ${c.number}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-building"></i>
                    <strong>Company:</strong> ${c.company}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-user"></i>
                    <strong>Client:</strong> ${c.client}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-dollar-sign"></i>
                    <strong>Value:</strong> $${parseFloat(c.value).toLocaleString()}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-calendar"></i>
                    <strong>Duration:</strong> ${formatDateRange(c.start, c.end)}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-flag"></i>
                    <strong>Status:</strong> 
                    <span class="contract-status ${c.status || 'active'}">${(c.status || 'active').toUpperCase()}</span>
                </div>
                ${daysLeft > 0 ? `
                <div class="contract-info-item">
                    <i class="fas fa-clock"></i>
                    <strong>Days Left:</strong> ${daysLeft} days
                </div>` : ''}
                ${c.category ? `
                <div class="contract-info-item">
                    <i class="fas fa-tag"></i>
                    <strong>Category:</strong> ${c.category}
                </div>` : ''}
            </div>
            <div class="contract-actions">
                <button class="professional-btn primary" onclick="viewContract('${c.id}')">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="professional-btn secondary" onclick="editContract('${c.id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="professional-btn secondary" onclick="duplicateContract('${c.id}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="professional-btn secondary" onclick="deleteContract('${c.id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
    
    updateContractStats();
};

// Professional Contract Management Functions

// Update contract statistics
const updateContractStats = () => {
    const contracts = DB.get('contracts');
    const totalContracts = contracts.length;
    const activeContracts = contracts.filter(c => (c.status || 'active') === 'active').length;
    const totalValue = contracts.reduce((sum, c) => sum + parseFloat(c.value || 0), 0);
    
    // Calculate upcoming deadlines (within 30 days)
    const currentDate = new Date();
    const thirtyDaysFromNow = new Date(currentDate.getTime() + (30 * 24 * 60 * 60 * 1000));
    const upcomingDeadlines = contracts.filter(c => {
        const endDate = new Date(c.end);
        return endDate >= currentDate && endDate <= thirtyDaysFromNow;
    }).length;
    
    // Update UI elements
    const totalEl = getEl('total-contracts');
    const activeEl = getEl('active-contracts');
    const valueEl = getEl('total-value');
    const deadlinesEl = getEl('upcoming-deadlines');
    
    if (totalEl) totalEl.textContent = totalContracts;
    if (activeEl) activeEl.textContent = activeContracts;
    if (valueEl) valueEl.textContent = `$${totalValue.toLocaleString()}`;
    if (deadlinesEl) deadlinesEl.textContent = upcomingDeadlines;
};

// Format date range for display
const formatDateRange = (startDate, endDate) => {
    const start = new Date(startDate).toLocaleDateString();
    const end = new Date(endDate).toLocaleDateString();
    return `${start} - ${end}`;
};

// Contract action functions
const viewContract = (contractId) => {
    const contracts = DB.get('contracts');
    const contract = contracts.find(c => c.id === contractId);
    if (contract) {
        showContractDetails(contract);
    }
};

const editContract = (contractId) => {
    const contracts = DB.get('contracts');
    const contract = contracts.find(c => c.id === contractId);
    if (contract) {
        populateContractForm(contract);
        showModal('contract-form-modal');
    }
};

const duplicateContract = (contractId) => {
    const contracts = DB.get('contracts');
    const contract = contracts.find(c => c.id === contractId);
    if (contract) {
        const duplicatedContract = {
            ...contract,
            id: `C${Date.now()}`,
            title: `${contract.title} (Copy)`,
            number: `${contract.number}-COPY`,
            createdDate: new Date().toISOString().split('T')[0],
            lastModified: new Date().toISOString()
        };
        contracts.push(duplicatedContract);
        DB.set('contracts', contracts);
        loadContracts();
        showNotification('success', 'Contract duplicated successfully!');
    }
};

const deleteContract = (contractId) => {
    if (confirm('Are you sure you want to delete this contract? This action cannot be undone.')) {
        const contracts = DB.get('contracts');
        const contract = contracts.find(c => c.id === contractId);
        const filteredContracts = contracts.filter(c => c.id !== contractId);
        DB.set('contracts', filteredContracts);
        loadContracts();
        showNotification('success', `Contract "${contract.title}" deleted successfully!`);
    }
};

// Show contract details in a modal or detailed view
const showContractDetails = (contract) => {
    const detailsHtml = `
        <div class="contract-details">
            <h2>${contract.title}</h2>
            <div class="details-grid">
                <div><strong>Contract Number:</strong> ${contract.number}</div>
                <div><strong>Company:</strong> ${contract.company}</div>
                <div><strong>Client:</strong> ${contract.client}</div>
                <div><strong>Value:</strong> $${parseFloat(contract.value).toLocaleString()}</div>
                <div><strong>Start Date:</strong> ${contract.start}</div>
                <div><strong>End Date:</strong> ${contract.end}</div>
                <div><strong>Status:</strong> ${contract.status || 'Active'}</div>
                ${contract.category ? `<div><strong>Category:</strong> ${contract.category}</div>` : ''}
                ${contract.projectManager ? `<div><strong>Project Manager:</strong> ${contract.projectManager}</div>` : ''}
                ${contract.description ? `<div><strong>Description:</strong> ${contract.description}</div>` : ''}
                ${contract.notes ? `<div><strong>Notes:</strong> ${contract.notes}</div>` : ''}
                ${contract.boq ? `<div><strong>BOQ Items:</strong> ${contract.boq.length} items</div>` : ''}
            </div>
        </div>
    `;
    
    // You could show this in a modal or navigate to a details page
    alert(detailsHtml.replace(/<[^>]*>/g, '\n').replace(/\n+/g, '\n'));
};

// Populate form for editing
const populateContractForm = (contract) => {
    getEl('contract-title').value = contract.title || '';
    getEl('contract-number').value = contract.number || '';
    getEl('contract-start').value = contract.start || '';
    getEl('contract-end').value = contract.end || '';
    getEl('contract-value').value = contract.value || '';
    getEl('company-name').value = contract.company || '';
    getEl('client-name').value = contract.client || '';
    getEl('contract-status').value = contract.status || 'active';
    getEl('contract-description').value = contract.description || '';
    getEl('project-manager').value = contract.projectManager || '';
    getEl('contract-category').value = contract.category || '';
    getEl('contract-notes').value = contract.notes || '';
    
    // Update modal title for editing
    getEl('modal-title-text').textContent = 'Edit Contract';
    getEl('save-btn-text').textContent = 'Update Contract';
};

// Clear form after save
const clearContractForm = () => {
    const form = getEl('contract-form');
    if (form) form.reset();
    
    // Reset modal title
    getEl('modal-title-text').textContent = 'Create New Contract';
    getEl('save-btn-text').textContent = 'Save Contract';
    
    // Hide file preview
    const filePreview = getEl('file-preview');
    if (filePreview) filePreview.style.display = 'none';
};

// Filter contracts based on search and status
const filterContracts = () => {
    const searchTerm = getEl('contract-search').value.toLowerCase();
    const statusFilter = getEl('status-filter').value;
    
    const contracts = DB.get('contracts');
    let filteredContracts = contracts;
    
    // Apply search filter
    if (searchTerm) {
        filteredContracts = filteredContracts.filter(contract => 
            contract.title.toLowerCase().includes(searchTerm) ||
            contract.number.toLowerCase().includes(searchTerm) ||
            contract.company.toLowerCase().includes(searchTerm) ||
            contract.client.toLowerCase().includes(searchTerm)
        );
    }
    
    // Apply status filter
    if (statusFilter) {
        filteredContracts = filteredContracts.filter(contract => 
            (contract.status || 'active') === statusFilter
        );
    }
    
    displayFilteredContracts(filteredContracts);
};

// Sort contracts
const sortContracts = () => {
    const sortBy = getEl('sort-contracts').value;
    const contracts = DB.get('contracts');
    
    let sortedContracts = [...contracts];
    
    switch (sortBy) {
        case 'date-desc':
            sortedContracts.sort((a, b) => new Date(b.createdDate || b.start) - new Date(a.createdDate || a.start));
            break;
        case 'date-asc':
            sortedContracts.sort((a, b) => new Date(a.createdDate || a.start) - new Date(b.createdDate || b.start));
            break;
        case 'value-desc':
            sortedContracts.sort((a, b) => parseFloat(b.value || 0) - parseFloat(a.value || 0));
            break;
        case 'value-asc':
            sortedContracts.sort((a, b) => parseFloat(a.value || 0) - parseFloat(b.value || 0));
            break;
        case 'title-asc':
            sortedContracts.sort((a, b) => a.title.localeCompare(b.title));
            break;
    }
    
    displayFilteredContracts(sortedContracts);
};

// Display filtered/sorted contracts
const displayFilteredContracts = (contracts) => {
    const container = getEl('saved-contracts-list');
    const emptyState = getEl('contracts-empty-state');
    
    container.innerHTML = '';
    
    if (contracts.length === 0) {
        container.style.display = 'none';
        emptyState.style.display = 'block';
        return;
    }
    
    container.style.display = 'grid';
    emptyState.style.display = 'none';
    
    contracts.forEach(c => {
        const card = document.createElement('div');
        card.className = 'contract-card';
        
        const startDate = new Date(c.start);
        const endDate = new Date(c.end);
        const currentDate = new Date();
        const daysLeft = Math.ceil((endDate - currentDate) / (1000 * 60 * 60 * 24));
        
        card.innerHTML = `
            <h3>${c.title}</h3>
            <div class="contract-info">
                <div class="contract-info-item">
                    <i class="fas fa-hashtag"></i>
                    <strong>Number:</strong> ${c.number}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-building"></i>
                    <strong>Company:</strong> ${c.company}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-user"></i>
                    <strong>Client:</strong> ${c.client}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-dollar-sign"></i>
                    <strong>Value:</strong> $${parseFloat(c.value).toLocaleString()}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-calendar"></i>
                    <strong>Duration:</strong> ${formatDateRange(c.start, c.end)}
                </div>
                <div class="contract-info-item">
                    <i class="fas fa-flag"></i>
                    <strong>Status:</strong> 
                    <span class="contract-status ${c.status || 'active'}">${(c.status || 'active').toUpperCase()}</span>
                </div>
                ${daysLeft > 0 ? `
                <div class="contract-info-item">
                    <i class="fas fa-clock"></i>
                    <strong>Days Left:</strong> ${daysLeft} days
                </div>` : ''}
                ${c.category ? `
                <div class="contract-info-item">
                    <i class="fas fa-tag"></i>
                    <strong>Category:</strong> ${c.category}
                </div>` : ''}
            </div>
            <div class="contract-actions">
                <button class="professional-btn primary" onclick="viewContract('${c.id}')">
                    <i class="fas fa-eye"></i> View
                </button>
                <button class="professional-btn secondary" onclick="editContract('${c.id}')">
                    <i class="fas fa-edit"></i> Edit
                </button>
                <button class="professional-btn secondary" onclick="duplicateContract('${c.id}')">
                    <i class="fas fa-copy"></i> Copy
                </button>
                <button class="professional-btn secondary" onclick="deleteContract('${c.id}')">
                    <i class="fas fa-trash"></i> Delete
                </button>
            </div>
        `;
        
        container.appendChild(card);
    });
};

// Switch view between grid and list
const switchView = (viewType) => {
    const gridBtn = document.querySelector('[data-view="grid"]');
    const listBtn = document.querySelector('[data-view="list"]');
    const container = getEl('saved-contracts-list');
    
    if (viewType === 'grid') {
        gridBtn.classList.add('active');
        listBtn.classList.remove('active');
        container.className = 'contracts-grid';
    } else {
        listBtn.classList.add('active');
        gridBtn.classList.remove('active');
        container.className = 'contracts-list';
    }
};

// File handling functions
const handleFileUpload = (input) => {
    const file = input.files[0];
    if (file) {
        const filePreview = getEl('file-preview');
        const fileName = filePreview.querySelector('.file-name');
        
        fileName.textContent = file.name;
        filePreview.style.display = 'flex';
    }
};

const removeFile = () => {
    const fileInput = getEl('contract-boq');
    const filePreview = getEl('file-preview');
    
    fileInput.value = '';
    filePreview.style.display = 'none';
};

// Export and import functions
const exportAllContracts = () => {
    const contracts = DB.get('contracts');
    const dataStr = JSON.stringify(contracts, null, 2);
    const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
    
    const exportFileDefaultName = `contracts_export_${new Date().toISOString().split('T')[0]}.json`;
    
    const linkElement = document.createElement('a');
    linkElement.setAttribute('href', dataUri);
    linkElement.setAttribute('download', exportFileDefaultName);
    linkElement.click();
    
    showNotification('success', 'Contracts exported successfully!');
};

const importContracts = () => {
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = '.json';
    
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const importedContracts = JSON.parse(e.target.result);
                    const existingContracts = DB.get('contracts');
                    const allContracts = [...existingContracts, ...importedContracts];
                    
                    DB.set('contracts', allContracts);
                    loadContracts();
                    showNotification('success', `${importedContracts.length} contracts imported successfully!`);
                } catch (error) {
                    showNotification('error', 'Error importing contracts. Please check the file format.');
                }
            };
            reader.readAsText(file);
        }
    };
    
    input.click();
};

// BOQ template download
const downloadBoqTemplate = () => {
    const csvContent = "data:text/csv;charset=utf-8,Item,Description,Unit,Quantity,Rate,Amount\nItem 001,Excavation work,m3,100,25,2500\nItem 002,Concrete work,m3,50,150,7500\nItem 003,Steel reinforcement,kg,1000,5,5000";
    const encodedUri = encodeURI(csvContent);
    const link = document.createElement("a");
    link.setAttribute("href", encodedUri);
    link.setAttribute("download", "boq_template.csv");
    document.body.appendChild(link);
    link.click();
    document.body.removeChild(link);
    
    showNotification('info', 'BOQ template downloaded successfully!');
};

// Professional notification system
const showNotification = (type, message) => {
    // Create notification element
    const notification = document.createElement('div');
    notification.className = `professional-notification ${type}`;
    notification.innerHTML = `
        <div class="notification-content">
            <i class="fas ${getNotificationIcon(type)}"></i>
            <span>${message}</span>
        </div>
        <button class="notification-close" onclick="this.parentElement.remove()">
            <i class="fas fa-times"></i>
        </button>
    `;
    
    // Add styles for notifications
    notification.style.cssText = `
        position: fixed;
        top: 20px;
        right: 20px;
        z-index: 10000;
        background: white;
        border-radius: 12px;
        box-shadow: 0 8px 30px rgba(0,0,0,0.15);
        border-left: 4px solid ${getNotificationColor(type)};
        padding: 15px 20px;
        min-width: 300px;
        max-width: 500px;
        display: flex;
        align-items: center;
        justify-content: space-between;
        animation: slideInNotification 0.3s ease;
        margin-bottom: 10px;
    `;
    
    // Add to page
    document.body.appendChild(notification);
    
    // Auto-remove after 5 seconds
    setTimeout(() => {
        if (notification.parentElement) {
            notification.remove();
        }
    }, 5000);
};

const getNotificationIcon = (type) => {
    switch (type) {
        case 'success': return 'fa-check-circle';
        case 'error': return 'fa-exclamation-circle';
        case 'warning': return 'fa-exclamation-triangle';
        case 'info': return 'fa-info-circle';
        default: return 'fa-bell';
    }
};

const getNotificationColor = (type) => {
    switch (type) {
        case 'success': return '#10b981';
        case 'error': return '#ef4444';
        case 'warning': return '#f59e0b';
        case 'info': return '#3b82f6';
        default: return '#6b7280';
    }
};

@keyframes slideInNotification {
    from {
        transform: translateX(100%);
        opacity: 0;
    }
    to {
        transform: translateX(0);
        opacity: 1;
    }
}

// ======== 4. DATA TABLES (BOQ) ========
const loadBoqTable = (boqData) => {
    const tableBody = getEl('boq-table-body');
    tableBody.innerHTML = '';
    boqData.forEach((row, index) => {
        if(row['BOQ Ref.']) { // Check if row is not empty
            addBoqRow(row);
        }
    });
};

const addBoqRow = (rowData = {}) => {
    const tableBody = getEl('boq-table-body');
    const newRow = tableBody.insertRow();
    newRow.innerHTML = `
        <td contenteditable="true">${rowData['BOQ Ref.'] || ''}</td>
        <td contenteditable="true">${rowData['Asset'] || ''}</td>
        <td contenteditable="true">${rowData['Description'] || ''}</td>
        <td contenteditable="true" oninput="handleUnitInput(event)">${rowData['Dimensions (L x W x H)'] || ''}</td>
        <td>${rowData['Unit'] || ''}</td>
        <td contenteditable="true">${rowData['Rate'] || ''}</td>
        <td><button class="btn-danger" onclick="deleteRow(this)"><i class="fa-solid fa-trash"></i></button></td>
    `;
};

const deleteRow = (btn) => {
    const row = btn.parentNode.parentNode;
    row.parentNode.removeChild(row);
};

const handleUnitInput = (event) => {
    const dimensions = event.target.textContent.toLowerCase();
    const unitCell = event.target.nextElementSibling;

    // L x W x H -> m
    if (dimensions.match(/(\d|\.)+\s?x\s?(\d|\.)+\s?x\s?(\d|\.)+/)) {
        unitCell.textContent = 'm';
    }
    // L x W -> m
    else if (dimensions.match(/(\d|\.)+\s?x\s?(\d|\.)+/)) {
        unitCell.textContent = 'm';
    }
    // L -> m
    else if (dimensions.match(/^(\d|\.)+$/)) {
        unitCell.textContent = 'm';
    }
    // NR
    else if (dimensions.toUpperCase() === 'NR') {
         unitCell.textContent = 'NR';
    }
    else {
        unitCell.textContent = 'Unit'; // Default
    }
};

const exportTableToCsv = (filename) => {
    let csv = [];
    const rows = document.querySelectorAll("#boq-table tr");
    for (const row of rows) {
        let cols = row.querySelectorAll("td, th");
        let csvrow = [];
        for (const col of cols) {
            // To handle cases where a cell might have a comma
            let data = `"${col.innerText.replace(/"/g, '""')}"`;
            csvrow.push(data);
        }
        // Exclude the action column from export
        csvrow.pop();
        csv.push(csvrow.join(","));
    }
    const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(csvFile);
    link.download = filename;
    link.click();
};

const exportTableToPdf = () => {
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();
    const container = getEl('boq-table-container').cloneNode(true);

    // Clean up for printing
    container.querySelectorAll('button').forEach(b => b.remove());
    container.querySelectorAll('[contenteditable="true"]').forEach(el => el.removeAttribute('contenteditable'));

    document.body.appendChild(container); // Needs to be in DOM for html2canvas

    html2canvas(container).then(canvas => {
        document.body.removeChild(container);
        const imgData = canvas.toDataURL('image/png');
        const imgProps = doc.getImageProperties(imgData);
        const pdfWidth = doc.internal.pageSize.getWidth();
        const pdfHeight = (imgProps.height * pdfWidth) / imgProps.width;
        doc.addImage(imgData, 'PNG', 0, 0, pdfWidth, pdfHeight);
        doc.save("boq-report.pdf");
    });
};

// ======== 5. GIS MAP (Main App Map) ========
let map; // Main GIS Map
let drawnItems;
window.mapInitialized = false;

const initializeMap = () => {
    map = L.map('map-container').setView([25.2854, 51.5310], 12); // Changed from map-page to map-container
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
    }).addTo(map);

    drawnItems = new L.FeatureGroup();
    map.addLayer(drawnItems);

    const geomanControls = new L.Control.Geoman(map, {
        position: 'topleft',
        drawMarker: true,
        drawCircleMarker: false,
        drawCircle: false,
        drawRectangle: true,
        drawPolygon: true,
        drawPolyline: true,
    });
    map.addControl(geomanControls);

    map.on('pm:create', (e) => {
        const layer = e.layer;
        drawnItems.addLayer(layer);
        calculateAndBindPopup(layer);
        saveMapData(); // Save map data after creation
    });

    map.on('pm:remove', (e) => {
        saveMapData(); // Save map data after removal
    });

    map.on('pm:edit', (e) => {
        saveMapData(); // Save map data after edit
    });

    addCustomMapControls();
    loadMapData(); // Load map data on initialization
    window.mapInitialized = true;
};

const calculateAndBindPopup = (layer) => {
    const geojson = layer.toGeoJSON();
    let content = '<h4>Shape Details</h4>';
    let area = 0;
    let length = 0;

    if (geojson.geometry.type === 'Polygon') {
        area = turf.area(geojson); // in square meters
        content += `<p><strong>Area:</strong> ${area.toFixed(2)} m</p>`;
    } else if (geojson.geometry.type === 'LineString') {
        length = turf.length(geojson, { units: 'meters' });
        content += `<p><strong>Length:</strong> ${length.toFixed(2)} m</p>`;
    }

    const center = layer.getBounds().getCenter();
    content += `<p><strong>Center Coords:</strong> ${center.lat.toFixed(4)}, ${center.lng.toFixed(4)}</p>`;
    content += `<button class="btn-danger btn-sm" onclick="removeLayer(${layer._leaflet_id})">Delete</button>`;
    layer.bindPopup(content).openPopup();

    // Store additional metadata
    layer.feature = layer.feature || {};
    layer.feature.properties = layer.feature.properties || {};
    layer.feature.properties.area = area;
    layer.feature.properties.length = length;
    layer.feature.properties.centerLat = center.lat;
    layer.feature.properties.centerLng = center.lng;
};

window.removeLayer = (id) => {
    drawnItems.eachLayer(layer => {
        if (layer._leaflet_id === id) {
            drawnItems.removeLayer(layer);
            saveMapData(); // Save map data after removal
        }
    });
};

const addCustomMapControls = () => {
    const customControl = L.Control.extend({
        options: { position: 'topright' },
        onAdd: function (map) {
            const container = L.DomUtil.create('div', 'leaflet-bar leaflet-control leaflet-control-custom');
            container.innerHTML = `
                <a href="#" title="More Actions" role="button" aria-label="More Actions">
                    <i class="fa-solid fa-ellipsis-vertical" style="font-size: 1.2em; padding: 5px;"></i>
                </a>
                <div class="custom-menu" style="display:none; background:white; padding: 5px; box-shadow: var(--shadow);">
                    <button class="btn" style="width:100%; margin-bottom:5px;" onclick="getEl('kml-input').click()">Import KML</button>
                    <button class="btn" style="width:100%;;" onclick="getEl('csv-input').click()">Import CSV</button>
                </div>
                <input type="file" id="kml-input" style="display:none" accept=".kml" onchange="importKML(event)">
                <input type="file" id="csv-input" style="display:none" accept=".csv" onchange="importCSV(event)">
            `;
            container.onclick = (e) => {
                e.stopPropagation();
                const menu = container.querySelector('.custom-menu');
                menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
            }
            L.DomEvent.disableClickPropagation(container);
            return container;
        }
    });
    map.addControl(new customControl());
};

const importKML = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        const kmlLayer = omnivore.kml.parse(e.target.result);
        kmlLayer.eachLayer(layer => {
            drawnItems.addLayer(layer);
            calculateAndBindPopup(layer); // Ensure metadata is calculated for imported layers
        });
        map.fitBounds(kmlLayer.getBounds());
        saveMapData();
    };
    reader.readAsText(file);
};

const importCSV = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    Papa.parse(file, {
        header: true,
        dynamicTyping: true,
        complete: (results) => {
            results.data.forEach(point => {
                if (point.lat && point.lng) {
                    const marker = L.marker([point.lat, point.lng]).addTo(drawnItems);
                    let popupContent = '<ul>';
                    for (const key in point) {
                        popupContent += `<li><strong>${key}:</strong> ${point[key]}</li>`;
                    }
                    popupContent += '</ul>';
                    marker.bindPopup(popupContent);
                    // Store metadata for imported markers
                    marker.feature = marker.feature || {};
                    marker.feature.properties = marker.feature.properties || {};
                    marker.feature.properties.lat = point.lat;
                    marker.feature.properties.lng = point.lng;
                    marker.feature.properties.type = 'marker';
                }
            });
            saveMapData();
        }
    });
};

const saveMapData = () => {
    const geoJsonData = drawnItems.toGeoJSON();
    DB.set('mapData', { layers: geoJsonData.features });
    saveActiveProjectDataIntoForms(); // Save map data as part of the current project
};

const loadMapData = () => {
    const mapData = DB.get('mapData');
    if (mapData && mapData.layers) {
        drawnItems.clearLayers(); // Clear existing layers
        L.geoJSON(mapData, {
            onEachFeature: (feature, layer) => {
                drawnItems.addLayer(layer);
                // Re-bind popups and re-calculate properties if needed (though they should be saved)
                calculateAndBindPopup(layer);
            }
        }).addTo(map);
        if (drawnItems.getLayers().length > 0) {
            map.fitBounds(drawnItems.getBounds());
        }
    }
};

const exportMapJson = () => {
    const mapData = DB.get('mapData');
    const blob = new Blob([JSON.stringify(mapData, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `${getEl('app-main-title').textContent.trim() || 'map_data'}.json`;
    link.click();
    addNotification('Map', 'Map data exported as JSON.');
};

const importMapJson = (event) => {
    const file = event.target.files[0];
    if (!file) return;
    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedData = JSON.parse(e.target.result);
            DB.set('mapData', importedData);
            loadMapData(); // Reload map with imported data
            addNotification('Map', 'Map data imported from JSON.');
        } catch (error) {
            displayMessage('map-page', 'Error importing map JSON: Invalid file format.', 'error');
            console.error('Error importing map JSON:', error);
        }
    };
    reader.readAsText(file);
};

const exportMapPdf = async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape', 'mm', 'a4');

    const mapContainer = getEl('map-container');
    const originalDisplay = mapContainer.style.display;
    mapContainer.style.display = 'block'; // Ensure map is visible for html2canvas

    // Temporarily hide controls for screenshot
    const controls = document.querySelectorAll('.leaflet-control-container, .leaflet-control-custom');
    controls.forEach(c => c.style.display = 'none');

    // Add a temporary title and date for the PDF
    const tempHeader = document.createElement('div');
    tempHeader.style.cssText = `
        position: absolute; top: 10px; left: 10px; right: 10px; z-index: 1000;
        display: flex; justify-content: space-between; align-items: center;
        background: white; padding: 10px; border-radius: 8px; box-shadow: 0 2px 5px rgba(0,0,0,0.2);
    `;
    tempHeader.innerHTML = `
        <img src="${clientLogoInspection || ''}" style="height: 40px; object-fit: contain;">
        <h2 style="margin:0; font-size: 16px;">${getEl('app-main-title').textContent} - GIS Map</h2>
        <img src="${companyLogoInspection || ''}" style="height: 40px; object-fit: contain;">
    `;
    document.body.appendChild(tempHeader);

    await html2canvas(document.body, {
        useCORS: true,
        scale: 1, // Lower scale for better performance on large maps
        windowWidth: document.body.scrollWidth,
        windowHeight: document.body.scrollHeight,
        x: 0,
        y: 0,
        width: document.body.scrollWidth,
        height: document.body.scrollHeight,
    }).then(canvas => {
        const imgData = canvas.toDataURL('image/png');
        const imgWidth = pdf.internal.pageSize.getWidth();
        const imgHeight = (canvas.height * imgWidth) / canvas.width;
        pdf.addImage(imgData, 'PNG', 0, 0, imgWidth, imgHeight);
        pdf.save(`${getEl('app-main-title').textContent.trim() || 'gis_map'}.pdf`);
        addNotification('Map', 'GIS map exported as PDF.');
    }).finally(() => {
        mapContainer.style.display = originalDisplay;
        controls.forEach(c => c.style.display = ''); // Show controls again
        if (tempHeader && tempHeader.parentNode) {
            tempHeader.parentNode.removeChild(tempHeader);
        }
    });
};


// ======== 6. IMAGE HANDLING & METADATA ========
// Image storage is part of project data, handled by saveActiveProjectDataIntoForms
// EXIF.getData is async, so it will be called when a file is selected.

function getImageMetadata(file) {
    return new Promise((resolve) => {
        EXIF.getData(file, function() {
            const lat = EXIF.getTag(this, 'GPSLatitude');
            const lng = EXIF.getTag(this, 'GPSLongitude');
            const timestamp = EXIF.getTag(this, 'DateTimeOriginal');

            let gpsLocation = null;
            if (lat && lng) {
                const latRef = EXIF.getTag(this, 'GPSLatitudeRef') || 'N';
                const lngRef = EXIF.getTag(this, 'GPSLongitudeRef') || 'E';
                const latitude = (lat[0] + lat[1] / 60 + lat[2] / 3600) * (latRef === 'N' ? 1 : -1);
                const longitude = (lng[0] + lng[1] / 60 + lng[2] / 3600) * (lngRef === 'E' ? 1 : -1);
                gpsLocation = { latitude, longitude };
            }
            resolve({ gpsLocation, timestamp });
        });
    });
}

// Marzipano related functions
let marzipanoViewer = null;
let marzipanoScene = null;

function openMarzipanoViewerModal() {
    // Prompt user to select a 360 image
    const input = document.createElement('input');
    input.type = 'file';
    input.accept = 'image/*';
    input.onchange = (e) => {
        const file = e.target.files[0];
        if (file) {
            const reader = new FileReader();
            reader.onload = (event) => {
                openMarzipanoViewer(event.target.result);
            };
            reader.readAsDataURL(file);
        }
    };
    input.click();
}

function openMarzipanoViewer(imageUrl) {
    showModal('marzipano-viewer-modal');
    const viewerElement = getEl('marzipano-viewer');

    if (marzipanoViewer) {
        marzipanoViewer.destroy(); // Destroy previous viewer instance
        marzipanoViewer = null;
    }
    
    // Initialize Marzipano viewer
    marzipanoViewer = new Marzipano.Viewer(viewerElement);

    // Create a new scene
    const source = Marzipano.ImageUrlSource.fromString(imageUrl);
    const geometry = new Marzipano.EquirectangularGeometry([{ width: 4000 }]); // Use a reasonable default width
    const limiter = Marzipano.RectilinearView.limit.traditional(4000, 100 * Math.PI / 180);
    const view = new Marzipano.RectilinearView(null, limiter);

    marzipanoScene = marzipanoViewer.createScene({
        source: source,
        geometry: geometry,
        view: view,
        pinFirstLevel: true
    });

    marzipanoScene.switchTo();
}


// ======== 7. NOTIFICATIONS ENGINE ========
// addNotification function is already enhanced to store more metadata.
// Loading notifications is already implemented.

// ======== 8. AI ROAD DEFECT DETECTION ========
const handleAIAnalysis = async () => {
    const fileInput = getEl('ai-image-upload');
    const file = fileInput.files[0];
    if (!file) {
        displayMessage('ai-results-card', "Please upload an image first.", 'error');
        return;
    }
    getEl('ai-results-card').style.display = 'block';
    getEl('ai-results-table').style.display = 'none';
    getEl('ai-spinner').style.display = 'block';

    const reader = new FileReader();
    reader.readAsDataURL(file);
    reader.onload = async (e) => {
        const imageDataUrl = e.target.result;
        const { gpsLocation, timestamp } = await getImageMetadata(file);

        // Simulate AI processing
        setTimeout(() => {
            let aiResultHtml = '';
            let defects = [];

            // Simulate defect detection based on image name or random
            if (file.name.includes('defect') || Math.random() > 0.5) {
                defects = [
                    {
                        type: "Pothole",
                        severity: "High",
                        location: "Lower-left",
                        description: "Surface collapse due to traffic and environmental factors.",
                        action: "Immediate Patching Required"
                    },
                    {
                        type: "Longitudinal Crack",
                        severity: "Medium",
                        location: "Center",
                        description: "Crack running parallel to the pavement's centerline, potential for water ingress.",
                        action: "Seal Crack"
                    }
                ];
            } else {
                defects = [{
                    type: "",
                    severity: "",
                    location: "",
                    description: "No visible defects detected.",
                    action: ""
                }];
            }

            aiResultHtml += `
                <table>
                    <thead>
                        <tr>
                            <th>Image Preview</th>
                            <th>GPS Location</th>
                            <th>Timestamp</th>
                            <th>Defect</th>
                            <th>Severity</th>
                            <th>Position in Image</th>
                            <th>Description</th>
                            <th>Action</th>
                        </tr>
                    </thead>
                    <tbody>
            `;

            defects.forEach((defect, index) => {
                aiResultHtml += `
                    <tr>
                        ${index === 0 ? `<td rowspan="${defects.length}"><img src="${imageDataUrl}" style="max-width:150px; max-height:100px; object-fit:contain;"></td>` : ''}
                        ${index === 0 ? `<td rowspan="${defects.length}">${gpsLocation ? `${gpsLocation.latitude.toFixed(6)}, ${gpsLocation.longitude.toFixed(6)}` : 'N/A'}</td>` : ''}
                        ${index === 0 ? `<td rowspan="${defects.length}">${timestamp || 'N/A'}</td>` : ''}
                        <td>${defect.type}</td>
                        <td>${defect.severity}</td>
                        <td>${defect.location}</td>
                        <td>${defect.description}</td>
                        <td>${defect.action}</td>
                    </tr>
                `;
            });
            aiResultHtml += `</tbody></table>`;

            getEl('ai-spinner').style.display = 'none';
            getEl('ai-results-table').innerHTML = aiResultHtml;
            getEl('ai-results-table').style.display = 'block';
            addNotification('AI Analysis', `Analysis complete for image ${file.name}.`, 'success', gpsLocation, imageDataUrl);

            // Store AI results as part of the current project
            const aiResults = {
                imageId: generateId(),
                fileName: file.name,
                imageDataUrl: imageDataUrl,
                gpsLocation: gpsLocation,
                timestamp: timestamp,
                defects: defects
            };
            const projects = DB.get('projects');
            const currentProject = projects.find(p => p.id === currentProjectId);
            if (currentProject) {
                currentProject.data.aiResults = currentProject.data.aiResults || [];
                currentProject.data.aiResults.push(aiResults);
                DB.set('projects', projects);
            }
        }, 2500);
    };
};


const loadAIPrompt = () => {
    const aiPromptEl = getEl('ai-prompt-textarea');
    if (aiPromptEl) aiPromptEl.value = localStorage.getItem('ai_prompt');
};
const saveAIPrompt = () => {
    const aiPromptEl = getEl('ai-prompt-textarea');
    if (aiPromptEl) {
        localStorage.setItem('ai_prompt', aiPromptEl.value);
        displayMessage('ai-prompt-card-message', 'AI prompt saved!', 'success');
    }
};

const exportAiResultsToCsv = () => {
    const table = getEl('ai-results-table').querySelector('table');
    if (!table) {
        displayMessage('ai-results-card', 'No AI analysis results to export.', 'error');
        return;
    }

    let csv = [];
    const rows = table.querySelectorAll("tr");
    for (const row of rows) {
        let cols = row.querySelectorAll("td, th");
        let csvrow = [];
        for (const col of cols) {
            // Skip image column for CSV export, or just get text content
            if (col.querySelector('img')) {
                csvrow.push(''); // Placeholder for image
            } else {
                let data = `"${col.innerText.replace(/"/g, '""')}"`;
                csvrow.push(data);
            }
        }
        csv.push(csvrow.join(","));
    }
    const csvFile = new Blob([csv.join("\n")], { type: "text/csv" });
    const link = document.createElement("a");
    link.href = URL.createObjectURL(csvFile);
    link.download = `${getEl('app-main-title').textContent.trim() || 'ai_results'}.csv`;
    link.click();
    addNotification('AI Analysis', 'AI results exported to CSV.');
};

const exportAiResultsToPdf = async () => {
    const { jsPDF } = window.jspdf;
    const pdf = new jsPDF('landscape', 'mm', 'a4');
    const table = getEl('ai-results-table').querySelector('table');

    if (!table) {
        displayMessage('ai-results-card', 'No AI analysis results to export.', 'error');
        return;
    }

    // Clone the table for processing without modifying the live DOM
    const clonedTable = table.cloneNode(true);
    // Remove image previews for autoTable, we'll add them manually
    clonedTable.querySelectorAll('img').forEach(img => img.remove());

    const head = Array.from(clonedTable.querySelectorAll('thead th')).map(th => th.textContent);
    const body = Array.from(clonedTable.querySelectorAll('tbody tr')).map(row => {
        return Array.from(row.querySelectorAll('td')).map(td => td.textContent);
    });

    // Get image data URLs separately
    const imageDataUrls = Array.from(table.querySelectorAll('tbody tr td:first-child img')).map(img => img.src);

    pdf.autoTable({
        head: [head],
        body: body,
        startY: 20,
        didDrawCell: (data) => {
            // Check if it's the first column (Image Preview) and a body cell
            if (data.column.index === 0 && data.cell.section === 'body' && imageDataUrls[data.row.index]) {
                const img = imageDataUrls[data.row.index];
                pdf.addImage(img, 'PNG', data.cell.x + 2, data.cell.y + 2, data.cell.width - 4, data.cell.height - 4);
            }
        },
        columnStyles: {
            0: { cellWidth: 30 } // Adjust width for image column
        },
        styles: {
            cellPadding: 2,
            fontSize: 8,
            valign: 'middle',
            halign: 'center'
        },
        headStyles: {
            fillColor: [0, 123, 255],
            textColor: 255
        },
        margin: { top: 10, left: 10, right: 10, bottom: 10 }
    });

    pdf.save(`${getEl('app-main-title').textContent.trim() || 'ai_results'}.pdf`);
    addNotification('AI Analysis', 'AI results exported to PDF.');
};


// ======== 9. NOTEBOOK SYSTEM ========
let editingNoteId = null;

function saveNote() {
    const noteTitle = getEl('note-title').value;
    const noteContent = getEl('note-content').value;
    const noteTags = getEl('note-tags').value.split(',').map(tag => tag.trim()).filter(tag => tag !== '');

    if (!noteTitle || !noteContent) {
        displayMessage('note-modal', 'Note title and content cannot be empty.', 'error');
        return;
    }

    let notes = DB.get('notes');
    const now = new Date().toISOString();

    if (editingNoteId) {
        // Update existing note
        const noteIndex = notes.findIndex(n => n.note_id === editingNoteId);
        if (noteIndex !== -1) {
            notes[noteIndex] = {
                ...notes[noteIndex],
                title: noteTitle,
                content: noteContent,
                tags: noteTags,
                updated_at: now,
                projectId: currentProjectId // Ensure it's linked to current project
            };
            addNotification('Notebook', `Note "${noteTitle}" updated.`, 'info');
        }
    } else {
        // Add new note
        const newNote = {
            note_id: generateId(),
            project_id: currentProjectId,
            title: noteTitle,
            content: noteContent,
            created_at: now,
            updated_at: now,
            tags: noteTags,
            location: null, // Placeholder for linked map marker, image location
            image_refs: [] // Placeholder for embedded images
        };
        notes.push(newNote);
        addNotification('Notebook', `New note "${noteTitle}" created.`, 'success');
    }

    DB.set('notes', notes);
    hideModal('note-modal');
    loadNotes(); // Reload notes list
    editingNoteId = null; // Reset editing state
    getEl('note-form').reset(); // Clear form
    saveActiveProjectDataIntoForms(); // Save notes as part of the current project
}

function loadNotes() {
    const notesListEl = getEl('notes-list');
    notesListEl.innerHTML = '';
    const notes = DB.get('notes').filter(note => note.project_id === currentProjectId); // Filter by current project

    if (notes.length === 0) {
        notesListEl.innerHTML = '<p>No notes yet. Add one to get started.</p>';
        return;
    }

    notes.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at)); // Sort by most recent

    notes.forEach(note => {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note-entry';
        noteDiv.innerHTML = `
            <h3>${note.title}</h3>
            <div class="note-meta">
                Created: ${new Date(note.created_at).toLocaleString()} | Last Updated: ${new Date(note.updated_at).toLocaleString()}
                ${note.tags && note.tags.length > 0 ? ` | Tags: ${note.tags.map(tag => `<span class="tag-pill">${tag}</span>`).join('')}` : ''}
            </div>
            <div class="note-content-display">${note.content}</div>
            <div class="note-actions">
                <button class="btn" onclick="editNote('${note.note_id}')">Edit</button>
                <button class="btn-danger" onclick="deleteNote('${note.note_id}')">Delete</button>
            </div>
        `;
        notesListEl.appendChild(noteDiv);
    });
}

function editNote(noteId) {
    const notes = DB.get('notes');
    const noteToEdit = notes.find(n => n.note_id === noteId);
    if (noteToEdit) {
        editingNoteId = noteId;
        getEl('note-modal-title').textContent = 'Edit Note';
        getEl('note-title').value = noteToEdit.title;
        getEl('note-content').value = noteToEdit.content;
        getEl('note-tags').value = noteToEdit.tags.join(', ');
        showModal('note-modal');
    }
}

function deleteNote(noteId) {
    if (!confirm('Are you sure you want to delete this note?')) return;
    let notes = DB.get('notes');
    notes = notes.filter(n => n.note_id !== noteId);
    DB.set('notes', notes);
    addNotification('Notebook', 'Note deleted.', 'danger');
    loadNotes();
    saveActiveProjectDataIntoForms(); // Update project data
}

function filterNotes() {
    const filterTags = getEl('note-filter-tags').value.toLowerCase().split(',').map(tag => tag.trim()).filter(tag => tag !== '');
    const notesListEl = getEl('notes-list');
    notesListEl.innerHTML = '';
    const allNotes = DB.get('notes').filter(note => note.project_id === currentProjectId);

    const filteredNotes = allNotes.filter(note => {
        if (filterTags.length === 0) return true; // No filter, show all
        return filterTags.some(filterTag => note.tags.some(noteTag => noteTag.toLowerCase().includes(filterTag)));
    });

    if (filteredNotes.length === 0) {
        notesListEl.innerHTML = '<p>No notes found matching your filter.</p>';
        return;
    }

    filteredNotes.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

    filteredNotes.forEach(note => {
        const noteDiv = document.createElement('div');
        noteDiv.className = 'note-entry';
        noteDiv.innerHTML = `
            <h3>${note.title}</h3>
            <div class="note-meta">
                Created: ${new Date(note.created_at).toLocaleString()} | Last Updated: ${new Date(note.updated_at).toLocaleString()}
                ${note.tags && note.tags.length > 0 ? ` | Tags: ${note.tags.map(tag => `<span class="tag-pill">${tag}</span>`).join('')}` : ''}
            </div>
            <div class="note-content-display">${note.content}</div>
            <div class="note-actions">
                <button class="btn" onclick="editNote('${note.note_id}')">Edit</button>
                <button class="btn-danger" onclick="deleteNote('${note.note_id}')">Delete</button>
            </div>
        `;
        notesListEl.appendChild(noteDiv);
    });
}


// ======== 10. DRAWING & ANNOTATION TOOL ========
let drawingCanvas, drawingCtx;
let isDrawing = false;
let currentTool = 'pen';
let strokeColor = '#000000';
let strokeWidth = 2;
let startX, startY;
let currentDrawingData = []; // Stores drawing commands for persistence
let backgroundImage = null; // Stores the loaded image for the canvas

function initializeDrawingCanvas() {
    drawingCanvas = getEl('drawing-canvas');
    drawingCtx = drawingCanvas.getContext('2d');

    // Set canvas size to fill container, or a default if container is not ready
    const container = getEl('drawing-canvas-container');
    drawingCanvas.width = container.clientWidth;
    drawingCanvas.height = 500; // Default height, can be adjusted

    // Event Listeners
    drawingCanvas.removeEventListener('mousedown', startDrawing); // Remove old listeners to prevent duplicates
    drawingCanvas.removeEventListener('mousemove', draw);
    drawingCanvas.removeEventListener('mouseup', stopDrawing);
    drawingCanvas.removeEventListener('mouseout', stopDrawing);

    drawingCanvas.addEventListener('mousedown', startDrawing);
    drawingCanvas.addEventListener('mousemove', draw);
    drawingCanvas.addEventListener('mouseup', stopDrawing);
    drawingCanvas.addEventListener('mouseout', stopDrawing);

    // Responsive canvas
    window.removeEventListener('resize', resizeDrawingCanvas); // Remove old listeners
    window.addEventListener('resize', resizeDrawingCanvas);
    resizeDrawingCanvas(); // Initial resize

    redrawCanvas(); // Draw existing data on init
}

function resizeDrawingCanvas() {
    const container = getEl('drawing-canvas-container');
    const tempCanvas = document.createElement('canvas');
    const tempCtx = tempCanvas.getContext('2d');
    tempCanvas.width = drawingCanvas.width;
    tempCanvas.height = drawingCanvas.height;
    tempCtx.drawImage(drawingCanvas, 0, 0); // Save current content

    drawingCanvas.width = container.clientWidth;
    // Maintain aspect ratio if an image is loaded, otherwise use default height
    if (backgroundImage) {
        drawingCanvas.height = (backgroundImage.height / backgroundImage.width) * drawingCanvas.width;
    } else {
        drawingCanvas.height = 500;
    }
    
    redrawCanvas(); // Redraw content after resize
}

function redrawCanvas() {
    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    if (backgroundImage) {
        drawingCtx.drawImage(backgroundImage, 0, 0, drawingCanvas.width, drawingCanvas.height);
    }
    currentDrawingData.forEach(item => {
        drawingCtx.strokeStyle = item.color;
        drawingCtx.lineWidth = item.width;
        drawingCtx.fillStyle = item.color;
        drawingCtx.font = `${item.width * 5}px sans-serif`; // Adjust font size for text

        if (item.tool === 'pen') {
            drawingCtx.beginPath();
            drawingCtx.moveTo(item.points[0].x, item.points[0].y);
            for (let i = 1; i < item.points.length; i++) {
                drawingCtx.lineTo(item.points[i].x, item.points[i].y);
            }
            drawingCtx.stroke();
        } else if (item.tool === 'rect') {
            drawingCtx.strokeRect(item.x, item.y, item.width, item.height);
        } else if (item.tool === 'circle') {
            drawingCtx.beginPath();
            drawingCtx.arc(item.x, item.y, item.radius, 0, 2 * Math.PI);
            drawingCtx.stroke();
        } else if (item.tool === 'arrow') {
            drawArrow(drawingCtx, item.startX, item.startY, item.endX, item.endY, item.width, item.color);
        } else if (item.tool === 'text') {
            drawingCtx.fillText(item.text, item.x, item.y);
        }
    });
}

function setDrawingTool(tool) {
    currentTool = tool;
    document.querySelectorAll('#drawing-toolbar button').forEach(btn => btn.classList.remove('active'));
    getEl(`tool-${tool}`).classList.add('active');
}

function setDrawingColor(color) {
    strokeColor = color;
}

function setDrawingWidth(width) {
    strokeWidth = parseInt(width, 10);
}

function startDrawing(e) {
    isDrawing = true;
    startX = e.offsetX;
    startY = e.offsetY;
    if (currentTool === 'pen') {
        currentDrawingData.push({ tool: 'pen', color: strokeColor, width: strokeWidth, points: [{ x: startX, y: startY }] });
    } else if (currentTool === 'text') {
        const text = prompt('Enter text:');
        if (text) {
            currentDrawingData.push({ tool: 'text', color: strokeColor, width: strokeWidth, text: text, x: startX, y: startY });
            redrawCanvas();
            saveDrawing();
        }
        isDrawing = false; // Stop drawing after text input
    }
}

function draw(e) {
    if (!isDrawing) return;

    const currentX = e.offsetX;
    const currentY = e.offsetY;

    if (currentTool === 'pen') {
        currentDrawingData[currentDrawingData.length - 1].points.push({ x: currentX, y: currentY });
        redrawCanvas();
    } else if (currentTool === 'eraser') {
        drawingCtx.clearRect(currentX - strokeWidth * 5, currentY - strokeWidth * 5, strokeWidth * 10, strokeWidth * 10);
        // For eraser, we actually modify the canvas directly, not store commands.
        // This is a simplification; for true vector eraser, it's more complex.
        // For now, we'll just clear the area on the canvas.
        // To make it persistent, one would need to re-render the whole canvas to a new image,
        // or implement a more complex vector eraser that modifies existing shapes.
        // For this simulation, we'll just clear the area on the canvas.
        // To make it persistent, one would need to re-render the whole canvas to a new image,
        // or implement a more complex vector eraser that modifies existing shapes.
        // For simplicity, we'll just redraw everything on mouseup/mouseout.
    } else {
        redrawCanvas(); // Clear and redraw to show preview
        drawingCtx.strokeStyle = strokeColor;
        drawingCtx.lineWidth = strokeWidth;
        if (currentTool === 'rect') {
            drawingCtx.strokeRect(startX, startY, currentX - startX, currentY - startY);
        } else if (currentTool === 'circle') {
            const radius = Math.sqrt(Math.pow(currentX - startX, 2) + Math.pow(currentY - startY, 2)) / 2;
            const centerX = startX + (currentX - startX) / 2;
            const centerY = startY + (currentY - startY) / 2;
            drawingCtx.beginPath();
            drawingCtx.arc(centerX, centerY, radius, 0, 2 * Math.PI);
            drawingCtx.stroke();
        } else if (currentTool === 'arrow') {
            drawArrow(drawingCtx, startX, startY, currentX, currentY, strokeWidth, strokeColor);
        }
    }
}

function stopDrawing(e) {
    if (!isDrawing) return;
    isDrawing = false;

    const endX = e.offsetX;
    const endY = e.offsetY;

    if (currentTool === 'rect') {
        currentDrawingData.push({ tool: 'rect', color: strokeColor, width: strokeWidth, x: startX, y: startY, width: endX - startX, height: endY - startY });
    } else if (currentTool === 'circle') {
        const radius = Math.sqrt(Math.pow(endX - startX, 2) + Math.pow(endY - startY, 2)) / 2;
        const centerX = startX + (endX - startX) / 2;
        const centerY = startY + (endY - startY) / 2;
        currentDrawingData.push({ tool: 'circle', color: strokeColor, width: strokeWidth, x: centerX, y: centerY, radius: radius });
    } else if (currentTool === 'arrow') {
        currentDrawingData.push({ tool: 'arrow', color: strokeColor, width: strokeWidth, startX: startX, startY: startY, endX: endX, endY: endY });
    }
    redrawCanvas(); // Final redraw to ensure everything is rendered
    saveDrawing(); // Save after each drawing action
}

function drawArrow(ctx, fromX, fromY, toX, toY, lineWidth, color) {
    const headlen = 10; // length of head in pixels
    const dx = toX - fromX;
    const dy = toY - fromY;
    const angle = Math.atan2(dy, dx);

    ctx.beginPath();
    ctx.moveTo(fromX, fromY);
    ctx.lineTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle - Math.PI / 6), toY - headlen * Math.sin(angle - Math.PI / 6));
    ctx.moveTo(toX, toY);
    ctx.lineTo(toX - headlen * Math.cos(angle + Math.PI / 6), toY - headlen * Math.sin(angle + Math.PI / 6));
    ctx.strokeStyle = color;
    ctx.lineWidth = lineWidth;
    ctx.stroke();
}


function clearDrawingCanvas() {
    drawingCtx.clearRect(0, 0, drawingCanvas.width, drawingCanvas.height);
    currentDrawingData = [];
    backgroundImage = null;
    saveDrawing(); // Save cleared state
    addNotification('Drawing', 'Canvas cleared.', 'info');
}

function loadDrawingImage(event) {
    const file = event.target.files[0];
    if (!file) return;

    const reader = new FileReader();
    reader.onload = (e) => {
        const img = new Image();
        img.onload = () => {
            backgroundImage = img;
            resizeDrawingCanvas(); // Adjust canvas size to image and redraw
            saveDrawing(); // Save image as part of drawing data
            addNotification('Drawing', `Image "${file.name}" loaded onto canvas.`, 'info');
        };
        img.src = e.target.result;
    };
    reader.readAsDataURL(file);
}

function saveDrawing(drawingId = null) {
    let drawings = DB.get('drawings');
    const now = new Date().toISOString();

    const canvasDataUrl = drawingCanvas.toDataURL('image/png'); // Save current canvas state as image

    const drawingToSave = {
        drawing_id: drawingId || generateId(),
        project_id: currentProjectId,
        image_data_url: canvasDataUrl, // Full canvas image
        vector_data: currentDrawingData, // Vector commands for re-editing
        background_image: backgroundImage ? backgroundImage.src : null,
        created_at: now,
        updated_at: now,
        title: drawingId ? drawings.find(d => d.drawing_id === drawingId)?.title : `Drawing ${new Date().toLocaleString()}` // Use existing title or generate
    };

    const existingIndex = drawings.findIndex(d => d.drawing_id === drawingToSave.drawing_id);
    if (existingIndex !== -1) {
        drawings[existingIndex] = drawingToSave;
        addNotification('Drawing', `Drawing updated.`, 'info');
    } else {
        drawings.push(drawingToSave);
        addNotification('Drawing', `New drawing saved.`, 'success');
    }
    DB.set('drawings', drawings);
    loadDrawingsList(); // Refresh list
    saveActiveProjectDataIntoForms(); // Save drawings as part of the current project
}

function loadDrawing(drawingId) {
    const drawings = DB.get('drawings');
    const drawingToLoad = drawings.find(d => d.drawing_id === drawingId);
    if (drawingToLoad) {
        clearDrawingCanvas(); // Clear current canvas
        currentDrawingData = drawingToLoad.vector_data || [];

        if (drawingToLoad.background_image) {
            const img = new Image();
            img.onload = () => {
                backgroundImage = img;
                resizeDrawingCanvas(); // Adjust canvas size to image and redraw
            };
            img.src = drawingToLoad.background_image;
        } else {
            redrawCanvas(); // Just redraw vector data
        }
        addNotification('Drawing', `Drawing "${drawingToLoad.title}" loaded.`, 'info');
    }
}

function deleteDrawing(drawingId) {
    if (!confirm('Are you sure you want to delete this drawing?')) return;
    let drawings = DB.get('drawings');
    drawings = drawings.filter(d => d.drawing_id !== drawingId);
    DB.set('drawings', drawings);
    addNotification('Drawing', 'Drawing deleted.', 'danger');
    loadDrawingsList();
    saveActiveProjectDataIntoForms(); // Update project data
}

function loadDrawingsList() {
    const drawingsListEl = getEl('drawings-list');
    drawingsListEl.innerHTML = '';
    const drawings = DB.get('drawings').filter(drawing => drawing.project_id === currentProjectId);

    if (drawings.length === 0) {
        drawingsListEl.innerHTML = '<p>No drawings saved yet for this project.</p>';
        return;
    }

    drawings.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));

    drawings.forEach(drawing => {
        const li = document.createElement('li');
        li.style.display = 'flex';
        li.style.justifyContent = 'space-between';
        li.style.alignItems = 'center';
        li.style.padding = '8px';
        li.style.borderBottom = '1px solid var(--glass-border)';
        li.innerHTML = `
            <span style="font-weight: bold; cursor: pointer;" onclick="loadDrawing('${drawing.drawing_id}')">${drawing.title}</span>
            <div>
                <button class="btn" onclick="loadDrawing('${drawing.drawing_id}')">Load</button>
                <button class="btn-danger" onclick="deleteDrawing('${drawing.drawing_id}')">Delete</button>
            </div>
        `;
        drawingsListEl.appendChild(li);
    });
}

function exportDrawing(format) {
    const drawingTitle = `drawing_${new Date().toISOString().slice(0,10)}`;
    if (format === 'png') {
        const link = document.createElement('a');
        link.download = `${drawingTitle}.png`;
        link.href = drawingCanvas.toDataURL('image/png');
        link.click();
        addNotification('Drawing', 'Drawing exported as PNG.', 'info');
    } else if (format === 'json') {
        const data = {
            backgroundImage: backgroundImage ? backgroundImage.src : null,
            vectorData: currentDrawingData
        };
        const blob = new Blob([JSON.stringify(data, null, 2)], { type: 'application/json' });
        const link = document.createElement('a');
        link.href = URL.createObjectURL(blob);
        link.download = `${drawingTitle}.json`;
        link.click();
        addNotification('Drawing', 'Drawing exported as JSON.', 'info');
    }
}


// ======== 11. SAVE & LOAD PROJECTS (Enhanced) ========
// currentProjectId is already global
// saveProjectAs, saveProject, loadProject, createNewProject, deleteProject, loadProjectsList are already defined

// Function to save the active project data
// This is called whenever data changes in the forms/tables
function saveActiveProjectDataIntoForms() {
    // This function doesn't save to a named project directly,
    // it updates the data in the currentProjectId's data object
    // which will then be saved when `saveProject` is called.
    // It's effectively an "auto-save" for the active session.

    const projects = DB.get('projects');
    let projectToUpdate = projects.find(p => p.id === currentProjectId);

    if (!projectToUpdate) {
        // If no project is active or it's a new session, create a default one
        projectToUpdate = {
            id: currentProjectId,
            name: document.querySelector('.main-title-report').textContent || langDict[currentLang].report_title,
            data: {}
        };
        projects.push(projectToUpdate);
    }

    // Capture data from Inspection Report page
    const inspectionReportData = {
        title: document.querySelector('.main-title-report').textContent,
        date: getEl('display-date').value,
        reportDetails: [],
        clientLogoInspection: clientLogoInspection,
        companyLogoInspection: companyLogoInspection,
    };
    if (reportTable && reportTable.tBodies[0]) {
        const reportRows = reportTable.tBodies[0].querySelectorAll('tr');
        reportRows.forEach(row => {
            const rowData = {
                id: row.dataset.id,
                asset: row.cells[1].textContent,
                status: row.cells[2].textContent,
                recommendation: row.cells[3].textContent,
                quantity: row.cells[4].textContent,
                photos: Array.from(row.cells[5].querySelectorAll('img')).map(img => img.src),
                latitude: row.cells[6].textContent,
                longitude: row.cells[7].textContent
            };
            inspectionReportData.reportDetails.push(rowData);
        });
    }
    projectToUpdate.data.inspection = inspectionReportData;


    // Capture data from Cost Estimation page
    const costEstimationData = {
        workOrderNo: getEl('work-order-no') ? getEl('work-order-no').value : '',
        tpcNo: getEl('tpc-no') ? getEl('tpc-no').value : '',
        workDesc: getEl('work-desc') ? getEl('work-desc').value : '',
        tableData: []
    };
    if (costEstimationTable && costEstimationTable.tBodies[0]) {
        const costRows = costEstimationTable.tBodies[0].querySelectorAll('tr');
        costRows.forEach(row => {
            const rowData = {
                boqRef: row.cells[0].textContent,
                description: row.cells[1].textContent,
                unit: row.cells[2].textContent,
                nr: row.cells[3].textContent,
                length: row.cells[4].textContent,
                width: row.cells[5].textContent,
                height: row.cells[6].textContent,
                totalQty: row.cells[7].textContent,
                rate: row.cells[8].textContent,
                amount: row.cells[9].textContent,
                remarks: row.cells[10].textContent,
            };
            costEstimationData.tableData.push(rowData);
        });
    }
    projectToUpdate.data.estimation = costEstimationData;

    // Capture GIS Map data
    projectToUpdate.data.map = DB.get('mapData');

    // Capture AI Results
    const aiResultsElement = getEl('ai-results-table');
    if (aiResultsElement && aiResultsElement.style.display !== 'none') {
        const aiResultTable = aiResultsElement.querySelector('table');
        if (aiResultTable) {
            const aiData = [];
            Array.from(aiResultTable.querySelectorAll('tbody tr')).forEach(row => {
                const rowCells = Array.from(row.cells);
                const rowObj = {
                    imagePreview: rowCells[0].querySelector('img') ? rowCells[0].querySelector('img').src : null,
                    gpsLocation: rowCells[1].textContent,
                    timestamp: rowCells[2].textContent,
                    defect: rowCells[3].textContent,
                    severity: rowCells[4].textContent,
                    positionInImage: rowCells[5].textContent,
                    description: rowCells[6].textContent,
                    action: rowCells[7].textContent
                };
                aiData.push(rowObj);
            });
            projectToUpdate.data.aiResults = aiData;
        }
    } else {
        projectToUpdate.data.aiResults = []; // Clear if AI results not displayed
    }

    // Capture Notes (filtered by currentProjectId)
    projectToUpdate.data.notes = DB.get('notes').filter(n => n.project_id === currentProjectId);

    // Capture Drawings (filtered by currentProjectId)
    projectToUpdate.data.drawings = DB.get('drawings').filter(d => d.project_id === currentProjectId);


    DB.set('projects', projects);
}


// Function to load the active project data into forms/tables
function loadActiveProjectDataIntoForms() {
    const projects = DB.get('projects');
    const project = projects.find(p => p.id === currentProjectId);

    if (project && project.data) {
        const projectData = project.data;

        // Load Inspection Report data
        if (projectData.inspection) {
            const mainTitleReportEl = document.querySelector('.main-title-report');
            if (mainTitleReportEl) mainTitleReportEl.textContent = projectData.inspection.title || project.name || langDict[currentLang].report_title;
            getEl('app-main-title').textContent = project.name; // Update main app title

            const displayDateEl = document.getElementById('display-date');
            if (displayDateEl) displayDateEl.value = projectData.inspection.date || new Date().toISOString().split('T')[0];

            if (reportTable && reportTable.tBodies[0]) {
                const tbody = reportTable.tBodies[0];
                tbody.innerHTML = ''; // Clear existing rows
                projectData.inspection.reportDetails.forEach(rowData => {
                    addRowReport(rowData); // Re-add rows with saved data
                });
            }
            clientLogoInspection = projectData.inspection.clientLogoInspection || null;
            const clientLogoInspectionEl = getEl('client-logo-inspection');
            if (clientLogoInspectionEl) clientLogoInspectionEl.src = clientLogoInspection || '';
            companyLogoInspection = projectData.inspection.companyLogoInspection || null;
            const companyLogoInspectionEl = getEl('company-logo-inspection');
            if (companyLogoInspectionEl) companyLogoInspectionEl.src = companyLogoInspection || '';
        } else {
            // If no inspection data, clear relevant fields/tables
            const mainTitleReportEl = document.querySelector('.main-title-report');
            if (mainTitleReportEl) mainTitleReportEl.textContent = project.name || langDict[currentLang].report_title;
            getEl('app-main-title').textContent = project.name;
            const displayDateEl = document.getElementById('display-date');
            if (displayDateEl) displayDateEl.value = new Date().toISOString().split('T')[0];
            if (reportTable && reportTable.tBodies[0]) reportTable.tBodies[0].innerHTML = '';
            if (getEl('client-logo-inspection')) getEl('client-logo-inspection').src = '';
            clientLogoInspection = null;
            if (getEl('company-logo-inspection')) getEl('company-logo-inspection').src = '';
            companyLogoInspection = null;
        }

        // Load Cost Estimation data
        if (projectData.estimation) {
            if (getEl('work-order-no')) getEl('work-order-no').value = projectData.estimation.workOrderNo || '';
            if (getEl('tpc-no')) getEl('tpc-no').value = projectData.estimation.tpcNo || '';
            if (getEl('work-desc')) getEl('work-desc').value = projectData.estimation.workDesc || '';

            if (costEstimationTable && costEstimationTable.tBodies[0]) {
                const costTbody = costEstimationTable.tBodies[0];
                costTbody.innerHTML = ''; // Clear existing rows
                projectData.estimation.tableData.forEach(rowData => {
                    insertBOQRow(rowData); // Re-add rows with saved data
                });
                calculateCostEstimationTotal();
            }
            clientLogoEstimation = projectData.estimation.clientLogoEstimation || null;
            const clientLogoEstimationEl = getEl('client-logo-estimation');
            if (clientLogoEstimationEl) clientLogoEstimationEl.src = clientLogoEstimation || '';
            companyLogoEstimation = projectData.estimation.companyLogoEstimation || null;
            const companyLogoEstimationEl = getEl('company-logo-estimation');
            if (companyLogoEstimationEl) companyLogoEstimationEl.src = companyLogoEstimation || '';
        } else {
            // If no estimation data, clear relevant fields/tables
            if (getEl('work-order-no')) getEl('work-order-no').value = '';
            if (getEl('tpc-no')) getEl('tpc-no').value = '';
            if (getEl('work-desc')) getEl('work-desc').value = '';
            if (costEstimationTable && costEstimationTable.tBodies[0]) costEstimationTable.tBodies[0].innerHTML = '';
            calculateCostEstimationTotal();
            if (getEl('client-logo-estimation')) getEl('client-logo-estimation').src = '';
            clientLogoEstimation = null;
            if (getEl('company-logo-estimation')) getEl('company-logo-estimation').src = '';
            companyLogoEstimation = null;
        }

        // Load GIS Map data
        if (projectData.map) {
            DB.set('mapData', projectData.map);
            if (window.mapInitialized) { // Only load if map is already initialized
                loadMapData();
            }
        } else {
            DB.set('mapData', { layers: [] }); // Clear map data
            if (window.mapInitialized) {
                drawnItems.clearLayers();
            }
        }

        // Load AI Results
        if (projectData.aiResults && projectData.aiResults.length > 0) {
            getEl('ai-results-card').style.display = 'block';
            getEl('ai-spinner').style.display = 'none';
            let aiResultHtml = `<table><thead><tr><th>Image Preview</th><th>GPS Location</th><th>Timestamp</th><th>Defect</th><th>Severity</th><th>Position in Image</th><th>Description</th><th>Action</th></tr></thead><tbody>`;
            projectData.aiResults.forEach(result => {
                aiResultHtml += `
                    <tr>
                        <td><img src="${result.imageDataUrl}" style="max-width:150px; max-height:100px; object-fit:contain;"></td>
                        <td>${result.gpsLocation ? `${result.gpsLocation.latitude.toFixed(6)}, ${result.gpsLocation.longitude.toFixed(6)}` : 'N/A'}</td>
                        <td>${result.timestamp || 'N/A'}</td>
                        <td>${result.defects[0].type}</td>
                        <td>${result.defects[0].severity}</td>
                        <td>${result.defects[0].location}</td>
                        <td>${result.defects[0].description}</td>
                        <td>${result.defects[0].action}</td>
                    </tr>
                `;
            });
            aiResultHtml += `</tbody></table>`;
            getEl('ai-results-table').innerHTML = aiResultHtml;
            getEl('ai-results-table').style.display = 'block';
        } else {
            getEl('ai-results-card').style.display = 'none';
            getEl('ai-results-table').innerHTML = '';
        }

        // Load Notes (will be filtered by currentProjectId when loadNotes() is called)
        // No direct loading here, loadNotes() will handle it when notebook page is activated.

        // Load Drawings (will be filtered by currentProjectId when loadDrawingsList() is called)
        // No direct loading here, loadDrawingsList() will handle it when drawing page is activated.

        // Reset current form inputs for new entries
        if (getEl('asset')) getEl('asset').value = '';
        if (getEl('status')) getEl('status').value = '';
        if (getEl('recommendation')) getEl('recommendation').value = '';
        if (getEl('photo-previews')) getEl('photo-previews').innerHTML = '';
        if (getEl('lat-display')) getEl('lat-display').textContent = 'N/A';
        if (getEl('lng-display')) getEl('lng-display').textContent = 'N/A';
        if (reportCurrentMarker) {
            reportMap.removeLayer(reportCurrentMarker);
            reportCurrentMarker = null;
        }
        if (getEl('boq-nr')) getEl('boq-nr').value = '';
        if (getEl('boq-length')) getEl('boq-length').value = '';
        if (getEl('boq-width')) getEl('boq-width').value = '';
        if (getEl('boq-height')) getEl('boq-height').value = '';
        if (getEl('boq-total-qty')) getEl('boq-total-qty').value = '';
        if (getEl('boq-amount')) getEl('boq-amount').value = '';
        if (getEl('boq-remarks')) getEl('boq-remarks').value = '';
        if (getEl('boq-ref-select')) getEl('boq-ref-select').selectedIndex = 0;
        updateBOQDetails(); // Update related fields
    } else {
        // If no project or no data, initialize with a blank slate
        createNewProject();
    }
}

function updateMainTitle(projectName) {
    const mainTitleReportEl = document.querySelector('.main-title-report');
    if (mainTitleReportEl) mainTitleReportEl.textContent = projectName;
    getEl('app-main-title').textContent = projectName;
}

// Export/Import All Projects
function exportAllProjects() {
    const allProjects = DB.get('projects');
    const blob = new Blob([JSON.stringify(allProjects, null, 2)], { type: 'application/json' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'all_engineering_projects.json';
    link.click();
    addNotification('Projects', 'All projects exported as JSON.', 'info');
}

function importAllProjects(event) {
    const file = event.target.files[0];
    if (!file) return;

    if (!confirm('Importing projects will overwrite existing saved projects. Are you sure?')) {
        return;
    }

    const reader = new FileReader();
    reader.onload = (e) => {
        try {
            const importedProjects = JSON.parse(e.target.result);
            DB.set('projects', importedProjects);
            localStorage.setItem('currentProjectId', importedProjects[0] ? importedProjects[0].id : 'default-project');
            currentProjectId = localStorage.getItem('currentProjectId');
            loadProjectsList();
            loadProject(currentProjectId); // Load the first project from the imported list
            addNotification('Projects', 'All projects imported successfully.', 'success');
        } catch (error) {
            displayMessage('saved-projects-page', 'Error importing projects: Invalid file format.', 'error');
            console.error('Error importing projects:', error);
        }
    };
    reader.readAsText(file);
}


// ======== 12. DEVELOPER CREDIT ========
// Added to the footer in HTML.


// ======== 13. EVENT LISTENERS ========
document.addEventListener('DOMContentLoaded', () => {
    DB.init();
    initializeApp(); // Directly initialize the app
    // The initial language is set in initializeApp now
});

</script>
</body>
</html>
