<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Engineering Project Platform</title>

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <link rel="stylesheet" href="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    
    <script defer src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script defer src="https://unpkg.com/@geoman-io/leaflet-geoman-free@latest/dist/leaflet-geoman.min.js"></script>
    <script defer src='https://unpkg.com/@mapbox/leaflet-omnivore@0.3.4/leaflet-omnivore.min.js'></script>
    <script defer src="https://npmcdn.com/@turf/turf/turf.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/PapaParse/5.3.2/papaparse.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script defer src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

    <style>
        :root {
            --primary-color: #007bff; --background-color: #f0f4f8;
            --glass-bg: rgba(255, 255, 255, 0.7); --glass-border: rgba(200, 210, 220, 0.5);
            --shadow: 0 8px 32px rgba(0, 0, 0, 0.1); --text-color: #2c3e50; --border-radius: 12px;
        }

        /* Base & Bilingual Support */
        html[dir="rtl"] { font-family: 'Tahoma', sans-serif; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--background-color); margin: 0; color: var(--text-color); transition: background-color 0.3s; }
        
        /* Page Visibility */
        .page { display: none; animation: fadeIn 0.5s; }
        .page.active { display: block; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* Layouts */
        .main-container { max-width: 1800px; margin: 0 auto; padding: 20px; }
        .centered-container { display: flex; flex-direction: column; justify-content: center; align-items: center; min-height: 100vh; padding: 20px; box-sizing: border-box; }

        /* Glass Card Style */
        .glass-card {
            background: var(--glass-bg);
            backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--glass-border);
            padding: 25px; border-radius: var(--border-radius);
            box-shadow: var(--shadow); margin-bottom: 20px;
        }
        html[dir="rtl"] .glass-card { text-align: right; }

        /* Forms & Buttons */
        .form-card { max-width: 480px; width: 100%; position: relative; }
        .form-card h1, .form-card p { text-align: center; }
        html[dir="rtl"] .form-card h1, html[dir="rtl"] .form-card p { text-align: center; }
        
        input[type="text"], input[type="email"], input[type="password"], input[type="date"], input[type="number"], input[type="file"] {
            width: 100%; padding: 12px; margin-bottom: 15px; border: 1px solid #ccc; border-radius: 8px; box-sizing: border-box;
        }
        
        button {
            padding: 10px 20px; border-radius: 8px; border: none; background-color: var(--primary-color);
            color: white; font-size: 16px; cursor: pointer; transition: background-color 0.3s;
        }
        button:hover { background-color: #0056b3; }
        button:disabled { background-color: #aaa; cursor: not-allowed; }
        
        /* Header */
        .header { display: flex; justify-content: space-between; align-items: center; padding: 10px; margin-bottom: 20px; }
        .header h1 { margin: 0; font-size: 1.5em; }
        
        /* Contract Selection */
        .contract-selection-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(250px, 1fr)); gap: 20px; margin-top: 20px; }
        .contract-select-card { background-color: white; padding: 20px; border-radius: 8px; text-align: center; cursor: pointer; transition: transform 0.2s, box-shadow 0.2s; }
        .contract-select-card:hover { transform: translateY(-5px); box-shadow: 0 4px 20px rgba(0,0,0,0.1); }
        .contract-select-card h3 { margin-top: 0; }

        /* NEW: Popup Styles */
        .popup-overlay {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background-color: rgba(0, 0, 0, 0.6);
            display: none; /* Hidden by default */
            justify-content: center; align-items: center;
            z-index: 1000; animation: fadeIn 0.3s;
        }
        .popup-close-btn {
            position: absolute; top: 10px; right: 20px; font-size: 30px;
            color: #555; cursor: pointer; border: none; background: none;
        }

        /* Footer */
        .footer { text-align: center; margin-top: 30px; padding: 20px; }
        html[dir="rtl"] .footer { text-align: center; }
    </style>
</head>
<body>
    <div id="login-page" class="page centered-container">
        <div class="form-card glass-card">
            <h1 data-translate="welcome_title">Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è</h1>
            <p data-translate="welcome_subtitle">Smart tools for managing maps, data, inspections, and reports for engineers and managers.</p>
            <form id="login-form">
                <input type="email" id="login-email" placeholder="Email" required>
                <input type="password" id="login-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_in">Sign In</button>
                <p class="error-message" id="login-error-message"></p>
                <a href="#" class="toggle-link" onclick="window.showPopup('signup-popup')" data-translate="need_account">Need an account? Sign Up</a>
            </form>
        </div>
    </div>

    <div id="contract-selection-page" class="page main-container">
        <div class="glass-card">
            <h1 data-translate="select_contract_title">Select a Contract</h1>
            <p data-translate="select_contract_subtitle">Choose a contract to access the project dashboard.</p>
            <div id="contract-selection-list" class="contract-selection-grid"></div>
        </div>
    </div>

    <div id="app-container" class="page main-container">
        <div class="header glass-card">
            <h1 id="app-main-title">Project Dashboard</h1>
            <div class="header-actions">
                <button id="map-nav-btn" onclick="window.showPage('map-page-content')" disabled>üó∫Ô∏è Map</button>
                <button id="tables-nav-btn" onclick="window.showPage('tables-page-content')" disabled>üìä Tables</button>
                <button id="reports-nav-btn" onclick="window.showPage('reports-page-content')" disabled>üìÑ Reports</button>
                <span style="border-left: 1px solid #ccc; height: 30px; margin: 0 10px;"></span>
                <select id="language-switcher" onchange="window.switchLanguage(this.value)">
                    <option value="en">English</option>
                    <option value="ar">ÿßŸÑÿπÿ±ÿ®Ÿäÿ©</option>
                </select>
                <button class="btn-danger" onclick="window.signOutUser()" data-translate="sign_out">Sign Out</button>
            </div>
        </div>
        <div id="app-content">
            <div id="map-page-content" class="app-page-content" style="display: none;"><div class="glass-card"><h2>Map View</h2><p>Map functionality will be displayed here.</p></div></div>
            <div id="tables-page-content" class="app-page-content" style="display: none;"><div class="glass-card"><h2>Tables View</h2><p>Data tables will be displayed here.</p></div></div>
            <div id="reports-page-content" class="app-page-content" style="display: none;"><div class="glass-card"><h2>Reports View</h2><p>Report generation tools will be displayed here.</p></div></div>
        </div>
    </div>

    <div id="signup-popup" class="popup-overlay">
        <div class="form-card glass-card">
            <button class="popup-close-btn" onclick="window.hidePopup('signup-popup')">&times;</button>
            <h1 data-translate="create_account">Create Your Account</h1>
            <form id="signup-form">
                <input type="text" id="signup-name" placeholder="Full Name" required>
                <input type="email" id="signup-email" placeholder="Email" required>
                <input type="password" id="signup-password" placeholder="Password" required>
                <button type="submit" data-translate="sign_up">Sign Up</button>
                <p id="signup-message" class="error-message"></p>
                <a href="#" class="toggle-link" onclick="window.hidePopup('signup-popup')" data-translate="have_account">Already have an account? Sign In</a>
            </form>
        </div>
    </div>

    <div id="pending-popup" class="popup-overlay">
        <div class="form-card glass-card">
            <h1 data-translate="pending_title">Request Received</h1>
            <p data-translate="pending_message">Your access request has been sent to the administrator for approval. You will be notified via email once your account is activated.</p>
            <button onclick="window.signOutUser()" data-translate="sign_out">Sign Out</button>
        </div>
    </div>
    
    <div class="footer">
        <p>Developed by Eng. Ahmet Nasan</p>
        <p>Civil Engineer & Software Developer</p>
        <em>‚ÄúBlending engineering precision with modern tech.‚Äù</em>
    </div>

    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';
        
        // --- Supabase Client Setup ---
        const supabaseUrl = 'https://cykjjrrexaqmsqwrgnzp.supabase.co';
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImN5a2pqcnJleGFxbXNxd3JnbnpwIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTE2MjUyMDksImV4cCI6MjA2NzIwMTIwOX0.Fx6f23TWCQQMCIkc5hcx8LqHyskVMm6WAhJl1UFZpMA';
        const supabase = createClient(supabaseUrl, supabaseKey);

        // --- GLOBAL STATE ---
        let currentUser;
        let selectedContract = null;

        // --- BILINGUAL DICTIONARY ---
        const translations = {
            en: {
                welcome_title: "Welcome to the Engineering Project Platform üë∑‚Äç‚ôÇÔ∏è",
                sign_in: "Sign In",
                need_account: "Need an account? Sign Up",
                create_account: "Create Your Account",
                sign_up: "Sign Up",
                have_account: "Already have an account? Sign In",
                pending_title: "Request Received",
                pending_message: "Your access request has been sent to the administrator for approval. You will be notified via email once your account is activated.",
                sign_out: "Sign Out",
                select_contract_title: "Select a Contract",
                select_contract_subtitle: "Choose a contract to access the project dashboard."
            },
            ar: {
                welcome_title: "ŸÖÿ±ÿ≠ÿ®Ÿãÿß ÿ®ŸÉ ŸÅŸä ŸÖŸÜÿµÿ© ÿßŸÑŸÖÿ¥ÿßÿ±Ÿäÿπ ÿßŸÑŸáŸÜÿØÿ≥Ÿäÿ© üë∑‚Äç‚ôÇÔ∏è",
                sign_in: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                need_account: "ÿ™ÿ≠ÿ™ÿßÿ¨ ÿ≠ÿ≥ÿßÿ®ÿü ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                create_account: "ÿ£ŸÜÿ¥ÿ¶ ÿ≠ÿ≥ÿßÿ®ŸÉ",
                sign_up: "ÿßÿ¥ÿ™ÿ±ÿßŸÉ",
                have_account: "ŸÑÿØŸäŸÉ ÿ≠ÿ≥ÿßÿ® ÿ®ÿßŸÑŸÅÿπŸÑÿü ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿØÿÆŸàŸÑ",
                pending_title: "ÿ™ŸÖ ÿßÿ≥ÿ™ŸÑÿßŸÖ ÿßŸÑÿ∑ŸÑÿ®",
                pending_message: "ÿ™ŸÖ ÿ•ÿ±ÿ≥ÿßŸÑ ÿ∑ŸÑÿ® ÿßŸÑŸàÿµŸàŸÑ ÿßŸÑÿÆÿßÿµ ÿ®ŸÉ ÿ•ŸÑŸâ ÿßŸÑŸÖÿ≥ÿ§ŸàŸÑ ŸÑŸÑŸÖŸàÿßŸÅŸÇÿ© ÿπŸÑŸäŸá. ÿ≥Ÿäÿ™ŸÖ ÿ•ÿπŸÑÿßŸÖŸÉ ÿπÿ®ÿ± ÿßŸÑÿ®ÿ±ŸäÿØ ÿßŸÑÿ•ŸÑŸÉÿ™ÿ± ÿßŸÑÿ•ŸÑŸÉÿ™ÿ±ŸàŸÜŸä ÿ®ŸÖÿ¨ÿ±ÿØ ÿ™ŸÅÿπŸäŸÑ ÿ≠ÿ≥ÿßÿ®ŸÉ.",
                sign_out: "ÿ™ÿ≥ÿ¨ŸäŸÑ ÿßŸÑÿÆÿ±Ÿàÿ¨",
                select_contract_title: "ÿßÿÆÿ™ÿ± ÿπŸÇÿØŸãÿß",
                select_contract_subtitle: "ÿßÿÆÿ™ÿ± ÿπŸÇÿØŸãÿß ŸÑŸÑŸàÿµŸàŸÑ ÿ•ŸÑŸâ ŸÑŸàÿ≠ÿ© ÿ™ÿ≠ŸÉŸÖ ÿßŸÑŸÖÿ¥ÿ±Ÿàÿπ."
            }
        };

        // --- UI & NAVIGATION FUNCTIONS ---
        window.showPopup = (popupId) => {
            const popup = document.getElementById(popupId);
            if(popup) popup.style.display = 'flex';
        };

        window.hidePopup = (popupId) => {
            const popup = document.getElementById(popupId);
            if(popup) popup.style.display = 'none';
        };

        window.showPage = (pageId) => {
            document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
            const page = document.getElementById(pageId);
            if (page) page.classList.add('active');

            document.querySelectorAll('.app-page-content').forEach(p => p.style.display = 'none');
            const appContentPage = document.getElementById(pageId);
            if (appContentPage && appContentPage.classList.contains('app-page-content')) {
                document.getElementById('app-container').classList.add('active');
                appContentPage.style.display = 'block';
            }
        };
        
        window.signOutUser = async () => {
            await supabase.auth.signOut();
            selectedContract = null; 
            hidePopup('pending-popup');
        };
        
        window.switchLanguage = (lang) => {
            document.documentElement.lang = lang;
            document.documentElement.dir = lang === 'ar' ? 'rtl' : 'ltr';
            document.querySelectorAll('[data-translate]').forEach(el => {
                const key = el.getAttribute('data-translate');
                el.innerText = translations[lang][key] || el.innerText;
            });
        };

        // --- AUTH STATE & ROUTING ---
        supabase.auth.onAuthStateChange(async (event, session) => {
            if (event === 'SIGNED_OUT' || !session) {
                currentUser = null;
                showPage('login-page');
            } else if (session) {
                currentUser = session.user;
                const { data: profile, error } = await supabase
                    .from('profiles')
                    .select('status, is_admin')
                    .eq('id', currentUser.id)
                    .single();

                if (error || !profile) {
                    showPopup('pending-popup'); // Show pending popup if profile not found
                    return;
                }

                if (profile.status === 'approved') {
                    showPage('contract-selection-page');
                    loadContractsForSelection();
                } else {
                    showPopup('pending-popup'); // Or if status is 'pending'
                }
            }
        });

        // --- FORM HANDLERS ---
        document.getElementById('login-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('login-email').value;
            const password = document.getElementById('login-password').value;
            const { error } = await supabase.auth.signInWithPassword({ email, password });
            if (error) document.getElementById('login-error-message').innerText = error.message;
        });

        document.getElementById('signup-form').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signup-name').value;
            const email = document.getElementById('signup-email').value;
            const password = document.getElementById('signup-password').value;
            const messageEl = document.getElementById('signup-message');

            const { data, error } = await supabase.auth.signUp({ email, password, options: { data: { full_name: name } } });
            
            if (error) {
                messageEl.innerText = error.message;
                messageEl.style.color = 'red';
            } else {
                hidePopup('signup-popup');
                showPopup('pending-popup'); // Show request received popup on success
            }
        });

        // --- CONTRACT SELECTION ---
        async function loadContractsForSelection() {
            const listContainer = document.getElementById('contract-selection-list');
            listContainer.innerHTML = '<p>Loading contracts...</p>';

            const { data: contracts, error } = await supabase.from('contracts').select('*');

            if (error || !contracts || contracts.length === 0) {
                listContainer.innerHTML = '<p>No contracts available. Please contact an administrator.</p>';
                return;
            }

            listContainer.innerHTML = '';
            contracts.forEach(contract => {
                const card = document.createElement('div');
                card.className = 'contract-select-card';
                card.innerHTML = `<h3>${contract.title}</h3><p>${contract.contract_number || ''}</p>`;
                card.onclick = () => selectContract(contract);
                listContainer.appendChild(card);
            });
        }
        
        window.selectContract = (contract) => {
            selectedContract = contract;
            document.getElementById('app-main-title').innerText = `Contract: ${contract.title}`;
            document.getElementById('map-nav-btn').disabled = false;
            document.getElementById('tables-nav-btn').disabled = false;
            document.getElementById('reports-nav-btn').disabled = false;
            showPage('map-page-content');
        };

        // --- INITIAL LOAD ---
        supabase.auth.getSession().then(({ data: { session } }) => {
            if (!session) {
                showPage('login-page');
            }
        });

    </script>
</body>
</html>
